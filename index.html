<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link href="style.css" rel="stylesheet" type="text/css" /><title>DAX Patterns</title></head><body><div id="calibre_link-2" lang="en-US" lang="en-US" class="calibre">
		<div class="_idgenobjectlayout">
			<div class="cover" type="cover" id="calibre_link-32">
				<img alt="DAX Patterns, Second Edition - The most comprehensive collection of ready-to-use solutions in DAX for Power BI, Analysis Services, and Power Pivot - Alberto Ferrari, Marco Russo" class="_idgenobjectattribute" src="images/000348.png" />
			</div>
		</div>
		<div class="_idgenobjectstyleoverride" type="covertitle" id="calibre_link-33">
			<p class="book-title">DAX Patterns</p>
			<p class="paraoverride"><span class="charoverride">SECOND EDITION</span></p>
		</div>
		<div class="halftitle" type="subtitle" id="calibre_link-34">
			<p class="book-tagline">The most comprehensive collection of</p>
			<p class="book-tagline">ready-to-use solutions in DAX for Power BI,</p>
			<p class="book-tagline">Analysis Services, and Power Pivot.</p>
		</div>
		<div class="halftitle" type="titlepage contributors" id="calibre_link-35">
			<p class="book-authors">Alberto Ferrari</p>
			<p class="book-authors">Marco Russo</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="sqlbi" id="calibre_link-36">
				<img alt="" class="_idgenobjectattribute" src="images/000330.png" />
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride1" id="calibre_link-37">
			</div>
		</div>
	</div>


<div id="calibre_link-23" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" type="copyright-page" id="calibre_link-38">
			<p class="normal"><span class="charoverride1">Copyright © 2020 by Alberto Ferrari and Marco Russo</span></p>
			<p class="copyright">All rights reserved. This publication is protected by copyright, and permission must be obtained from the publisher prior to any prohibited reproduction, storage in a retrieval system, or transmission in any form or by any means, electronic, mechanical, photocopying, recording, or likewise. Microsoft and the trademarks listed at www.microsoft.com/en-us/legal/intellectualproperty/trademarks/usage/general are trademarks of the Microsoft group of companies. All other marks are property of their respective owners.</p>
			<p class="copyright">The example companies, organizations, products, domain names, email addresses, logos, people, places, and events depicted herein are fictitious. No association with any real company, organization, product, domain name, email address, logo, person, place, or event is intended or should be inferred.</p>
			<p class="copyright">This book expresses the author’s views and opinions. The information contained in this book is provided without any express, statutory, or implied warranties. Neither the authors, the publisher, nor its resellers, or distributors will be held liable for any damages caused or alleged to be caused either directly or indirectly by this book.</p>
		</div>
		<div class="halftitle" type="colophon" id="calibre_link-39">
			<p class="production"><span class="charoverride2">Publisher / Editorial Production:</span> SQLBI Corp., Las Vegas, NV, United States</p>
			<p class="production"><span class="charoverride2">Authors:</span> Alberto Ferrari, Marco Russo </p>
			<p class="production"><span class="charoverride2">Copy Editor:</span> Claire Costa</p>
			<p class="production"><span class="charoverride2">Technical Editors:</span> Daniil Maslyuk, Sergio Murru</p>
			<p class="production"><span class="charoverride2">Cover Designer:</span> Daniele Perilli</p>
			<p class="production1"><span class="charoverride2">ISBN: </span>978-1-7353652-0-6</p>
			<p class="production1"><span class="charoverride2">Library of Congress Control Number</span>: 2020912594</p>
			<p class="copyright1">All the samples and files used in this book are available on <a href="https://www.daxpatterns.com"><span class="hyperlink">www.daxpatterns.com</span></a></p>
			<p class="copyright">All the code in this book has been formatted with <a href="https://www.daxformatter.com"><span class="hyperlink">www.daxformatter.com</span></a></p>
		</div>
	</div>


<div id="calibre_link-15" lang="en-US" lang="en-US" class="calibre">
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride2" id="calibre_link-40">
			</div>
		</div>
		<div class="full-margin-text-frame" type="introduction" id="calibre_link-41">
			<p class="ch-title--no-toc" id="calibre_link-42">Introduction</p>
			<p class="normal--unindented">At SQLBI we have a beautiful job: we are world-wide trainers and consultants. We meet thousands of people all over the world every year: a crowd of very diverse persons, sharing the same passion for Business Intelligence and DAX. We are asked to solve scenarios of various complexity by our students and customers. </p>
			<p class="normal1">Say a student approaches you because they need to compute the number of new customers for their report. You solve the problem once, twice, three times… And at some point, you feel that the next time you need to answer the same question, you would love to have a ready-to-use solution. This is the reason we started the daxpatterns.com website in 2013. We started collecting patterns that repeat themselves. We created a collection of DAX formulas aimed at solving the most frequently-asked questions we receive. At that time, the goal was not to write a new book. Instead, our goal was to create some sort of memory bank for the solutions we would find. We thought we would be the main users of our own website.</p>
			<p class="normal1">As is often the case, real-life does not go according to plan. This time, for the better. The website had a tremendous success. Users downloaded the samples and achieved two different goals: they found a ready-to-use solution to their problems, and they improved their DAX skills based on the formulas we authored. Because of the different file formats, we included samples for Excel 2010 and Excel 2013 &ndash; the latter still works with later versions of Excel. Eventually, we collected the content of the website into a book. That was the first edition of DAX Patterns. It was at the end of 2015. At the time, we had not yet published the first edition of The Definitive Guide to DAX. Therefore, we included a short introduction to DAX in the DAX Patterns book.</p>
			<p class="normal1">Many things changed over the following five years. DAX evolved with many useful features. Most importantly, Power BI hit the market and the number of users adopting DAX grew at an exponential rate. Today, most of the DAX users create a Power BI solution. When we published the first edition of this book, Power BI had not even been announced yet. </p>
			<p class="normal1">During these five years, the process of collecting patterns continued. We met more students, we solved more problems, we also got better and better at DAX. Plus, we now had thousands of users who were able to provide feedback on previous patterns. Studying user comments gave us a better picture of what our readers needed. In parallel, we went on to publish two editions of The Definitive Guide to DAX. At that point, there was no longer a reason to be teaching DAX in a book about patterns. </p>
			<p class="normal1">Long story short, it started to make a lot of sense to author a new version of both the DAX Patterns website and book. We rolled up our sleeves and created the book you are reading right now.</p>
			<p class="normal1">We did not use any of the content from the previous book. We wanted a fresh start. The entire library of code is rewritten from scratch, using the latest DAX and Power BI features and adapting the code to Excel 2019 when necessary. </p>
			<p class="normal1">In this new edition we made several choices:</p>
			<ul class="calibre1">
				<li class="bull-list">We greatly increased the share of the book dedicated to time intelligence calculations. Time intelligence is by far the most widely studied topic. Therefore, it made sense to increase the number of time-related calculations and patterns.</li>
				<li class="bull-list">Similarly, the New and returning customers pattern was an absolute hit. We gave that pattern a bigger share of the book as well, increasing the number of formulas and models to compute new and returning customers.</li>
				<li class="bull-list">We increased the number of patterns, adding several that &ndash; in our experience &ndash; are likely to be useful to our readers.</li>
				<li class="bull-list">We decided to cut out a few patterns. For example, the chapter about statistical calculations was useful back in 2015, because of the lack of statistical functions in DAX. Since then, DAX introduced many new functions to compute the formulas that were explained in that chapter. There is no need for that content in 2020.</li>
				<li class="bull-list">We no longer provide code snippets. In the previous book, most of the code was shown including placeholders for the columns that readers were likely to change. We no longer do that. We show code that works, because you often have to adapt the data model and other details in the formula. We felt this would make the code more readable and easier to use and to adapt to your model.</li>
				<li class="bull-list">We optimized every single formula. All the code you see in these patterns has been thoroughly reviewed for performance. This is not to say that these patterns are the very best. They are the best we could come up with. If you can make the code better and faster, let us know! The comment sections on the website are the right place to provide your feedback.</li>
				<li class="bull-list">We created a Power BI and an Excel version of each sample file. In the book, we include pictures of Power BI reports showing the results of the code, but the examples you can download are available in both formats: Power BI and Excel.</li>
				<li class="bull-list">We improved the readability of the eBook version of DAX Patterns. This meant keeping the code formatting intact regardless of the eBook reader size.</li>
			</ul>
			<p class="heading" id="calibre_link-43">Why we published this book</p>
			<p class="normal--unindented">If you are wondering what the differences may be between the content of this book and the content published on daxpatterns.com, we want to assure you that there are no differences. Should you buy the book to obtain extra content? No. The access to the web site is free, where you can read the same content as what you will find in this book and download the sample files for free.</p>
			<p class="normal1">That said, if you enjoy having an offline copy of the patterns, if you enjoy having a printed version, if you would like to have it in your eBook collection, then you should purchase it. This way, you help us keep the business up and running. We were surprised with the number of people who purchased the first edition. This motivated us to further invest into this new version of the website and the pattern. We hope the process will continue!</p>
			<p class="normal1">By visiting the daxpatterns.com website, you will also see that we have recorded a video for each pattern. This is where we go into more depth on how to use the patterns and how the formulas work. These videos are for sale. You can buy all of them, or just the pattern you want to study more. It is an additional service that many people have been asking for; we know some prefer the book, some prefer the video, and many people want both!</p>
			<p class="heading" id="calibre_link-44">How to use this book</p>
			<p class="normal--unindented">What will you find in this book? Each standalone chapter covers a separate pattern and can be read without having read the others. You can read the Currency conversion pattern without having ever looked at the Basket analysis, or at any of the time-related calculations.</p>
			<p class="normal1">Each chapter about a pattern starts with a brief description of the business scenario; it then goes into a more complete description of the solution, along with all the DAX code that needs to be implemented in order to solve the scenario. We kept the description of the code short, using comments in the code to document the measures where needed.</p>
			<p class="normal1">You need separate companion content for the book. At the beginning of each chapter, a short URL points to the corresponding pattern on the daxpatterns.com website. You can download the sample files for Power BI and Excel from the website.</p>
			<p class="normal1">The book is intended to be used as a reference. When you want to implement a pattern, you do not want to read long descriptions: you want to see the code and the reason for it. Therefore, we kept it as compact as possible, keeping the spotlight on the DAX code.</p>
			<p class="normal1">That said, if you want to implement a pattern we strongly suggest that you read the entire chapter before implementing any code. The reason is that we sometimes present multiple solutions and you need to choose the best for your specific scenario. For each pattern we also provide the demo files both in Power BI and Power Pivot for Excel. Sometimes the code of the two versions is slightly different. The book always presents the Power BI solution, which is using the latest features of DAX at the time of printing. Some of those features are not available in Power Pivot &ndash; like calculated tables. This is the main reason for the differences.</p>
			<p class="normal1">There is only one exception: time-related calculations. As we said, we gave the time-related calculations more space in the book: we now present four different patterns for time-related calculations. Each of these four patterns is huge. Together, they represent more than 40% of this book. This is why we created an introductory chapter to the time-related calculations, which aims to help you choose the right pattern for your scenario. If you need to implement time-related calculations, make sure to read the introduction first, and then the full chapter covering the pattern you decide to use.</p>
			<p class="heading" id="calibre_link-45">Prerequisites</p>
			<p class="normal--unindented">One word of advice to our readers: this book does not teach DAX.</p>
			<p class="normal1">You are expected to already know DAX to make the best use of these patterns. Most of the patterns show advanced DAX techniques that you are welcome to study and use in your solutions. By reading this book you will not learn DAX. But if you already know DAX, you will likely become a better DAX developer.</p>
			<p class="normal1">We suggest that you use these patterns with the latest version of Power BI or Excel, because DAX evolves and improves over time. We tested the patterns on Power BI June 2020, Excel 2019, and Excel for Microsoft 365 version 2006. Most of the patterns work with earlier versions of Power BI and Excel, but we cannot guarantee this because we did not thoroughly test for all the previous versions.</p>
			<p class="heading" id="calibre_link-46">Acknowledgments</p>
			<p class="normal--unindented">Last, but not least: the acknowledgments section.</p>
			<p class="normal1">The most important person we want to thank is you. This work was made possible by the discussions we have had over time with readers, users, customers, and students like yourself. Therefore, even without knowing it you have contributed to this content; and if you post comments in our public forums, you will be contributing further.</p>
			<p class="normal1">That said, there are some people who directly contributed to the entire writing process: Daniil Maslyuk meticulously reviewed each pattern, found all the errors we had made and provided invaluable feedback. Claire Costa reviewed our English grammar and readability, making the book more precise and enjoyable. Sergio Murru built the Excel versions of the sample files, which made the patterns available also to Power Pivot for Excel users. Daniele Perilli is the reason behind the book and the website being as beautiful as they are. We are responsible for the content and for any mistake, but if you can read accurate numbers, in good English, in both Excel and Power BI, and with a gorgeous overall presentation, it is thanks to them.  </p>
			<p class="normal1">Enjoy DAX!</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride3" id="calibre_link-47">
			</div>
		</div>
	</div>


<div id="calibre_link-18" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-48">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture" id="calibre_link-49">
					<img alt="" class="_idgenobjectattribute" src="images/000447.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 1</p>
			<p class="ch-title--no-toc" id="calibre_link-50"><a id="calibre_link-51" class="calibre2"></a>Time-related calculations</p>
			<p class="normal--unindented">This chapter introduces the four time-related calculations patterns presented in the next chapters. The goal here is to help you choose the right pattern based on your specific needs. Indeed, when it comes to time-related calculations, the choice of the pattern is hard.</p>
			<p class="normal1">First, what is a time-related calculation? A time-related calculation refers to any calculation that involves time. Examples include the set of period-to-date calculations, like year-to-date, quarter-to-date, or month-to-date. These calculations accumulate values from the beginning of a time period &ndash; year, quarter, month &ndash; and they return the aggregation of the measure from the start of the period to the date shown in the report. The definition of a time period changes depending on whether you work with the Gregorian calendar or a fiscal calendar. In Figure 1-1, you can see an example of period-to-date calculations, where YTD stands for year-to-date, and QTD for quarter-to-date.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-52">
					<img alt="" class="_idgenobjectattribute" src="images/000158.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 1-1</span> Examples of period-to-date calculations.</p>
			<p class="normal1">Included in these patterns are also comparisons of a parameter over a certain period of time, with a different period of time. For example, you can compare the sales of the current month against the sales of the same month in the previous year. Another example of time-related calculations is the moving average over a time period, like a rolling average over 12 months which smoothes out line charts and removes the effect of seasonality from calculations. The four time-related patterns implement the same set of calculations.</p>
			<p class="normal1">What makes the patterns so different from one another, is the definition of what a calendar is. You can already appreciate the different definitions of a year-to-date calculation by looking at Figure 1-1. Depending on whether you are working with the Gregorian or the fiscal calendar, the numbers are different. When talking about a calendar, things can easily become very complicated because of the definition of the calendar.</p>
			<p class="normal1">For example, you might have a week-based calendar following an ISO standard or your own definition. In a week-based calendar every month starts the same day of the week, and the same goes for the year. Therefore, a year in a week-based calendar might start in the Gregorian year before, or end in the next one. Moreover, some calendars split a year into 13 periods instead of 12 months, for accounting purposes. The calendar requirements are the main driver for the choice of the time-related pattern.</p>
			<p class="normal1">The four time-related patterns are presented in order of increasing complexity:</p>
			<ol class="calibre3">
				<li class="num-list">Standard time-related calculations</li>
				<li class="num-list">Month-related calculations</li>
				<li class="num-list">Week-related calculations</li>
				<li class="num-list">Custom time-related calculations</li>
			</ol>
			<p class="normal1">The <a href="#calibre_link-9"><span class="hyperlink1">Standard time-related calculations</span></a> pattern is implemented using regular DAX time intelligence functions. It works based on the assumption that your calendar is a regular Gregorian calendar and that your fiscal calendar starts at the beginning of a Gregorian quarter. For example, DAX time intelligence functions work fine if your fiscal calendar starts on July 1 (start of the third quarter of a Gregorian calendar). Yet, they might provide unexpected results if your fiscal calendar starts on March 1 &ndash; both because March does not start a Gregorian quarter, and because of a historical bug in handling leap years with fiscal calendars. Despite these limitations, the pattern is easy to use and implement because it relies on standard DAX functions and works with a regular date table, with few requirements.</p>
			<p class="normal1">The next three patterns do not use DAX time intelligence calculations. Rather, they are written using basic DAX functions &ndash; which leaves much more flexibility in the definition of what a calendar is in terms of quarters, months, and weeks. These patterns require you to build a <span class="charoverride3">Date</span> table whose columns are required for the DAX measures to identify the fractions of the year. For example, you need one column containing the year, one for the quarter, one for the month, plus additional columns to simplify the calculations.</p>
			<p class="normal1">Moreover, many details need to be considered when detecting and filtering periods. Many calculations that look easy to humans prove to be very complicated for a computer. When you compare one quarter against the previous one, you need to select a different number of days for the two quarters: the January-March quarter is shorter than the April-June quarter. The same goes for the months: January is longer than February, but if you want to make a comparison month-over-month, you need two date selections of different lengths.</p>
			<p class="normal1">If standard time intelligence functions do not meet your needs, then you need to implement one of the other three patterns. All of them require the creation of your own <span class="charoverride3">Date</span> table.</p>
			<p class="normal1">The <a href="#calibre_link-19"><span class="hyperlink1">Month-related calculations</span></a> pattern is the easiest one. It implements all the calculations assuming that you are not interested in the daily details. For example, if you need calculations and reports that compare one month against another, then the pattern is a good fit. The pattern does not support sub-month selections. If you want to compare three days in a quarter against the same three days in the previous quarter, then you exceed the potential of the pattern: it just does not work. Despite strong limitations in its analytical power (limited to monthly granularity) the month-related pattern is extremely fast and simple to implement. Moreover, it can handle scenarios where you have more than 12 months seamlessly. It comes with the flexibility of a custom-made pattern, and it is simpler than the standard time-related pattern. If you are ok with its limitation about the month granularity, this should be the pattern of choice.</p>
			<p class="normal1">In the <a href="#calibre_link-8"><span class="hyperlink1">Week-related calculations</span></a> pattern, the week is the foundation of the calendar. The ISO 8601 is one of the standards that provide a definition of a week date system &ndash; even though many countries adopt different national standards to identify years, quarters, and weeks. One year has 52 or 53 weeks, one quarter has 13 weeks, and each quarter is subdivided into 5+4+4 weeks, 4+5+4 weeks, or 4+4+5 weeks. When there are 53 weeks in a year, there are 14 weeks in one of the quarters. Because a week is not necessarily entirely included in a month, the group of weeks within a quarter should be called a “period” even though it is often referred to as a month. For this reason, we refer to the month names as “periods” in the following description.</p>
			<p class="normal1">Because weeks are the main entity, there is no correspondence between a year in a Gregorian calendar and a year in a week-based calendar. A week-based calendar always starts on the same weekday, like Monday or Sunday. Therefore, only occasionally does this day happen to fall on January 1. For a weekly year, it is totally fine to start on December 29 of the previous year, or on January 3 of the current year. Despite being somewhat unusual, weekly calendars come with some great characteristics: every “month” in a quarter includes the same number of weekdays. Comparing one quarter against another means comparing the same number of days and the same distribution of weekdays.</p>
			<p class="normal1">Week-based calendars require a dedicated <span class="charoverride3">Date</span> table with several columns to drive the DAX calculations. Moreover, there are no pre-existing DAX functions available to compute calculations over such calendars. Therefore, week-based calculations are implemented with custom DAX code. The complexity is higher than the month-related pattern because the week-related pattern lets you filter any time period, down to the day level. If you have a calendar based on weeks, the week-based calculations pattern is what you have to implement.</p>
			<p class="normal1">The <a href="#calibre_link-7"><span class="hyperlink1">Custom time-related calculations</span></a> pattern is the most flexible (and complex) one. This last pattern provides the same calculations as the standard time-related pattern. The relevant difference is that the entire pattern is written using basic DAX functions: we do not use any DAX time intelligence functions. Consequently, the pattern is extremely flexible because you can freely change the behavior of the calculations. With greater flexibility comes greater complexity.</p>
			<p class="normal1">The DAX code of the last pattern is not trivial. It requires much attention to small details. Use it only if none of the other patterns satisfies your business requirements, and you really need the complete flexibility it provides.</p>
			<p class="normal1">Finally, which pattern should you choose?</p>
			<ul class="calibre1">
				<li class="bull-list">If your requirements are satisfied by a regular Gregorian calendar, the <a href="#calibre_link-9"><span class="hyperlink1">Standard time-related calculations</span></a><span class="charoverride2"> </span>pattern is the obvious choice.</li>
				<li class="bull-list">If the month granularity is enough for your reporting needs &ndash; which is often the case, more often than expected &ndash; then the <a href="#calibre_link-19"><span class="hyperlink1">Month-related calculations</span></a> pattern is the optimal choice: fast and simple. </li>
				<li class="bull-list">If you work with a calendar based on weeks, then you need the <a href="#calibre_link-8"><span class="hyperlink1">Week-related calculations</span></a> pattern.</li>
				<li class="bull-list">If none of the above is enough and you really need total flexibility, be prepared for a long and fascinating trip into the intricacies of filter contexts and dive straight into the <a href="#calibre_link-7"><span class="hyperlink1">Custom time-related calculations</span></a> pattern.</li>
			</ul>
			<p class="normal1">Remember: with a Business Intelligence project, simpler is better. Choose the most straightforward pattern that satisfies your needs. Needless to say, if you are curious about the differences between the various implementations, it might be useful to have a quick read through all four chapters before making your choice.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride4" id="calibre_link-53">
			</div>
		</div>
	</div>


<div id="calibre_link-21" lang="en-US" lang="en-US" class="calibre">
		<div class="_idgenobjectstyleoverride" id="calibre_link-54">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture1" id="calibre_link-55">
					<img alt="" class="_idgenobjectattribute" src="images/000344.png" />
				</div>
			</div>
			<p class="ch-number">Chapter 2</p>
			<p class="ch-title--no-toc" id="calibre_link-56"><a id="calibre_link-9" class="calibre2"></a>Standard time-related calculations</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-201"><span class="hyperlink1">https://sql.bi/dax-201</span></a></p>
			<p class="normal--unindented">In this pattern, we show you how to compute time-related calculations, like year-to-date, same period last year, and percentage growth using a standard calendar. The great advantage of working with a standard calendar is that you can rely on several built-in time intelligence functions. The built-in functions are designed in such a way that they provide the correct result for the most common requirements.</p>
			<p class="normal1">In case your requirement cannot be fulfilled by the built-in functions, or if you have a non-standard calendar, then you should use regular (non-time-related) DAX functions to reach the same goal. This way, you customize the result of your code at will. That said, if you need custom calculations, then you also need to enrich your date table with a set of columns that are needed by the DAX formulas to move the filter. These custom calculations are covered in the <a href="#calibre_link-7"><span class="hyperlink1">Custom time-related calculations</span></a> pattern.</p>
			<p class="normal1">If you are using a regular Gregorian calendar, then the formulas in this pattern are the easiest and most effective way of producing time intelligence calculations. Keep in mind that standard DAX time intelligence functions only support a regular Gregorian calendar &ndash; that is a calendar with 12 months, each month with its Gregorian number of days, quarters made up of three months, and all the regular aspects of a calendar that we are used to.</p>
			<p class="heading1" id="calibre_link-57">Introduction to time intelligence calculations</p>
			<p class="normal--unindented">In order to use any time intelligence calculation, you need a well-formed date table. The <span class="charoverride3">Date</span> table must satisfy the following requirements:</p>
			<ul class="calibre1">
				<li class="bull-list">All dates need to be present for the years required. The <span class="charoverride3">Date</span> table must always start on January 1 and end on December 31, including all the days in this range. If the report only references fiscal years, then the date table must include all the dates from the first to the last day of a fiscal year. For example, if the fiscal year 2008 starts on July 1, 2007, then the <span class="charoverride3">Date</span> table must include all the days from July 1, 2007 to June 30, 2008.</li>
				<li class="bull-list">There needs to be a column with a <span class="charoverride3">DateTime</span> or <span class="charoverride3">Date</span> data type containing unique values. This column is usually called <span class="charoverride3">Date</span>. Even though the <span class="charoverride3">Date</span> column is often used to define relationships with other tables, this is not required. Still, the <span class="charoverride3">Date</span> column must contain unique values and should be referenced by the Mark as Date Table feature. In case the column also contains a time part, no time should be used &ndash; for example, the time should always be 12:00 am.</li>
				<li class="bull-list">The <span class="charoverride3">Date</span> table must be marked as a date table in the model, in case the relationship between the <span class="charoverride3">Date</span> table and any other table (like <span class="charoverride3">Sales</span> in our example) is not based on the <span class="charoverride3">Date</span> column.</li>
			</ul>
			<p class="normal1">There are several ways to build a <span class="charoverride3">Date</span> table. The way you build the <span class="charoverride3">Date</span> table does not affect how you use the standard time intelligence calculations, as long as the date table satisfies the requirements. If you already have a <span class="charoverride3">Date</span> table that works well for your report, just import it and mark it as a date table after having checked that it satisfies the minimum requirements. If you do not have a <span class="charoverride3">Date</span> table, you can create one using a DAX calculated table as described later.</p>
			<p class="normal1">It is a best practice to apply the Mark as a Date Table setting to the <span class="charoverride3">Date</span> table used for time intelligence calculations. The Mark as a Date Table setting adds a REMOVEFILTERS modifier over the <span class="charoverride3">Date</span> table every time a filter is applied to the <span class="charoverride3">Date</span> column. This action (applying a filter on the <span class="charoverride3">Date</span> column) is performed by all the time intelligence functions used in CALCULATE. DAX implements the same behavior if you define the relationship between <span class="charoverride3">Sales </span>and <span class="charoverride3">Date</span> using the <span class="charoverride3">Date</span> column. Nevertheless, applying the Mark as a Date Table setting to a date table is a best practice. If you have multiple date tables, you can mark all of them as date tables.</p>
			<p class="normal1">If you do not use the Mark as a Date Table setting and you do not use the date column for the relationship, then you must add a REMOVEFILTERS over the <span class="charoverride3">Date</span> table whenever you use a time intelligence function in CALCULATE. This behavior is described in more detail in the article <a href="https://www.sqlbi.com/articles/time-intelligence-in-power-bi-desktop/"><span class="hyperlink">Time Intelligence in Power BI Desktop</span></a>.</p>
			<p class="heading" id="calibre_link-58">What are standard DAX time intelligence functions</p>
			<p class="normal--unindented">The standard time intelligence functions are table functions returning a list of dates used as a filter in CALCULATE. The result of a time intelligence function can be obtained by writing a more complex filter expression. For example, the DATESYTD function returns all the dates in the same year between the first day of the year and the last day visible in the filter context. The following expression:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-59">
					<img alt="" class="_idgenobjectattribute" src="images/000310.png" />
				</div>
			</div>
			<p class="normal1">corresponds to the following FILTER expression:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-60">
					<img alt="" class="_idgenobjectattribute" src="images/000325.png" />
				</div>
			</div>
			<p class="normal1">There are many time intelligence functions, most of which we present in this pattern. Be mindful: time intelligence functions should be used as filter arguments of CALCULATE, and sometimes you will resort to variables to achieve that. It is dangerous to use time intelligence functions in iterators, because of the implicit context transition that is triggered to retrieve the dates active from the filter context. More details about this behavior are available in the DAX Guide documentation, like <a href="https://dax.guide/datesytd/"><span class="hyperlink">https://dax.guide/datesytd/</span></a> .</p>
			<p class="normal1">The following is a quick guide to the best practices when using time intelligence functions:</p>
			<ul class="calibre1">
				<li class="bull-list">Use time intelligence functions like DATESYTD only in filter arguments of CALCULATE / CALCULATETABLE, or to assign filters to variables.</li>
				<li class="bull-list">Use scalar functions like EDATE and EOMONTH in DAX formulas returning a value &ndash; also known as scalar expressions. These functions are not time intelligence functions and can be used in expressions evaluated in a row context.</li>
				<li class="bull-list">Use CONVERT to convert a date into a number and vice versa. </li>
				<li class="bull-list">A complete updated list of time intelligence functions is available at <a href="https://dax.guide/"><span class="hyperlink">https://dax.guide/</span></a>.</li>
			</ul>
			<p class="normal1">DAX beginners often confuse time intelligence functions with regular &ndash; scalar &ndash; time functions. This confusion leads to common mistakes that can be avoided by following these suggestions:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride2">DO NOT</span> use DATEADD to return the previous or the following day. You can use simple mathematical operators to do that.</li>
				<li class="bull-list"><span class="charoverride2">DO NOT</span> use PREVIOUSDAY to compute the previous day in a scalar expression. You can just subtract one from a date to obtain the previous day in a scalar expression.</li>
				<li class="bull-list"><span class="charoverride2">DO NOT</span> use EOMONTH as a filter &ndash; use ENDOFMONTH instead. EOMONTH is a scalar expression. ENDOFMONTH is a time intelligence function. Always pay attention to the return type of a function: only table functions are time intelligence functions, and they should not be used in scalar expressions.</li>
			</ul>
			<p class="heading" id="calibre_link-61">Disabling the Auto Date/Time</p>
			<p class="normal--unindented">Power BI can automatically add a <span class="charoverride3">Date</span> table to a data model<span class="charoverride2">. Yet, we strongly suggest disabling the automatic </span><span class="charoverride4">Date</span><span class="charoverride2"> table created by Power BI</span> and importing or creating an explicit <span class="charoverride3">Date</span> table instead. More details are included in the article <a href="https://www.sqlbi.com/articles/automatic-time-intelligence-in-power-bi/"><span class="hyperlink">Automatic time intelligence in Power BI</span></a>.</p>
			<p class="normal1">The presence of an automatic <span class="charoverride3">Date</span> table also enables a specific syntax called column variation. Column variations are expressed with a dot after the date column, followed by a column of the date table that is created automatically:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-62">
					<img alt="" class="_idgenobjectattribute" src="images/000338.png" />
				</div>
			</div>
			<p class="normal1">Power BI quick measures make extensive use of column variations when used over an automatic <span class="charoverride3">Date</span> table. We do not rely on the date tables created automatically in Power BI because we want to maintain maximum flexibility and maximum control over our model. The syntax of column variations is not used for Date tables that are part of the model and thus are not created automatically.</p>
			<p class="heading" id="calibre_link-63">Limitations of standard time intelligence functions</p>
			<p class="normal--unindented">The standard time intelligence functions work on a regular Gregorian calendar. They have several limitations, listed in this section. When your requirements are not compatible with these limitations, you need another pattern (see <a href="#calibre_link-7"><span class="hyperlink1">Custom time-related calculations</span></a> and <a href="#calibre_link-8"><span class="hyperlink1">Week-related calculations</span></a>).</p>
			<ul class="calibre1">
				<li class="bull-list">The year starts on the first of January. There is limited support for fiscal calendars starting at a different date. However, the first day of the fiscal year must always be the same for every year and cannot be the first of March, because of historical bugs related to leap years.</li>
				<li class="bull-list">The quarters always start on the first of January, April, July, and October. The range of a quarter cannot be modified.</li>
				<li class="bull-list">A month is always a calendar month.</li>
				<li class="bull-list">Filters of additional columns such as <span class="charoverride3">Day of Week</span> or <span class="charoverride3">Working Day</span> might not be supported correctly by standard time intelligence functions. More details about possible workarounds are available in the section, “Filtering other date attributes”.</li>
			</ul>
			<p class="normal1">Consequently, many advanced calculations like calculations over weeks are not supported by the standard time intelligence calculations. These advanced calculations require a custom calendar.</p>
			<p class="heading" id="calibre_link-64">Building a <span class="charoverride5">Date</span> table</p>
			<p class="normal--unindented">DAX time intelligence functions work on any standard Gregorian calendar table. If you already have a <span class="charoverride3">Date</span> table, you can import the table and use it without any issue. If a <span class="charoverride3">Date</span> table is not available, you can create one using a DAX calculated table. As an example, the following DAX expression defines the simple <span class="charoverride3">Date</span> table used in this chapter:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-65">
					<img alt="" class="_idgenobjectattribute" src="images/000354.png" />
				</div>
			</div>
			<p class="normal1">You can customize the first three variables to build a <span class="charoverride3">Date</span> table that meets specific business requirements. In order to obtain the correct result, the columns must be configured in the data model as follows &ndash; when the column is not text, it is a <span class="charoverride3">Date</span> data type with standard or custom format:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride3">Date</span>: m/dd/yyyy (8/14/2007), used as a column to mark as date table</li>
				<li class="bull-list"><span class="charoverride3">Year</span>: yyyy (2007)</li>
				<li class="bull-list"><span class="charoverride3">Year Quarter</span>: Text (Q3-2008)</li>
				<li class="bull-list"><span class="charoverride3">Year Quarter Date</span>: Hidden (9/30/2008) </li>
				<li class="bull-list"><span class="charoverride3">Quarter</span>: Text (Q1)</li>
				<li class="bull-list"><span class="charoverride3">Year Month</span>: mmm yyyy (Aug 2007)</li>
				<li class="bull-list"><span class="charoverride3">Month</span>: mmm (Aug)</li>
				<li class="bull-list"><span class="charoverride3">Day of Week</span>: ddd (Tue)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year</span>: \F\Y yyyy (FY 2008)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Quarter</span>: Text (FQ1-2008)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Quarter Date</span>: Hidden (9/30/2008) </li>
				<li class="bull-list"><span class="charoverride3">Fiscal Quarter</span>: Text (FQ1)</li>
			</ul>
			<p class="normal1">The <span class="charoverride3">Date</span> table in this pattern has two hierarchies:</p>
			<ul class="calibre1">
				<li class="bull-list">Calendar: Year (<span class="charoverride3">Year</span>), Quarter (<span class="charoverride3">Year Quarter</span>), Month (<span class="charoverride3">Year Month</span>)</li>
				<li class="bull-list">Fiscal: Year (<span class="charoverride3">Fiscal Year</span>), Quarter (<span class="charoverride3">Fiscal Year Quarter</span>), Month (<span class="charoverride3">Year Month</span>)</li>
			</ul>
			<p class="normal1">Regardless of the source, the <span class="charoverride3">Date</span> table must also include a hidden <span class="charoverride3">DateWithSales</span> calculated column to use the formulas of this pattern: </p>
			<p class="code-block-screened-head">Calculated column in the Date table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-66">
					<img alt="" class="_idgenobjectattribute" src="images/000369.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Date[DateWithSales]</span> column is <span class="charoverride3">TRUE</span> if the date is on or before the last date with transactions in the Sales table; it is <span class="charoverride3">FALSE</span> otherwise. In other words, <span class="charoverride3">DateWithSales</span> is <span class="charoverride3">TRUE</span> for “past” dates and <span class="charoverride3">FALSE</span> for “future” dates, where “past” and “future” are relative to the last date with transactions in <span class="charoverride3">Sales</span>.</p>
			<p class="heading" id="calibre_link-67">Controlling the visualization in future dates</p>
			<p class="normal--unindented">Most of the time intelligence calculations should not display values for dates after the last date available. For example, a year-to-date calculation can also show values for future dates, but we want to hide those values. The dataset used in these examples ends on August 15, 2009. Therefore, we consider the month of August 2009, the third quarter of 2009 (Q3-2009), and the year 2009 as the last periods with data. Any date later than August 15, 2019 is considered as future, and we want to hide values there.</p>
			<p class="normal1">In order to avoid showing results in future dates, we use the following <span class="charoverride3">ShowValueForDates</span> measure. <span class="charoverride3">ShowValueForDates</span> returns TRUE if the time period selected is not after the last period with data:</p>
			<p class="code-block-screened-head">Measure (hidden) in the Date table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-68">
					<img alt="" class="_idgenobjectattribute" src="images/000384.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">ShowValueForDates</span> measure is hidden. It is a technical measure created to reuse the same logic in many different time-related calculations, and the user should not use <span class="charoverride3">ShowValueForDates</span> directly in a report.</p>
			<p class="heading" id="calibre_link-69">Naming convention</p>
			<p class="normal--unindented">This section describes the naming convention we adopted to reference the time intelligence calculations. A simple categorization shows whether a calculation:</p>
			<ul class="calibre1">
				<li class="bull-list">shifts over a period of time, for example the same period in the previous year;</li>
				<li class="bull-list">performs an aggregation, for example year-to-date; or</li>
				<li class="bull-list">compares two time periods, for example this year compared to last year.</li>
			</ul>
			<div class="_idgenobjectlayout">
				<div class="table-screenshot" id="calibre_link-70">
					<img alt="" class="_idgenobjectattribute" src="images/000390.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-71">Computing period-to-date totals</p>
			<p class="normal--unindented">The year-to-date, quarter-to-date, and month-to-date calculations modify the filter context for the <span class="charoverride3">Date</span> table, applying a range of dates as a filter that overwrites the filter for the period selected.</p>
			<p class="normal1">All these calculations can be implemented using a regular CALCULATE with a time intelligence function, or with one of the TOTAL functions such as TOTALYTD. TOTAL functions are just syntactic sugar for the CALCULATE version. We show them as a reference, even though we prefer the CALCULATE version &ndash; indeed, using CALCULATE makes the formula logic more evident, and it provides more flexibility than TOTAL functions do. The formulas using the TOTAL functions are marked as (2) in the following examples. The purpose of showing them is only to show that they return the same values as the CALCULATE version does.</p>
			<p class="heading" id="calibre_link-72">Year-to-date total</p>
			<p class="normal--unindented">The year-to-date aggregates data starting on January 1 of the year, as shown in Figure 2-1. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-73">
					<img alt="" class="_idgenobjectattribute" src="images/000464.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-1</span> <span class="charoverride3">Sales YTD (simple)</span> shows the value for any time period, whereas <span class="charoverride3">Sales YTD</span> and <span class="charoverride3">Sales YTD (2)</span> hide the result after the last period with data.</p>
			<p class="normal1">The year-to-date total of a measure can rely on the DATESYTD function this way:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-74">
					<img alt="" class="_idgenobjectattribute" src="images/000399.png" />
				</div>
			</div>
			<p class="normal1">DATESYTD returns the set of dates from the first day of the current year, up to the last date visible in the filter context. Therefore, the <span class="charoverride3">Sales YTD (simple)</span> measure shows data even for future dates in the year. We can avoid this behavior in the <span class="charoverride3">Sales YTD</span> measure by returning a result only when the <span class="charoverride3">ShowValueForDates</span> measure returns TRUE:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-75">
					<img alt="" class="_idgenobjectattribute" src="images/000413.png" />
				</div>
			</div>
			<p class="normal1">If the report is based on a fiscal year that does not correspond to the calendar year, DATESYTD requires an additional argument to identify the last day of the fiscal year. Take for example, the report in Figure 2-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-76">
					<img alt="" class="_idgenobjectattribute" src="images/000478.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-2</span> <span class="charoverride3">Sales Fiscal YTD </span>and <span class="charoverride3">Sales Fiscal YTD (2)</span> show the year-to-date based on fiscal years.</p>
			<p class="normal1">The <span class="charoverride3">Sales Fiscal YTD</span> measure specifies the last day and month of the fiscal year in the second argument of DATESYTD. The following measure uses June 30 as the last day of the fiscal year. The second argument of DATESYTD must be a constant value (also called a literal) corresponding to the definition of the fiscal year in the <span class="charoverride3">Date</span> table; it cannot be computed dynamically:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-77">
					<img alt="" class="_idgenobjectattribute" src="images/000427.png" />
				</div>
			</div>
			<p class="normal1">The TOTALYTD function is a possible alternative to DATESYTD:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-78">
					<img alt="" class="_idgenobjectattribute" src="images/000441.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-79">
					<img alt="" class="_idgenobjectattribute" src="images/000455.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-80">Quarter-to-date total</p>
			<p class="normal--unindented">The quarter to date aggregates data from the first day of the quarter, as shown in Figure 2-3. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-81">
					<img alt="" class="_idgenobjectattribute" src="images/000491.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-3</span> <span class="charoverride3">Sales QTD</span> shows the quarter-to-date amount, which is blank for 2009 because there is no data in Q4-2009.</p>
			<p class="normal1">The quarter-to-date total of a measure is computed with the DATESQTD function as follows:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-82">
					<img alt="" class="_idgenobjectattribute" src="images/000469.png" />
				</div>
			</div>
			<p class="normal1">The TOTALQTD is a possible alternative to DATESQTD:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-83">
					<img alt="" class="_idgenobjectattribute" src="images/000483.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-84">Month-to-date total</p>
			<p class="normal--unindented">The month to date aggregates data from the first day of the month, as shown in Figure 2-4. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-85">
					<img alt="" class="_idgenobjectattribute" src="images/000504.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-4</span> <span class="charoverride3">Sales MTD</span> shows the month-to-date amount, which is blank for CY 2009 and Q3-2009 because there is no data after August 15, 2009.</p>
			<p class="normal1">The month-to-date total of a measure is computed with the DATESMTD function this way:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-86">
					<img alt="" class="_idgenobjectattribute" src="images/000496.png" />
				</div>
			</div>
			<p class="normal1">The TOTALMTD is a possible alternative to DATESMTD :</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-87">
					<img alt="" class="_idgenobjectattribute" src="images/000511.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-88">Computing period-over-period growth</p>
			<p class="normal--unindented">A common requirement is to compare a time period with the same time period in the previous year, quarter, or month. The last month/quarter/year could be incomplete; so in order to achieve a fair comparison, the comparison should consider an equivalent period. For these reasons, the calculations shown in this section use the <span class="charoverride3">Date[DateWithSales]</span> calculated column, as described in the article <a href="https://www.sqlbi.com/articles/hiding-future-dates-for-calculations-in-dax/"><span class="hyperlink">Hiding future dates for calculations in DAX</span></a>.</p>
			<p class="heading" id="calibre_link-89">Year-over-year growth</p>
			<p class="normal--unindented">Year-over-year compares a period to the equivalent period in the previous year. In this example, data is available until August 15, 2009. For this reason, <span class="charoverride3">Sales PY</span> shows numbers related to 2008 only considering transactions prior to August 15, 2008. Figure 2-5 shows that <span class="charoverride3">Sales Amount</span> of August 2008 is 721,560.95, whereas <span class="charoverride3">Sales PY</span> for August 2009 returns 296,529.51 because the measure only considers sales up to August 15, 2008.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-90">
					<img alt="" class="_idgenobjectattribute" src="images/000520.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-5</span>  For August 2009, <span class="charoverride3">Sales PY</span> shows the amount for August 1-15, 2008, because there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PY</span> uses DATEADD and filters <span class="charoverride3">Date[DateWithSales]</span> to guarantee a fair comparison of the last period with data. The year-over-year growth is computed as an amount in <span class="charoverride3">Sales YOY,</span> and as a percentage in <span class="charoverride3">Sales YOY %</span>. Both measures use <span class="charoverride3">Sales PY</span> to only consider dates up to August 15, 2009:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-91">
					<img alt="" class="_idgenobjectattribute" src="images/000526.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-92">
					<img alt="" class="_idgenobjectattribute" src="images/000540.png" />
				</div>
			</div>
			<p class="code-block-screened-head"> Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-93">
					<img alt="" class="_idgenobjectattribute" src="images/000555.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales PY</span> can also be written using SAMEPERIODLASTYEAR. SAMEPERIODLASTYEAR is easier to read, but it does not offer any performance benefit. This is because internally, it is translated into the DATEADD function used in previous formulas:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-94">
					<img alt="" class="_idgenobjectattribute" src="images/000569.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-95">Quarter-over-quarter growth</p>
			<p class="normal--unindented">Quarter-over-quarter compares a period with the equivalent period in the previous quarter. In this example, data is available until August 15, 2009, which is the first half of the third quarter of 2009. Therefore, <span class="charoverride3">Sales PQ</span> for August 2009 (the second month of the third quarter) shows sales until May 15, 2009, which is the first half of the second month of the previous quarter. Figure 2-6 shows that <span class="charoverride3">Sales Amount</span> of May 2009 is 1,067,165.23, whereas <span class="charoverride3">Sales PQ</span> for August 2009 returns 435,306.10, only taking into account sales made prior to May 15, 2009.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-96">
					<img alt="" class="_idgenobjectattribute" src="images/000534.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-6</span> For August 2009, <span class="charoverride3">Sales PQ shows</span> the amount for May 1-15, 2009; indeed, there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PQ</span> uses DATEADD and filters <span class="charoverride3">Date[DateWithSales]</span> to guarantee a fair comparison with the last period with data. The quarter-over-quarter growth is computed as an amount in <span class="charoverride3">Sales QOQ</span> and as a percentage in <span class="charoverride3">Sales QOQ %</span>. Both measures use <span class="charoverride3">Sales PQ</span> to guarantee the same fair comparison: </p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-97">
					<img alt="" class="_idgenobjectattribute" src="images/000583.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-98">
					<img alt="" class="_idgenobjectattribute" src="images/000000.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-99">
					<img alt="" class="_idgenobjectattribute" src="images/000012.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-100">Month-over-month growth</p>
			<p class="normal--unindented">Month-over-month compares a time period with its equivalent in the previous month. In this example, data is only available until August 15, 2009. For this reason, <span class="charoverride3">Sales PM</span> only considers sales between July 1-15, 2009 in order to return a value for August 2009. That way, it only returns the corresponding portion of the previous month. Figure 2-7 shows that <span class="charoverride3">Sales Amount</span> for July 2009 is 1,068,396.58, whereas <span class="charoverride3">Sales PM</span> of August 2019 returns 584,212.78, since it only takes into account sales prior to July 15, 2009.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-101">
					<img alt="" class="_idgenobjectattribute" src="images/000548.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-7</span>  For August 2009, <span class="charoverride3">Sales PM</span> shows the amount in the July 1-15, 2009 time period; indeed, there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PM</span> uses DATEADD and filters the <span class="charoverride3">Date[DateWithSales]</span> column to guarantee a fair comparison of the last period with data. The month-over-month growth is computed as an amount in <span class="charoverride3">Sales MOM</span> and as a percentage in <span class="charoverride3">Sales MOM %</span>. Both measures use <span class="charoverride3">Sales PM</span> to guarantee the same fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-102">
					<img alt="" class="_idgenobjectattribute" src="images/000026.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-103">
					<img alt="" class="_idgenobjectattribute" src="images/000040.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-104">
					<img alt="" class="_idgenobjectattribute" src="images/000054.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-105">Period-over-period growth</p>
			<p class="normal--unindented">Period-over-period growth automatically selects one of the measures previously described in this section based on the current selection of the visualization. For example, it returns the value of month-over-month growth measures if the visualization displays data at the month level, switching to year-over-year growth measures if the visualization shows the total at the year level. The expected result is visible in Figure 2-8.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-106">
					<img alt="" class="_idgenobjectattribute" src="images/000563.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-8</span> <span class="charoverride3">Sales PP</span> shows the value of the previous month at the month level, of the previous quarter at the quarter level, and of the previous year at the year level.</p>
			<p class="normal1">The three measures <span class="charoverride3">Sales PP</span>, <span class="charoverride3">Sales POP</span>, and <span class="charoverride3">Sales POP %</span> redirect the evaluation to the corresponding year, quarter, and month measures depending on the level selected in the report. The ISINSCOPE function detects the level used in the report. The arguments passed to ISINSCOPE are the attributes used in the rows of the Matrix visual in Figure 2-8. The measures are defined as follows:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-107">
					<img alt="" class="_idgenobjectattribute" src="images/000068.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-108">
					<img alt="" class="_idgenobjectattribute" src="images/000083.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-109">
					<img alt="" class="_idgenobjectattribute" src="images/000098.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-110">Computing period-to-date growth</p>
			<p class="normal--unindented">The growth of a “to-date” measure is the comparison of the “to-date” measure with the same measure over an equivalent period with a specific offset. For example, you can compare a year-to-date aggregation against the year-to-date in the previous year, that is with an offset of one year.</p>
			<p class="normal1">All the measures in this set of calculations take care of partial periods. Because data is available only until August 15, 2009 in our example, the measures make sure that data in the previous year does not consider dates after August 15, 2019.</p>
			<p class="heading" id="calibre_link-111">Year-over-year-to-date growth</p>
			<p class="normal--unindented">Year-over-year-to-date growth compares the year-to-date at a specific date with the year-to-date at an equivalent date in the previous year. Figure 2-9 shows that <span class="charoverride3">Sales PYTD</span> in 2009 is only considering transactions until August 15, 2008. For this reason, <span class="charoverride3">Sales YTD</span> of Q3-2008 is 7,129,971.53, whereas <span class="charoverride3">Sales PYTD</span> for Q3-2009 is less: 5,741,502.86.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-112">
					<img alt="" class="_idgenobjectattribute" src="images/000577.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-9</span>  For Q3-2009, <span class="charoverride3">Sales PYTD</span> shows the amount of January 1-August 15, 2008 because there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PYTD</span> uses DATEADD and filters the <span class="charoverride3">Date[DateWithSales]</span> column to guarantee a fair comparison of the last period with data. <span class="charoverride3">Sales YOYTD</span> and <span class="charoverride3">Sales YOYTD %</span> rely on <span class="charoverride3">Sales PYTD</span> to guarantee the same fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-113">
					<img alt="" class="_idgenobjectattribute" src="images/000113.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-114">
					<img alt="" class="_idgenobjectattribute" src="images/000127.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-115">
					<img alt="" class="_idgenobjectattribute" src="images/000140.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales PYTD</span> shifts the date filter back one year by using DATEADD. Using DATEADD makes it easy to apply shifts of two or more years. However, to shift dates back by one year <span class="charoverride3">Sales PYTD</span> can also be written using SAMEPERIODLASTYEAR as in the following example, which internally uses DATEADD as in the previous example:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-116">
					<img alt="" class="_idgenobjectattribute" src="images/000153.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-117">Quarter-over-quarter-to-date growth</p>
			<p class="normal--unindented">Quarter-over-quarter-to-date growth compares the quarter-to-date at a specific date with the quarter-to-date at an equivalent date in the previous quarter. Figure 2-10 shows that <span class="charoverride3">Sales PQ</span> in August 2009 is only considering transactions until May 15, 2008, to only get the first half of the previous quarter. For this reason <span class="charoverride3">Sales QTD</span> of May 2009 is 1,746,058.45, whereas <span class="charoverride3">Sales PQTD</span> for August 2009 is lower: 1,114,199.32.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-118">
					<img alt="" class="_idgenobjectattribute" src="images/000590.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-10</span> <span class="charoverride3">Sales PQTD</span> shows for Aug 2009 the amount of the period April 1-May 15, 2009, because there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PQTD</span> uses DATEADD and filters the <span class="charoverride3">Date[DateWithSales]</span> column to guarantee a fair comparison of the last period with data. <span class="charoverride3">Sales QOQTD</span> and <span class="charoverride3">Sales QOQTD %</span> rely on <span class="charoverride3">Sales PQTD</span> to guarantee the same fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-119">
					<img alt="" class="_idgenobjectattribute" src="images/000166.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-120">
					<img alt="" class="_idgenobjectattribute" src="images/000179.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-121">
					<img alt="" class="_idgenobjectattribute" src="images/000193.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-122">Month-over-month-to-date growth</p>
			<p class="normal--unindented">Month-over-month-to-date growth compares a month-to-date at a specific date with the month-to-date at an equivalent date in the previous month. Figure 2-11 shows that <span class="charoverride3">Sales PMTD</span> in August 2009 is only considering sales until July 15, 2009, to only get the corresponding portion of the previous month. For this reason <span class="charoverride3">Sales MTD</span> of July 2009 is 1,068,396.58, whereas <span class="charoverride3">Sales PMTD</span> for August 2009 is less: 584,212.78.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-123">
					<img alt="" class="_idgenobjectattribute" src="images/000006.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-11</span>  For Aug 2009, <span class="charoverride3">Sales PQTD</span> shows the amount of the period July 1-July 15, 2009, because there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PMTD</span> uses DATEADD and filters the <span class="charoverride3">Date[DateWithSales]</span> column to guarantee a fair comparison of the last period with data. <span class="charoverride3">Sales MOMTD</span> and <span class="charoverride3">Sales MOMTD %</span> rely on the <span class="charoverride3">Sales PMTD</span> measure to guarantee the same fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-124">
					<img alt="" class="_idgenobjectattribute" src="images/000207.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-125">
					<img alt="" class="_idgenobjectattribute" src="images/000219.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-126">
					<img alt="" class="_idgenobjectattribute" src="images/000232.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-127">Comparing period-to-date with previous full period</p>
			<p class="normal--unindented">Comparing a to-date aggregation with the previous full period is useful when you consider the previous period as a benchmark. Once the current year-to-date reaches 100% of the full previous year, this means we have reached the same performance as the previous full period, hopefully in fewer days.</p>
			<p class="heading" id="calibre_link-128">Year-to-date over the full previous year</p>
			<p class="normal--unindented">The year-to-date over the full previous year compares the year-to-date against the entire previous year. Figure 2-12 shows that in November 2008 <span class="charoverride3">Sales YTD</span> almost reaches <span class="charoverride3">Sales Amount</span> for the entire year 2007. <span class="charoverride3">Sales YTDOPY% </span>provides an immediate comparison of the year-to-date with the total of the previous year; it shows growth over the previous year when the percentage is positive, as is the case starting December 1, 2008.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-129">
					<img alt="" class="_idgenobjectattribute" src="images/000018.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-12</span> <span class="charoverride3">Sales YTDOPY %</span> shows a positive percentage from December 1, 2008, when the <span class="charoverride3">Sales YTD</span> starts to be greater than <span class="charoverride3">Sales Amount</span> for 2007.</p>
			<p class="normal--unindented">The year-to-date-over-previous-year growth is computed by the <span class="charoverride3">Sales YTDOPY</span> and <span class="charoverride3">Sales YTDOPY %</span> measures; these rely on the <span class="charoverride3">Sales YTD</span> measure to compute the year-to-date value, and on the <span class="charoverride3">Sales PYC</span> measure to get the sales amount of the entire previous year:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-130">
					<img alt="" class="_idgenobjectattribute" src="images/000245.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-131">
					<img alt="" class="_idgenobjectattribute" src="images/000260.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-132">
					<img alt="" class="_idgenobjectattribute" src="images/000274.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Sales PYC</span> measure can also be written using PREVIOUSYEAR, whose behavior is similar to PARALLELPERIOD (the difference is not relevant for this example):</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-133">
					<img alt="" class="_idgenobjectattribute" src="images/000289.png" />
				</div>
			</div>
			<p class="normal1">PREVIOUSYEAR is mandatory if the comparison uses the fiscal year because PREVIOUSYEAR accepts a second argument to specify the last day of the fiscal year. Look at the following report in Figure 2-13, which is slicing the measures by fiscal periods.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-134">
					<img alt="" class="_idgenobjectattribute" src="images/000032.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-13</span> <span class="charoverride3">Sales Fiscal YTDOPY %</span> compares <span class="charoverride3">Sales YTD</span> with the <span class="charoverride3">Sales Amount</span> of the previous fiscal year.</p>
			<p class="normal1">The measures used in the report are defined as follows. Please pay attention to the second argument of PREVIOUSYEAR in <span class="charoverride3">Sales Fiscal PYC</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-135">
					<img alt="" class="_idgenobjectattribute" src="images/000303.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-136">
					<img alt="" class="_idgenobjectattribute" src="images/000318.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-137">
					<img alt="" class="_idgenobjectattribute" src="images/000331.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-138">Quarter-to-date over full previous quarter</p>
			<p class="normal--unindented">The quarter-to-date over full previous quarter compares the quarter-to-date against the entire previous quarter. Figure 2-14 shows that <span class="charoverride3">Sales QTD</span> in May 2008 surpasses the total <span class="charoverride3">Sales Amount</span> for Q1-2008. <span class="charoverride3">Sales QTDOPQ%</span> provides an immediate comparison of the quarter-to-date with the total of the previous quarter; it shows growth over the previous quarter when the percentage is positive, as is the case starting in May 2008.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-139">
					<img alt="" class="_idgenobjectattribute" src="images/000046.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-14</span> <span class="charoverride3">Sales QTDOPQ %</span> shows a positive percentage from May 2008, when <span class="charoverride3">Sales QTD</span> starts to be greater than the <span class="charoverride3">Sales Amount</span> for Q1-2008.</p>
			<p class="normal1">The quarter-to-date-over-previous-quarter growth is computed with the <span class="charoverride3">Sales QTDOPQ</span> and <span class="charoverride3">Sales QTDOPQ %</span> measures; these rely on the <span class="charoverride3">Sales QTD</span> measure to compute the quarter-to-date value and on the <span class="charoverride3">Sales PQC</span> measure to get the sales amount of the entire previous quarter:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-140">
					<img alt="" class="_idgenobjectattribute" src="images/000346.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-141">
					<img alt="" class="_idgenobjectattribute" src="images/000361.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-142">
					<img alt="" class="_idgenobjectattribute" src="images/000376.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Sales PQC</span> measure can also be written using PREVIOUSQUARTER, as long as it is not used at the year level for more than one quarter:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-143">
					<img alt="" class="_idgenobjectattribute" src="images/000391.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-144">Month-to-date over full previous month</p>
			<p class="normal--unindented">The month-to-date over full previous month compares the month-to-date against the entire previous month. Figure 2-15 shows that <span class="charoverride3">Sales MTD</span> during April 2008 surpasses the total <span class="charoverride3">Sales Amount</span> for March 2008. The <span class="charoverride3">Sales MTDOPM%</span> provides an immediate comparison of the month-to-date with the total of the previous month; it shows growth over the previous month when the percentage is positive as is the case starting April 19, 2008.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-145">
					<img alt="" class="_idgenobjectattribute" src="images/000060.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-15</span> <span class="charoverride3">Sales MTDOPM %</span> shows a positive percentage from April 19, 2008, when <span class="charoverride3">Sales MTD</span> starts to be greater than the <span class="charoverride3">Sales Amount</span> for March 2008.</p>
			<p class="normal1">The month-to-date-over-previous-month growth is computed with the <span class="charoverride3">Sales MTDOPM %</span> and <span class="charoverride3">Sales MTDOPM</span> measures; these rely on the <span class="charoverride3">Sales MTD</span> measure to compute the month-to-date value and on the <span class="charoverride3">Sales PMC</span> measure to get the sales amount of the entire previous month:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-146">
					<img alt="" class="_idgenobjectattribute" src="images/000406.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-147">
					<img alt="" class="_idgenobjectattribute" src="images/000420.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-148">
					<img alt="" class="_idgenobjectattribute" src="images/000434.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Sales PMC</span> measure can also be written using PREVIOUSMONTH, as long as it is not used at the quarter or year level for more than one month:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-149">
					<img alt="" class="_idgenobjectattribute" src="images/000448.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-150">Using moving annual total calculations</p>
			<p class="normal--unindented">A common way to aggregate data over several months is by using the moving annual total instead of the year-to-date. The moving annual total includes the last 12 months of data. For example, the moving annual total for March 2008 includes data from April 2007 to March 2008. </p>
			<p class="heading" id="calibre_link-151">Moving annual total</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales MAT</span> measure computes the moving annual total, as shown in Figure 2-16.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-152">
					<img alt="" class="_idgenobjectattribute" src="images/000075.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-16</span> <span class="charoverride3">Sales MAT</span> in March 2008 aggregates <span class="charoverride3">Sales Amount</span> from April 2007 to March 2008.</p>
			<p class="normal1">The moving annual total uses DATESINPERIOD to select the previous year:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-153">
					<img alt="" class="_idgenobjectattribute" src="images/000462.png" />
				</div>
			</div>
			<p class="normal1">DATESINPERIOD returns the set of dates starting from the date passed in the second argument and applying an offset specified in the third and fourth arguments. For example, the <span class="charoverride3">Sales MAT</span> measure returns the dates included in the full year before the last date available in the filter context. The same result could have been obtained by specifying -12 and MONTH in the third and fourth arguments, respectively.</p>
			<p class="heading" id="calibre_link-154">Moving annual total growth</p>
			<p class="normal--unindented">The moving annual total growth is computed with the <span class="charoverride3">Sales PYMAT</span>, <span class="charoverride3">Sales MATG</span>, and <span class="charoverride3">Sales MATG %</span> measures, which rely on the <span class="charoverride3">Sales MAT</span> measure. The <span class="charoverride3">Sales MAT</span> measure provides a correct value one year after the first sale ever (when it collects one full year of data), and it is not protected in case the current time period is shorter than a full year. For example, the amount for the full year 2009 of <span class="charoverride3">Sales PYMAT</span> is 9,927,582.99, which corresponds to the <span class="charoverride3">Sales Amount</span> of 2008 as shown in Figure 2-17. When compared with sales in 2009, this produces a comparison of less than 8 months &ndash; data being only available until August 15, 2009 &ndash; with a full year 2008. Similarly, you can see that <span class="charoverride3">Sales MATG %</span> starts in 2008 with very high values and stabilizes after a year. The first values are due to the effect of having no sales in the previous year. This behavior is by design: the moving annual total is usually computed at the month or day granularity to show trends in a chart.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-155">
					<img alt="" class="_idgenobjectattribute" src="images/000090.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-17</span> <span class="charoverride3">Sales MATG %</span> shows the growth between <span class="charoverride3">Sales MAT</span> and <span class="charoverride3">Sales PYMAT</span> as a percentage.</p>
			<p class="normal1">The measures are defined as follows:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-156">
					<img alt="" class="_idgenobjectattribute" src="images/000476.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-157">
					<img alt="" class="_idgenobjectattribute" src="images/000489.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-158">
					<img alt="" class="_idgenobjectattribute" src="images/000502.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Sales PYMAT</span> measure can also be written using SAMEPERIODLASTYEAR as in the following example, which internally uses DATEADD as in the previous example:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-159">
					<img alt="" class="_idgenobjectattribute" src="images/000518.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-160">Moving averages</p>
			<p class="normal--unindented">The moving average is typically used to display trends in line charts. Figure 2-18 includes the moving average of <span class="charoverride3">Sales Amount</span> over 30 days (<span class="charoverride3">Sales AVG 30D</span>), three months (<span class="charoverride3">Sales AVG 3M</span>), and a year (<span class="charoverride3">Sales AVG 1Y</span>).</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-161">
					<img alt="" class="_idgenobjectattribute" src="images/000105.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-18</span> <span class="charoverride3"> Sales AVG 30D</span>, <span class="charoverride3">Sales AVG 3M</span>, and <span class="charoverride3">Sales AVG 1Y</span> show the moving average over 30 days, three months, and one year, respectively.</p>
			<p class="heading" id="calibre_link-162">Moving average 30 days</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 30D</span> measure computes the moving average over 30 days by iterating a list of the last 30 dates obtained by DATESINPERIOD:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-163">
					<img alt="" class="_idgenobjectattribute" src="images/000532.png" />
				</div>
			</div>
			<p class="normal1">This pattern is very flexible. But for a regular additive calculation, <span class="charoverride3">Result</span> can be implemented using a different and faster formula:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-164">
					<img alt="" class="_idgenobjectattribute" src="images/000546.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-165">Moving average 3 months</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 3M</span> measure computes the moving average over three months by iterating a list of the dates in the last three months obtained by DATESINPERIOD:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-166">
					<img alt="" class="_idgenobjectattribute" src="images/000561.png" />
				</div>
			</div>
			<p class="normal1">For simple additive measures, the pattern based on DIVIDE which is shown for the moving average over 30 days can also be used for the average over three months.</p>
			<p class="heading" id="calibre_link-167">Moving average 1 year</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 1Y</span> measure computes the moving average over one year by iterating a list of the dates in the last year obtained by DATESINPERIOD:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-168">
					<img alt="" class="_idgenobjectattribute" src="images/000575.png" />
				</div>
			</div>
			<p class="normal1">For simple additive measures, the same pattern based on DIVIDE, shown for the moving average over 30 days can also be used for the average over one year.</p>
			<p class="heading1" id="calibre_link-169">Filtering other date attributes</p>
			<p class="normal--unindented">Once you mark the Date table as a date table, DAX automatically removes any filter from the <span class="charoverride3">Date</span> table every time CALCULATE filters the date column of the <span class="charoverride3">Date</span> table. This behavior is by design. Its goal is to simplify the writing of time intelligence calculations. Indeed, if DAX did not remove the filters, it would be necessary to manually add a REMOVEFILTERS over the <span class="charoverride3">Date</span> table every time a DAX time intelligence function is used, resulting in a negative development experience.</p>
			<p class="normal1">The automatic removal of the filters from the <span class="charoverride3">Date</span> table might introduce issues for some particular reports. For example, if a report computes the year-to-date of sales by slicing the amount by day of the week, the result obtained by only using the time intelligence function DATESYTD is wrong. Figure 2-19 shows that the result of <span class="charoverride3">Sales YTD</span> for each day of the week is slightly smaller or equal to the row total, which is showing the value for all the days of the week.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-170">
					<img alt="" class="_idgenobjectattribute" src="images/000119.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-19</span> Slicing the measure <span class="charoverride3">Sales YTD</span> by day of the week produces an inaccurate result.</p>
			<p class="normal1">The reason for the inaccurate value is that DATESYTD applies a filter on the <span class="charoverride3">Date[Date]</span> column. Because <span class="charoverride3">Date</span> is marked as a date table, DAX automatically applies a <span class="charoverride3">REMOVEFILTERS( ‘Date’ )</span> modifier to the same CALCULATE where DATESYTD is used in a filter argument &ndash; thus removing the filter on the day of the week. Therefore, the number shown is the year-to-date regardless of any filter on the weekday. The day-of-week filter only affects the last day of the period specified on the rows of the report &ndash; year or quarter. The correct result, shown in Figure 2-20, requires a different approach.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-171">
					<img alt="" class="_idgenobjectattribute" src="images/000132.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-20</span> Slicing <span class="charoverride3">Sales YTD (day of week)</span> by day of the week produces the correct result.</p>
			<p class="normal1">There are two options to obtain the correct value: either reiterate the filter over the day of the week in the CALCULATE statement, or update the data model.</p>
			<p class="normal1">Restoring the filter over the day of the week requires adding <span class="charoverride3">VALUES ( Date[Day of Week] )</span> only if the columns are filtered, like in the following code:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-172">
					<img alt="" class="_idgenobjectattribute" src="images/000589.png" />
				</div>
			</div>
			<p class="normal1">This first solution works well, but it comes with a significant shortcoming: there are two different versions of the calculation depending on whether the <span class="charoverride3">Date[Day of Week]</span> column is filtered or not. On large models, this might have a noticeable impact on performance.</p>
			<p class="normal1">There is another solution to this scenario that requires updating the data model. Instead of using the <span class="charoverride3">Date</span> table to select the day of the week, we can store the day of the week in a separate table that filters <span class="charoverride3">Sales</span> without being related to <span class="charoverride3">Date.</span> This way, the automatic filter removal over <span class="charoverride3">Date</span> does not affect the existing filter over the day of the week. For example, the <span class="charoverride3">Day of Week</span> table can be created as a calculated table:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-173">
					<img alt="" class="_idgenobjectattribute" src="images/000004.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Day of week</span> table must have a relationship between <span class="charoverride3">Sales[Order Date]</span> and <span class="charoverride3">‘Day of week’[Date]</span>, meaning the model must look like the one in Figure 2-21.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-174">
					<img alt="" class="_idgenobjectattribute" src="images/000145.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 2-21</span> The new <span class="charoverride3">Day of Week</span> table is related to the same <span class="charoverride3">Order Date</span> column used by <span class="charoverride3">Date</span>.</p>
			<p class="normal1">Please note that we created the new <span class="charoverride3">Day of Week</span> table using all the dates in <span class="charoverride3">Date</span> to create the relationship with the existing <span class="charoverride3">Sales[Order Date]</span> column. It is possible to obtain the same behavior by creating a table with only seven values (Sunday through Saturday), but that choice requires an additional column in the <span class="charoverride3">Sales</span> table &ndash; thus consuming more memory for the data model.</p>
			<p class="normal1">Slicing by <span class="charoverride3">Day of Week</span> in the newly created table is compatible with any time intelligence calculation and respects any filter on the <span class="charoverride3">Day of Week</span> table; this is because the two filters (<span class="charoverride3">Date</span> and <span class="charoverride3">Day of the week</span>) belong to two different tables.</p>
			<p class="normal1">The additional table could consolidate any set of attributes required by specific business rules. We built an example with the day of the week, but you can use any other set of attributes (like working days, holidays, seasons), provided that such attributes depend on <span class="charoverride3">Order Date</span>.</p>
		</div>
	</div>


<div id="calibre_link-6" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-175">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture2" id="calibre_link-176">
					<img alt="" class="_idgenobjectattribute" src="images/000231.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 3</p>
			<p class="ch-title--no-toc" id="calibre_link-177"><a id="calibre_link-19" class="calibre2"></a>Month-related calculations</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-202"><span class="hyperlink1">https://sql.bi/dax-202</span></a></p>
			<p class="normal--unindented">This pattern describes how to compute month-related calculations such as year-to-date, same period last year, and percentage growth using a month granularity. This pattern does not rely on DAX built-in time intelligence functions.</p>
			<p class="normal1">You can use the Month-related calculations pattern if the analysis over sales is executed at the month level (or above) only. In other words, the formulas stop working if you drill down to the date level. Because the pattern does not use real dates to link to sales, you can also implement fiscal calendars with 13 months and any non-standard time-related calculation &ndash; provided that the maximum level of detail of the reports is the month and not weeks or days. The report cannot filter or group by week, day of week, or working days; despite the fact that the granularity of the <span class="charoverride3">Date</span> table can be at the date level, these columns must not be part of the <span class="charoverride3">Date</span> table because they are not compatible with the formulas in this pattern.</p>
			<p class="normal1">The Month-related calculations pattern is useful to create simple formulas and optimal performance in all those cases where the day granularity is not required. Moreover, this is the only pattern that allows the creation of additional months, like a 13<span class="charoverride6">th</span> virtual month for a fiscal year that contains year-end adjustments in accounting systems. If you manage time-related calculations over time periods based on months and you need the day granularity, consider using the <a href="#calibre_link-7"><span class="hyperlink1">Custom time-related calculations</span></a> pattern. If you manage time-related calculations over time periods based on weeks, consider using the <a href="#calibre_link-8"><span class="hyperlink1">Week-related calculations</span></a> pattern.</p>
			<p class="heading1" id="calibre_link-178">Introduction to month-related time intelligence calculations</p>
			<p class="normal--unindented">The time intelligence calculations in this pattern modify the filter context over the <span class="charoverride3">Date</span> table to obtain the result. The formulas are designed to apply filters at the month granularity to improve query performance, regardless of the cardinality of the <span class="charoverride3">Date</span> table. For example, many calculations modify the filter context at the month level instead of the individual dates. This technique reduces the cost of computing the new filter and applying it to the filter context. This optimization is especially useful when using DirectQuery, even though it also improves performance on models imported in memory.</p>
			<p class="normal1">The pattern does not rely on the standard time intelligence functions; therefore, the <span class="charoverride3">Date</span> table does not have the requirements needed for standard DAX time intelligence functions. The formulas are identical whether you have one row for each month or one row for each day.</p>
			<p class="normal1">If the <span class="charoverride3">Date</span> table has a <span class="charoverride3">Date</span> column, the Mark as Date Table setting is allowed but not required. The formulas in this pattern do not rely on the automatic REMOVEFILTERS applied over the <span class="charoverride3">Date</span> table when the <span class="charoverride3">Date</span> column is filtered. Instead, all the formulas use a specific REMOVEFILTERS over the <span class="charoverride3">Date</span> table to get rid of the existing filters, in turn replacing them with the minimal number of filters that guarantee the desired result.</p>
			<p class="heading" id="calibre_link-179">Building a <span class="charoverride5">Date</span> table</p>
			<p class="normal--unindented">The <span class="charoverride3">Date</span> table used for month-related calculations can be built in many ways. The requirement for the pattern is to expose columns related to the months and any aggregation over months, such as quarters and years. The months could be different from those defined in the standard Gregorian calendar, as is the case when a 13<span class="charoverride6">th</span> month is required. The sample files available for this pattern include four different scenarios for the <span class="charoverride3">Date</span> table:</p>
			<ol class="calibre3">
				<li class="list-paragraph" value="1">One row for each date based on the Gregorian calendar, using <span class="charoverride3">Date</span> as the primary key. In this case, the behavior is close to the standard time intelligence calculations, with the noticeable difference that the formulas are faster.</li>
				<li class="list-paragraph">One row for each month based on the Gregorian calendar, using <span class="charoverride3">Year Month Number</span> as the primary key. This pattern is even better than the previous one, because the date table is significantly smaller.</li>
				<li class="list-paragraph">One row for each month in an accounting calendar with 13 fiscal months, where the 13<span class="charoverride6">th</span> fiscal month is projected as an additional month in the Gregorian calendar between the last month of a fiscal year and the first month of the following fiscal year. Performance is close to that of the second pattern.</li>
				<li class="list-paragraph">One row for each month in an accounting calendar with 13 fiscal months, where the 13<span class="charoverride6">th</span> fiscal month is projected in the last fiscal month on the Gregorian calendar. Performance and behavior are very close to what is observed in the third example.</li>
			</ol>
			<p class="normal1">In case there is one row for each month in the <span class="charoverride3">Date</span> table, you should not use a date to link the <span class="charoverride3">Sales</span> and <span class="charoverride3">Date</span> tables &ndash; unless you use specific dates to identify each month. For example, December 1 for December and December 31 for the 13<span class="charoverride6">th</span> month of the year.</p>
			<p class="normal1">The <span class="charoverride3">Date</span> table in this pattern must have all the months included in the range between the first and the last date referenced in the <span class="charoverride3">Sales</span> table. Therefore, if the last sale was processed in August 2009, the last month in the Date table must be August 2009. This requirement is different from the requirement of the standard time-intelligence functions in DAX, where all the months of a year must be present in the <span class="charoverride3">Date</span> table to guarantee the correct behavior.</p>
			<p class="normal1">If you already have a <span class="charoverride3">Date</span> table, you can import the table and use it by showing only the columns required for this pattern while hiding columns with a day or week granularity. If a <span class="charoverride3">Date</span> table is not available, you can create one using a DAX calculated table. As an example, the following DAX expression defines the <span class="charoverride3">Date</span> table used in the first three scenarios described earlier:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-180">
					<img alt="" class="_idgenobjectattribute" src="images/000016.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-181">
					<img alt="" class="_idgenobjectattribute" src="images/000030.png" />
				</div>
			</div>
			<p class="normal1">You can customize the first two variables to build a <span class="charoverride3">Date</span> table that meets specific business requirements. The <span class="charoverride3">FirstFiscalMonth</span> variable defines the first fiscal month in the year, and the <span class="charoverride3">MonthsInYear</span> variable defines the number of months for each fiscal year. The other customization is the first argument of GENERATE, which can be:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride3">GranularityByMonth</span> to generate one row for each month;</li>
				<li class="bull-list"><span class="charoverride3">GranularityByDate</span> to generate one row for each date.</li>
			</ul>
			<p class="normal1">The <span class="charoverride3">GranularityByDate</span> argument is used in the first scenario (one row for every date), whereas <span class="charoverride3">GranularityByMonth</span> is used in the other three scenarios (one row for every month). The <span class="charoverride3">Year Month</span> column has one value for each month; the month description is the same for both the fiscal and Gregorian calendar hierarchies. The fourth scenario includes a few additional columns to get a different value between <span class="charoverride3">Month</span> and <span class="charoverride3">Fiscal Month</span>. This is required to manage the 13<span class="charoverride6">th</span> month differently, depending on the hierarchy.</p>
			<p class="normal1">In order to obtain the correct visualization, the <span class="charoverride2">calendar columns</span> must be configured in the data model as follows. For each column we show the data type followed by a sample value assuming a fiscal month starting in March where there are 12 months in the fiscal year: </p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride3">Date</span>: Date, Hidden (8/14/2007), used only for the first scenario</li>
				<li class="bull-list"><span class="charoverride3">Year Month Key</span>: Whole Number, Hidden (200708), used to define relationships</li>
				<li class="bull-list"><span class="charoverride3">Year Month</span>: Text (Aug 2007)</li>
				<li class="bull-list"><span class="charoverride3">Year Quarter</span>: Text (Q3-2007)</li>
				<li class="bull-list"><span class="charoverride3">Year Quarter Number</span>: Whole Number, Hidden (8030)</li>
				<li class="bull-list"><span class="charoverride3">Quarter</span>: Text (Q3)</li>
				<li class="bull-list"><span class="charoverride3">Year Month Number</span>: Whole Number, Hidden (24091)</li>
				<li class="bull-list"><span class="charoverride3">Month</span>: Text (Aug)</li>
				<li class="bull-list"><span class="charoverride3">Month Number</span>: Whole Number, Hidden (8)</li>
				<li class="bull-list"><span class="charoverride3">Month In Quarter Number</span>: Whole Number, Hidden (2)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Month</span>: Text (Aug)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Month Number</span>: Whole Number, Hidden (6)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Month in Quarter Number</span>: Whole Number, Hidden (3)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year</span>: Text (FY 2008)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Number</span>: Whole Number, Hidden (2008)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Quarter</span>: Text (FQ2-2008)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Quarter</span> Number: Whole Number, Hidden (8033) </li>
				<li class="bull-list"><span class="charoverride3">Fiscal Quarter</span>: Text (FQ2)</li>
			</ul>
			<p class="normal1">The <span class="charoverride3">Date</span> table in this pattern has four hierarchies:</p>
			<ul class="calibre1">
				<li class="bull-list">Fiscal Year-Quarter: Year (<span class="charoverride3">Fiscal Year</span>), Quarter (<span class="charoverride3">Fiscal Year Quarter</span>), Month (<span class="charoverride3">Year Month</span>)</li>
				<li class="bull-list">Fiscal Year-Month: Year (<span class="charoverride3">Fiscal Year</span>), Month (<span class="charoverride3">Year Month</span>)</li>
				<li class="bull-list">Year-Quarter: Year (<span class="charoverride3">Year</span>), Quarter (<span class="charoverride3">Year Quarter</span>), Month (<span class="charoverride3">Year Month</span>)</li>
				<li class="bull-list">Year-Month: Year (<span class="charoverride3">Year</span>), Month (<span class="charoverride3">Year Month</span>)</li>
			</ul>
			<p class="normal1">Several columns serve the only purpose of simplifying the formulas used in custom time-related calculations. The <span class="charoverride3">Year Month Key</span> column is only used to define a relationship with the <span class="charoverride3">Sales</span> table using an integer in the format <span class="charoverride3">YYYYMM</span>. This numeric format to identify a month is common in many data sources that manage data at the month granularity.</p>
			<p class="normal1">The <span class="charoverride3">Date</span> table has only the range of months required by the data available. For example, in the example the <span class="charoverride3">Date</span> table includes only the months from March 2007 to August 2009. This pattern does not come with the constraint of including all the months in one year. For this reason, there is no need for additional calculated columns like the <span class="charoverride3">DateWithSales</span> used in the <a href="#calibre_link-9"><span class="hyperlink1">Standard time-related calculations</span></a> pattern.</p>
			<p class="heading" id="calibre_link-182">Naming convention</p>
			<p class="normal--unindented">This section describes the naming convention we adopted to reference the time intelligence calculations. A simple categorization shows whether a calculation:</p>
			<ul class="calibre1">
				<li class="bull-list">shifts over a period of time, for example the same period in the previous year;</li>
				<li class="bull-list">performs an aggregation, for example year-to-date; or</li>
				<li class="bull-list">compares two time periods, for example this year compared to last year.</li>
			</ul>
			<div class="_idgenobjectlayout">
				<div class="table-screenshot" id="calibre_link-183">
					<img alt="" class="_idgenobjectattribute" src="images/000405.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-184">Computing period-to-date totals</p>
			<p class="normal--unindented">The year-to-date, quarter-to-date, and month-to-date calculations modify the filter context for the <span class="charoverride3">Date</span> table, so to include the dates from the beginning of the period to the currently selected month.</p>
			<p class="heading" id="calibre_link-185">Year-to-date total</p>
			<p class="normal--unindented">The year-to-date aggregates data starting from the first day of the year, as shown in Figure 3-1. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-186">
					<img alt="" class="_idgenobjectattribute" src="images/000257.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-1</span> <span class="charoverride3">Sales YTD </span>shows the aggregated value from the beginning of the year, whereas <span class="charoverride3">Sales Fiscal YTD</span> aggregates the value starting from the beginning of the fiscal year.</p>
			<p class="normal1">The year-to-date total of a measure filters all the months that are in the year of the last date available in the filter context, and whose month is less than or equal to the month of that date:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-187">
					<img alt="" class="_idgenobjectattribute" src="images/000044.png" />
				</div>
			</div>
			<p class="normal1">If the report uses a hierarchy based on the fiscal year, then the measure must filter the corresponding columns with the word “Fiscal” before the acronym identifying the time intelligence calculation. For example, the <span class="charoverride3">Sales Fiscal YTD</span> measure uses <span class="charoverride3">Fiscal Year Number</span> instead of <span class="charoverride3">Year</span>; however, it does not change the filter over <span class="charoverride3">Year Month Number</span> because that column is identical for both fiscal and calendar hierarchies:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-188">
					<img alt="" class="_idgenobjectattribute" src="images/000058.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-189">Quarter-to-date total</p>
			<p class="normal--unindented">The quarter to date aggregates data from the first month of the fiscal quarter, as shown in Figure 3-2. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-190">
					<img alt="" class="_idgenobjectattribute" src="images/000285.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-2</span> <span class="charoverride3">Sales QTD</span> shows the quarter-to-date amount, which is the value of the last quarter available at the year level.</p>
			<p class="normal1">The quarter-to-date total of a measure is computed with the technique used for the year-to-date total. The only difference is that the filter is now on <span class="charoverride3">Year Quarter Number</span> instead of <span class="charoverride3">Year</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-191">
					<img alt="" class="_idgenobjectattribute" src="images/000073.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-192">Computing period-over-period growth</p>
			<p class="normal--unindented">A common requirement is to compare a time period with the same time period in the previous year, quarter, or month. In order to achieve a fair comparison, the measure takes into account the same relative months in the previous year, or the same relative months in the previous quarter.</p>
			<p class="heading" id="calibre_link-193">Year-over-year growth</p>
			<p class="normal--unindented">Year-over-year compares a time period to its equivalent in the previous year. In this example, data is available until August 2009. For this reason, <span class="charoverride3">Sales PY</span> shows numbers related to the year 2009 considering transactions only from before August 2008. Figure 3-3 shows that the <span class="charoverride3">Sales Amount</span> of 2008 is 9,927,582.99, whereas <span class="charoverride3">Sales PY</span> for 2009 returns 6,166,534.30 because the measure involves sales only up to August 2008.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-194">
					<img alt="" class="_idgenobjectattribute" src="images/000314.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-3</span> For the year 2009, <span class="charoverride3">Sales PY</span> shows the amount from January to August 2008, because there is no data after August 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PY</span> removes all the filters from the <span class="charoverride3">Date</span> table; it filters the <span class="charoverride3">Year</span> column by using the previous year, and by using <span class="charoverride3">VALUES</span> it retrieves the months visible in the current filter context to then filter the <span class="charoverride3">Month Number</span> column. The <span class="charoverride3">Date</span> table must hold only the months with sales, instead of holding all the months of the year as required by the standard time intelligence functions in DAX. This way, any direct or indirect selection of months is applied to the previous year:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-195">
					<img alt="" class="_idgenobjectattribute" src="images/000087.png" />
				</div>
			</div>
			<p class="normal1">Year-over-year growth is computed as an amount in <span class="charoverride3">Sales YOY,</span> and as a percentage in <span class="charoverride3">Sales YOY %</span>. Both measures use <span class="charoverride3">Sales PY</span> to take into account dates only up to August 2009:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-196">
					<img alt="" class="_idgenobjectattribute" src="images/000540.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-197">
					<img alt="" class="_idgenobjectattribute" src="images/000555.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-198">Quarter-over-quarter growth</p>
			<p class="normal--unindented">Quarter-over-quarter compares a time period to its equivalent in the previous quarter. In this example, data is available until August 2009. For this reason, <span class="charoverride3">Sales PQ</span> shows numbers related to Q3-2009 considering only transactions before the second month of Q2-2009. Figure 3-4 shows that the <span class="charoverride3">Sales Amount</span> of Q2-2009 is 2,618,644.64, whereas <span class="charoverride3">Sales PY</span> for Q3-2009 returns 1,746,058.45. This is because the measure takes into account the sales of only the first two months of Q2-2009.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-199">
					<img alt="" class="_idgenobjectattribute" src="images/000342.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-4</span> For Q3-2009, <span class="charoverride3">Sales PQ shows</span> the sum of Apr 2009 and May 2009, because there are only two months in Q3-2009 to be compared to Q2-2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PQ</span> removes all the filters from the <span class="charoverride3">Date</span> table; it filters the <span class="charoverride3">Year Quarter Number</span> column using the previous quarter, and with VALUES which retrieves the months visible in the filter context it filters the <span class="charoverride3">Month In Quarter Number</span> column. This way, any direct or indirect selection of months is applied to the previous quarter:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-200">
					<img alt="" class="_idgenobjectattribute" src="images/000102.png" />
				</div>
			</div>
			<p class="normal1">Quarter-over-quarter growth is computed as an amount in <span class="charoverride3">Sales QOQ</span> and as a percentage in <span class="charoverride3">Sales QOQ %</span>. Both measures use <span class="charoverride3">Sales PQ</span> to guarantee a fair comparison: </p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-201">
					<img alt="" class="_idgenobjectattribute" src="images/000117.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-202">
					<img alt="" class="_idgenobjectattribute" src="images/000012.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-203">Month-over-month growth</p>
			<p class="normal--unindented">Month-over-month compares a time period to its equivalent in the previous month. Figure 3-5 shows that <span class="charoverride3">Sales PM</span> always corresponds to the <span class="charoverride3">Sales Amount</span> of the previous month and does not produce any result at the quarter and at the year levels (only the year level is visible in Figure 3-5).</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-204">
					<img alt="" class="_idgenobjectattribute" src="images/000373.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-5</span> <span class="charoverride3">Sales PM</span> always corresponds to the <span class="charoverride3">Sales Amount</span> of the previous month.</p>
			<p class="normal1"><span class="charoverride3">Sales PM</span> removes all the filters from the <span class="charoverride3">Date</span> table and only filters the <span class="charoverride3">Year Month Number</span> column using the previous month:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-205">
					<img alt="" class="_idgenobjectattribute" src="images/000130.png" />
				</div>
			</div>
			<p class="normal1">The month-over-month growth is computed as an amount in <span class="charoverride3">Sales MOM</span> and as a percentage in <span class="charoverride3">Sales MOM %</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-206">
					<img alt="" class="_idgenobjectattribute" src="images/000143.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-207">
					<img alt="" class="_idgenobjectattribute" src="images/000054.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-208">Period-over-period growth</p>
			<p class="normal--unindented">Period-over-period growth automatically selects one of the measures previously described in this section based on the current selection in the visualization. For example, it returns the value of month-over-month growth measures if the visualization displays data at the month level, but switches to year-over-year growth measures if the visualization shows the total at the year level. The result you would expect is visible in Figure 3-6.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-209">
					<img alt="" class="_idgenobjectattribute" src="images/000403.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-6</span> <span class="charoverride3">Sales PP</span> shows the value of the previous month at the month level, of the previous quarter at the quarter level, and of the previous year at the year level.</p>
			<p class="normal1">The three measures <span class="charoverride3">Sales PP</span>, <span class="charoverride3">Sales POP</span>, and <span class="charoverride3">Sales POP %</span> redirect the evaluation to the corresponding year, quarter, and month measures depending on the level selected in the report. The ISINSCOPE function detects the level used in the report. The arguments passed to ISINSCOPE are the attributes used in the rows of the Matrix visual from Figure 3-6. The measures are defined as follows:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-210">
					<img alt="" class="_idgenobjectattribute" src="images/000068.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-211">
					<img alt="" class="_idgenobjectattribute" src="images/000083.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-212">
					<img alt="" class="_idgenobjectattribute" src="images/000098.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-213">Computing period-to-date growth</p>
			<p class="normal--unindented">The growth of a “to-date” measure is the comparison of said “to-date” measure with the same measure over an equivalent time period with a specific offset. For example, you can compare a year-to-date aggregation against the year-to-date in the previous year, that is with an offset of one year.</p>
			<p class="normal1">All the measures in this set of calculations take care of partial periods. Because data is available only until August 2009 in our example, the measures make sure the previous year does not report dates after August 2008.</p>
			<p class="heading" id="calibre_link-214">Year-over-year-to-date growth</p>
			<p class="normal--unindented">Year-over-year-to-date growth compares the year-to-date at a specific date with the year-to-date in an equivalent month in the previous year. Figure 3-7 shows that <span class="charoverride3">Sales PYTD</span> in 2009 is taking into account transactions only until August 2008. For this reason, <span class="charoverride3">Sales YTD</span> of Q3-2008 is 7,129,971.53, whereas <span class="charoverride3">Sales PYTD</span> for Q3-2009 is less: 6,166,534.30.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-215">
					<img alt="" class="_idgenobjectattribute" src="images/000431.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-7</span>  For Q3-2009, <span class="charoverride3">Sales PYTD</span> shows the amount of July-August 2008 because there is no data after August 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PYTD</span> filters the previous value in <span class="charoverride3">Year </span>and all the months in the year less than or equal to the last month visible in the filter context:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-216">
					<img alt="" class="_idgenobjectattribute" src="images/000156.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales YOYTD</span> and <span class="charoverride3">Sales YOYTD %</span> rely on <span class="charoverride3">Sales PYTD</span> to provide their result:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-217">
					<img alt="" class="_idgenobjectattribute" src="images/000169.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-218">
					<img alt="" class="_idgenobjectattribute" src="images/000140.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-219">Quarter-over-quarter-to-date growth</p>
			<p class="normal--unindented">Quarter-over-quarter-to-date growth compares the quarter-to-date at a specific date with the quarter-to-date at an equivalent month in the previous quarter. Figure 3-8 shows that <span class="charoverride3">Sales PQTD</span> in 2009 is taking into account transactions only until May 2009, which is the second month in the quarter. For this reason, <span class="charoverride3">Sales QTD</span> of Q2-2009 is 2,618,644.64, whereas <span class="charoverride3">Sales PQTD</span> for Q3-2009 is less: 1,746,058.45.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-220">
					<img alt="" class="_idgenobjectattribute" src="images/000445.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-8</span> <span class="charoverride3">Sales PQTD</span> shows for Q3-2009 the amount of the period April-May 2009, because there is no data after August 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PQTD</span> filters the previous value in <span class="charoverride3">Year Quarter Number, </span>and through <span class="charoverride3">Month In Quarter Number</span> filters all the months in the quarter less than or equal to the last relative month of the quarter visible in the filter context:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-221">
					<img alt="" class="_idgenobjectattribute" src="images/000183.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales QOQTD</span> and <span class="charoverride3">Sales QOQTD %</span> rely on <span class="charoverride3">Sales PQTD</span> to guarantee a fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-222">
					<img alt="" class="_idgenobjectattribute" src="images/000196.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-223">
					<img alt="" class="_idgenobjectattribute" src="images/000193.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-224">Comparing period-to-date with a previous full period</p>
			<p class="normal--unindented">Comparing a to-date aggregation with the previous full period is useful when you consider the previous period as a benchmark. Once the current year-to-date reaches 100% of the full previous year, this means we have reached the performance of the previous full period &ndash; hopefully in fewer days.</p>
			<p class="heading" id="calibre_link-225">Year-to-date over the full previous year</p>
			<p class="normal--unindented">As the name indicates, the year-to-date over the full previous year compares the year-to-date against the entire previous year. Figure 3-9 shows that in November 2008 (which is close to the end of the year 2008) <span class="charoverride3">Sales YTD</span> almost reached the value of <span class="charoverride3">Sales Amount</span> for the entire year 2007. <span class="charoverride3">Sales YTDOPY % </span>provides an immediate comparison of the year-to-date with the total of the previous year; it shows growth over the previous year when the percentage is positive, which is the case in December 2008.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-226">
					<img alt="" class="_idgenobjectattribute" src="images/000473.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-9</span> <span class="charoverride3">Sales YTDOPY %</span> shows a negative value corresponding to the missing percentage of <span class="charoverride3">Sales YTD</span> to reach the total <span class="charoverride3">Sales Amount</span> of the previous year.</p>
			<p class="normal1">The year-to-date-over-previous-year growth is computed by using the <span class="charoverride3">Sales YTDOPY</span> and <span class="charoverride3">Sales YTDOPY %</span> measures; these in turn rely on the <span class="charoverride3">Sales YTD</span> measure to compute the year-to-date value, and on the <span class="charoverride3">Sales PYC</span> measure to get the sales amount of the entire previous year:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-227">
					<img alt="" class="_idgenobjectattribute" src="images/000209.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-228">
					<img alt="" class="_idgenobjectattribute" src="images/000222.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-229">
					<img alt="" class="_idgenobjectattribute" src="images/000274.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-230">Quarter-to-date over full previous quarter</p>
			<p class="normal--unindented">As the name indicates, the quarter-to-date over the full previous quarter compares the quarter-to-date against the entire previous quarter. Figure 3-10 shows that in May 2009, <span class="charoverride3">Sales QTD</span> exceeded the value of <span class="charoverride3">Sales Amount</span> for the entire previous quarter (Q1-2009). <span class="charoverride3">Sales QTDOPQ% </span>provides an immediate comparison of the quarter-to-date with the total of the previous quarter; it shows growth over the previous quarter when the percentage is positive, which is the case in May and June 2009.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-231">
					<img alt="" class="_idgenobjectattribute" src="images/000500.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-10</span> <span class="charoverride3">Sales QTDOPQ %</span> shows a positive percentage in May 2009 and June 2009, when <span class="charoverride3">Sales QTD</span> starts to be greater than the <span class="charoverride3">Sales Amount</span> for Q1-2009.</p>
			<p class="normal1">The quarter-to-date-over-previous-quarter growth is computed by using the <span class="charoverride3">Sales QTDOPQ</span> and <span class="charoverride3">Sales QTDOPQ %</span> measures; these in turn rely on the <span class="charoverride3">Sales QTD</span> measure to compute the quarter-to-date value and on the <span class="charoverride3">Sales PQC</span> measure to get the sales amount of the entire previous quarter:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-232">
					<img alt="" class="_idgenobjectattribute" src="images/000235.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-233">
					<img alt="" class="_idgenobjectattribute" src="images/000361.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-234">
					<img alt="" class="_idgenobjectattribute" src="images/000376.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-235">Using moving annual total calculations</p>
			<p class="normal--unindented">A common way to aggregate data over several months is by using the moving annual total instead of the year-to-date. The moving annual total includes the last 12 months of data. For example, the moving annual total for March 2009 includes data from April 2008 to March 2009. </p>
			<p class="heading" id="calibre_link-236">Moving annual total</p>
			<p class="normal--unindented"><span class="charoverride3">Sales MAT</span> computes the moving annual total, as shown in Figure 3-11.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-237">
					<img alt="" class="_idgenobjectattribute" src="images/000530.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-11</span> <span class="charoverride3">Sales MAT</span> in March 2009 aggregates <span class="charoverride3">Sales Amount</span> from April 2008 to March 2009.</p>
			<p class="normal1">The <span class="charoverride3">Sales MAT </span>measure defines a range over the <span class="charoverride3">Year Month Number</span> column that includes the months of one complete year from the last month in the filter context:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-238">
					<img alt="" class="_idgenobjectattribute" src="images/000248.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-239">Moving annual total growth</p>
			<p class="normal--unindented">The moving annual total growth is computed by using the <span class="charoverride3">Sales PYMAT</span>, <span class="charoverride3">Sales MATG</span>, and <span class="charoverride3">Sales MATG %</span> measures, which in turn rely on the <span class="charoverride3">Sales MAT</span> measure. The <span class="charoverride3">Sales MAT</span> measure starts to provide accurate values one year after the first sale ever &ndash; once it has been able to collect one full year of data &ndash; and it is not protected in case the current time period is shorter than a full year.</p>
			<p class="normal1">For example, the amount for the year 2009 of <span class="charoverride3">Sales PYMAT</span> is 9,927,582.99, which corresponds to the <span class="charoverride3">Sales Amount</span> of the entire year 2008 as shown in Figure 3-11 (see previous section). When compared with sales in 2009, this produces a comparison of 8 months &ndash; data being only available until August 2009 &ndash; with the whole year 2008. Similarly, you can see that <span class="charoverride3">Sales MATG %</span> starts in March 2008 with very high values and stabilizes after a year. This behavior is by design: the moving annual total is usually computed at the month granularity to show trends in a chart.</p>
			<p class="normal1">The measures are defined as follows:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-240">
					<img alt="" class="_idgenobjectattribute" src="images/000263.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-241">
					<img alt="" class="_idgenobjectattribute" src="images/000277.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-242">
					<img alt="" class="_idgenobjectattribute" src="images/000292.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-243">Moving averages</p>
			<p class="normal--unindented">The moving average is typically used to display trends in line charts. Figure 3-12 includes the moving average of three months (<span class="charoverride3">Sales AVG 3M</span>) and a year (<span class="charoverride3">Sales AVG 1Y</span>).</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-244">
					<img alt="" class="_idgenobjectattribute" src="images/000559.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-12</span> <span class="charoverride3">Sales AVG 3M</span> and <span class="charoverride3">Sales AVG 1Y</span> show the moving average over three months and one year, respectively.</p>
			<p class="heading" id="calibre_link-245">Moving average 3 months</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 3M</span> measure computes the moving average over three months by iterating the last three months obtained in the <span class="charoverride3">Period3M</span> variable:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-246">
					<img alt="" class="_idgenobjectattribute" src="images/000306.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-247">Moving average 1 year</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 1Y</span> measure computes the moving average over one year by iterating the last 12 months stored in the <span class="charoverride3">Period1Y </span>variable:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-248">
					<img alt="" class="_idgenobjectattribute" src="images/000321.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-249">Managing years with more than 12 months</p>
			<p class="normal--unindented">As we stated in the introduction, this pattern works even in scenarios where one year contains more than 12 months. For example, accounting oftentimes requires a 13<span class="charoverride6">th</span> month containing the year-end adjustments. In these scenarios, it is important to set the values in the <span class="charoverride3">Date</span> table correctly. Specifically,  the <span class="charoverride3">Year Month Number</span> column must store a sequential number for each month of the year; therefore, the same month in the previous year can be obtained by just subtracting 13 from the value of the current month if the year contains 13 months.</p>
			<p class="normal1">Moreover, you need to pay attention to the content of the <span class="charoverride3">Month</span> and <span class="charoverride3">Year Month</span> columns<span class="charoverride3">.</span> Indeed, these columns must contain a proper name for the 13<span class="charoverride6">th</span> month, and that choice depends on how you plan to show the month in both the fiscal and Gregorian calendars. </p>
			<p class="normal1">If the report shows only the fiscal year, you can choose any name and you will always show 13 months. If you need to show both fiscal and Gregorian calendar hierarchies, then you should decide between the following options: you can show the 13<span class="charoverride6">th</span> month as a separate month in the Gregorian calendar; or you can decide to merge it under the corresponding Gregorian month, which means you are still showing 12 months when displaying the Gregorian calendar. </p>
			<p class="normal1">For example, Figure 3-13 shows the 13<span class="charoverride6">th</span> month named “M13”. Its position is right after June, because the fiscal calendar ends in June. The month is visible both in the fiscal and in the Gregorian calendars.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-250">
					<img alt="" class="_idgenobjectattribute" src="images/000587.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-13</span> 13 fiscal months and 13 calendar months.</p>
			<p class="normal1">Figure 3-14 shows the result of a different choice, where the 13<span class="charoverride6">th</span> month is visible only in the fiscal calendar. When the report is being browsed by the Gregorian calendar, the value of the 13<span class="charoverride6">th</span> month is merged with that of June. Therefore, the Gregorian calendar is still showing 12 months.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-251">
					<img alt="" class="_idgenobjectattribute" src="images/000567.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 3-14</span> 13 fiscal months and 12 calendar months.</p>
			<p class="normal1">If you want to merge June with the 13<span class="charoverride6">th</span> month as shown on the left side of Figure 3-14, then you must assign the proper values to the columns in the <span class="charoverride3">Date</span> table; it is then no longer possible to share the same columns for both fiscal and Gregorian calendars. The columns for the fiscal calendar must differentiate between the 12<span class="charoverride6">th</span> and 13<span class="charoverride6">th</span> months, whereas the columns for the Gregorian calendar will share the values for the month name and number. Therefore, the <span class="charoverride3">Date</span> table still contains 13 months, but two of them share the same values in the Gregorian set of columns. By doing so, the report merges rows with the same value in the months columns and the user obtains the desired result.</p>
			<p class="normal1">You can find the set of values for the figures shown in this section in the demo files <span class="charoverride3">”Month-related calculations - 13 Fiscal and 13 Calendar Months.pbix”</span> and <span class="charoverride3">”Month-related calculations - 13 Fiscal and 12 Calendar Months.pbix”</span>, respectively, where the <span class="charoverride3">Year Month</span>, <span class="charoverride3">Year Month Number</span>, <span class="charoverride3">Month</span>, and <span class="charoverride3">Month Number</span> columns for the Gregorian calendar have corresponding <span class="charoverride3">Fiscal Year Month</span>, <span class="charoverride3">Fiscal Year Month Number</span>, <span class="charoverride3">Fiscal Month</span>, and <span class="charoverride3">Fiscal Month</span> Number columns for the fiscal calendar.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride5" id="calibre_link-252">
			</div>
		</div>
	</div>


<div id="calibre_link-31" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-253">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture3" id="calibre_link-254">
					<img alt="" class="_idgenobjectattribute" src="images/000475.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 4</p>
			<p class="ch-title--no-toc" id="calibre_link-255"><a id="calibre_link-8" class="calibre2"></a>Week-related calculations</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-203"><span class="hyperlink1">https://sql.bi/dax-203</span></a></p>
			<p class="normal--unindented">This pattern describes how to compute week-related calculations, such as year-to-date, same period last year, and percentage growth using a week granularity. This pattern does not rely on DAX built-in time intelligence functions. All the measures refer to the fiscal calendar because the nature of a calendar based on weeks is not compatible with the definition of months in a regular Gregorian calendar. You can use the <a href="#calibre_link-9"><span class="hyperlink1">Standard time-related calculations</span></a> pattern for time-related calculations based on a Gregorian calendar.</p>
			<p class="normal1">Every time a fiscal calendar is based on weeks, this pattern should be used instead of other patterns based on calendar months. There are many different standards adopted worldwide to define a week-based calendar. The assumptions in this pattern are:</p>
			<ul class="calibre1">
				<li class="bull-list">Every year is a set of complete weeks;</li>
				<li class="bull-list">Every period within the year (quarter, month) is a set of complete weeks;</li>
				<li class="bull-list">The fiscal year always starts on the same day of the week, so it does not always start on January 1.</li>
				<li class="bull-list">The fiscal month and the fiscal quarter always start on the same day of the week, so they do not always start on the first day of a month.</li>
			</ul>
			<p class="heading1" id="calibre_link-256">Introduction to week-related time intelligence calculations</p>
			<p class="normal--unindented">The time intelligence calculations in this pattern modify the filter context over the <span class="charoverride3">Date</span> table to obtain the result. The formulas are designed to apply filters at a granularity corresponding to the calculation requirements, without removing filters applied to attributes like working day and day of week; this is so that the report granularity is not limited by the implementation of the pattern.</p>
			<p class="normal1">The pattern does not rely on the standard time intelligence functions. Therefore, the <span class="charoverride3">Date</span> table does not have the requirements needed for standard DAX time intelligence functions. The formulas are identical whether you have one row for each week or one row for each day. The examples contain one row for each day, in order to create a relationship with the <span class="charoverride3">Sales</span> table through the <span class="charoverride3">Sales[Order Date]</span> column.</p>
			<p class="normal1">If there is a <span class="charoverride3">Date</span> column in the <span class="charoverride3">Date</span> table, the Mark as a Date Table setting is allowed but not required. The formulas in this pattern do not rely on the automatic REMOVEFILTERS being applied over the <span class="charoverride3">Date</span> table when the <span class="charoverride3">Date</span> column is filtered. Instead, all the formulas use a specific REMOVEFILTERS over the <span class="charoverride3">Date</span> table to get rid of the existing filters, replacing them with the minimum number of filters that guarantee the result.</p>
			<p class="heading" id="calibre_link-257">Building a <span class="charoverride5">Date</span> table</p>
			<p class="normal--unindented">The <span class="charoverride3">Date</span> table used for week-related calculations must include the right definition of all the fiscal periods required &ndash; quarter, month, week. The requirement for the pattern is to expose columns related to the week and any aggregation over weeks, such as quarters and years. The months could be different from those defined in the standard Gregorian calendar, as it happens when you have a 4-4-5 calendar like the one used in the example.</p>
			<p class="normal1">If you already have a <span class="charoverride3">Date</span> table, you can import the table &ndash; but make sure you have the columns required for this pattern, adding them to the <span class="charoverride3">Date</span> table if necessary. If a <span class="charoverride3">Date</span> table is not available, you can create one using a DAX calculated table. The <span class="charoverride3">Date</span> table included in the example dynamically creates a 4-4-5 calendar based on the ISO 8601 definition of weeks in a Gregorian calendar.</p>
			<p class="normal1">The first rows of the formula for the <span class="charoverride3">Date</span> calculated table included in the example define the type of week-based table to create in specific variables. For example, these are the parameters used for a 4-4-5 calendar starting in January of each year, although the first day of the fiscal year could be in December of the previous calendar year:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-258">
					<img alt="" class="_idgenobjectattribute" src="images/000334.png" />
				</div>
			</div>
			<p class="normal1">We suggest you read the comments included in the <span class="charoverride3">Date </span>calculated table in the example to find whether it works with your specific requirements. However, if you already have a <span class="charoverride3">Date</span> table in your data model, you should just make sure to include the columns described in the following paragraphs.</p>
			<p class="normal1">In order to obtain the correct visualization, the <span class="charoverride2">calendar columns</span> must be configured in the data model as follows. For each column you can see the data type followed by a sample value:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride3">Date</span>: Date, m/dd/yyyy (8/14/2007), used as a column to mark as date table, which is optional</li>
				<li class="bull-list"><span class="charoverride3">Sequential Day Number</span>: Whole Number, Hidden (40040) , same value of Date as integer</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year</span>: Text (FY 2007)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Number</span>: Whole Number, Hidden (2007)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Quarter</span>: Text (FQ3)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Quarter Number</span>: Whole Number, Hidden (3)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Quarter</span>: Text (FQ3-2007)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Quarter</span> <span class="charoverride3">Number</span>: Whole Number, Hidden (8030) </li>
				<li class="bull-list"><span class="charoverride3">Fiscal Week</span>: Text (FW33)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Week Number</span>: Whole Number, Hidden (33)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Week</span>: Text (FW33-2007)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Week Number</span>: Whole Number, Hidden (5564)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Month</span>: Text (FM Aug)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Month Number</span>: Whole Number, Hidden (8)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Month</span>: Text (FM Aug 2007)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Month Number</span>: Whole Number, Hidden (24091)</li>
				<li class="bull-list"><span class="charoverride3">Day of Fiscal Month Number</span>: Whole Number, Hidden (17)</li>
				<li class="bull-list"><span class="charoverride3">Day of Fiscal Quarter Number</span>: Whole Number, Hidden (45)</li>
				<li class="bull-list"><span class="charoverride3">Day of Fiscal Year Number</span>: Whole Number, Hidden (227)</li>
			</ul>
			<p class="normal1">We want to introduce the concept of <span class="charoverride2">filter-safe columns</span>. In a table, there are columns whose filters need to be preserved. The filters over filter-safe columns are not altered by the time intelligence calculations. They will be affecting the calculations presented in this pattern. The filter-safe columns in our sample table are the following:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride3">Day of Week</span>: ddd (Tue)</li>
				<li class="bull-list"><span class="charoverride3">Day of Week Number</span>: Whole Number, Hidden (6)</li>
				<li class="bull-list"><span class="charoverride3">Working Day</span>: Text (Working Day)</li>
			</ul>
			<p class="normal1">We provide a more in-depth description of the behavior of filter-safe columns in the next section.</p>
			<p class="normal1">The <span class="charoverride3">Date</span> table in this pattern contains several hierarchies:</p>
			<ul class="calibre1">
				<li class="bull-list">Year-Month-Week: Year (<span class="charoverride3">Fiscal Year</span>), Month (<span class="charoverride3">Fiscal Year Month</span>), Week (<span class="charoverride3">Fiscal Year Week</span>)</li>
				<li class="bull-list">Year-Quarter-Month-Week: Year (<span class="charoverride3">Fiscal Year</span>), Quarter (<span class="charoverride3">Fiscal Year Quarter</span>), Month (<span class="charoverride3">Fiscal Year Month</span>), Week (<span class="charoverride3">Fiscal Year Week</span>)</li>
				<li class="bull-list">Year-Quarter-Week: Year (<span class="charoverride3">Fiscal Year</span>), Quarter (<span class="charoverride3">Fiscal Year Quarter</span>), Week (<span class="charoverride3">Fiscal Year Week</span>)</li>
				<li class="bull-list">Year- Week: Year (<span class="charoverride3">Fiscal Year</span>), Week (<span class="charoverride3">Fiscal Year Week</span>)</li>
			</ul>
			<p class="normal1">The columns are designed to simplify the formulas. For example, the <span class="charoverride3">Day of Fiscal Year Number</span> column contains the number of days since the beginning of the fiscal year; this number makes it easier to find a corresponding range of dates in the previous year.</p>
			<p class="normal1">The <span class="charoverride3">Date</span> table must also include a hidden <span class="charoverride3">DateWithSales</span> calculated column, used by some of the formulas of this pattern: </p>
			<p class="code-block-screened-head">Calculated column in the Date table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-259">
					<img alt="" class="_idgenobjectattribute" src="images/000369.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Date[DateWithSales]</span> column is <span class="charoverride3">TRUE</span> if the date is on or before the last date with sales; it is <span class="charoverride3">FALSE</span> otherwise. In other words, <span class="charoverride3">DateWithSales</span> is <span class="charoverride3">TRUE</span> for “past” dates and <span class="charoverride3">FALSE</span> for “future” dates, where “past” and “future” are relative to the last date with sales.</p>
			<p class="normal1">In case you import a <span class="charoverride3">Date</span> table, you want to create columns that are similar to the ones we describe in this pattern, in that they should behave the same way.  </p>
			<p class="heading" id="calibre_link-260">Understanding filter-safe columns</p>
			<p class="normal1">The <span class="charoverride3">Date</span> table contains two types of columns: regular columns and filter-safe columns. The regular columns are worked on by the measures shown in this pattern. The filters over filter-safe columns are always preserved and never altered by the measures of this pattern. An example clarifies this distinction. </p>
			<p class="normal1">The <span class="charoverride3">Year Quarter Number</span> column is a regular column: the formulas in this pattern have the option of changing its value during their computation. To compute the previous quarter, the formulas change the filter context by subtracting one to the value of <span class="charoverride3">Year Quarter Number</span> in the filter context. Conversely, the <span class="charoverride3">Day of Week</span> column is a filter-safe column. If a user filters Monday to Friday, the formulas do not alter that filter on the day of the week. Therefore, a previous-quarter measure keeps the filter on the day of the week, and replaces only the filter on calendar columns such as year, month, and date.</p>
			<p class="normal1">To implement this pattern, you must identify which columns need to be treated as filter-safe columns, because filter-safe columns require special handling. The following is the classification of the columns used in the <span class="charoverride3">Date</span> table of this pattern:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride2">Calendar columns</span>: <span class="charoverride3">Date</span>, <span class="charoverride3">Fiscal Year</span>, <span class="charoverride3">Fiscal Year Number</span>, <span class="charoverride3">Fiscal Quarter</span>, <span class="charoverride3">Fiscal Quarter Number</span>, <span class="charoverride3">Fiscal Year Quarter</span>, <span class="charoverride3">Fiscal Year Quarter Number</span>, <span class="charoverride3">Fiscal Week</span>, <span class="charoverride3">Fiscal Week Number</span>, <span class="charoverride3">Fiscal Year Week</span>, <span class="charoverride3">Fiscal Year Week Number</span>, <span class="charoverride3">Fiscal Month</span>, <span class="charoverride3">Fiscal Month Number</span>, <span class="charoverride3">Fiscal Year Month</span>, <span class="charoverride3">Fiscal Year Month Number</span>, <span class="charoverride3">Day of Fiscal Month Number</span>, <span class="charoverride3">Day of Fiscal Quarter Number</span>, <span class="charoverride3">Day of Fiscal Year Number</span>.</li>
				<li class="bull-list"><span class="charoverride2">Filter-safe columns</span>: <span class="charoverride3">Day of Week</span>, <span class="charoverride3">Day of Week Number</span>, <span class="charoverride3">Working Day</span>.</li>
			</ul>
			<p class="normal1">The special handling of filter-safe columns revolves around the filter context. Every measure in this pattern manipulates the filter context by replacing filters over all the calendar columns, without altering any filter applied to the filter-safe columns. In other words, every measure follows two rules:</p>
			<ul class="calibre1">
				<li class="bull-list">Remove filters on calendar columns;</li>
				<li class="bull-list">Do not alter filters on filter-safe columns.</li>
			</ul>
			<p class="normal1">The ALLEXCEPT function can implement these requirements if the user specifies the <span class="charoverride3">Date</span> table in the first argument, and the filter-safe columns in the following arguments:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-261">
					<img alt="" class="_idgenobjectattribute" src="images/000349.png" />
				</div>
			</div>
			<p class="normal1">If the <span class="charoverride3">Date</span> table did not have any filter-safe column, the filters could be removed by using REMOVEFILTERS over the <span class="charoverride3">Date</span> table instead of ALLEXCEPT:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-262">
					<img alt="" class="_idgenobjectattribute" src="images/000364.png" />
				</div>
			</div>
			<p class="normal1">If your <span class="charoverride3">Date</span> table does not contain any filter-safe column, then you can use REMOVEFILTERS instead of ALLEXCEPT in all the measures of this pattern. We provide a complete scenario that includes filter-safe columns. Whenever possible, you can simplify it.</p>
			<p class="normal1">While the ALLEXCEPT should include all the filter-safe columns, we skip strictly those hidden filter-safe columns used only to sort other columns. For example, we do not include <span class="charoverride3">Day of Week Number</span>, which is a hidden column used to sort the <span class="charoverride3">Day of Week</span> column. The assumption is that the user never applies filters on hidden columns; if this assumption is not true, then the hidden filter-safe columns must also be included in the arguments of ALLEXCEPT. You can find an example of the impact of using REMOVEFILTERS vs. ALLEXCEPT in the <span class="charoverride2">Year-to-date total</span> section of this pattern.</p>
			<p class="heading" id="calibre_link-263">Controlling the visualization in future dates</p>
			<p class="normal--unindented">Most of the time intelligence calculations should not display values for dates after the last available date. For example, a year-to-date calculation can also show values for future dates, but we want to hide those values. The dataset used in these examples ends on August 15, 2009. Therefore, we consider the fiscal month FM August 2009, the third fiscal quarter of 2009 FQ3-2009, and the fiscal year FY 2009 to be the last periods with data. Any date after August 15, 2019 is considered as future, and we want to hide values there.</p>
			<p class="normal1">In order to avoid showing results in future dates, we use the following <span class="charoverride3">ShowValueForDates</span> measure. <span class="charoverride3">ShowValueForDates</span> returns TRUE if the period selected is earlier than the last period with data:</p>
			<p class="code-block-screened-head">Measure (hidden) in the Date table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-264">
					<img alt="" class="_idgenobjectattribute" src="images/000384.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">ShowValueForDates</span> measure is hidden. It is a technical measure created to reuse the same logic in many different time-related calculations, and the user should not use <span class="charoverride3">ShowValueForDates</span> directly in a report. The REMOVEFILTERS function removes the filter from any table in the model, because the purpose is to retrieve the last date used in the <span class="charoverride3">Sales</span> table regardless of any filter.</p>
			<p class="heading" id="calibre_link-265">Naming convention</p>
			<p class="normal--unindented">This section describes the naming convention we adopted to reference the time intelligence calculations. A simple categorization shows whether a calculation:</p>
			<ul class="calibre1">
				<li class="bull-list">shifts over a period of time, for example the same period in the previous year;</li>
				<li class="bull-list">performs an aggregation, for example year-to-date; or</li>
				<li class="bull-list">compares two time periods, for example this year compared to last year.</li>
			</ul>
			<div class="_idgenobjectlayout">
				<div class="table-screenshot" id="calibre_link-266">
					<img alt="" class="_idgenobjectattribute" src="images/000419.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-267">Computing period-to-date totals</p>
			<p class="normal--unindented">The year-to-date, quarter-to-date, month-to-date, and week-to-date calculations modify the filter context for the <span class="charoverride3">Date</span> table, showing the values from the beginning of the period up to the last date available in the filter context.</p>
			<p class="heading" id="calibre_link-268">Year-to-date total</p>
			<p class="normal--unindented">The year-to-date aggregates data starting from the first day of the fiscal year, as shown in Figure 4-1. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-269">
					<img alt="" class="_idgenobjectattribute" src="images/000271.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-1</span> <span class="charoverride3">Sales YTD (simple)</span> shows the value for any time period, whereas <span class="charoverride3">Sales YTD</span> hides the result after the last period with data.</p>
			<p class="normal1">The measure filters all the days less than or equal to the last day visible in the last fiscal year. It also filters the last visible<span class="charoverride3"> Fiscal Year Number</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-270">
					<img alt="" class="_idgenobjectattribute" src="images/000379.png" />
				</div>
			</div>
			<p class="normal1">Because <span class="charoverride3">LastDayAvailable</span> contains the last date visible in the filter context, <span class="charoverride3">Sales YTD (simple)</span> shows data even for future dates in the year. We can avoid this behavior in the <span class="charoverride3">Sales YTD</span> measure by returning a result only when <span class="charoverride3">ShowValueForDates</span> returns TRUE:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-271">
					<img alt="" class="_idgenobjectattribute" src="images/000394.png" />
				</div>
			</div>
			<p class="normal1">ALLEXCEPT is required to preserve the filter-safe columns <span class="charoverride3">Working Day</span> or <span class="charoverride3">Day of Week</span> in case they are used in the report. To demonstrate this, we purposely created an incorrect measure: <span class="charoverride3">Sales YTD (wrong)</span>, which removes the filters from the <span class="charoverride3">Date</span> table by using REMOVEFILTERS instead of ALLEXCEPT. By doing this, the formula loses the filter on <span class="charoverride3">Working Day</span> used in the columns of the matrix, thus producing an incorrect result:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-272">
					<img alt="" class="_idgenobjectattribute" src="images/000409.png" />
				</div>
			</div>
			<p class="normal1">Figure 4-2 shows the comparison of the correct and incorrect measures.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-273">
					<img alt="" class="_idgenobjectattribute" src="images/000300.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-2</span> <span class="charoverride3">Sales YTD (wrong)</span> shows <span class="charoverride3">Sales YTD</span> calculated by ignoring the filter over <span class="charoverride3">Working Day</span>.</p>
			<p class="normal1">The <span class="charoverride3">Sales YTD (wrong)</span> measure would work well if the <span class="charoverride3">Date</span> table did not contain any filter-safe columns. The presence of filter-safe columns requires using ALLEXCEPT instead of REMOVEFILTERS. We used <span class="charoverride3">Sales YTD</span> as an example, but the same concept is valid for all the other measures in this pattern.</p>
			<p class="heading" id="calibre_link-274">Quarter-to-date total</p>
			<p class="normal--unindented">Quarter-to-date aggregates data from the first day of the fiscal quarter, as shown in Figure 4-3. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-275">
					<img alt="" class="_idgenobjectattribute" src="images/000328.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-3</span> <span class="charoverride3">Sales QTD</span> shows the quarter-to-date amount, which is blank for FY 2009 because there is no data in FQ4-2009.</p>
			<p class="normal1">Quarter-to-date is computed with the same technique as the one we used for the year-to-date total. The only differences are the filters on <span class="charoverride3">Fiscal Year Quarter Number</span> instead of <span class="charoverride3">Fiscal Year Number</span>, and<span class="charoverride3"> Day of Fiscal Quarter Number</span> instead of <span class="charoverride3">Day of Fiscal Year Number</span>.</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-276">
					<img alt="" class="_idgenobjectattribute" src="images/000423.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-277">Month-to-date total</p>
			<p class="normal--unindented">Month-to-date aggregates data starting from the first day of the fiscal month, as shown in Figure 4-4. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-278">
					<img alt="" class="_idgenobjectattribute" src="images/000358.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-4</span> <span class="charoverride3">Sales MTD</span> shows the month-to-date amount, which is blank for FY 2009 and FQ3-2009 because there is no data after August 15, 2009.</p>
			<p class="normal1">The month-to-date total is computed with a technique similar to those used in year-to-date total and quarter-to-date total, which filter all the days that are less than or equal to the last day visible in the last fiscal month. The filters are applied to the <span class="charoverride3">Day of Month Number</span> and <span class="charoverride3">Year Month Number</span> columns:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-279">
					<img alt="" class="_idgenobjectattribute" src="images/000437.png" />
				</div>
			</div>
			<p class="normal1">The measure filters <span class="charoverride3">Day of Fiscal Month Number</span> instead of <span class="charoverride3">Day of Fiscal Year Number</span>. The reason is to filter a column with a lower number of unique values, which is a best practice from a query performance standpoint.</p>
			<p class="heading" id="calibre_link-280">Week-to-date total</p>
			<p class="normal--unindented">Week-to-date aggregates data from the first day of the week, as shown in Figure 4-5. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-281">
					<img alt="" class="_idgenobjectattribute" src="images/000388.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-5</span> <span class="charoverride3">Sales WTD</span> shows the week-to-date amount, which is blank for FY 2009, FQ3-2009, and FM Aug 2009 because there is no data after August 15, 2009.</p>
			<p class="normal1">The week-to-date total is computed with a technique similar to those used in year-to-date total and quarter-to-date total, which filters all the days that are less than or equal to the last weekday day number visible in the last fiscal week. The filters are applied to the <span class="charoverride3">Day of Week Number</span> and <span class="charoverride3">Fiscal Year Week Number</span> columns:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-282">
					<img alt="" class="_idgenobjectattribute" src="images/000451.png" />
				</div>
			</div>
			<p class="normal1">The measure filters <span class="charoverride3">Day of Week Number</span> instead of <span class="charoverride3">Day of Fiscal Year Number</span>. This is to filter a column with a lower number of unique values, which is a best practice from a query performance standpoint.</p>
			<p class="heading1" id="calibre_link-283">Computing period-over-period growth</p>
			<p class="normal--unindented">A common requirement is to compare a time period with the same time period in the previous year, quarter, or week. We do not look at the comparison over the previous month because in a 4-4-5 calendar there may be a different number of weeks within the months. In order to achieve a fair comparison, the measure should work with an equivalent period, also taking into account that the last week/quarter/year could be incomplete. For these reasons, the calculations shown in this section use the <span class="charoverride3">Date[DateWithSales]</span> calculated column, as described in the article, <a href="https://www.sqlbi.com/articles/hiding-future-dates-for-calculations-in-dax/"><span class="hyperlink">Hiding future dates for calculations in DAX</span></a>.</p>
			<p class="heading" id="calibre_link-284">Year-over-year growth</p>
			<p class="normal--unindented">Year-over-year compares a time period to the equivalent time period in the previous year. In this example, data is available until August 15, 2009. For this reason, <span class="charoverride3">Sales PY</span> shows numbers related to FY 2009 and takes into account only transactions before August 15, 2008. Figure 4-6 shows that <span class="charoverride3">Sales Amount</span> of FQ3-2008 is 2,573,182.08, whereas <span class="charoverride3">Sales PY</span> for FQ3-2009 returns 1,270,748.28 because the measure considers only sales up to August 15, 2008.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-285">
					<img alt="" class="_idgenobjectattribute" src="images/000417.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-6</span> For FQ3-2009, <span class="charoverride3">Sales PY</span> shows the amount of FQ3-2008 until August 15, 2008, because there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PY</span> uses a standard technique that shifts the selection by the number of months defined in the <span class="charoverride3">MonthsOffset</span> variable. In <span class="charoverride3">Sales PY</span> the variable is set to 12, to move back in time by 12 months. The next measures, <span class="charoverride3">Sales PQ</span> and <span class="charoverride3">Sales PM,</span> use the same code. The only difference is the value assigned to <span class="charoverride3">MonthsOffset</span>.</p>
			<p class="normal1"><span class="charoverride3">Sales PY </span>iterates every year active in the filter context. For each year, it retrieves the days selected in the year while ignoring the filter-safe columns (<span class="charoverride3">Working Day</span>, <span class="charoverride3">Day of Week</span> and <span class="charoverride3">Day of Week Number</span> in our example). The days are evaluated using the relative day number within the year. These days are applied as a filter on the previous year. The filters over filter-safe columns are kept in the filter context by using ALLEXCEPT:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-286">
					<img alt="" class="_idgenobjectattribute" src="images/000465.png" />
				</div>
			</div>
			<p class="normal1">The year-over-year growth is computed as an amount in <span class="charoverride3">Sales YOY</span> and as a percentage in <span class="charoverride3">Sales YOY %</span>. Both measures use <span class="charoverride3">Sales PY</span> to take into account only dates up to August 15, 2009:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-287">
					<img alt="" class="_idgenobjectattribute" src="images/000479.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-288">
					<img alt="" class="_idgenobjectattribute" src="images/000555.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-289">Quarter-over-quarter growth</p>
			<p class="normal--unindented">Quarter-over-quarter compares a time period with the equivalent time period in the previous quarter. In this example, data is available until August 15, 2009, which is more than half of the third quarter of FY 2009 &ndash; it is day 49 in that quarter. Therefore, <span class="charoverride3">Sales PQ</span> for August 2009 &ndash; the second month of the third quarter &ndash; shows sales until May 16, 2009, which is day 49 in the previous quarter, FQ2-2009. Figure 4-7 shows that <span class="charoverride3">Sales Amount</span> of FQ2-2009 is 2,531,034.28, whereas <span class="charoverride3">Sales PQ</span> for FQ3-2009 returns 1,140,186.77, restricted to sales performed up to May 16, 2009.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-290">
					<img alt="" class="_idgenobjectattribute" src="images/000205.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-7</span> For FQ3-2009, <span class="charoverride3">Sales PQ </span>shows the values of FQ2-2009 until May 16, 2009; indeed, there is no data after August 15, 2009, which sits at the same relative position in the quarter (day 49).</p>
			<p class="normal1"><span class="charoverride3">Sales PQ</span> uses the technique described for <span class="charoverride3">Sales PY</span>. The only difference is that instead of iterating <span class="charoverride3">Fiscal Year Number</span>, it iterates <span class="charoverride3">Fiscal Year Quarter Number</span> and applies the filter over <span class="charoverride3">Day of Fiscal Quarter Number</span> instead of over <span class="charoverride3">Day of Fiscal Year Number</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-291">
					<img alt="" class="_idgenobjectattribute" src="images/000492.png" />
				</div>
			</div>
			<p class="normal1">The quarter-over-quarter growth is computed as an amount in <span class="charoverride3">Sales QOQ</span> and as a percentage in <span class="charoverride3">Sales QOQ %</span>. Both measures use <span class="charoverride3">Sales PQ</span> to guarantee a fair comparison: </p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-292">
					<img alt="" class="_idgenobjectattribute" src="images/000506.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-293">
					<img alt="" class="_idgenobjectattribute" src="images/000012.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-294">Week-over-week growth</p>
			<p class="normal--unindented">Week-over-week compares a time period with its equivalent in the previous week. The calculation is similar to year-over-year and quarter-over-quarter growth, even though the data available does not show a specific example of a partial week corresponding to the last day available (August 15, 2019). The <span class="charoverride3">Sales PW</span> measure sums all the weeks of the period shifted back by one week if the report aggregates more weeks, like at the year and quarter level. Figure 4-8 shows an example of the result.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-295">
					<img alt="" class="_idgenobjectattribute" src="images/000459.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-8</span>  The <span class="charoverride3">Sales PW</span> measure shows the <span class="charoverride3">Sales Amount</span> of the previous week.</p>
			<p class="normal1"><span class="charoverride3">Sales PW</span> uses the technique described for <span class="charoverride3">Sales PY</span>. The only difference is that instead of iterating <span class="charoverride3">Fiscal Year Number</span>, it iterates <span class="charoverride3">Fiscal Year Week Number</span> and applies the filter over <span class="charoverride3">Day of Week Number</span> instead of over <span class="charoverride3">Day of Fiscal Year Number</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-296">
					<img alt="" class="_idgenobjectattribute" src="images/000522.png" />
				</div>
			</div>
			<p class="normal1">The week-over-week growth is computed as an amount in <span class="charoverride3">Sales WOW</span> and as a percentage in <span class="charoverride3">Sales WOW %</span>. Both measures use <span class="charoverride3">Sales PW</span> to guarantee a fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-297">
					<img alt="" class="_idgenobjectattribute" src="images/000535.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride7">Measure in the Sales table</span></p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-298">
					<img alt="" class="_idgenobjectattribute" src="images/000550.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-299">Period-over-period growth</p>
			<p class="normal--unindented">Period-over-period growth automatically selects one of the measures described earlier in this section based on the current selection of the visualization. For example, it returns the value of week-over-week growth measures if the visualization displays data at the week level, and switches to quarter-over-quarter or year-over-year growth measures if the visualization shows the total at the quarter or year level, respectively. The month level is not supported on a 4-4-5 calendar. The expected result is visible in Figure 4-9.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-300">
					<img alt="" class="_idgenobjectattribute" src="images/000487.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-9</span> <span class="charoverride3">Sales PP</span> shows the value of the previous week at the week level, of the previous quarter at the quarter level, and of the previous year at the year level.</p>
			<p class="normal1">The three measures <span class="charoverride3">Sales PP</span>, <span class="charoverride3">Sales POP</span>, and <span class="charoverride3">Sales POP %</span> redirect the evaluation to the corresponding year, quarter, and week measures depending on the level selected in the report. ISINSCOPE detects the level used in the report. The arguments passed to ISINSCOPE are the attributes used in the rows of the Matrix visual in Figure 4-9. The measures are defined as follows:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-301">
					<img alt="" class="_idgenobjectattribute" src="images/000564.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-302">
					<img alt="" class="_idgenobjectattribute" src="images/000578.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-303">
					<img alt="" class="_idgenobjectattribute" src="images/000591.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-304">Computing period-to-date growth</p>
			<p class="normal--unindented">The growth of a “to-date” measure is the comparison of the “to-date” measure with the same measure over an equivalent time period with a specific offset. For example, you can compare a year-to-date aggregation against the year-to-date in the previous fiscal year, that is with an offset of one fiscal year.</p>
			<p class="normal1">All the measures in this set of calculations take care of partial periods. Because data is available only until August 15, 2009 in our example, the measures make sure the previous year does not report dates after August 15, 2008.</p>
			<p class="heading" id="calibre_link-305">Year-over-year-to-date growth</p>
			<p class="normal--unindented">Year-over-year-to-date growth compares the year-to-date on a specific date with the year-to-date on an equivalent date in the previous year. Figure 4-10 shows that <span class="charoverride3">Sales PYTD</span> in FY 2009 is considering only sales until August 16, 2008, because it is the same relative day within FY 2008 as is August 15, 2009 for FY 2009. For this reason, <span class="charoverride3">Sales YTD</span> of FQ3-2008 is 7,124,371.27, whereas <span class="charoverride3">Sales PYTD</span> for FQ3-2009 is less: 5,821,937.47.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-306">
					<img alt="" class="_idgenobjectattribute" src="images/000515.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-10</span>  For FQ3-2009, <span class="charoverride3">Sales PYTD</span> shows the amount of the days in FQ3-2008 until August 16, 2008 because there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PYTD</span> is like <span class="charoverride3">Sales YTD</span>: it filters the previous value in <span class="charoverride3">Fiscal Year Number</span> instead of the last year visible in the filter context. The main difference is the evaluation of <span class="charoverride3">LastDayOfFiscalYearAvailable</span>, which must consider only dates with sales while ignoring the filter on filter-safe columns, which are considered in the evaluation of <span class="charoverride3">Sales Amount</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-307">
					<img alt="" class="_idgenobjectattribute" src="images/000007.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales YOYTD</span> and <span class="charoverride3">Sales YOYTD %</span> rely on <span class="charoverride3">Sales PYTD</span> to guarantee a fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-308">
					<img alt="" class="_idgenobjectattribute" src="images/000169.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-309">
					<img alt="" class="_idgenobjectattribute" src="images/000140.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-310">Quarter-over-quarter-to-date growth</p>
			<p class="normal--unindented">Quarter-over-quarter-to-date growth compares the quarter-to-date on a specific date with the quarter-to-date on an equivalent date in the previous quarter. Figure 4-11 shows that <span class="charoverride3">Sales PQTD</span> in FW August 2009 is considering only transactions that occurred prior to May 16, 2009, to get the corresponding part of the previous quarter. For this reason <span class="charoverride3">Sales QTD</span> of FW May 2009 is 1,411,541.99, whereas <span class="charoverride3">Sales PQTD</span> for FW August 2009 is lower: 1,140,186.77.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-311">
					<img alt="" class="_idgenobjectattribute" src="images/000544.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-11</span> For Aug 2009, <span class="charoverride3">Sales PQTD</span> shows the amount for March 29-May 16, 2009, because there is no data after August 15, 2009. The comparison only uses the first 49 days of the quarter.</p>
			<p class="normal1"><span class="charoverride3">Sales PQTD</span> is like <span class="charoverride3">Sales QTD</span>; it filters the previous value in <span class="charoverride3">Fiscal Year Quarter Number</span> instead of the last quarter visible in the filter context. The main difference is the evaluation of <span class="charoverride3">LastDayOfFiscalYearQuarterAvailable</span>, which must consider only dates with sales while ignoring the filter on filter-safe columns, which are considered in the evaluation of <span class="charoverride3">Sales Amount</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-312">
					<img alt="" class="_idgenobjectattribute" src="images/000020.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales QOQTD</span> and <span class="charoverride3">Sales QOQTD %</span> rely on <span class="charoverride3">Sales PQTD</span> to guarantee a fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-313">
					<img alt="" class="_idgenobjectattribute" src="images/000196.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-314">
					<img alt="" class="_idgenobjectattribute" src="images/000193.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-315">Week-over-week-to-date growth</p>
			<p class="normal--unindented">Week-over-week-to-date growth compares a week-to-date on a specific date with the week-to-date on an equivalent date in the previous week. The calculation is similar to year-over-year and quarter-over-quarter growth, even though the data available does not show a specific example of a partial week corresponding to the last day available (August 15, 2019). Figure 4-12 shows an example of the result.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-316">
					<img alt="" class="_idgenobjectattribute" src="images/000573.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-12</span>  The <span class="charoverride3">Sales PWTD</span> measure shows the <span class="charoverride3">Sales WTD</span> of the previous week.</p>
			<p class="normal1"><span class="charoverride3">Sales PWTD</span> is like <span class="charoverride3">Sales WTD</span>; it filters the previous value in <span class="charoverride3">Fiscal Year Week Number</span> instead of the last week visible in the filter context. The main difference is the evaluation of <span class="charoverride3">LastDayOfFiscalYearWeekAvailable</span>, which must consider only dates with sales while ignoring the filter on filter-safe columns, which are considered in the evaluation of <span class="charoverride3">Sales Amount</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-317">
					<img alt="" class="_idgenobjectattribute" src="images/000034.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales WOWTD</span> and <span class="charoverride3">Sales WOWTD %</span> rely on the <span class="charoverride3">Sales PWTD</span> measure to guarantee a fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-318">
					<img alt="" class="_idgenobjectattribute" src="images/000048.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-319">
					<img alt="" class="_idgenobjectattribute" src="images/000062.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-320">Comparing period-to-date with previous full period</p>
			<p class="normal--unindented">Comparing a to-date aggregation with the previous full period is useful when you consider the previous period as a benchmark. Once the current year-to-date reaches 100% of the full previous year, this means we have reached the same performance as the previous full period, hopefully in fewer days.</p>
			<p class="heading" id="calibre_link-321">Year-to-date over the full previous year</p>
			<p class="normal--unindented">Year-to-date over the full previous year compares the year-to-date against the entire previous year. Figure 4-13 shows that in FW48-2008 <span class="charoverride3">Sales YTD</span> surpassed the value of <span class="charoverride3">Sales Amount</span> for the entire fiscal year 2007. <span class="charoverride3">Sales YTDOPY % </span>provides an immediate comparison of the year-to-date with the total of the previous fiscal year; it shows growth over the previous fiscal year when the percentage is positive.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-322">
					<img alt="" class="_idgenobjectattribute" src="images/000019.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-13</span> <span class="charoverride3">Sales YTDOPY %</span> shows a positive value when <span class="charoverride3">Sales YTD</span> is greater than the total <span class="charoverride3">Sales Amount</span> of the previous fiscal year.</p>
			<p class="normal1">The year-to-date-over-previous-year growth is computed by the <span class="charoverride3">Sales YTDOPY</span> and <span class="charoverride3">Sales YTDOPY %</span> measures; these rely on the <span class="charoverride3">Sales YTD</span> measure to compute the year-to-date value, and on the <span class="charoverride3">Sales PYC</span> measure to get the sales amount of the entire previous fiscal year:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-323">
					<img alt="" class="_idgenobjectattribute" src="images/000077.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-324">
					<img alt="" class="_idgenobjectattribute" src="images/000092.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-325">
					<img alt="" class="_idgenobjectattribute" src="images/000274.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-326">Quarter-to-date over the full previous quarter</p>
			<p class="normal--unindented">Quarter-to-date over the full previous quarter compares the quarter-to-date against the entire previous fiscal quarter. Figure 4-14 shows that <span class="charoverride3">Sales QTD</span> surpassed the total <span class="charoverride3">Sales Amount</span> for FQ1-2009 in FW23-2009. <span class="charoverride3">Sales QTDOPQ %</span> provides an immediate comparison of the quarter-to-date with the total of the previous quarter; it shows growth over the previous quarter when the percentage is positive.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-327">
					<img alt="" class="_idgenobjectattribute" src="images/000010.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-14</span> <span class="charoverride3">Sales QTDOPQ %</span> shows a positive percentage from FW23-2009, when <span class="charoverride3">Sales QTD</span> starts to be greater than the <span class="charoverride3">Sales Amount</span> for FQ1-2009.</p>
			<p class="normal1">The quarter-to-date-over-previous-quarter growth is computed with the <span class="charoverride3">Sales QTDOPQ</span> and <span class="charoverride3">Sales QTDOPQ %</span> measures. These rely on the <span class="charoverride3">Sales QTD</span> measure to compute the quarter-to-date value, and on the <span class="charoverride3">Sales PQC</span> measure to get the sales amount of the entire previous quarter:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-328">
					<img alt="" class="_idgenobjectattribute" src="images/000107.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-329">
					<img alt="" class="_idgenobjectattribute" src="images/000121.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-330">
					<img alt="" class="_idgenobjectattribute" src="images/000376.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-331">Week-to-date over the full previous week</p>
			<p class="normal--unindented">The week-to-date over the full previous week compares the week-to-date against the entire previous week. Figure 4-15 shows that <span class="charoverride3">Sales WTD</span> during FW33-2009 surpasses the total <span class="charoverride3">Sales Amount</span> for FW32-2009. <span class="charoverride3">Sales WTDOPW%</span> provides an immediate comparison of the week-to-date with the total of the previous week; it shows growth over the previous week when the percentage is positive, as is the case starting from August 11, 2009.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-332">
					<img alt="" class="_idgenobjectattribute" src="images/000553.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-15</span> <span class="charoverride3">Sales WTDOPW %</span> shows a positive percentage starting from August 11, 2009, when <span class="charoverride3">Sales WTD</span> starts to be greater than the <span class="charoverride3">Sales Amount</span> for FW32-2009.</p>
			<p class="normal1">The week-to-date-over-previous-week growth is computed with the <span class="charoverride3">Sales WTDOPW %</span> and <span class="charoverride3">Sales WTDOPW</span> measures. These rely on the <span class="charoverride3">Sales WTD</span> measure to compute the week-to-date value, and on the <span class="charoverride3">Sales PWC</span> measure to get the sales amount of the entire previous week:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-333">
					<img alt="" class="_idgenobjectattribute" src="images/000134.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-334">
					<img alt="" class="_idgenobjectattribute" src="images/000147.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-335">
					<img alt="" class="_idgenobjectattribute" src="images/000160.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-336">Using moving annual total calculations</p>
			<p class="normal--unindented">A common way to aggregate data over several months is by using the moving annual total instead of the year-to-date. In the week-based calendar, the moving annual total includes the last 52 weeks (364 days) of data. </p>
			<p class="heading" id="calibre_link-337">Moving annual total</p>
			<p class="normal--unindented"><span class="charoverride3">Sales MAT (364)</span> computes the moving annual total, as shown in Figure 4-16.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-338">
					<img alt="" class="_idgenobjectattribute" src="images/000066.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-16</span> <span class="charoverride3">Sales MAT (364)</span> in FQ3-2009 aggregates <span class="charoverride3">Sales Amount</span> from FQ4-2008 to FQ3-2009.</p>
			<p class="normal1">The <span class="charoverride3">Sales MAT (364) </span>measure defines a range over the <span class="charoverride3">Date[Date]</span> column that includes the days of one complete year from the last day in the filter context:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-339">
					<img alt="" class="_idgenobjectattribute" src="images/000173.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Sales MAT (364)</span> does not correspond to a year total in case the year has more than 52 weeks, as is the case every 5-6 years in the 4-4-5 calendar. Yet, it is a better measure to evaluate trends over time because it always includes the same number of days and weeks. </p>
			<p class="heading" id="calibre_link-340">Moving annual total growth</p>
			<p class="normal--unindented">The moving annual total growth is computed with the <span class="charoverride3">Sales PYMAT (364)</span>, <span class="charoverride3">Sales MATG</span>, and <span class="charoverride3">Sales MATG %</span> measures, which rely on the <span class="charoverride3">Sales MAT (364)</span> measure. <span class="charoverride3">Sales MAT (364)</span> provides a correct value one year after the first sale ever, once it has collected one full year of data; it is not protected in case the current time period is shorter than a full year. For example, the amount for the fiscal year FY 2009 of <span class="charoverride3">Sales PYMAT (364)</span> is 9,788,101.45, which corresponds to the <span class="charoverride3">Sales Amount</span> of FY 2008 as shown in Figure 4-17. When compared with sales in FY 2009, this produces a comparison of less than 6 months &ndash; data being only available until August 15, 2009 &ndash; with a full fiscal year 2009. Similarly, you can see that <span class="charoverride3">Sales MATG %</span> starts in FY 2008 with very high values and stabilizes after a year. This behavior is by design: the moving annual total is usually computed at the month or day granularity to show trends in a chart.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-341">
					<img alt="" class="_idgenobjectattribute" src="images/000038.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-17</span> <span class="charoverride3">Sales MATG %</span> shows the growth between <span class="charoverride3">Sales MAT (364)</span> and <span class="charoverride3">Sales PYMAT (364)</span> as a percentage.</p>
			<p class="normal1">The measures are defined as follows:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-342">
					<img alt="" class="_idgenobjectattribute" src="images/000187.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-343">
					<img alt="" class="_idgenobjectattribute" src="images/000200.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-344">
					<img alt="" class="_idgenobjectattribute" src="images/000213.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-345">Moving averages</p>
			<p class="normal--unindented">The moving average is typically used to display trends in line charts. Figure 4-18 includes the moving average of <span class="charoverride3">Sales Amount</span> over four weeks (<span class="charoverride3">Sales AVG 4W</span>), one quarter (<span class="charoverride3">Sales AVG 1Q</span>), and a fiscal year (<span class="charoverride3">Sales AVG 1Y</span>).</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-346">
					<img alt="" class="_idgenobjectattribute" src="images/000052.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 4-18</span> <span class="charoverride3">Sales AVG 4W</span>, <span class="charoverride3">Sales AVG 1Q</span>, and <span class="charoverride3">Sales AVG 1Y</span> show the moving average over four weeks, one quarter, and one year, respectively.</p>
			<p class="heading" id="calibre_link-347">Moving average 4 weeks</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 4W</span> measure computes the moving average over four weeks by iterating a list of the last 28 dates obtained in the <span class="charoverride3">Period4W</span> variable. The <span class="charoverride3">Period4W</span> variable retrieves the dates visible in the last 28 days with two exceptions; it ignores dates without sales, and it applies the filters existing on filter-safe columns in the <span class="charoverride3">Date</span> table:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-348">
					<img alt="" class="_idgenobjectattribute" src="images/000226.png" />
				</div>
			</div>
			<p class="normal1">This pattern is very flexible because it also works for non-additive measures. With that said, for a regular additive calculation <span class="charoverride3">Result</span> can be implemented using a different and faster formula:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-349">
					<img alt="" class="_idgenobjectattribute" src="images/000239.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-350">Moving average 1 quarter</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 1Q</span> measure computes the moving average over 13 weeks by iterating a list of the dates in the last quarter obtained in the <span class="charoverride3">Period1Q</span> variable. The <span class="charoverride3">Period1Q</span> variable retrieves the dates visible included in the last 13 weeks (91 days) with two exceptions; it ignores dates without sales, and it applies the filters existing on filter-safe columns in the <span class="charoverride3">Date</span> table:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-351">
					<img alt="" class="_idgenobjectattribute" src="images/000254.png" />
				</div>
			</div>
			<p class="normal1">For simple additive measures, the pattern based on DIVIDE which is shown for the moving average over four weeks (28 days) can also be used for the average over 91 days.</p>
			<p class="heading" id="calibre_link-352">Moving average 1 year</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 1Y</span> measure computes the moving average over one year by iterating a list of the dates in the last 364 days in the <span class="charoverride3">Period1Y </span>variable. The<span class="charoverride3"> Period1Y </span>variable retrieves the dates visible included in the last fiscal year (only including 52 weeks) with two exceptions; it ignores dates without sales, and it applies the filters existing on filter-safe columns in the <span class="charoverride3">Date</span> table:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-353">
					<img alt="" class="_idgenobjectattribute" src="images/000268.png" />
				</div>
			</div>
			<p class="normal1">For simple additive measures, the pattern based on DIVIDE shown for the moving average over four weeks (28 days) can also be used for the average over 364 days.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride6" id="calibre_link-354">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride7" id="calibre_link-355">
			</div>
		</div>
	</div>


<div id="calibre_link-11" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-356">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture2" id="calibre_link-357">
					<img alt="" class="_idgenobjectattribute" src="images/000408.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 5</p>
			<p class="ch-title--no-toc" id="calibre_link-358"><a id="calibre_link-7" class="calibre2"></a>Custom time-related calculations</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-204"><span class="hyperlink1">https://sql.bi/dax-204</span></a></p>
			<p class="normal--unindented">This pattern shows how to compute time-related calculations like year-to-date, same period last year, and percentage growth using a custom calendar. This pattern does not rely on DAX built-in time intelligence functions. All the measures refer to the fiscal calendar because the same measures, with a regular Gregorian calendar, can be obtained using the <a href="#calibre_link-9"><span class="hyperlink1">Standard time-related calculations</span></a> pattern.</p>
			<p class="normal1">There are several scenarios where the DAX built-in functions for time intelligence cannot provide the right answers. For example, if your fiscal year starts on a month other than January, April, July, or October, then you cannot use the DAX time intelligence functions for quarterly-related calculations. In these scenarios, you need to rewrite the time intelligence logic of the built-in functions by using plain DAX functions like FILTER and CALCULATE. Moreover, you must create a <span class="charoverride3">Date</span> table that contains additional columns to compute time periods like the previous quarter or a whole year. Indeed, the standard time intelligence functions derive this information from the <span class="charoverride3">Date</span> column in the <span class="charoverride3">Date</span> table. The custom time-related calculations pattern does not extract the information from the <span class="charoverride3">Date</span> column and requires additional columns.</p>
			<p class="normal1">The measures in this pattern work on a regular Gregorian calendar with the following assumptions:</p>
			<ul class="calibre1">
				<li class="bull-list">Years and quarters always start on the first day of a month.</li>
				<li class="bull-list">A month is always a calendar month.</li>
			</ul>
			<p class="normal1">In simpler words, this pattern works fine if the fiscal year starts on the first day of a month, and a quarter is made of three regular months. For example, if the fiscal year starts on March 3, or all the fiscal quarters must have 90 days, then the formulas do not work.</p>
			<p class="normal1">An example of a calendar that does not satisfy the requirements of this pattern is a week-based calendar. If you need calculations over periods based on weeks, you should use the <a href="#calibre_link-8"><span class="hyperlink1">Week-related calculations</span></a> pattern.</p>
			<p class="heading1" id="calibre_link-359">Introduction to custom time intelligence calculations</p>
			<p class="normal--unindented">The custom time intelligence calculations in this pattern modify the filter context over the <span class="charoverride3">Date</span> table to obtain the required result. The formulas are designed to apply filters to the lowest granularity required to improve query performances. For example, a calculation over months works by modifying the filter context at the month level, instead of the individual dates. This technique reduces the cost of computing the new filter and applying it to the filter context. This optimization is especially useful when using DirectQuery, even though it also improves performance on models imported in memory.</p>
			<p class="normal1">Because the pattern does not rely on the standard time intelligence functions, the <span class="charoverride3">Date</span> table does not have the requirements needed for standard DAX time intelligence functions.</p>
			<p class="normal1">For example, the Mark as Date Table setting is suggested, but not required. The formulas in this pattern do not rely on the automatic REMOVEFILTERS applied over the <span class="charoverride3">Date</span> table when the <span class="charoverride3">Date</span> column is filtered. Instead, the <span class="charoverride3">Date</span> table must contain specific columns required by the measures. Therefore, although you might already have a <span class="charoverride3">Date</span> table in your model, you must read the next section (Building a <span class="charoverride3">Date</span> table) to verify that all the required columns are present in the <span class="charoverride3">Date</span> table.</p>
			<p class="heading" id="calibre_link-360">Building a <span class="charoverride5">Date</span> table</p>
			<p class="normal--unindented">The <span class="charoverride3">Date</span> table used for custom time-related calculations is based on the months of the standard Gregorian calendar table. If you already have a <span class="charoverride3">Date</span> table, you can import the table and &ndash; if necessary &ndash; extend it to include a set of columns containing the information required by the DAX formulas. We describe these columns later in this section.</p>
			<p class="normal1">If a <span class="charoverride3">Date</span> table is not available, you can create one using a DAX calculated table. As an example, the following DAX expression defines the <span class="charoverride3">Date</span> table used in this pattern, which has a fiscal year starting on March 1:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-361">
					<img alt="" class="_idgenobjectattribute" src="images/000282.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-362">
					<img alt="" class="_idgenobjectattribute" src="images/000297.png" />
				</div>
			</div>
			<p class="normal1">The first two variables are useful to customize the beginning of both the fiscal year and the week. The next variables detect the range of fiscal years required, based on the transactions in <span class="charoverride3">Sales</span>. You can customize <span class="charoverride3">FirstSalesDate</span> and <span class="charoverride3">LastSalesDate</span> to retrieve the first and last transaction date in your model, or you can assign the first and last fiscal year in the <span class="charoverride3">FirstFiscalYear</span> and <span class="charoverride3">LastFiscalYear</span> variables.</p>
			<p class="normal1">The quarters are computed starting from the first month of the fiscal year. The <span class="charoverride3">Date</span> table contains hidden columns to support the correct sorting of years, quarters, and months. These hidden columns are populated with sequential numbers that make it easy to apply filters to retrieve previous or following years, quarters, and months, without relying on complex calculations at query time.</p>
			<p class="normal1">Among the many columns, one is worth expanding on. The <span class="charoverride4">Year Month Number</span> column contains the year number multiplied by 12, plus the month. The resulting number is hard to read, but it allows math over months. Given the <span class="charoverride3">Year Month Number</span> value, you can just subtract 12 to go back one year; this gives you the value of <span class="charoverride3">Year Month Number</span> corresponding to the same month in the previous year. Many formulas use this characteristic to perform time-shifts.</p>
			<p class="normal1">In order to obtain the right visualization, the <span class="charoverride2">calendar columns</span> must be configured in the data model as follows &ndash; for each column you can see the data type and the format string, followed by a sample value:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride3">Date</span>: Date, m/dd/yyyy (8/14/2007), used as a column to mark as date table (not required)</li>
				<li class="bull-list"><span class="charoverride3">DateKey</span>: Whole Number, (20070814), used as an alternate key for relationships</li>
				<li class="bull-list"><span class="charoverride3">Sequential Day Number</span>: Whole Number, Hidden (40040), same value of Date as integer</li>
				<li class="bull-list"><span class="charoverride3">Year Month</span>: Text (Aug 2007)</li>
				<li class="bull-list"><span class="charoverride3">Year Month Number</span>: Whole Number, Hidden (24091)</li>
				<li class="bull-list"><span class="charoverride3">Month</span>: Text (Aug)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Month Number</span>: Whole Number, Hidden (6)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Month in Quarter Number</span>: Whole Number, Hidden (3)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year</span>: Text (FY 2008)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Number</span>: Whole Number, Hidden (2008)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Quarter</span>: Text (FQ2-2008)</li>
				<li class="bull-list"><span class="charoverride3">Fiscal Year Quarter</span> Number: Whole Number, Hidden (8033) </li>
				<li class="bull-list"><span class="charoverride3">Fiscal Quarter</span>: Text (FQ2)</li>
				<li class="bull-list"><span class="charoverride3">Day of Fiscal Year Number</span>: Whole Number, Hidden (167)</li>
				<li class="bull-list"><span class="charoverride3">Day of Month Number</span>: Whole Number, Hidden (14)</li>
			</ul>
			<p class="normal1">We want to introduce the concept of <span class="charoverride2">filter-safe columns</span>. In a table, there are columns whose filters need to be preserved. The filters over filter-safe columns are not altered by the time intelligence calculations. They will be affecting the calculations presented in this pattern. The filter-safe columns in our sample table are the following:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride3">Day of Week</span>: ddd (Tue)</li>
				<li class="bull-list"><span class="charoverride3">Day of Week Number</span>: Whole Number, Hidden (6)</li>
				<li class="bull-list"><span class="charoverride3">Working Day</span>: Text (Working Day)</li>
			</ul>
			<p class="normal1">We further describe the behavior of filter-safe columns in the next section.</p>
			<p class="normal2">The <span class="charoverride3">Date</span> table in this pattern has one hierarchy:</p>
			<ul class="calibre1">
				<li class="bull-list">Fiscal: Year (<span class="charoverride3">Fiscal Year</span>), Quarter (<span class="charoverride3">Fiscal Year Quarter</span>), Month (<span class="charoverride3">Year Month</span>)</li>
			</ul>
			<p class="normal1">The columns are designed to simplify the formulas. For example, the <span class="charoverride3">Day of Fiscal Year Number</span> column contains the number of days since the beginning of the fiscal year, ignoring February 29 in leap years; this number makes it easier to find a corresponding range of dates in the previous year.</p>
			<p class="normal1">The <span class="charoverride3">Date</span> table must also include a hidden <span class="charoverride3">DateWithSales</span> calculated column, used by some of the formulas of this pattern: </p>
			<p class="code-block-screened-head">Calculated column in the Date table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-363">
					<img alt="" class="_idgenobjectattribute" src="images/000017.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Date[DateWithSales]</span> column is <span class="charoverride3">TRUE</span> if the date is on or before the last date with sales; it is <span class="charoverride3">FALSE</span> otherwise. In other words, <span class="charoverride3">DateWithSales</span> is <span class="charoverride3">TRUE</span> for “past” dates and <span class="charoverride3">FALSE</span> for “future” dates, where “past” and “future” are relative to the last date with sales.</p>
			<p class="normal1"><span class="charoverride8">In case you import a </span><span class="charoverride9">Date</span><span class="charoverride8"> table, you want to create columns that are similar to the ones we describe in this pattern, in that they should behave the same way.&nbsp;</span></p>
			<p class="heading" id="calibre_link-364">Understanding filter-safe columns</p>
			<p class="normal1">The <span class="charoverride3">Date</span> table contains two types of columns: regular columns and filter-safe columns. The regular columns are manipulated by the measures shown in this pattern. The filters over filter-safe columns are always preserved and never altered by the measures of this pattern. An example clarifies this distinction. The <span class="charoverride3">Year Month Number</span> column is a regular column: the formulas in this pattern have the option of changing its value during their computation.</p>
			<p class="normal1">For example, in order to compute the previous month the formulas change the filter context by subtracting one to the value of <span class="charoverride3">Year Month Number</span> in the filter context. Conversely, the <span class="charoverride3">Day of Week</span> column is a filter-safe column. If a user filters Monday to Friday, the formulas do not alter that filter on the day of the week. Therefore, a previous-year measure keeps the filter on the day of the week; it replaces only the filter on calendar columns such as year, month, and date.</p>
			<p class="normal1">To implement this pattern, you must identify which columns need to be treated as filter-safe columns, because filter-safe columns require special handling. The following is the classification of the columns used in the <span class="charoverride3">Date</span> table of this pattern:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride2">Calendar columns</span>: <span class="charoverride3">Date</span>, <span class="charoverride3">DateKey</span>, <span class="charoverride3">Sequential Day Number</span>, <span class="charoverride3">Year Month</span>, <span class="charoverride3">Year Month Number</span>, <span class="charoverride3">Month</span>, <span class="charoverride3">Fiscal Month Number</span>, <span class="charoverride3">Fiscal Month in Quarter Number</span>, <span class="charoverride3">Fiscal Year</span>, <span class="charoverride3">Fiscal Year Number</span>, <span class="charoverride3">Fiscal Year Quarter</span>, <span class="charoverride3">Fiscal Year Quarter Number</span>, <span class="charoverride3">Fiscal Quarter</span>, <span class="charoverride3">Day of Fiscal Year Number</span>, <span class="charoverride3">Day of Month Number</span> .</li>
				<li class="bull-list"><span class="charoverride2">Filter-safe columns</span>: <span class="charoverride3">Day of Week</span>, <span class="charoverride3">Day of Week Number</span>, <span class="charoverride3">Working Day</span>.</li>
			</ul>
			<p class="normal1">The special handling of filter-safe columns pertains to the filter context. Every measure in this pattern manipulates the filter context by replacing filters over all the calendar columns, without altering any filter applied to the filter-safe columns. In other words, every measure follows two rules:</p>
			<ul class="calibre1">
				<li class="bull-list">Remove filters on calendar columns;</li>
				<li class="bull-list">Keep filters on filter-safe columns.</li>
			</ul>
			<p class="normal1">The ALLEXCEPT function can implement these requirements; specify the <span class="charoverride3">Date</span> table in the first argument, and the filter-safe columns in the following arguments:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-365">
					<img alt="" class="_idgenobjectattribute" src="images/000311.png" />
				</div>
			</div>
			<p class="normal1">If the <span class="charoverride3">Date</span> table did not have any filter-safe column, the filters could be removed by using REMOVEFILTERS over the <span class="charoverride3">Date</span> table instead of ALLEXCEPT:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-366">
					<img alt="" class="_idgenobjectattribute" src="images/000355.png" />
				</div>
			</div>
			<p class="normal1">If your <span class="charoverride3">Date</span> table does not contain any filter-safe column, then you can use REMOVEFILTERS instead of ALLEXCEPT in all the measures of this pattern. We provide a complete scenario that includes filter-safe columns. Whenever possible, you can simplify it.</p>
			<p class="normal1">While the ALLEXCEPT should include all the filter-safe columns, we skip specifically the hidden filter-safe columns used only to sort other columns. For example, we do not include <span class="charoverride3">Day of Week Number</span>, which is a hidden column used to sort the <span class="charoverride3">Day of Week</span> column. The assumption is that the user never applies filters on hidden columns; if this assumption is not true, then the hidden filter-safe columns must also be included in the ALLEXCEPT arguments. You can find an example of the different results of using REMOVEFILTERS and ALLEXCEPT in the <span class="charoverride2">Year-to-date total</span> section of this pattern.</p>
			<p class="heading" id="calibre_link-367">Controlling the visualization on future dates</p>
			<p class="normal--unindented">Most of the time intelligence calculations should not display values for dates after the last date available. For example, a year-to-date calculation can also show values for future dates, but we want to hide those values. The dataset used in these examples ends on August 15, 2009. Therefore, we consider the month of August 2009, the third quarter of 2009 (Q3-2009), and the year 2009 as the last time periods with data. Any date later than August 15, 2019 is considered future, and we want to hide its values.</p>
			<p class="normal1">In order to avoid showing results in future dates, we use the following <span class="charoverride3">ShowValueForDates</span> measure. <span class="charoverride3">ShowValueForDates</span> returns TRUE if the period selected is earlier than the last period with data:</p>
			<p class="code-block-screened-head">Measure (hidden) in the Date table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-368">
					<img alt="" class="_idgenobjectattribute" src="images/000339.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">ShowValueForDates</span> measure is hidden. It is a technical measure created to reuse the same logic in many different time-related calculations, and the user should not use <span class="charoverride3">ShowValueForDates</span> directly in a report. The REMOVEFILTERS function removes filters from all tables in the model, because the purpose is to retrieve the last date used in the <span class="charoverride3">Sales</span> table regardless of filters.</p>
			<p class="heading" id="calibre_link-369">Naming convention</p>
			<p class="normal--unindented">This section describes the naming convention we adopted to reference the time intelligence calculations. A simple categorization shows whether a calculation:</p>
			<ul class="calibre1">
				<li class="bull-list">Shifts over a period of time, for example the same period in the previous year;</li>
				<li class="bull-list">Performs an aggregation, for example year-to-date; or,</li>
				<li class="bull-list">Compares two time periods, for example this year compared to last year.</li>
			</ul>
			<div class="_idgenobjectlayout">
				<div class="table-screenshot" id="calibre_link-370">
					<img alt="" class="_idgenobjectattribute" src="images/000433.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-371">Computing period-to-date totals</p>
			<p class="normal--unindented">The year-to-date, quarter-to-date, and month-to-date calculations modify the filter context for the <span class="charoverride3">Date</span> table, showing the values from the beginning of the period up to the last date available in the filter context.</p>
			<p class="heading" id="calibre_link-372">Year-to-date total</p>
			<p class="normal--unindented">The year-to-date aggregates data starting from the first day of the fiscal year, as shown in Figure 5-1. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-373">
					<img alt="" class="_idgenobjectattribute" src="images/000081.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-1</span> <span class="charoverride3">Sales YTD (simple)</span> shows the value for any time period, whereas <span class="charoverride3">Sales YTD</span> hides the result after the last period with data.</p>
			<p class="normal1">The measure filters all the days less than or equal to the last day visible in the last fiscal year. It also filters the last visible <span class="charoverride3">Fiscal Year Number</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-374">
					<img alt="" class="_idgenobjectattribute" src="images/000370.png" />
				</div>
			</div>
			<p class="normal1">Because <span class="charoverride3">LastDayAvailable</span> contains the last date visible in the filter context, <span class="charoverride3">Sales YTD (simple)</span> shows data even for future dates in the year. We can prevent this behavior in the <span class="charoverride3">Sales YTD</span> measure by returning a result only when <span class="charoverride3">ShowValueForDates</span> returns TRUE:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-375">
					<img alt="" class="_idgenobjectattribute" src="images/000385.png" />
				</div>
			</div>
			<p class="normal1">ALLEXCEPT is required to preserve the filter-safe columns <span class="charoverride3">Working Day</span> or <span class="charoverride3">Day of Week</span> in case they are used in the report. To demonstrate this, we created an incorrect measure: <span class="charoverride3">Sales YTD (wrong)</span>, which removes the filters from the <span class="charoverride3">Date</span> table by using REMOVEFILTERS instead of ALLEXCEPT. By doing this, the formula loses the filter on <span class="charoverride3">Working Day</span> used in the columns of the matrix, thus returning an inaccurate result:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-376">
					<img alt="" class="_idgenobjectattribute" src="images/000400.png" />
				</div>
			</div>
			<p class="normal1">Figure 5-2 shows the comparison of the correct and incorrect measures.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-377">
					<img alt="" class="_idgenobjectattribute" src="images/000096.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-2</span> <span class="charoverride3">Sales YTD (wrong)</span> shows Sales YTD calculated by ignoring the filter over <span class="charoverride3">Working Day</span>.</p>
			<p class="normal1">The <span class="charoverride3">Sales YTD (wrong)</span> measure would work well if the <span class="charoverride3">Date</span> table did not contain any filter-safe columns. The presence of filter-safe columns requires the use of ALLEXCEPT instead of REMOVEFILTERS. We used <span class="charoverride3">Sales YTD</span> as an example, but the same concept is valid for all the other measures in this pattern.</p>
			<p class="heading" id="calibre_link-378">Quarter-to-date total</p>
			<p class="normal--unindented">Quarter-to-date aggregates data starting from the first day of the fiscal quarter, as shown in Figure 5-3. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-379">
					<img alt="" class="_idgenobjectattribute" src="images/000125.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-3</span> <span class="charoverride3">Sales QTD</span> shows the quarter-to-date amount, which is blank for FY 2010 because there is no data in FQ4-2010.</p>
			<p class="normal1">The quarter-to-date value is computed using the same technique as the one used for the year-to-date total. The only difference is the filter on <span class="charoverride3">Fiscal Year Quarter Number</span> instead of on <span class="charoverride3">Fiscal Year Number</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-380">
					<img alt="" class="_idgenobjectattribute" src="images/000414.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-381">Month-to-date total</p>
			<p class="normal--unindented">The month-to-date aggregates data from the first day of the month, as shown in Figure 5-4. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-382">
					<img alt="" class="_idgenobjectattribute" src="images/000138.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-4</span> <span class="charoverride3">Sales MTD</span> shows the month-to-date amount, which is blank for FY 2010 because there is no data after August 15, 2009.</p>
			<p class="normal1">The month-to-date total is computed with a technique similar to the technique used in year-to-date total and quarter-to-date total. It filters all the days that are less than or equal to the last day visible in the last month. The filters are applied to the <span class="charoverride3">Day of Month Number</span> and <span class="charoverride3">Year Month Number</span> columns:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-383">
					<img alt="" class="_idgenobjectattribute" src="images/000428.png" />
				</div>
			</div>
			<p class="normal1">The measure filters <span class="charoverride3">Day of Month Number</span> instead of <span class="charoverride3">Day of Fiscal Year Number</span>. The goal is to filter a column with a lower number of unique values, which is a best practice from a query performance standpoint (the quarter-to-date total does not apply this optimization because the performance advantage would be minimal).</p>
			<p class="heading1" id="calibre_link-384">Computing period-over-period growth</p>
			<p class="normal--unindented">A common requirement is to compare a time period with the same period in the previous year, quarter, or month. The last month/quarter/year could be incomplete. In order to achieve a fair comparison, the measure should work on an equivalent time period. For these reasons, the calculations shown in this section use the <span class="charoverride3">Date[DateWithSales]</span> calculated column as described in the article, <a href="https://www.sqlbi.com/articles/hiding-future-dates-for-calculations-in-dax/"><span class="hyperlink">Hiding future dates for calculations in DAX</span></a>.</p>
			<p class="heading" id="calibre_link-385">Year-over-year growth</p>
			<p class="normal--unindented">Year-over-year compares a time period to its equivalent in the previous year. In this example, data is available until August 15, 2009. For this reason, <span class="charoverride3">Sales PY</span> shows numbers related to FY 2010, and just considers transactions made before August 15, 2008. Figure 5-5 shows that <span class="charoverride3">Sales Amount</span> in August 2009 is 721,560.95, whereas <span class="charoverride3">Sales PY</span> in August 2009 returns 296,529.51 because the measure considers only the sales made up to August 15, 2008.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-386">
					<img alt="" class="_idgenobjectattribute" src="images/000151.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-5</span>  For August 2009, <span class="charoverride3">Sales PY</span> shows the amount for August 1-15, 2008 because there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PY</span> uses a standard technique that shifts the selection by the number of months defined in the <span class="charoverride3">MonthsOffset</span> variable. In <span class="charoverride3">Sales PY</span> the variable is set to 12, to move time back by 12 months. The next measures <span class="charoverride3">Sales PQ</span> and <span class="charoverride3">Sales PM</span> use the same code, the only difference being the value assigned to <span class="charoverride3">MonthsOffset</span>.</p>
			<p class="normal1"><span class="charoverride3">Sales PY </span>iterates every month active in the filter context. For each month, it checks whether the days selected in the month correspond to all the days of the month, taking into account the filter-safe columns &ndash; <span class="charoverride3">Working Day</span> and <span class="charoverride3">Day of Week</span> in our example. If all the days are selected, it means that the current filter context includes a full month. Therefore, the filter is shifted back to the previous full month. If not all the days are selected, it means that the user has placed one or more filters on calendar columns that show a partial month. In that case, the selected days are shifted back in the corresponding month of the previous year. The filter over <span class="charoverride3">Date[DateWithSales]</span> guarantees a fair comparison with the last period with data:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-387">
					<img alt="" class="_idgenobjectattribute" src="images/000442.png" />
				</div>
			</div>
			<p class="normal1">The year-over-year growth is computed as an amount in <span class="charoverride3">Sales YOY,</span> and as a percentage in <span class="charoverride3">Sales YOY %</span>. Both measures use <span class="charoverride3">Sales PY</span> to consider only dates up to August 15, 2009:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-388">
					<img alt="" class="_idgenobjectattribute" src="images/000456.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-389">
					<img alt="" class="_idgenobjectattribute" src="images/000555.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-390">Quarter-over-quarter growth</p>
			<p class="normal--unindented">Quarter-over-quarter compares a time period with its equivalent in the previous quarter. In this example, data is available until August 15, 2009, which is the first 15 days of the third month in the second quarter of FY 2010. Therefore, <span class="charoverride3">Sales PQ</span> for August 2009 (the third month of the second quarter) shows sales until May 15, 2009, which is the first 15 days of the third month of the previous quarter. Figure 5-6 shows that <span class="charoverride3">Sales Amount</span> in May 2009 is 1,067,165.23, whereas <span class="charoverride3">Sales PQ</span> in August 2009 returns 435,306.10 thus only taking into account sales made up to May 15, 2009.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-391">
					<img alt="" class="_idgenobjectattribute" src="images/000164.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-6</span> For August 2009, <span class="charoverride3">Sales PQ shows</span> the amount for May 1-15, 2009; indeed, there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PQ</span> also uses the technique described for <span class="charoverride3">Sales PY</span>. The only difference is that <span class="charoverride3">MonthsOffset</span> is set to 3 months instead of 12:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-392">
					<img alt="" class="_idgenobjectattribute" src="images/000470.png" />
				</div>
			</div>
			<p class="normal1">The quarter-over-quarter growth is computed as an amount in <span class="charoverride3">Sales QOQ</span> and as a percentage in <span class="charoverride3">Sales QOQ %</span>. Both measures use <span class="charoverride3">Sales PQ</span> to guarantee a fair comparison: </p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-393">
					<img alt="" class="_idgenobjectattribute" src="images/000484.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-394">
					<img alt="" class="_idgenobjectattribute" src="images/000012.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-395">Month-over-month growth</p>
			<p class="normal--unindented">Month-over-month compares a time period with its equivalent in the previous month. In this example, data is only available until August 15, 2009. For this reason, <span class="charoverride3">Sales PM</span> only takes sales between July 1-15, 2009 into account in order to return a value for August 2009. That way, it only returns the corresponding portion of the previous month. Figure 5-7 shows that <span class="charoverride3">Sales Amount</span> for July 2009 is 1,068,396.58, whereas <span class="charoverride3">Sales PM</span> of August 2019 returns 584,212.78 &ndash; since it only takes into account sales up to July 15, 2009.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-396">
					<img alt="" class="_idgenobjectattribute" src="images/000177.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-7</span>  For August 2009, <span class="charoverride3">Sales PM</span> shows the amount in the July 1-15, 2009 time period; indeed, there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PM</span> uses the technique described for <span class="charoverride3">Sales PY</span>. The only difference is that <span class="charoverride3">MonthsOffset</span> is set to 1 month instead of 12:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-397">
					<img alt="" class="_idgenobjectattribute" src="images/000497.png" />
				</div>
			</div>
			<p class="normal1">The month-over-month growth is computed as an amount in <span class="charoverride3">Sales MOM</span> and as a percentage in <span class="charoverride3">Sales MOM %</span>. Both measures use <span class="charoverride3">Sales PM</span> to guarantee a fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-398">
					<img alt="" class="_idgenobjectattribute" src="images/000512.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-399">
					<img alt="" class="_idgenobjectattribute" src="images/000054.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-400">Period-over-period growth</p>
			<p class="normal--unindented">Period-over-period growth automatically selects one of the measures previously described in this section based on the current selection of the visualization. For example, it returns the value of month-over-month growth measures if the visualization displays data at the month level; but it switches to year-over-year growth measures if the visualization shows the total at the year level. The result is visible in Figure 5-8.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-401">
					<img alt="" class="_idgenobjectattribute" src="images/000191.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-8</span> <span class="charoverride3">Sales PP</span> shows the value of the previous month at the month level, of the previous quarter at the quarter level, and of the previous year at the year level.</p>
			<p class="normal1">The three measures <span class="charoverride3">Sales PP</span>, <span class="charoverride3">Sales POP</span>, and <span class="charoverride3">Sales POP %</span> redirect the evaluation to the corresponding year, quarter, and month measures depending on the level selected in the report. ISINSCOPE detects the level used in the report. The arguments passed to ISINSCOPE are the attributes used in the rows of the Matrix visual in Figure 5-8. The measures are defined as follows:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-402">
					<img alt="" class="_idgenobjectattribute" src="images/000527.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-403">
					<img alt="" class="_idgenobjectattribute" src="images/000541.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-404">
					<img alt="" class="_idgenobjectattribute" src="images/000556.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-405">Computing period-to-date growth</p>
			<p class="normal--unindented">The growth of a “to-date” measure is the comparison of the “to-date” measure with the same measure over an equivalent period with a specific offset. For example, you can compare a year-to-date aggregation against the year-to-date in the previous year, that is with an offset of one year.</p>
			<p class="normal1">All the measures in this set of calculations take care of partial time periods. Because data is available only until August 15, 2009 in our example, the measures make sure the previous year does not report dates after August 15, 2008.</p>
			<p class="heading" id="calibre_link-406">Year-over-year-to-date growth</p>
			<p class="normal--unindented">Year-over-year-to-date growth compares the year-to-date at a specific date with the year-to-date at an equivalent date in the previous year. Figure 5-9 shows that <span class="charoverride3">Sales PYTD</span> in FY 2010 is considering only sales until August 15, 2008. For this reason, <span class="charoverride3">Sales YTD</span> of FQ2-2009 is 4,909,687.61, whereas <span class="charoverride3">Sales PYTD</span> for FQ2-2010 is less at 4,484,656.17.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-407">
					<img alt="" class="_idgenobjectattribute" src="images/000204.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-9</span>  For FQ2-2010, <span class="charoverride3">Sales PYTD</span> shows the amount of March 1-August 15, 2008 because there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PYTD</span> is like <span class="charoverride3">Sales YTD</span>, in that it filters the previous value in <span class="charoverride3">Fiscal Year Number</span> instead of the last year visible in the filter context. The main difference is the evaluation of <span class="charoverride3">LastDayOfFiscalYearAvailable</span>; it must take into account only dates with sales, and ignore the filter on filter-safe columns which matter in the evaluation of <span class="charoverride3">Sales Amount</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-408">
					<img alt="" class="_idgenobjectattribute" src="images/000570.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales YOYTD</span> and <span class="charoverride3">Sales YOYTD %</span> rely on <span class="charoverride3">Sales PYTD</span> to guarantee a fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-409">
					<img alt="" class="_idgenobjectattribute" src="images/000169.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-410">
					<img alt="" class="_idgenobjectattribute" src="images/000140.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-411">Quarter-over-quarter-to-date growth</p>
			<p class="normal--unindented">Quarter-over-quarter-to-date growth compares the quarter-to-date at a specific date with the quarter-to-date at an equivalent date in the previous quarter. Figure 5-10 shows that <span class="charoverride3">Sales PQ</span> in August 2009 is just taking into account transactions performed up to May 15, 2008, to get the corresponding part of the previous quarter. For this reason <span class="charoverride3">Sales QTD</span> of May 2009 is 2,242,196.31, whereas <span class="charoverride3">Sales PQTD</span> for August 2009 is lower at 1,610,337.18.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-412">
					<img alt="" class="_idgenobjectattribute" src="images/000217.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-10</span> <span class="charoverride3">Sales PQTD</span> shows for Aug 2009 the amount of the March 1-May 15, 2009 period, because there is no data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PQTD</span> performs several steps, some of which are somewhat complex. The first two variables are quite easy: <span class="charoverride3">LastMonthSelected</span> contains the last month visible in the filter context, while <span class="charoverride3">DaysOnLastMonth</span> contains the number of days in <span class="charoverride3">LastMonthSelected</span>. </p>
			<p class="normal1">It is important to note that if <span class="charoverride3">DaysOnLastMonth</span> is equal to <span class="charoverride3">DaysLastMonthSelected</span>, it means that the current filter context includes the end of a month; therefore the corresponding selection in the previous quarter must include the entire relative month. If <span class="charoverride3">DaysOnLastMonth</span> is not equal to <span class="charoverride3">DaysLastMonthSelected</span>, then the filter context is restricting the number of visible days. Consequently, we compute the last day of the month with data and we restrict the result to go only up to the same day number in the relative month within the previous quarter. This calculation takes place in <span class="charoverride3">LastDayOfMonthWithSales</span>, which contains the last day of the month with sales regardless of the filter-safe columns.</p>
			<p class="normal1">If the selection in the last month includes the whole month, then <span class="charoverride3">LastDayOfMonthWithSales</span> contains the fixed value 31, which is a number greater than or equal to all the other days of a month. A similar calculation occurs with <span class="charoverride3">LastMonthInQuarterWithSales</span>, this time with the month number. These two variables are used to compute <span class="charoverride3">FilterQTD</span> in the last step. <span class="charoverride3">FilterQTD</span> contains all the pairs of (<span class="charoverride3">FiscalMonthInQuarter</span>, <span class="charoverride3">FiscalDayInMonth</span>) that are less than or equal to the pair (<span class="charoverride3">LastMonthInQuarterWithSales</span>, <span class="charoverride3">LastDayOfMonthWithSales</span>). By using ISONORAFTER ( …, DESC ) we obtain the effect we would get by using NOT ISONORAFTER with the default ASC sort order:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-413">
					<img alt="" class="_idgenobjectattribute" src="images/000584.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-414">
					<img alt="" class="_idgenobjectattribute" src="images/000001.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales QOQTD</span> and <span class="charoverride3">Sales QOQTD %</span> rely on <span class="charoverride3">Sales PQTD</span> to guarantee a fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-415">
					<img alt="" class="_idgenobjectattribute" src="images/000196.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-416">
					<img alt="" class="_idgenobjectattribute" src="images/000193.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-417">Month-over-month-to-date growth</p>
			<p class="normal--unindented">Month-over-month-to-date growth compares a month-to-date at a specific date with the month-to-date at an equivalent date in the previous month. Figure 5-11 shows that <span class="charoverride3">Sales PMTD</span> in August 2009 is only taking sales made up to July 15, 2009 into account, to get the corresponding portion of the previous month. For this reason <span class="charoverride3">Sales MTD</span> of July 2009 is 1,068,396.58, whereas <span class="charoverride3">Sales PMTD</span> for August 2009 is lower: 584,212.78.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-418">
					<img alt="" class="_idgenobjectattribute" src="images/000230.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-11</span>  For Aug 2009, <span class="charoverride3">Sales PQTD</span> shows the amount of the July 1-15, 2009 period, because there is no sales data after August 15, 2009.</p>
			<p class="normal1"><span class="charoverride3">Sales PMTD</span> performs several steps, some of which are somewhat complex. The first two variables are quite easy: <span class="charoverride3">LastMonthSelected</span> contains the last month visible in the filter context, while <span class="charoverride3">DaysOnLastMonth</span> contains the number of days in <span class="charoverride3">LastMonthSelected</span>. </p>
			<p class="normal1">It is important to note that if <span class="charoverride3">DaysOnLastMonth</span> is equal to <span class="charoverride3">DaysLastMonthSelected</span>, it means that the current filter context includes the end of a month; therefore the corresponding selection in the previous month must include the complete month. If <span class="charoverride3">DaysOnLastMonth</span> is not equal to <span class="charoverride3">DaysLastMonthSelected</span>, then the filter context is restricting the number of visible days. Consequently, we compute the last day of the month with data, and we restrict the result to only go up to the same day number in the previous month. This calculation takes place in <span class="charoverride3">LastDayOfMonthWithSales</span>, which contains the last day of the month with sales data regardless of the filter-safe columns.</p>
			<p class="normal1">If the selection in the last month includes the whole month, then <span class="charoverride3">LastDayOfMonthWithSales</span> contains the fixed value 31, which is a number greater than or equal to all the other days of a month. The <span class="charoverride3">LastDayOfMonthWithSales</span> is then used to filter the days in the previous month, which is obtained by subtracting one to the value of <span class="charoverride3">LastMonthSelected</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-419">
					<img alt="" class="_idgenobjectattribute" src="images/000013.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales MOMTD</span> and <span class="charoverride3">Sales MOMTD %</span> rely on the <span class="charoverride3">Sales PMTD</span> measure to guarantee a fair comparison:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-420">
					<img alt="" class="_idgenobjectattribute" src="images/000027.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-421">
					<img alt="" class="_idgenobjectattribute" src="images/000232.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-422">Comparing period-to-date with a previous full period</p>
			<p class="normal--unindented">Comparing a to-date aggregation with the previous full time period is useful when you look at the previous period as a benchmark. Once the current year-to-date reaches 100% of the full previous year, this means you have reached the same performance as the previous full period, hopefully in fewer days.</p>
			<p class="heading" id="calibre_link-423">Year-to-date over the full previous year</p>
			<p class="normal--unindented">The year-to-date over the full previous year compares the year-to-date against the entire previous year. Figure 5-12 shows that in January 2009 (which is close to the end of FY 2009) <span class="charoverride3">Sales YTD</span> is 10% lower than <span class="charoverride3">Sales Amount</span> for the entire fiscal year 2008. <span class="charoverride3">Sales YTDOPY % </span>provides an immediate comparison of the year-to-date with the total of the previous year; it shows growth over the previous year when the percentage is positive, which never happens in this example.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-424">
					<img alt="" class="_idgenobjectattribute" src="images/000243.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-12</span> <span class="charoverride3">Sales YTDOPY %</span> shows a negative value corresponding to the missing percentage of <span class="charoverride3">Sales YTD</span> to reach the total <span class="charoverride3">Sales Amount</span> of the previous year.</p>
			<p class="normal1">The year-to-date-over-previous-year growth is computed by the <span class="charoverride3">Sales YTDOPY</span> and <span class="charoverride3">Sales YTDOPY %</span> measures; these rely on the <span class="charoverride3">Sales YTD</span> measure to compute the year-to-date value, and on the <span class="charoverride3">Sales PYC</span> measure to get the sales amount of the entire previous year:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-425">
					<img alt="" class="_idgenobjectattribute" src="images/000077.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-426">
					<img alt="" class="_idgenobjectattribute" src="images/000260.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-427">
					<img alt="" class="_idgenobjectattribute" src="images/000274.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-428">Quarter-to-date over the full previous quarter</p>
			<p class="normal--unindented">The quarter-to-date over the full previous quarter compares the quarter-to-date against the entire previous quarter. Figure 5-13 shows that <span class="charoverride3">Sales QTD</span> surpassed the total <span class="charoverride3">Sales Amount</span> for FQ1-2008 only in August 2008. <span class="charoverride3">Sales QTDOPQ %</span> provides an immediate comparison of the quarter-to-date with the total of the previous quarter; it shows growth over the previous quarter when the percentage is positive.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-429">
					<img alt="" class="_idgenobjectattribute" src="images/000258.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-13</span> <span class="charoverride3">Sales QTDOPQ %</span> shows a positive percentage in August 2008, when <span class="charoverride3">Sales QTD</span> is greater than the <span class="charoverride3">Sales Amount</span> for FQ1-2008.</p>
			<p class="normal1">The quarter-to-date-over-previous-quarter growth is computed with the <span class="charoverride3">Sales QTDOPQ</span> and <span class="charoverride3">Sales QTDOPQ %</span> measures; these rely on the <span class="charoverride3">Sales QTD</span> measure to compute the quarter-to-date value and on the <span class="charoverride3">Sales PQC</span> measure to get the sales amount of the entire previous quarter:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-430">
					<img alt="" class="_idgenobjectattribute" src="images/000041.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-431">
					<img alt="" class="_idgenobjectattribute" src="images/000055.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-432">
					<img alt="" class="_idgenobjectattribute" src="images/000376.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-433">Month-to-date over the full previous month</p>
			<p class="normal--unindented">The month-to-date over the full previous month compares the month-to-date against the entire previous month. Figure 5-14 shows that <span class="charoverride3">Sales MTD</span> during April 2008 surpasses the total <span class="charoverride3">Sales Amount</span> for March 2008. <span class="charoverride3">Sales MTDOPM %</span> provides an immediate comparison of the month-to-date with the total of the previous month; it shows growth over the previous month when the percentage is positive as is the case starting April 19, 2008.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-434">
					<img alt="" class="_idgenobjectattribute" src="images/000272.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-14</span> <span class="charoverride3">Sales MTDOPM %</span> shows a positive percentage starting from April 19, 2008, when <span class="charoverride3">Sales MTD</span> starts to be greater than the <span class="charoverride3">Sales Amount</span> for March 2008.</p>
			<p class="normal1">The month-to-date-over-previous-month growth is computed with the <span class="charoverride3">Sales MTDOPM %</span> and <span class="charoverride3">Sales MTDOPM</span> measures; these rely on the <span class="charoverride3">Sales MTD</span> measure to compute the month-to-date value and on the <span class="charoverride3">Sales PMC</span> measure to get the sales amount of the entire previous month:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-435">
					<img alt="" class="_idgenobjectattribute" src="images/000069.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-436">
					<img alt="" class="_idgenobjectattribute" src="images/000084.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-437">
					<img alt="" class="_idgenobjectattribute" src="images/000434.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-438">Using moving annual total calculations</p>
			<p class="normal--unindented">A common way of aggregating data over several months is by using the moving annual total instead of the year-to-date. The moving annual total includes the last 12 months of data. For example, the moving annual total for March 2008 includes data from April 2007 to March 2008. </p>
			<p class="heading" id="calibre_link-439">Moving annual total</p>
			<p class="normal--unindented"><span class="charoverride3">Sales MAT</span> computes the moving annual total, as shown in Figure 5-15. The same report also shows <span class="charoverride3">Sales MAT (364):</span> it is a similar measure with the difference that it uses the last 364 days (corresponding to the last 52 weeks), instead of a full year.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-440">
					<img alt="" class="_idgenobjectattribute" src="images/000286.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-15</span> <span class="charoverride3">Sales MAT</span> in March 2008 aggregates <span class="charoverride3">Sales Amount</span> from April 2007 to March 2008.</p>
			<p class="normal1">The <span class="charoverride3">Sales MAT </span>measure defines a range over the <span class="charoverride3">Date[Date]</span> column that includes the days of one complete year starting from the last day in the filter context:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-441">
					<img alt="" class="_idgenobjectattribute" src="images/000099.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">Sales MAT (364)</span> does not correspond to a total over the year. Yet, it is a good measure to evaluate trends over time or in a chart because it always includes the same number of days and an integer number of weeks. Consequently, the days of the week are evenly represented in the result. The measure defines a range over the <span class="charoverride3">Date[Date]</span> column that includes the last 364 days from the last day in the filter context:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-442">
					<img alt="" class="_idgenobjectattribute" src="images/000114.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-443">Moving annual total growth</p>
			<p class="normal--unindented">The moving annual total growth is computed with the <span class="charoverride3">Sales PYMAT</span>, <span class="charoverride3">Sales MATG</span>, and <span class="charoverride3">Sales MATG %</span> measures, which rely on the <span class="charoverride3">Sales MAT</span> measure. The <span class="charoverride3">Sales MAT</span> measure provides a correct value one year after the first sale ever (when it collects one full year of data), and it is not protected in case the current time period is shorter than a full year. For example, the amount for the fiscal year 2010 of <span class="charoverride3">Sales PYMAT</span> is 9,874,218.49, which corresponds to the <span class="charoverride3">Sales Amount</span> of FY 2009 as shown in Figure 5-16. When compared with sales in FY 2010, this produces a comparison of less than 6 months &ndash; data being only available until August 15, 2009 &ndash; with the full fiscal year 2009. Similarly, you can see that <span class="charoverride3">Sales MATG %</span> starts in FY 2009 with very high values and stabilizes after a year. This behavior is by design: the moving annual total is usually computed at the month or day granularity to show trends in a chart.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-444">
					<img alt="" class="_idgenobjectattribute" src="images/000301.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-16</span> <span class="charoverride3">Sales MATG %</span> shows the growth between <span class="charoverride3">Sales MAT</span> and <span class="charoverride3">Sales PYMAT</span> as a percentage.</p>
			<p class="normal1">The measures are defined as follows:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-445">
					<img alt="" class="_idgenobjectattribute" src="images/000347.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-446">
					<img alt="" class="_idgenobjectattribute" src="images/000277.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-447">
					<img alt="" class="_idgenobjectattribute" src="images/000502.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Sales PYMAT</span> measure can also be written using the last 364 days, similar to <span class="charoverride3">Sales MAT (364)</span> &ndash; the difference between <span class="charoverride3">Sales PYMAT</span> and <span class="charoverride3">Sales PYMAT (364)</span> is the evaluation of the <span class="charoverride3">FirstDayMAT</span> and the <span class="charoverride3">LastDayMAT</span> variables:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-448">
					<img alt="" class="_idgenobjectattribute" src="images/000362.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-449">Moving averages</p>
			<p class="normal--unindented">The moving average is typically used to display trends in line charts. Figure 5-17 includes the moving average of <span class="charoverride3">Sales Amount</span> over 30 days (<span class="charoverride3">Sales AVG 30D</span>), three months (<span class="charoverride3">Sales AVG 3M</span>), and a year (<span class="charoverride3">Sales AVG 1Y</span>).</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-450">
					<img alt="" class="_idgenobjectattribute" src="images/000315.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 5-17</span> <span class="charoverride3"> Sales AVG 30D</span>, <span class="charoverride3">Sales AVG 3M</span>, and <span class="charoverride3">Sales AVG 1Y</span> show the moving average over 30 days, three months, and one year, respectively.</p>
			<p class="heading" id="calibre_link-451">Moving average 30 days</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 30D</span> measure computes the moving average over 30 days by iterating a list of the last 30 dates obtained in the <span class="charoverride3">Period30D</span> variable. It does so by fetching the dates visible included in the last 30 days, while ignoring dates without sales and taking into account filters applied by filter-safe columns in the <span class="charoverride3">Date</span> table:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-452">
					<img alt="" class="_idgenobjectattribute" src="images/000319.png" />
				</div>
			</div>
			<p class="normal1">This pattern is very flexible because it also works for non-additive measures. With that said, for a regular additive calculation <span class="charoverride3">Result</span> can be implemented using a different and faster formula:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-453">
					<img alt="" class="_idgenobjectattribute" src="images/000088.png" />
				</div>
			</div>
			<p class="normal3"><span class="charoverride10">Moving average 3 months</span></p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 3M</span> measure computes the moving average over three months. It iterates a list of the dates in the last three months obtained in the <span class="charoverride3">Period3M</span> variable by getting the dates visible included in the last 3 months, by ignoring dates without sales and by taking into account the filters applied by filter-safe columns in the <span class="charoverride3">Date</span> table:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-454">
					<img alt="" class="_idgenobjectattribute" src="images/000103.png" />
				</div>
			</div>
			<p class="normal1">For simple additive measures, the pattern based on DIVIDE which is shown for the moving average over 30 days can also be used for the average over three months.</p>
			<p class="heading" id="calibre_link-455">Moving average 1 year</p>
			<p class="normal--unindented">The <span class="charoverride3">Sales AVG 1Y</span> measure computes the moving average over one year by iterating a list of the dates in the last year in the <span class="charoverride3">Period1Y </span>variable. It does so by getting the dates visible included in the last year, by ignoring dates without sales and by taking into account filters applied by filter-safe columns in the <span class="charoverride3">Date</span> table:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-456">
					<img alt="" class="_idgenobjectattribute" src="images/000180.png" />
				</div>
			</div>
			<p class="normal1">For simple additive measures, the pattern based on DIVIDE shown for the moving average over 30 days can also be used for the average over one year.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-457">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-458">
			</div>
		</div>
	</div>


<div id="calibre_link-13" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-459">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture4" id="calibre_link-460">
					<img alt="" class="_idgenobjectattribute" src="images/000333.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 6</p>
			<p class="ch-title--no-toc" id="calibre_link-461"><a id="calibre_link-462" class="calibre2"></a>Comparing different time periods</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-205"><span class="hyperlink1">https://sql.bi/dax-205</span></a></p>
			<p class="normal--unindented">This pattern is a useful technique to compare the value of a measure in different time periods. For example, we can compare the sales of the last month against a user-defined period. The two time periods might have a different number of days, like comparing one month against a full year. When the durations of both time periods are different, we should adjust the values to make a fair comparison.</p>
			<p class="heading1" id="calibre_link-463">Pattern description</p>
			<p class="normal--unindented">The user selects two different time periods (current, comparison) through slicers. The report in Figure 6-1 shows the sales in the current period and in a comparison period. The sales of the comparison period must be adjusted using the number of days in each period as the allocation factor.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-464">
					<img alt="" class="_idgenobjectattribute" src="images/000279.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 6-1</span> The report shows sales in different periods, alongside the adjusted comparison value.</p>
			<p class="normal1">In order to enable the choice of two different time periods, the model must contain two date tables: one to select the current period, one to select the comparison period. As shown in Figure 6-2, the additional <span class="charoverride3">Comparison Date</span> table is linked to the original <span class="charoverride3">Date</span> table with an inactive relationship: This simplifies the handling of relationships with other fact tables.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-465">
					<img alt="" class="_idgenobjectattribute" src="images/000294.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 6-2</span> The <span class="charoverride3">Comparison Date</span> table is linked to the <span class="charoverride3">Date</span> table through an inactive relationship.</p>
			<p class="normal1">When a measure evaluates an expression filtered by the <span class="charoverride3">Comparison Date</span> table, the measure expression activates the relationship between <span class="charoverride3">Comparison Date</span> and <span class="charoverride3">Date</span>; it also performs a REMOVEFILTERS on the <span class="charoverride3">Date</span> table in order to use - in <span class="charoverride3">Sales</span> - the filter from <span class="charoverride3">Comparison Date</span>. Using this model, any existing measure can compute the value in the current or comparison period with a simple change in the active relationship.</p>
			<p class="normal1">The following is the definition of the <span class="charoverride3">Comparison Sales Amount</span> measure:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-466">
					<img alt="" class="_idgenobjectattribute" src="images/000579.png" />
				</div>
			</div>
			<p class="normal1">In order to adjust the value of <span class="charoverride3">Comparison Sales Amount</span>, we need an allocation method. In the example we use the number of days in the two periods as the allocation factor; the business logic may dictate that only working days should be used for the adjustment. In other words, a different adjustment logic is possible and depends on the business requirements.</p>
			<p class="normal1">In this example of adjustment logic, if the comparison period has more days than the current time period, we reduce the <span class="charoverride3">Comparison Sales Amount</span> result according to the ratio between the number of days in the two periods:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-467">
					<img alt="" class="_idgenobjectattribute" src="images/000536.png" />
				</div>
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-468">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-469">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-470">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-471">
			</div>
		</div>
	</div>


<div id="calibre_link-0" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-472">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture5" id="calibre_link-473">
					<img alt="" class="_idgenobjectattribute" src="images/000316.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 7</p>
			<p class="ch-title--no-toc" id="calibre_link-474"><a id="calibre_link-475" class="calibre2"></a>Semi-additive calculations</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-206"><span class="hyperlink1">https://sql.bi/dax-206</span></a></p>
			<p class="normal--unindented">Calculations reporting values at the start or the end of a time period are quite the challenge for any BI developer, and DAX is no exception. These measures are not hard to compute; the complicated part is understanding the desired behavior precisely. These calculations do not work by aggregating values throughout the entire period, as you would typically do for sales amounts. Instead, the calculations should return the value at the beginning or the end of a selected time period. These calculations are also known as semi-additive calculations. They are semi-additive because they do sum up specific attributes, like customers, but not over other attributes, like dates, all the while reporting the value at the beginning or end of the period.</p>
			<p class="normal1">As an example, we use a model that contains the current balance of bank accounts. Over the customers, the measure must be additive: the total balance for all customers is the sum of the balance for each customer. Nevertheless, when aggregating over time you cannot use the SUM function. The balance of a quarter is not the sum of individual monthly balances. Instead, the measure should report the last balance of the quarter.</p>
			<p class="normal1">There are many details that need to be addressed when defining the meaning of <span class="charoverride3">start or end of the period</span>. This is the reason why this pattern contains many examples. We suggest you read all of them, so to better understand the subtle differences between the different examples before choosing the correct one for your specific scenario.</p>
			<p class="heading1" id="calibre_link-476">Introduction</p>
			<p class="normal--unindented">You have a model containing the balance of a few customers’ accounts. For each date, the number reported is the balance at that date. There are different reporting dates for different customers, as shown in Figure 7-1.  </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-477">
					<img alt="" class="_idgenobjectattribute" src="images/000171.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 7-1</span> The source table contains customer account balances at different dates.</p>
			<p class="normal1">Because of the nature of the data, you cannot aggregate using SUM over time. Instead, you need to aggregate values at the month, quarter, and year level using the first or the last value of the period. Before looking at the code, you need to focus on some important details by answering the following questions:</p>
			<ol class="calibre3">
				<li class="num-list">What is the end balance of Katie Jordan’s account for 2020? Her last available balance is on September 30, so should we consider this to be the final value for 2020? Similarly, is the balance of Luis Bonifaz’s account zero or is it 1,813.00 at the end of 2020?</li>
				<li class="num-list">What is the total end balance over all three customers for 2020? Is it only the amount on Maurizio Macagno’s account &ndash; because his balance is the last one &ndash; or is it the sum of the last balance for each customer, at their respective dates?</li>
				<li class="num-list">What is the starting balance of 2020 for Luis Bonifaz? Is it the balance on January 1, 2020 or December 27/31, 2019?</li>
			</ol>
			<p class="normal1">As you see, there are multiple valid answers to each question, and none of them is more correct than the others. Depending on your requirements, you choose the pattern that best fits your needs. Indeed, all these patterns compute the balance at the start or the end of a period. The only and very relevant difference, is in the definition of what <span class="charoverride3">end of period</span> means.</p>
			<p class="heading1" id="calibre_link-478">First and last date</p>
			<p class="normal--unindented">The first and last date pattern is the simplest one. However, it can only be adopted in the few scenarios where the dataset always contains data at the beginning and at the end of each time period. The formula returns the balance using the first and last date of the <span class="charoverride3">Date</span> table in the current filter context, regardless of whether data is present on the given date. If there is no balance on that date, its result is blank:</p>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-479">
					<img alt="" class="_idgenobjectattribute" src="images/000507.png" />
				</div>
			</div>
			<p class="normal1">This formula produces the result in Figure 7-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-480">
					<img alt="" class="_idgenobjectattribute" src="images/000185.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 7-2</span> The report shows the balance on the last date from the Date table.</p>
			<p class="normal1">On months where data is not available on the last day of the month, the measure reports a blank. This pattern is the fastest among our many examples, but it only returns accurate results when data is stored on each and every day, or at least at the end of each and every time period. Therefore, it is the preferred pattern for example in financial applications where data is reported once every month.</p>
			<p class="heading1" id="calibre_link-481">First and last date with data</p>
			<p class="normal--unindented">In this pattern, the formula searches the last date for which there is data in the current filter context. Therefore, instead of finding the last date in the <span class="charoverride3">Date</span> table, it searches for the last date in the <span class="charoverride3">Balances</span> table. The result is visible in Figure 7-3.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-482">
					<img alt="" class="_idgenobjectattribute" src="images/000198.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 7-3</span> The report shows the balance on the last date with data.</p>
			<p class="normal1">The formula first finds the last date to use, by finding the last date for which there is any data in the model. It then applies it as a filter:</p>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-483">
					<img alt="" class="_idgenobjectattribute" src="images/000021.png" />
				</div>
			</div>
			<p class="normal1">It is worth noting the presence of ALLEXCEPT in the calculation of <span class="charoverride3">MaxBalanceDate</span>. ALLEXCEPT is needed in order to avoid obtaining the last date in the current context, which would use a different date for each customer and at the total level. ALLEXCEPT guarantees that the same date is used for all the customers. In your specific scenario you might have to modify that filter to accommodate for further requirements.</p>
			<p class="normal1">In case you do not want to use the same date for all the customers, but instead you want to use a different date for every customer and total those values, then this is not the right pattern. You need to use the <span class="charoverride4">First and last date by customer</span> pattern.</p>
			<p class="normal1">An alternative implementation of this pattern based on LASTNONBLANK is less efficient. It should only be used when the business logic determining whether a date should be considered or not is more complex than just looking at the presence of a row in the <span class="charoverride3">Balances</span> table. For example, the following implementation produces the same result as the previous formula with slower execution time and larger memory consumption at query time:</p>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-484">
					<img alt="" class="_idgenobjectattribute" src="images/000035.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-485">First and last date by customer</p>
			<p class="normal--unindented">If the dataset contains different dates for each customer - or in general for each entity - then the pattern is different. For each customer you must compute its last date, obtaining the subtotals by summing partial results across other non-date attributes. The result is visible in Figure 7-4.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-486">
					<img alt="" class="_idgenobjectattribute" src="images/000211.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 7-4</span> The report shows the balance on the last date by customer, with the Total column computed as sum.</p>
			<p class="normal--unindented">The <span class="charoverride3">Balance LastDateByCustomer</span> measure provides the desired result:</p>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-487">
					<img alt="" class="_idgenobjectattribute" src="images/000049.png" />
				</div>
			</div>
			<p class="normal1">In the calculation of the max balance date per customer, you might need to modify the filter further. For example, Katie Jordan reports a blank in Q4 because her last date happens to be outside of the current filter context by quarter. If you need to modify this behavior and report the balance of September forward to the end of the year &ndash; and in following years if present &ndash; this is achieved by the <span class="charoverride3">Balance LastDateByCustomerEver </span>measure<span class="charoverride3">: </span> </p>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-488">
					<img alt="" class="_idgenobjectattribute" src="images/000063.png" />
				</div>
			</div>
			<p class="normal--unindented">You can see the result of the <span class="charoverride3">Balance LastDateByCustomerEver</span> measure in Figure 7-5.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-489">
					<img alt="" class="_idgenobjectattribute" src="images/000224.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 7-5</span> The last balance of each customer is moved forward to the end of the year.</p>
			<p class="heading1" id="calibre_link-490">Opening and closing balance</p>
			<p class="normal--unindented">The previous calculations to compute a measure for the last date of a period can be used to compute the closing balance; depending on the requirements, you can choose the right technique. However, the same techniques for the first date cannot be used to retrieve the opening balance, which is usually the closing balance of the previous period.</p>
			<p class="normal1">The <span class="charoverride3">Opening</span> measure filters the day before the first day of the period, whereas the <span class="charoverride3">Closing</span> measure just gets the last date of the period using LASTDATE:</p>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-491">
					<img alt="" class="_idgenobjectattribute" src="images/000078.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride7">Measure in the Balances table</span></p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-492">
					<img alt="" class="_idgenobjectattribute" src="images/000093.png" />
				</div>
			</div>
			<p class="normal1">The result in Figure 7-6 shows that Katie Jordan has an empty opening balance, because the assumption is that the lack of data on December 31, 2019 reflects an empty balance. Indeed, the behavior of the <span class="charoverride3">Opening</span> and <span class="charoverride3">Closing</span> measures corresponds to the <span class="charoverride4">First and last date</span> pattern - which only works if there is a balance for all the customers on the last day of the month.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-493">
					<img alt="" class="_idgenobjectattribute" src="images/000237.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 7-6</span> Opening and closing balances using standard DAX functions.</p>
			<p class="normal1">DAX also provides time intelligence functions for the same purpose, which are specific for each time period considered - month, quarter, or year. However, these functions are slower and they require a more complex DAX syntax in the measures. They should only be considered for measures that always return the opening or closing balance of a specific granularity regardless of the selection. For example, a measure returns the opening or closing balance of the corresponding year, and though the selection might very well be month or quarter the measure would still return the yearly balance.</p>
			<p class="normal1">In our sample report, the CLOSINGBALANCEMONTH can be used instead of CLOSINGBALANCEQUARTER and CLOSINGBALANCEYEAR because they provide the same result for the last month of a period. Similarly, OPENINGBALANCEMONTH can be used instead of OPENINGBALANCEQUARTER and OPENINGBALANCEYEAR because they provide the same result for the first month of a period.</p>
			<p class="normal1">The definition of the <span class="charoverride3">Opening Dax</span> and <span class="charoverride3">Closing Dax</span> measures is the following:</p>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-494">
					<img alt="" class="_idgenobjectattribute" src="images/000108.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride7">Measure in the Balances table</span></p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-495">
					<img alt="" class="_idgenobjectattribute" src="images/000122.png" />
				</div>
			</div>
			<p class="normal1">If you are looking to achieve a behavior matching the <span class="charoverride4">First and last date by customer</span> pattern, then you need <span class="charoverride3">Balance LastDateByCustomerEver</span> for the implementation of the <span class="charoverride3">Closing Ever</span> measure. With a small variation of the same pattern, we are also able to implement the <span class="charoverride3">Opening Ever</span> measure:</p>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-496">
					<img alt="" class="_idgenobjectattribute" src="images/000135.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-497">
					<img alt="" class="_idgenobjectattribute" src="images/000148.png" />
				</div>
			</div>
			<p class="normal1">Figure 7-7 shows that the opening account balance for Katie Jordan for January and Q1 2020 corresponds to the last account balance available in 2019.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-498">
					<img alt="" class="_idgenobjectattribute" src="images/000250.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 7-7</span> Opening and closing balances using custom calculations.</p>
			<p class="heading1" id="calibre_link-499">Growth in period</p>
			<p class="normal--unindented">A useful application of this pattern is to compute the variation of a measure over a selected time period. In our example, we want to compute a new measure that produces the difference between the opening and the closing balance for a selected period. The result is visible in Figure 7-8.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-500">
					<img alt="" class="_idgenobjectattribute" src="images/000265.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 7-8</span> The report shows the difference between the opening and closing balance.</p>
			<p class="normal1">The <span class="charoverride3">Growth</span> measure uses the <span class="charoverride3">Opening</span> and <span class="charoverride3">Closing</span> measures based on the <span class="charoverride4">First and last date</span> pattern:</p>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-501">
					<img alt="" class="_idgenobjectattribute" src="images/000161.png" />
				</div>
			</div>
			<p class="normal1">As suggested in the comments of the <span class="charoverride3">Growth</span> measure, it is possible to use a different logic to obtain the opening and closing balance &ndash; by changing the assignment to the <span class="charoverride3">Opening</span> and <span class="charoverride3">Closing</span> variables. For example, the <span class="charoverride3">Growth Ever</span> measure uses the <span class="charoverride3">Opening Ever</span> and <span class="charoverride3">Closing Ever</span> measures described in the <span class="charoverride4">Opening and closing balance</span> pattern:</p>
			<p class="code-block-screened-head">Measure in the Balances table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-502">
					<img alt="" class="_idgenobjectattribute" src="images/000174.png" />
				</div>
			</div>
			<p class="normal1">The result of the <span class="charoverride3">Growth Ever</span> measure is visible in Figure 7-9.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-503">
					<img alt="" class="_idgenobjectattribute" src="images/000329.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 7-9</span> The report shows the difference between the opening and closing balance (Ever version).</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-504">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-505">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-506">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-507">
			</div>
		</div>
	</div>


<div id="calibre_link-1" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-508">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture6" id="calibre_link-509">
					<img alt="" class="_idgenobjectattribute" src="images/000378.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 8</p>
			<p class="ch-title--no-toc" id="calibre_link-510"><a id="calibre_link-511" class="calibre2"></a>Cumulative total</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-207"><span class="hyperlink1">https://sql.bi/dax-207</span></a></p>
			<p class="normal--unindented">The cumulative total pattern allows you to perform calculations such as running totals. You can use it to implement warehouse stock and balance sheet calculations using the original transactions instead of using snapshots of data over time.</p>
			<p class="normal1">For example, in order to create an <span class="charoverride3">Inventory</span> table that shows the stock of each product for every month, you can make that calculation by using the original warehouse movements table, without processing and consolidating data in advance.</p>
			<p class="normal1">The most frequent case of running total is the sum of all the transactions made before a given date. But that same calculation can be used in any scenario where you accumulate values over any sortable column. This is shown in one of the examples of this pattern.</p>
			<p class="heading1" id="calibre_link-512">Basic scenario</p>
			<p class="normal--unindented">We want to create a measure that sums all the sales values up to a certain date. The result should look like what we show in Figure 8-1.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-513">
					<img alt="" class="_idgenobjectattribute" src="images/000308.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 8-1</span> The running total accumulates values from the beginning of time up to the current date.</p>
			<p class="normal1">The formula must compute the value of <span class="charoverride3">Sales Amount</span> for all the dates which are less than or equal to the last one visible in the current filter context. The code also performs an additional check to avoid showing values for future dates &ndash; that is, when the minimum visible date is greater than the last date with sales:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-514">
					<img alt="" class="_idgenobjectattribute" src="images/000188.png" />
				</div>
			</div>
			<p class="normal1">It is important that the <span class="charoverride3">Date</span> table is marked as a date table for the formula to work. If not, it is necessary to add REMOVEFILTERS over <span class="charoverride3">Date</span> as a further CALCULATE modifier, when applying the filter in the computation of the <span class="charoverride3">Result</span> variable:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-515">
					<img alt="" class="_idgenobjectattribute" src="images/000201.png" />
				</div>
			</div>
			<p class="normal1">Either way, the formula of <span class="charoverride3">Sales Amount RT</span> applies a filter to the <span class="charoverride3">Date</span> table which removes all the previously existing filters on <span class="charoverride3">Date</span>. Therefore, if you need to keep existing filters on some columns of the <span class="charoverride3">Date</span> table, you must apply these filters again. For example, in order to compute the running total while keeping the filter on the day of the week, the code would be the following:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-516">
					<img alt="" class="_idgenobjectattribute" src="images/000214.png" />
				</div>
			</div>
			<p class="normal1">Figure 8-2 shows the two measures <span class="charoverride3">RT Weekdays</span> and <span class="charoverride3">Sales Amount RT</span> running totals behaving differently, with and without the additional filter on the days of the week.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-517">
					<img alt="" class="_idgenobjectattribute" src="images/000351.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 8-2</span> The <span class="charoverride3">RT Weekdays</span> measure accurately accumulates values from the beginning of time taking into account just the selected days; <span class="charoverride3">Sales Amount RT</span> ignores the selection made in the <span class="charoverride3">Day of Week</span> slicer.</p>
			<p class="heading1" id="calibre_link-518">Cumulative total on columns that can be sorted</p>
			<p class="normal--unindented">Most commonly, the cumulative total pattern tends to be based on the date. That said, that pattern can be adapted to any column that can be sorted. The option for a column to be sorted is important because the code includes a “less than or equal to” condition to work properly.</p>
			<p class="normal1">As an example, we classify customers based on sales volumes, according to the table in Figure 8-3.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-519">
					<img alt="" class="_idgenobjectattribute" src="images/000396.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 8-3</span> The configuration table controls how to cluster customers based on sales.</p>
			<p class="normal1">We want to produce a report that shows the sales amount of each class along with the running total of sales by customer class, as you can see in Figure 8-4.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-520">
					<img alt="" class="_idgenobjectattribute" src="images/000439.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 8-4</span> The running total computes the sales amount including “previous” classes of customers.</p>
			<p class="normal1">The code requires us to pay special attention to the Sort by Column. Indeed, because the column shown in the report is <span class="charoverride3">Customer[Customer Class]</span> and ordering is achieved by <span class="charoverride3">Customer[Customer Class Number]</span>, the calculation must override the filters on both columns even though the entire calculation is only based on the class number:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-521">
					<img alt="" class="_idgenobjectattribute" src="images/000227.png" />
				</div>
			</div>
			<p class="normal1">The ALLSELECTED function used in order to evaluate the <span class="charoverride3">ClassesToSum</span> variable only takes into account the classes visible in the visual for the running total calculation. In case Sort by Column is not being used, the ALLSELECTED can include the single column to filter.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-522">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-523">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-524">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-525">
			</div>
		</div>
	</div>


<div id="calibre_link-3" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-526">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture7" id="calibre_link-527">
					<img alt="" class="_idgenobjectattribute" src="images/000259.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 9</p>
			<p class="ch-title--no-toc" id="calibre_link-528"><a id="calibre_link-529" class="calibre2"></a>Parameter table</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-210"><span class="hyperlink1">https://sql.bi/dax-210</span></a></p>
			<p class="normal--unindented">The parameter table pattern is used to create parameters in a report, so that users can interact with slicers and dynamically change the behavior of the report itself. For example, a report can show the top N products by category, letting the users decide through a slicer if they want to see 3, 5, 10 or any other number of best products. The values available for a parameter must be stored in one or more disconnected tables, which do not have a relationship with any other tables of the same model. This chapter includes several examples with the parameter table, but this pattern has an even broader range of application.</p>
			<p class="normal1">In this pattern, we create the parameter tables by using DAX code. The Parameter feature of Power BI Desktop uses a similar technique. Indeed, the Parameter feature in Power BI Desktop creates a slicer tied to a calculated table computed with the GENERATESERIES function; it also creates a measure that returns the selected value of the parameter. This is the approach followed in this pattern. The main advantage of writing the calculated table manually in DAX is that it provides greater flexibility in the parameters to use.</p>
			<p class="heading1" id="calibre_link-530">Changing the scale of a measure</p>
			<p class="normal--unindented">The user may need to be able to choose whether to show the <span class="charoverride3">Sales Amount</span> measure as its actual value in dollars, or in thousands, or in millions. This is achieved with a slicer, as in the report visible in Figure 9-1. Though the real value of sales is around 30 million dollars, the measure shows it divided by one thousand as per the slicer selection.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-531">
					<img alt="" class="_idgenobjectattribute" src="images/000343.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 9-1</span>  The user chooses the scale of the <span class="charoverride3">Sales Amount</span> measure with the slicer.</p>
			<p class="normal1">The slicer requires a <span class="charoverride3">Scale</span> table with the list of scales. That table includes two columns: one for the description to use in the slicer (Units, Thousands, Millions) and one to store the actual denominator to use when scaling the measure (1, 1,000, 1,000,000). The <span class="charoverride3">Scale</span> calculated table can be created using the DATATABLE function:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-532">
					<img alt="" class="_idgenobjectattribute" src="images/000312.png" />
				</div>
			</div>
			<p class="normal1">Using the Sort by Column feature to sort <span class="charoverride3">Scale</span> by the <span class="charoverride3">Denominator</span> column is a best practice.</p>
			<p class="normal1">The <span class="charoverride3">Sales Amount</span> measure scales down the result based on the denominator obtained by the current selection in the <span class="charoverride3">Scale[Denominator]</span> column:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-533">
					<img alt="" class="_idgenobjectattribute" src="images/000326.png" />
				</div>
			</div>
			<p class="normal1">It is worth noting that despite the slicer being based on the <span class="charoverride3">Scale[Scale]</span> column, that column also cross-filters the <span class="charoverride3">Scale[Denominator]</span> column. Therefore, SELECTEDVALUE can query the <span class="charoverride3">Scale[Denominator]</span> column directly.</p>
			<p class="normal1">If multiple measures must be scaled based on the same slicer, it might be convenient to define a measure returning the denominator value, instead of repeating the same code snippet in every measure that needs to follow the slicer selection:</p>
			<p class="code-block-screened-head">Measure (hidden) in the Scale table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-534">
					<img alt="" class="_idgenobjectattribute" src="images/000340.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-535">
					<img alt="" class="_idgenobjectattribute" src="images/000356.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-536">
					<img alt="" class="_idgenobjectattribute" src="images/000371.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-537">Multiple independent parameters</p>
			<p class="normal--unindented">If a calculation depends on multiple parameters, there could be multiple parameter tables in the model - one for each independent parameter.</p>
			<p class="normal1">Imagine the simulation of a discount on orders: when the total number of items in a single order exceeds a given number of articles (<span class="charoverride3">Min Quantity</span> parameter), the <span class="charoverride3">Discounted Amount</span> measure applies the <span class="charoverride3">Discount</span> parameter to the transaction. Users can simulate the effect of their choices on the historical data by using the slicers, as shown in Figure 9-2.  </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-538">
					<img alt="" class="_idgenobjectattribute" src="images/000531.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 9-2</span> <span class="charoverride3">Discounted Amount</span> applies a 15% discount to the orders with more than 6 products.</p>
			<p class="normal1">The implementation of the <span class="charoverride3">Discounted Amount</span> measure first prepares a table in the <span class="charoverride3">Orders</span> variable including the quantity and amount of each order. The result is obtained by iterating over the table in <span class="charoverride3">Orders</span>, applying the discount to each individual order if the total quantity exceeds the defined boundary:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-539">
					<img alt="" class="_idgenobjectattribute" src="images/000386.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-540">
					<img alt="" class="_idgenobjectattribute" src="images/000401.png" />
				</div>
			</div>
			<p class="normal1">By using multiple parameter tables, the parameters are independent from each other. In other words, a user can choose any combination of the two parameters, and the selection made in one parameter slicer does not affect the values available in other parameter slicers. In order to apply restrictions to the available combinations of parameters in different slicers, it is necessary to implement the multiple dependent parameters pattern.</p>
			<p class="heading1" id="calibre_link-541">Multiple dependent parameters</p>
			<p class="normal--unindented">If a calculation depends on multiple parameters with limited available options, then a single table with one column for each parameter can store one row for each valid combination of the parameter values.</p>
			<p class="normal1">Imagine the scenario of the “Multiple independent parameters” pattern with two parameters: <span class="charoverride3">Min Quantity</span> and <span class="charoverride3">Discount</span>. The additional requirement is that the discount percentage cannot be greater than 10 times the <span class="charoverride3">Min Quantity</span>. In other words, if a user selects 3 for <span class="charoverride3">Min Quantity</span>, the maximum <span class="charoverride3">Discount</span> available is 30%.</p>
			<p class="normal1">When the user makes a selection in the <span class="charoverride3">Min Quantity</span> slicer, the <span class="charoverride3">Discount</span> slicer only shows allowed percentage values according to the <span class="charoverride3">Min Quantity</span> selected. Figure 9-3 shows an example of this scenario.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-542">
					<img alt="" class="_idgenobjectattribute" src="images/000072.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 9-3</span> Because the selection on <span class="charoverride3">Min Quantity</span> is three, the <span class="charoverride3">Discount</span> slicer only shows options up to 30%.</p>
			<p class="normal1">The <span class="charoverride3">Discounted Amount</span> measure is identical to the measure used for the multiple dependent parameters example - it prepares a table in the <span class="charoverride3">Orders</span> variable that includes the quantity and amount of each order, and then performs the proper calculation by iterating over the table in <span class="charoverride3">Orders</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-543">
					<img alt="" class="_idgenobjectattribute" src="images/000415.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-544">
					<img alt="" class="_idgenobjectattribute" src="images/000429.png" />
				</div>
			</div>
			<p class="normal1">The Discount table contains both parameters in the Discount[Min Quantity] and Discount[Discount] columns. The Discount table must only include rows corresponding to valid combinations of Min Quantity and Discount. The following definition of the <span class="charoverride3">Discount</span> calculated table only generates combinations where the <span class="charoverride3">Discount</span> percentage is less than or equal to 10 times the <span class="charoverride3">Min Quantity</span>:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-545">
					<img alt="" class="_idgenobjectattribute" src="images/000443.png" />
				</div>
			</div>
			<p class="normal1">The Discount table does not include combinations such as 3 for <span class="charoverride3">Min Quantity</span> and 50% for <span class="charoverride3">Discount</span>. Therefore, when the <span class="charoverride3">Min Quantity</span> slicer selects 3, the <span class="charoverride3">Discount</span> slicer only shows values less than or equal to 30%. The relationship between two or more parameters is implicitly found in the <span class="charoverride3">Discount</span> table and directly affects the slicers through cross-filtering.</p>
			<p class="heading1" id="calibre_link-546">Selecting top N products dynamically</p>
			<p class="normal--unindented">Imagine needing a report like the one in Figure 9-4, where each column filters a different number of products with the highest <span class="charoverride3">Sales Amount</span>. Each column shows the <span class="charoverride3">Sales Amount</span> of only the top N products, where N is determined by the column header. In this case, each visible name of the <span class="charoverride3">TopN</span> parameter is mapped to a different number, used as the parameter value in the <span class="charoverride3">Top Sales</span> measure.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-547">
					<img alt="" class="_idgenobjectattribute" src="images/000146.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 9-4</span> The <span class="charoverride3">TopN Products</span> parameter assigned to the report columns defines the number of products considered for the Sales Amount calculation.</p>
			<p class="normal1">This visualization is hard to obtain in Power BI, because the Top N visual-level filter can only be applied once in one visual. In this case, every column has a different parameter for the TOPN function used in the <span class="charoverride3">Top Sales</span> measure.</p>
			<p class="normal1">The parameter table requires two columns: one for the visible name (<span class="charoverride3">TopN Products</span>) that contains the description of the parameter, and the other column (<span class="charoverride3">TopN)</span> is a number corresponding to both the result of the parameter selection and the sort order of the <span class="charoverride3">TopN Products</span> values.</p>
			<p class="normal1">The <span class="charoverride3">TopN Filter</span> calculated table can be defined with the following code:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-548">
					<img alt="" class="_idgenobjectattribute" src="images/000457.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Top Sales</span> measure uses the selected value to filter the number of top products by evaluating the <span class="charoverride3">Sales Amount</span> measure:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-549">
					<img alt="" class="_idgenobjectattribute" src="images/000471.png" />
				</div>
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-550">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-551">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-552">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-553">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-554">
			</div>
		</div>
	</div>


<div id="calibre_link-4" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-555">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture8" id="calibre_link-556">
					<img alt="" class="_idgenobjectattribute" src="images/000360.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 10</p>
			<p class="ch-title--no-toc" id="calibre_link-557"><a id="calibre_link-558" class="calibre2"></a>Static segmentation</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-211"><span class="hyperlink1">https://sql.bi/dax-211</span></a></p>
			<p class="normal--unindented"><span class="charoverride8">The static segmentation pattern classifies numerical values into ranges. A typical example is the analysis of sales by price range. You do not want to slice the data by individual price; instead you want to simplify the analysis by grouping prices within ranges of prices. The price ranges are stored in a configuration table and the pattern requires the model to be entirely data-driven. In other words, when the configuration table is updated, the model is updated automatically without requiring any change to the DAX code.</span></p>
			<p class="normal1">Depending on the size of the data model, there are different options for this pattern. On small models (up to a few million rows) the best option is to use calculated columns and/or calculated relationships. On larger models with hundreds of millions of rows, calculated columns might increase the processing time of the model. Therefore, for large models the best option is to build a calculated table expanding the prices, thereby reducing to a minimum the number of calculated columns in the larger tables.</p>
			<p class="heading1" id="calibre_link-559">Basic pattern</p>
			<p class="normal--unindented">You need to analyze sales sliced by price range. To attain this goal, you build a configuration table that stores the price ranges; the price should be greater than or equal to the <span class="charoverride3">Min Price</span> and less than the <span class="charoverride3">Max Price</span>, as shown in Figure 10-1.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-560">
					<img alt="" class="_idgenobjectattribute" src="images/000336.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 10-1</span> The configuration table defines the price ranges.</p>
			<p class="normal1">Then, you want to analyze sales by price range, obtaining a report like Figure 10-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-561">
					<img alt="" class="_idgenobjectattribute" src="images/000381.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 10-2</span> The report shows sales sliced by price range.</p>
			<p class="normal1">In the report, the VERY LOW row contains the sales with a net price between 0 and 100.</p>
			<p class="normal1">In order to obtain the desired result, you need a relationship between the configuration table (<span class="charoverride3">Price Ranges</span>) and the Sales table. In the example, we use <span class="charoverride3">Sales[Net Price]</span> instead of <span class="charoverride3">Sales[Unit Price]</span> to determine the sales price, so to consider possible discounts. Indeed, <span class="charoverride3">Sales[Net Price]</span> might be different than <span class="charoverride3">Sales[Unit price]</span> because of discounts. The required relationship should use a “between” condition for the join, which is not natively supported by the Tabular engine. Nevertheless, in the <span class="charoverride3">Sales</span> table we can add a calculated column that stores the key of the price range for each specific row, by using the following code:</p>
			<p class="code-block-screened-head">Calculated column in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-562">
					<img alt="" class="_idgenobjectattribute" src="images/000485.png" />
				</div>
			</div>
			<p class="normal1">When building the calculated column, you need to be careful not to use functions that might reference the blank row, such as ALL and VALUES. This is the reason we used DISTINCT instead of VALUES to retrieve the price range key.</p>
			<p class="normal1">Next, you build a relationship between <span class="charoverride3">Sales</span> and <span class="charoverride3">Price Ranges</span> based on the new calculated column, like in Figure 10-3.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-563">
					<img alt="" class="_idgenobjectattribute" src="images/000425.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 10-3</span> The relationship is based on a calculated column.</p>
			<p class="normal1">Once the relationship is in place, you can slice sales by <span class="charoverride3">‘Price Ranges’[Price Range]</span>.</p>
			<p class="normal1">You need to make sure that the configuration table is properly designed, so that each price belongs to only one price range. The presence of overlapping segments in the configuration table can generate errors in the evaluation of the <span class="charoverride3">PriceRangeKey</span> calculated column. If you want to make sure there are no mistakes in the configuration table &ndash; such as overlapping ranges &ndash; you can generate the <span class="charoverride3">Max Price</span> column using a calculated column that retrieves the value of <span class="charoverride3">Min Price</span> for the next segment. This is shown in the following sample code.</p>
			<p class="code-block-screened-head">Calculated column in the Price Ranges table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-564">
					<img alt="" class="_idgenobjectattribute" src="images/000498.png" />
				</div>
			</div>
			<p class="normal1">You can also write a safer version of the calculated column that writes a blank or generates an error in the event there are multiple ranges active for one price, as in the following example:</p>
			<p class="code-block-screened-head">Calculated column in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-565">
					<img alt="" class="_idgenobjectattribute" src="images/000513.png" />
				</div>
			</div>
			<p class="normal1">The code shown in this pattern must satisfy the requirements for calculated columns used in a relationship, in order to <a href="https://www.sqlbi.com/articles/avoiding-circular-dependency-errors-in-dax/"><span class="hyperlink">avoid circular dependencies</span></a>.</p>
			<p class="heading1" id="calibre_link-566">Price ranges by category</p>
			<p class="normal--unindented">A variation of the static segmentation pattern is when the condition to check is not a simple between, but rather a more complex condition. For example, the requirement might be to use different price ranges for different product categories: The LOW price range for games and toys needs to be different from the LOW price range for home appliances.</p>
			<p class="normal1">In this scenario, the configuration table contains an additional column that indicates the category the price range must be applied to. Different categories might have different price ranges, as in Figure 10-4.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-567">
					<img alt="" class="_idgenobjectattribute" src="images/000467.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 10-4</span> The configuration table also contains the categories.</p>
			<p class="normal1">The pattern here is very similar to the basic pattern, the only noticeable change being in the condition used to find the correct price range key. Indeed, the search must be limited to the row in the <span class="charoverride3">Price Ranges</span> table with the category of the product being sold and where the net price falls within the desired range:</p>
			<p class="code-block-screened-head">Calculated column in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-568">
					<img alt="" class="_idgenobjectattribute" src="images/000528.png" />
				</div>
			</div>
			<p class="normal1">Similarly, you can use any other condition if it is guaranteed that only one row remains visible in the configuration table. In order to make sure that the configuration table does not contain overlapping ranges, you can generate the <span class="charoverride3">Max Price</span> column using a calculated column similar to the one used in the basic pattern. The important difference is the use of ALLEXCEPT instead of REMOVEFILTERS, so that the filter over <span class="charoverride3">‘Price Ranges’[Category]</span> coming from the context transition is kept in the filter context:</p>
			<p class="code-block-screened-head">Calculated column in the Price Ranges table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-569">
					<img alt="" class="_idgenobjectattribute" src="images/000542.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-570">Price ranges on large tables</p>
			<p class="normal--unindented">The static segmentation pattern requires the creation of a calculated column in the <span class="charoverride3">Sales</span> table. The column itself is typically rather small in size, because it contains few distinct values. However, on very large tables the column size might start to grow and you may face another problem: the column needs to be computed for the entire table at every data refresh. On a multi-billion-row table that is likely to be partitioned, the column needs to be recomputed for the entire table whenever one partition is refreshed. This slows down every refresh operation.</p>
			<p class="normal1">In this scenario, it is possible to use a variation of the static segmentation that works without adding any column in the Sales table. Instead of building the relationship with the new calculated column, this pattern uses <span class="charoverride3">Sales[Net Price]</span> as the key for a relationship with a new calculated table. Indeed, it is not possible to create a relationship between <span class="charoverride3">Sales</span> and the <span class="charoverride3">Price Ranges</span> table because the <span class="charoverride3">Price Ranges</span> table is missing a suitable column. Nevertheless, such column can be created by increasing the number of rows in the configuration table.</p>
			<p class="normal1">The table we want to generate contains one row for each value of <span class="charoverride3">Sales[Net Price]</span> with the corresponding price range, like in Figure 10-5.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-571">
					<img alt="" class="_idgenobjectattribute" src="images/000509.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 10-5</span> The expanded configuration contains one row for each value in <span class="charoverride3">Net Price</span>.</p>
			<p class="normal1">We renamed the original configuration table to <span class="charoverride3">Price Ranges Configuration</span>. The <span class="charoverride3">Price Ranges</span> table can be created as a calculated table using the following code:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-572">
					<img alt="" class="_idgenobjectattribute" src="images/000557.png" />
				</div>
			</div>
			<p class="normal1">This new table contains exactly one row for each distinct value of the <span class="charoverride3">Sales[Net Price]</span> column. Therefore, it is possible to create a relationship between <span class="charoverride3">Sales</span> and the new <span class="charoverride3">Price Ranges</span> calculated table based on the <span class="charoverride3">Net Price</span> column, as shown in Figure 10-6.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-573">
					<img alt="" class="_idgenobjectattribute" src="images/000552.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 10-6</span> The relationship is based on the <span class="charoverride3">Net Price</span> column.</p>
			<p class="normal1">With this optimization, there is no need to create a new column in <span class="charoverride3">Sales</span>, because the model uses the existing <span class="charoverride3">Sales[Net Price]</span> column to setup the relationship. Therefore, no calculated column in <span class="charoverride3">Sales</span> must be recomputed during data refresh. The original <span class="charoverride3">Price Ranges Configuration</span> table should be hidden in the model in order to avoid any possible confusion for the end users. </p>
			<p class="normal1">On smaller models, creating a calculated column is not an issue. Therefore, the basic solution that does not involve new tables is to be preferred. On larger models, this version reduces the processing time.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-574">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-575">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-576">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-577">
			</div>
		</div>
	</div>


<div id="calibre_link-5" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-578">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture9" id="calibre_link-579">
					<img alt="" class="_idgenobjectattribute" src="images/000422.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 11</p>
			<p class="ch-title--no-toc" id="calibre_link-580"><a id="calibre_link-581" class="calibre2"></a>Dynamic segmentation</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-212"><span class="hyperlink1">https://sql.bi/dax-212</span></a></p>
			<p class="normal--unindented"><span class="charoverride8">The Dynamic segmentation pattern is useful to perform the classification of entities based on measures. A typical example is to cluster customers based on spending volume. The clustering is dynamic, so that the categorization considers the filters active in the report. Indeed, a customer might belong to different clusters on different dates.</span></p>
			<p class="heading1" id="calibre_link-582">Basic pattern</p>
			<p class="normal--unindented">You need to categorize customers based on spending. Using a configuration table like Figure 11-1, you define the clusters.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-583">
					<img alt="" class="_idgenobjectattribute" src="images/000137.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 11-1</span> The configuration table defines the boundaries of each segment.</p>
			<p class="normal1">Every segment represents a classification for a customer based on their <span class="charoverride3">Sales Amount</span> computed over one year. Using this configuration, you want to analyze how many customers belong to each segment over time. One same customer might be Silver in one year, and Platinum in a different year.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-584">
					<img alt="" class="_idgenobjectattribute" src="images/000150.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 11-2</span> The report shows the number of customers in each segment for each year.</p>
			<p class="normal1">In the report in Figure 11-2, the first row shows that in 2007 there were 2,142 customers in the SILVER segment. By adding a <span class="charoverride3">Category</span> slicer to this report, we segment our customers based on their purchases in the chosen category alone, as shown in Figure 11-3.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-585">
					<img alt="" class="_idgenobjectattribute" src="images/000163.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 11-3</span> The report shows customers in each segment considering sales of the given category alone.</p>
			<p class="normal1">Being dynamic, the pattern is implemented through a measure. The measure finds the customers who belong to the selected cluster. It then uses this table as a filter in CALCULATE to restrict the calculation to the customers found. KEEPFILTERS is needed to intersect the customers list with the customers found: </p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-586">
					<img alt="" class="_idgenobjectattribute" src="images/000571.png" />
				</div>
			</div>
			<p class="normal1">The measure must iterate through all the segments for each customer, to make sure the total is correct with an arbitrary selection of segments, as shown in Figure 11-4. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-587">
					<img alt="" class="_idgenobjectattribute" src="images/000176.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 11-4</span> The report shows an accurate total for each year summing only the selected segments.</p>
			<p class="normal1">By nature, this calculation is non-additive. The previous implementation works at the year level only, which is a good idea to compute the number of customers. This way, the same customer is never summed twice. However, for other measures the segmentation could require an additive behavior. For example, imagine a measure showing the <span class="charoverride3">Sales Amount</span> of the customer in the segment that should also show a total over multiple years. The following measure implements a calculation that is additive across the years:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-588">
					<img alt="" class="_idgenobjectattribute" src="images/000585.png" />
				</div>
			</div>
			<p class="normal1">The result shown in Figure 11-5 provides a total in each row, summing the measure computed for each year.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-589">
					<img alt="" class="_idgenobjectattribute" src="images/000190.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 11-5</span>  The Sales Seg. Customers measure is additive over the years.</p>
			<p class="normal1">You need to make sure that the configuration table is designed properly, so that each possible value of <span class="charoverride3">Sales Amount</span> only belongs to one segment. The presence of overlapping segment boundaries in the configuration table can generate errors in the evaluation of the <span class="charoverride3">CustomersInSegment</span> variable. If you want to make sure there are no mistakes in the configuration table &ndash; such as overlapping ranges &ndash; you can generate the <span class="charoverride3">Max Sales</span> column using a calculated column that retrieves the value of <span class="charoverride3">Min Sales </span>for the next segment. This is shown in the following sample code:</p>
			<p class="code-block-screened-head">Calculated column in the Customer Segments table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-590">
					<img alt="" class="_idgenobjectattribute" src="images/000002.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-591">Clustering by product growth</p>
			<p class="normal--unindented">The dynamic segmentation pattern is very flexible, because it allows you to categorize entities based on dynamic calculations. Moreover, one entity might belong to different clusters. A good example of its flexibility is the following: you want to cluster products based on their yearly growth in sales.</p>
			<p class="normal1">In the sample model, if the year-over-year growth of a product falls within the +/-20% range, then it is considered stable; if its growth is lower than -20%, then it is dropping; if it is over 20%, then it is growing. The same product might be dropping in 2008 and stable in 2009, as highlighted in Figure 11-6.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-592">
					<img alt="" class="_idgenobjectattribute" src="images/000203.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 11-6</span> The same product belongs to different clusters, in different years.</p>
			<p class="normal1">You start by building the segmentation table. It is shown in Figure 11-7.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-593">
					<img alt="" class="_idgenobjectattribute" src="images/000216.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 11-7</span> The configuration table defines the boundaries of each segment.</p>
			<p class="normal1">Once the table is in the model, the code to use is a slight variation of the basic model. This time, instead of determining the customers who belong to a segment based on their spending volume, it determines the products that belong to a segment based on product growth. The only difference in the measure is the reference to the <span class="charoverride3">Growth %</span> measure:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-594">
					<img alt="" class="_idgenobjectattribute" src="images/000014.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-595">
					<img alt="" class="_idgenobjectattribute" src="images/000028.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-596">Clustering by best status</p>
			<p class="normal--unindented">The dynamic segmentation pattern is also useful to cluster customers based on sales, assigning each customer to exactly one cluster depending on the highest sales for that customer over time.</p>
			<p class="normal1">If the assignment of the cluster to each customer is static, then this is better implemented through the static segmentation pattern. However, if the assignment has to be dynamic but you do not want a customer to belong to different clusters over time, then the dynamic segmentation pattern is the optimal choice.</p>
			<p class="normal1">Starting with the configuration table in Figure 11-8, we assign customers to one cluster depending on the highest yearly sales. Therefore, a customer is PLATINUM if &ndash; in a year &ndash; they exceeded the amount of 500.00 spent. If it is determined that the customer be platinum, their sales are reported under the PLATINUM segment for all the years.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-597">
					<img alt="" class="_idgenobjectattribute" src="images/000229.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 11-8</span> The configuration table defines the boundaries of each segment.</p>
			<p class="normal1">In the report shown in Figure 11-9, the sales reported under PLATINUM are the sales of all customers that reached the platinum level in one of the selected years. If their sales are reported under PLATINUM, they are not reported in any other cluster.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-598">
					<img alt="" class="_idgenobjectattribute" src="images/000242.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 11-9</span> Sales are sliced by best segment reached in a year.</p>
			<p class="normal1">The measure in the report is a variation of the dynamic segmentation pattern. This time it is not necessary to iterate the calculation over the years. The <span class="charoverride3">CustomersInSegment</span> variable computes the max sales amount for each year in the report using the <span class="charoverride3">Max Yearly Sales</span> measure, which also ignores any other filter over the <span class="charoverride3">Date</span> table. The result is applied as a filter to compute the Sales Amount measure:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-599">
					<img alt="" class="_idgenobjectattribute" src="images/000042.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-600">
					<img alt="" class="_idgenobjectattribute" src="images/000056.png" />
				</div>
			</div>
			<p class="normal1">     </p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-601">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-602">
			</div>
		</div>
	</div>


<div id="calibre_link-10" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-603">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture10" id="calibre_link-604">
					<img alt="" class="_idgenobjectattribute" src="images/000253.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 12</p>
			<p class="ch-title--no-toc" id="calibre_link-605"><a id="calibre_link-606" class="calibre2"></a>ABC classification</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-213"><span class="hyperlink1">https://sql.bi/dax-213</span></a></p>
			<p class="normal--unindented"><span class="charoverride8">The ABC classification pattern classifies entities based on values, grouping entities together that contribute to a certain percentage of the total. A typical example of ABC classification is the segmentation of products (entity) based on sales (value). The best-selling products that contribute to up to 70% of the total sales belong to cluster A. The products making up the next 20% of sales are in cluster B, whereas the products representing the last 10% of sales, belong to class C. Hence, the pattern is named after the three clusters (ABC).</span></p>
			<p class="normal1">You can use this pattern to determine the core business of a company, typically in terms of best performing products or best customers. You can find more information on ABC classification at <a href="http://en.wikipedia.org/wiki/ABC_analysis"><span class="hyperlink2">http://en.wikipedia.org/wiki/ABC_analysis</span></a>.</p>
			<p class="normal1">ABC classification can be either static or dynamic. Static ABC classification assigns a class to each product statically, so that the class of a product does not change depending on the filters being applied to the report. Dynamic ABC classification computes the class of each product dynamically, based on the report filters. As such, in the dynamic ABC classification the clustering of product needs to be done in measures, resulting in a less efficient &ndash; albeit more flexible &ndash; algorithm.</p>
			<p class="normal1">There is also a third pattern for this type of clustering, which lies in-between the static and the dynamic versions: the snapshot ABC. For example, if one needs to update the ABC class to a product on a yearly basis, they can accomplish this by creating a snapshot table containing the ABC class of a product for every year.</p>
			<p class="heading1" id="calibre_link-607">Static ABC classification</p>
			<p class="normal--unindented">In the example, we cluster products based on sales. Each product is statically assigned to a class that can be used on the rows and columns of a report. The report in Figure 12-1 shows that there are 493 products in class A, making over 21M in sales, whereas 1,455 products in class C only generate 3M in sales.  </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-608">
					<img alt="" class="_idgenobjectattribute" src="images/000359.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 12-1</span> The ABC class can be used to filter the products into a given class.</p>
			<p class="normal--unindented">The static ABC classification is based on calculated columns. You need four new calculated columns, as shown in Figure 12-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-609">
					<img alt="" class="_idgenobjectattribute" src="images/000545.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 12-2</span> The ABC static pattern requires four calculated columns.</p>
			<p class="normal1">The four calculated columns are:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride2">Product Sales</span>: the total sales for the product (current row).</li>
				<li class="bull-list"><span class="charoverride2">Cumulated Sales</span>: the running total of Product Sales ranked from largest to smallest.</li>
				<li class="bull-list"><span class="charoverride2">Cumulated Pct</span>: the percentage of Cumulated Sales against the grand total of sales.</li>
				<li class="bull-list"><span class="charoverride2">ABC Class</span>: the class of the product, which could be A, B, or C. </li>
			</ul>
			<p class="normal1">You define the calculated columns using the following DAX formulas:</p>
			<p class="code-block-screened-head">Calculated Column in the Product table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-610">
					<img alt="" class="_idgenobjectattribute" src="images/000070.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Calculated Column in the Product table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-611">
					<img alt="" class="_idgenobjectattribute" src="images/000085.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Calculated Column in the Product table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-612">
					<img alt="" class="_idgenobjectattribute" src="images/000100.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Calculated Column in the Product table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-613">
					<img alt="" class="_idgenobjectattribute" src="images/000115.png" />
				</div>
			</div>
			<p class="normal1">The product class is determined by the value of <span class="charoverride3">Cumulated Pct</span>. As you can see in Figure 12-3, when the value is below 70% the product class is still A, when it is over 70% the product class becomes B.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-614">
					<img alt="" class="_idgenobjectattribute" src="images/000505.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 12-3</span> Products that fall over the 70% threshold in cumulated values are in class B.</p>
			<p class="normal1">The four columns can be replaced with a single calculated column containing the complete logic, using several variables:</p>
			<p class="code-block-screened-head">Calculated Column in the Product table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-615">
					<img alt="" class="_idgenobjectattribute" src="images/000128.png" />
				</div>
			</div>
			<p class="normal1">Using this version of the code reduces the size of the model, because it creates one column in place of the four needed in the earlier version. Nevertheless, on databases with a large number of products, the column calculation might require an excessive amount of memory.</p>
			<p class="heading1" id="calibre_link-616">Snapshot ABC classification</p>
			<p class="normal--unindented">You might need to assign the ABC class to each product on a yearly basis, so that the same product can fall into different ABC classes in different years. In this case, you should build a solution with an additional snapshot table containing the correct ABC class for each product and year. The goal is to produce a report like the one in Figure 12-4 &ndash; showing for each year, the number of products that fell in class A, B or C.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-617">
					<img alt="" class="_idgenobjectattribute" src="images/000159.png" />
				</div>
			</div>
			<p class="fig-graphic"> </p>
			<p class="num-caption"><span class="fig-num">Figure 12-4</span> The ABC classification evaluates the product class every year.</p>
			<p class="normal1">The model requires an additional table to store the ABC class for each year and product. The <span class="charoverride3">ABC by Year</span> table does not have relationships with other tables in the model and it contains the product key, the year, and the assigned class, as shown in Figure 12-5. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-618">
					<img alt="" class="_idgenobjectattribute" src="images/000481.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 12-5</span> The calculated table that computes the ABC class has one row for each year and product.</p>
			<p class="normal1">The code that computes the table is the following:</p>
			<p class="code-block-screened-head">Calculated table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-619">
					<img alt="" class="_idgenobjectattribute" src="images/000141.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-620">
					<img alt="" class="_idgenobjectattribute" src="images/000154.png" />
				</div>
			</div>
			<p class="normal1">The result of this code is the final one, shown in Figure 12-5. It helps to visualize the content of the <span class="charoverride3">ClassByYearProduct</span> variable, which shows the columns added to the intermediate calculation through several steps. You can see this in Figure 12-6.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-621">
					<img alt="" class="_idgenobjectattribute" src="images/000524.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 12-6</span> The intermediate calculation evaluated in the <span class="charoverride3">ClassByYearProduct </span>variable.</p>
			<p class="normal1">Once the table is loaded in the model, the <span class="charoverride3">ABC by Year</span> table can be used as a filter remapping the data lineage of <span class="charoverride3">ProductKey</span> and <span class="charoverride3">Calendar Year</span> to the corresponding columns in the <span class="charoverride3">Product</span> and <span class="charoverride3">Date</span> tables. For example, the report shown at the beginning of the section uses these two measures:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-622">
					<img alt="" class="_idgenobjectattribute" src="images/000181.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-623">
					<img alt="" class="_idgenobjectattribute" src="images/000194.png" />
				</div>
			</div>
			<p class="normal1">By using TREATAS both measures move the filter from the snapshot to the <span class="charoverride3">Product</span> and the <span class="charoverride3">Date</span> tables, obtaining the desired result. It is important to apply <span class="charoverride3">ProductKey</span> and <span class="charoverride3">Calendar Year</span> in the same filter, otherwise the measure could include combinations of products and years that are not included in the selected ABC classes.</p>
			<p class="normal1">There is an alternative solution that works better in models with a larger number of products &ndash; by using expanded tables. As you can see in Figure 12-7, this requires an intermediate <span class="charoverride3">Years</span> table linked to <span class="charoverride3">Date</span> through a relationship with a bidirectional filter (so it is not available in the Excel Power Pivot sample).</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-624">
					<img alt="" class="_idgenobjectattribute" src="images/000566.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 12-7</span> The <span class="charoverride3">Years</span> calculated table enables a relationship propagation from <span class="charoverride3">Date</span> to <span class="charoverride3">ABC by Year</span>.</p>
			<p class="normal1">The <span class="charoverride3">Years</span> table is easily computed using a DISTINCT function:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-625">
					<img alt="" class="_idgenobjectattribute" src="images/000206.png" />
				</div>
			</div>
			<p class="normal1">The measures are simpler &ndash; though harder to understand &ndash; because they rely on table expansion:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-626">
					<img alt="" class="_idgenobjectattribute" src="images/000220.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-627">
					<img alt="" class="_idgenobjectattribute" src="images/000233.png" />
				</div>
			</div>
			<p class="normal1">The snapshot ABC classification is more dynamic than the static version. The calculated table requires some computational effort. Nevertheless, it is computed at data refresh time and it is very quick at query time. Therefore, the snapshot ABC classification is a very good compromise between speed and flexibility. If flexibility is the main goal, then the slower dynamic ABC classification pattern is a better fit.</p>
			<p class="heading1" id="calibre_link-628">Dynamic ABC classification</p>
			<p class="normal--unindented">The dynamic ABC pattern is the most flexible of the three patterns presented, and consequently it is the slowest and most memory-hungry. The goal is to dynamically compute the number of products, the sales amount or any other measure determining the set of products that belong to the given ABC class in the context of the report. For example, in Figure 12-8 the classes are determined considering only the Cell phones category; when the user selects a different category, the whole report is computed with the new filters.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-629">
					<img alt="" class="_idgenobjectattribute" src="images/000009.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 12-8</span> The ABC classification segments the products dynamically, based on the current selection.</p>
			<p class="normal1">Being dynamic, the whole logic is defined in a measure that retrieves the list of products in the desired class, and then uses this list as a filter over the required calculation. Moreover, from the model point of view, there is the need to create an additional <span class="charoverride3">ABC Classes</span> table that contains the three classes with their boundaries. This is shown in Figure 12-9.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-630">
					<img alt="" class="_idgenobjectattribute" src="images/000051.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 12-9</span> The <span class="charoverride3">ABC Classes</span> table contains the definition of the boundaries for each class.</p>
			<p class="normal1">The measure that computes the <span class="charoverride3">ABC Sales Amount</span> is the following:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-631">
					<img alt="" class="_idgenobjectattribute" src="images/000246.png" />
				</div>
			</div>
			<p class="normal1">The complexity of the formula mainly depends on the number of products &ndash; the larger the number of products, the slower and more memory-intensive it becomes. Over around ten thousand products, the code will likely start to be too slow to produce an interactive report. This defeats the initial purpose of obtaining a dynamic report.  </p>
			<p class="heading1" id="calibre_link-632">Finding the ABC class</p>
			<p class="normal--unindented">This pattern describes how to find the ABC class of a product dynamically, producing the result in a measure instead of using a column to classify an existing item. Other ABC segmentation patterns aim to split products into different classes and compute a value, like the sales amount or the number of products. This pattern is useful when you need to show the ABC class of a product dynamically, producing a report like Figure 12-10: The report shows for each product of the Computers category, its ABC class in 2008.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-633">
					<img alt="" class="_idgenobjectattribute" src="images/000065.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 12-10</span> The ABC classification segments the products dynamically, based on the current selection.</p>
			<p class="normal1">The measure that computes the ABC class is a variation of the dynamic ABC classification. This time, the measure does not need to compute the ABC class of all the products &ndash; it is enough to compute the ABC class of the selected product. Therefore, once it computes the list of all products along with their sales, the measure uses the information to compute the correct values only for the current product:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-634">
					<img alt="" class="_idgenobjectattribute" src="images/000261.png" />
				</div>
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-635">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-636">
			</div>
		</div>
	</div>


<div id="calibre_link-12" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-637">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture11" id="calibre_link-638">
					<img alt="" class="_idgenobjectattribute" src="images/000244.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 13</p>
			<p class="ch-title--no-toc" id="calibre_link-639"><a id="calibre_link-640" class="calibre2"></a>New and returning customers</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-218"><span class="hyperlink1">https://sql.bi/dax-218</span></a></p>
			<p class="normal--unindented">The New and returning customers pattern helps in understanding how many customers in a period are new, returning, lost, or recovered. There are several variations to this pattern, each with different performance and results depending on the requirements. Moreover, it is a very flexible pattern that allows the identification of new and returning customers, or the computation of these customers’ purchase volume &ndash; also known as sales amount.</p>
			<p class="normal1">Before using this pattern, you need to clearly define the meaning of new and returning customers, as well as when a customer is lost or recovered. Indeed, depending on the definition you give to these calculations, the formulas are quite different both in their writing and &ndash; most important &ndash; in performance. Even though you could use the most flexible formula to compute any variation, we would advise you to spend some time experimenting in order to find the best version that fits your needs. The most flexible formula is very expensive from a computational point of view. Therefore, it might be slow even on small datasets.</p>
			<p class="heading1" id="calibre_link-641">Introduction</p>
			<p class="normal--unindented">Given a certain time period, you want to compute these formulas:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride4">Customers</span>: the number of customers who made a purchase within that time period.</li>
				<li class="bull-list"><span class="charoverride4">New customers</span>: the number of customers who made their first purchase within that time period.  </li>
				<li class="bull-list"><span class="charoverride4">Returning customers</span>: the number of customers who have already purchased something in the past, and are returning in that time period.</li>
				<li class="bull-list"><span class="charoverride4">Lost customers</span>: the number of customers whose last purchase occurred at least 2 months before the start of the current period.</li>
				<li class="bull-list"><span class="charoverride4">Recovered customers:</span> the number of customers who were considered lost in a previous time period, and then made a purchase in the current period.</li>
			</ul>
			<p class="normal1">The report looks like the one in Figure 13-1.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-642">
					<img alt="" class="_idgenobjectattribute" src="images/000374.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-1</span> The report shows the main calculations of the pattern.</p>
			<p class="normal1">As shown in the report, in January 2007 all customers were new. In February, 116 customers were returning and 1,037 were new, for a total of 1,153 customers. In March, 603 customers were lost.</p>
			<p class="normal1">While the measures computing the number of customers and the number of new customers are easy to describe, calculating the number of lost customers is already complex. In the example, let us look at a customer lost two months after their last purchase. Therefore, the number reported (603) is made up of customers who made their last purchase in January. In other words, out of the 1,375 customers in January 2007, 603 did not buy anything in February, March, and the following months; for this reason, we consider them lost at the end of March. </p>
			<p class="normal1">The definition of lost customers may be different in your business. For example, you might define a customer as lost if they made their last purchase two months ago, even though you already know that they will be making another purchase next month. Imagine a customer who bought something in January and April: are they lost at the end of March or not? The answer leads to different formulations of the same calculation. Indeed, we consider the customer as being temporarily lost at the end of March, because we know the same customer will be recovered later. A report counting the temporarily-lost customers (who did not buy anything for two months, but then made a purchase afterwards) is visible in Figure 13-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-643">
					<img alt="" class="_idgenobjectattribute" src="images/000560.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-2</span> The report shows temporarily-lost customers, along with the number of recovered customers.</p>
			<p class="normal1">The number of temporarily-lost customers is higher than the number of lost customers previously shown. The reason is that many of the temporarily-lost customers will buy something in future months. In that case, the report counts them as recovered customers in the month when they make a new purchase. </p>
			<p class="normal1">Another important element to take into account when selecting the right pattern is how you want to look at filters on the report. If the user selects a category of products, how does this filter affect the calculation? Let us say that you filter the Cell Phones category. Do you consider a customer as new the first time they buy a cell phone? If so, then a single customer will be new multiple times, depending on the filter. Otherwise, if you want to consider a customer as new only once, then you need to ignore the filters when computing the number of new customers. Similarly, all the remaining measures might or might not be affected by the filters.</p>
			<p class="normal1">Let us clarify the concept with another example. Figure 13-3 shows the raw data of a reduced version of Contoso with only three customers.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-644">
					<img alt="" class="_idgenobjectattribute" src="images/000521.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-3</span> The report shows three customers along with their purchase history.</p>
			<p class="normal1">Considering the data in Figure 13-3, can you tell when Dale Lal is a new customer, if a user added a filter for Games and Toys? He bought a toy for the first time in April, even though he was already a customer for Cameras and camcorders products. Now focus on Tammy Metha: is she to be considered lost two months after her game purchase in February? She did not buy any other game product, even though she bought products of other categories. Answering these questions is of paramount importance to support your choice of the pattern that will best suit your specific business needs.</p>
			<p class="normal1">Additionally, counting customers is useful, but sometimes you are interested in analyzing the amounts sold to new, returning, and recovered customers. Or you might want to estimate the amount lost because of customer losses, in a report like the one in Figure 13-4. In the report we used the average sales volumes of our lost customers over the last 12 months, as an estimate for lost sales.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-645">
					<img alt="" class="_idgenobjectattribute" src="images/000172.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-4</span> The report shows the sales amount of new, returning, recovered, and lost customers.</p>
			<p class="normal1">Another important note is to think about how the formulas count the different statuses of a customer inside each time period. For example, if you consider a full year, then it is possible that the same customer is new, temporarily lost, returning, and then permanently lost &ndash; all within the same period. On a given day, the status of a customer is well defined. However, throughout longer time frames the same customer can be in different statuses. Our formulas are designed to account for the customer in all their statuses. Figure 13-5 shows a sample report that only filters and shows one customer: Lal Dale.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-646">
					<img alt="" class="_idgenobjectattribute" src="images/000295.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-5</span> The same customer is both new and lost in the same year.</p>
			<p class="normal1">The customer is both new and lost in the same year. Lal Dale was a returning customer for a few months, but not at the year level because he was new during the year. In Figure 13-6 the same report filters out January, thus showing the customer as returning three times within the period, and never showing them as a new customer.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-647">
					<img alt="" class="_idgenobjectattribute" src="images/000426.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-6</span> Filtering out January, when the customer was new, the customer now appears as returning in the period.</p>
			<p class="normal1">If we were to describe all the possible combinations of measures in this pattern, this alone would require an entire book. Instead, we show some of the most common patterns, leaving to the reader the task of changing the formulas in case their scenario is different from any of the patterns described.</p>
			<p class="normal1">Finally, the New and returning customers pattern requires heavy calculations. Therefore, we present both a dynamic and a snapshot version of the formulas.</p>
			<p class="heading1" id="calibre_link-648">Pattern description</p>
			<p class="normal--unindented">The pattern is based on two types of formulas:</p>
			<ul class="calibre1">
				<li class="bull-list">Internal formulas: their goal is to compute the relevant dates for a given customer.</li>
				<li class="bull-list">External formulas: these are the formulas used in reports. They use the internal formulas to compute the number of customers, the sales amount, or any other measure.</li>
			</ul>
			<p class="normal1">For example, in order to compute the number of new customers, for each customer the internal formula computes the date of their first purchase. The external formula then computes the number of customers whose first purchase happens to fall within the time period currently filtered. </p>
			<p class="normal1">An example is helpful to better understand this technique. Look at Figure 13-7, which shows the reduced dataset we use in order to explain the different formulas.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-649">
					<img alt="" class="_idgenobjectattribute" src="images/000554.png" />
				</div>
			</div>
			<p class="fig-graphic"> </p>
			<p class="num-caption"><span class="fig-num">Figure 13-7</span> The report shows a few customers, along with their purchase history.</p>
			<p class="normal1">Using this data as an example, think about how you can compute the number of new customers in March. The new customers external measure checks how many customers made their first purchase in March. To obtain its result, the external formula queries the internal formulas on a customer-by-customer basis, checking their first purchase. The internal formula returns March 14 for the first purchase of Gerald Suri, whereas the first purchases of the other customers occurred earlier than that. Consequently, the external formula returns 1 as the number of new customers.</p>
			<p class="normal1">Other measures behave the same way, although each comes with peculiarities worthy of a more complete description.</p>
			<p class="normal1">As a first example of code, look at the internal formula that computes the date when a customer must be considered new. Be mindful, each example has different formulas and we provide greater detail on this code in subsequent sections. This first example of DAX is reported here only as an introduction:</p>
			<p class="code-block-screened-head">Measure (hidden) in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-650">
					<img alt="" class="_idgenobjectattribute" src="images/000118.png" />
				</div>
			</div>
			<p class="normal1">The internal formula is then used by the external formula, which computes the number of customers who are new in the given period:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-651">
					<img alt="" class="_idgenobjectattribute" src="images/000131.png" />
				</div>
			</div>
			<p class="normal1">Using this approach, the pattern is more flexible. Indeed, if you need to change the logic that determines when a customer is to be considered new, lost, or temporarily lost, you only need to update the internal formulas &ndash; thus leaving the external formula untouched. Still, we need to raise a big warning for our readers: the formulas shown in this pattern are extremely complex and delicate in the way the filter context is handled. You will certainly need to change them to suit your needs. But do so only after having thoroughly understood their behavior; indeed, each line of DAX in this pattern is the result of hours of thinking and endless tests, as we systematically had to make sure that it was the correct way to write it. In other words, get ready to walk on eggshells with this pattern; we certainly had to!</p>
			<p class="normal1">We organized the patterns in two families: dynamic and snapshot. The dynamic version computes the measures in a dynamic way, considering all the filters of the report. The snapshot version precomputes the values of the internal measures in calculated tables, in order to speed up the calculation of the external measures. Therefore, the snapshot version provides less flexibility, albeit with improved speed.</p>
			<p class="normal1">We also provide three different implementations, depending on how the measure should consider the active filters in the report:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride2">Relative</span>: a customer is considered new the first time they buy one of the products selected in the report. </li>
				<li class="bull-list"><span class="charoverride2">Absolute</span>: a customer is considered new the first time they buy a product, regardless of any filter present in the report.</li>
				<li class="bull-list"><span class="charoverride2">By category</span>: a customer is considered new the first time they buy a product from any of the product categories selected in the report. If they buy two products of the same category then they are considered new only once, whereas if they buy two products of different categories then they are considered new twice.</li>
			</ul>
			<p class="normal1">You can find a more complete explanation of the various calculations in the corresponding section of each pattern. Our suggestion is to read the chapter start-to-finish before attempting an implementation on your model. It is better to understand your requirements well before proceeding with the implementation, rather than only finding out at the end that you chose the wrong pattern.</p>
			<p class="normal1">Finally, the demo files of this pattern include two versions: the full version includes the complete database, whereas the base version only includes three customers. The base version is useful to better understand the pattern, because you can easily check the numbers thanks to the limited number of rows in the model. The full version is more useful to evaluate the performance of the different calculations.</p>
			<p class="heading" id="calibre_link-652">Internal measures</p>
			<p class="normal--unindented">There are three internal measures:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride3">Date New Customer</span>: returns the date when the customer is to be considered new.</li>
				<li class="bull-list"><span class="charoverride3">Date Lost Customer</span>: returns the date when the customer is to be considered permanently lost, checking that there are no sales in following time periods.</li>
				<li class="bull-list"><span class="charoverride3">Date Temporary Lost Customer</span>: returns the date when the customer might be lost, without checking whether the customer comes back in a following period.</li>
			</ul>
			<p class="normal1">These measures are not intended to be used in reports &ndash; they exist only to be used by the external measures. The code of the internal measures is different for each pattern.</p>
			<p class="heading" id="calibre_link-653">External measures</p>
			<p class="normal--unindented">Each pattern defines several measures to count customers and evaluate sales in the various customer states:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride3"># New Customers</span>: counts the number of customers who are new.</li>
				<li class="bull-list"><span class="charoverride3"># Returning Customers</span>: counts the number of customers who were new in a previous period and made a new purchase within the time period considered.</li>
				<li class="bull-list"><span class="charoverride3"># Lost Customers</span>: counts the number of customers permanently lost.</li>
				<li class="bull-list"><span class="charoverride3"># Temporarily Lost Customers</span>: counts the number of customers who are only lost when we look at the current time period, even though they might return in a later period.</li>
				<li class="bull-list"><span class="charoverride3"># Recovered Customers</span>: counts the number of customers who were temporarily lost and then made a new purchase within the time period considered.</li>
				<li class="bull-list"><span class="charoverride3">Sales New Customers</span>: returns the value of <span class="charoverride3">Sales Amount </span>by filtering only the new customers.</li>
				<li class="bull-list"><span class="charoverride3">Sales Returning Customers</span>: computes the value of <span class="charoverride3">Sales Amount</span> by filtering only the customers who were new in a previous period and made a new purchase in the period considered.</li>
				<li class="bull-list"><span class="charoverride3">Sales Lost Customers (12M)</span>: computes the value of <span class="charoverride3">Sales Amount</span> for 12 months prior to the start of the selected time period, filtering only customers permanently lost in the selected period.</li>
				<li class="bull-list"><span class="charoverride3">Sales Recovered Customers</span>: returns the value of <span class="charoverride3">Sales Amount</span> filtering only customers who were previously temporarily lost and who made a new purchase in the period considered.</li>
			</ul>
			<p class="normal1">The code of the external measures is very similar in all the patterns. There are minor variations for some scenarios that are highlighted when we describe the individual patterns.</p>
			<p class="heading" id="calibre_link-654">How to use pattern measures</p>
			<p class="normal--unindented">The formulas presented in the pattern can be grouped into two categories. The measures starting with the <span class="charoverride3">#</span> prefix compute the number of unique customers by applying a certain filter. Usually these measures are used as-is and are optimized for this purpose. For example, the following measure returns the number of new customers:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-655">
					<img alt="" class="_idgenobjectattribute" src="images/000144.png" />
				</div>
			</div>
			<p class="normal1">The measures that do not start with the <span class="charoverride3">#</span> prefix create a filter of customers that is applied to another measure. For example, the measures with the <span class="charoverride3">Sales</span> prefix are measures that apply a filter of customers to the <span class="charoverride3">Sales Amount</span> measure. The following measure can be reused to compute other measures by just changing the <span class="charoverride3">Sales Amount</span> measure reference in the last CALCULATE function:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-656">
					<img alt="" class="_idgenobjectattribute" src="images/000157.png" />
				</div>
			</div>
			<p class="normal1">In each pattern we show the two measures (with the <span class="charoverride3">#</span> and <span class="charoverride3">Sales</span> prefixes) when there are differences in the measure structure, even just for performance optimization. If the two measures only differ by the calculation made in the last CALCULATE function, then we only include the <span class="charoverride3">#</span> prefix version of the measure.</p>
			<p class="normal1"> <span class="charoverride1">Dynamic relative</span></p>
			<p class="normal--unindented">The Dynamic relative pattern takes into account all the filters in the report for the calculation. Therefore, if the report filters one category (Audio, for example), a customer is reported as new the first time they buy a product of the Audio category. Similarly, a customer is considered lost a certain number of days after they last purchased a product of the Audio category. Figure 13-8 is useful to better understand the behavior of this pattern.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-657">
					<img alt="" class="_idgenobjectattribute" src="images/000039.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-8</span> The only customer visible (Lal Dale) is considered as new multiple times, for different categories.</p>
			<p class="normal1">The report only takes one customer into account: Lal Dale. He is reported as new in January, when Cameras and camcorders is selected, and he is also considered new in April, for the Games and Toys category. All the other measures behave similarly, by considering the filter where they are evaluated.</p>
			<p class="heading" id="calibre_link-658">Internal measures</p>
			<p class="normal--unindented">The internal measures are the following:</p>
			<p class="code-block-screened-head">Measure (hidden) in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-659">
					<img alt="" class="_idgenobjectattribute" src="images/000170.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure (hidden) in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-660">
					<img alt="" class="_idgenobjectattribute" src="images/000184.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure (hidden) in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-661">
					<img alt="" class="_idgenobjectattribute" src="images/000197.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-662">New customers</p>
			<p class="normal--unindented">The measure that computes the number of new customers is the following:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-663">
					<img alt="" class="_idgenobjectattribute" src="images/000210.png" />
				</div>
			</div>
			<p class="normal1">The code computes the date when each customer is new. ALLSELECTED is useful for optimization purposes: it lets the engine reuse the value of the <span class="charoverride3">CustomersWithNewDate</span> variable in multiple executions of the same expression.</p>
			<p class="normal1">Then, in <span class="charoverride3">CustomersWithLineage</span> the formula updates the lineage of <span class="charoverride3">CustomersWithNewDate</span> to let the variable filter <span class="charoverride3">Sales[CustomerKey]</span> and <span class="charoverride3">Date[Date]</span>. When used as a filter, <span class="charoverride3">CustomersWithLineage</span> makes the customers only visible on dates when they are considered new. The final CALCULATE applies the <span class="charoverride3">CustomersWithLineage</span> filter using KEEPFILTERS to intersect with the current filter context. This way the new filter context ignores customers that are not new in the range of dates considered.</p>
			<p class="normal1">In order to apply the new customers as a filter for another measure like <span class="charoverride3">Sales Amount</span> we need a slightly different approach, as shown in the following <span class="charoverride3">Sales New Customers</span> measure:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-664">
					<img alt="" class="_idgenobjectattribute" src="images/000223.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">NewCustomers</span> variable holds a list of the values in <span class="charoverride3">Sales[CustomerKey]</span> corresponding to the new customers, obtained by checking whether the <span class="charoverride3">@NewCustomerDate</span> is within the filter context of the current evaluation. The <span class="charoverride3">NewCustomers</span> variable obtained this way is then applied as a filter to compute the <span class="charoverride3">Sales Amount</span> measure. Even though the variable contains two columns (<span class="charoverride3">Sales[CustomerKey]</span> and <span class="charoverride3">@NewCustomerDate</span>), the only column actively filtering the model is <span class="charoverride3">Sales[CustomerKey]</span>, because the newly added column does not share the lineage with any other column in the model. </p>
			<p class="heading" id="calibre_link-665">Lost customers</p>
			<p class="normal--unindented">The measure computing the number of lost customers needs to count customers that are not part of the current filter context. Indeed, in March we might lose a customer who made a purchase in January. Therefore, when filtering March the customer is not visible. The formula must look back at January to find that customer. This is the reason why the structure of the code is different from the <span class="charoverride3">New Customers</span> measure:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-666">
					<img alt="" class="_idgenobjectattribute" src="images/000236.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">CustomersWithLostDate</span> variable computes the date of loss for each customer. <span class="charoverride3">LostCustomers</span> filters out customers whose date of loss is not in the current period. Eventually, the measure computes the number of customers left by counting the rows in <span class="charoverride3">LostCustomers</span> that correspond to the customers whose date of loss falls within the period visible in the current filter context.</p>
			<p class="heading" id="calibre_link-667">Temporarily-lost customers</p>
			<p class="normal--unindented">The measure computing the number of temporarily-lost customers is a major variation of the measure computing the lost customers. The measure must check that in the current context the customer who is potentially lost did not make a purchase prior to the date when they would have been lost. This is the code that implements this calculation:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-668">
					<img alt="" class="_idgenobjectattribute" src="images/000249.png" />
				</div>
			</div>
			<p class="normal1">The measure first computes the potential date of loss of each customer; it applies a filter on the date so that it only considers transactions made before the start of the current time period. Then, it checks which customers have a loss date that falls within the current period. </p>
			<p class="normal1">The resulting table (<span class="charoverride3">PotentialTemporarilyLostCustomers</span>) contains the customers that can be potentially lost in the current period. Before returning a result, a final check is required: these customers must not have purchased anything in the current period before the date when they would be considered lost. This validation happens by computing <span class="charoverride3">TemporarilyLostCustomers</span>, which checks for each customer whether there are sales in the current period before the date when the customer would be considered lost.</p>
			<p class="heading" id="calibre_link-669">Recovered customers</p>
			<p class="normal--unindented">The number of recovered customers is the number of customers that were temporarily lost before a purchase was made in the current period. It is computed by the following measure:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-670">
					<img alt="" class="_idgenobjectattribute" src="images/000264.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">CustomersWithLostDateComplete</span> variable computes the temporarily-lost date for the customers. Out of this list, the <span class="charoverride3">CustomersWithLostDate</span> variable removes the customers who do not have a temporarily-lost date. The <span class="charoverride3">ActiveCustomers</span> variable retrieves the first purchase date for the customers in the current selection. The <span class="charoverride3">RecoveredCustomers</span> variable filters customers that are in both <span class="charoverride3">ActiveCustomers</span> and <span class="charoverride3">CustomersWithLostDate</span> lists and have a transaction date greater than the temporarily-lost date.</p>
			<p class="normal1">Finally, the <span class="charoverride3">Result</span> variable counts the recovered customers.</p>
			<p class="heading" id="calibre_link-671">Returning customers</p>
			<p class="normal--unindented">The last measure in the set of counting measures is <span class="charoverride3"># Returning Customers</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-672">
					<img alt="" class="_idgenobjectattribute" src="images/000278.png" />
				</div>
			</div>
			<p class="normal1">The measure first prepares a table in <span class="charoverride3">CustomersWithNewDate</span> with the first purchase date for every customer. The <span class="charoverride3">ExistingCustomers</span> variable filters out all the customers whose date is not strictly earlier than the start of the currently selected period. What remains in <span class="charoverride3">ExistingCustomers</span> is the set of customers who already purchased products before the current period started. Therefore, if those customers also made purchases within the current period, then they are returning customers. This last condition is obtained by combining <span class="charoverride3">ExistingCustomers</span> with the customers active in the selected period. The result in the <span class="charoverride3">ReturningCustomers</span> variable can be used to count the returning customers &ndash; as in this measure &ndash; or to filter them in a different calculation.</p>
			<p class="heading2" id="calibre_link-673">Dynamic absolute</p>
			<p class="normal--unindented">The Dynamic absolute pattern ignores the filters on the report when computing the relevant dates for the customer. Its implementation is a variation of the basic Dynamic relative pattern, with a different set of CALCULATE modifiers to explicitly ignore filters.</p>
			<p class="normal1">The result is an absolute assignment of the status of a customer regardless of report filters, as shown in Figure 13-9: Dale Lal is considered new in January when Games and Toys is selected, even though he purchased cameras and no games.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-674">
					<img alt="" class="_idgenobjectattribute" src="images/000097.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-9</span> Lal Dale is considered new, returning, and lost regardless of the category used in the visual.</p>
			<p class="normal1">The only measure that changes depending on the category is <span class="charoverride3"># Customers</span>, which shows when Lal Dale purchased products. All the other measures ignore the filter on the product: customers are new only the first time they make a purchase regardless of the report filter.</p>
			<p class="heading" id="calibre_link-675">Internal measures</p>
			<p class="normal--unindented">The internal measures are the following:</p>
			<p class="code-block-screened-head">Measure (hidden) in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-676">
					<img alt="" class="_idgenobjectattribute" src="images/000293.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure (hidden) in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-677">
					<img alt="" class="_idgenobjectattribute" src="images/000307.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure (hidden) in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-678">
					<img alt="" class="_idgenobjectattribute" src="images/000322.png" />
				</div>
			</div>
			<p class="normal1">As shown in the previous code, the internal measures are designed to ignore all filters other than the ones on <span class="charoverride3">Customer</span> &ndash; with the noticeable exception of <span class="charoverride3">Date Temporary Lost Customer</span> which needs to also consider the filters on <span class="charoverride3">Date</span>.</p>
			<p class="normal1">Please note that the internal measures have been designed to behave properly when called from the external measures. This is the reason why ALLEXCEPT explicitly keeps the filter on <span class="charoverride3">Sales[CustomerKey]</span> in a somewhat unusual way. If called within an iteration that includes that column, the internal measures do not remove the filter, thereby observing the requirements of the external measure.</p>
			<p class="heading" id="calibre_link-679">New customers</p>
			<p class="normal--unindented">The measure that computes the new customers is the following:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-680">
					<img alt="" class="_idgenobjectattribute" src="images/000335.png" />
				</div>
			</div>
			<p class="normal1">There are two things to note about this measure. First, the filter in the calculation of <span class="charoverride3">CustomersWithNewDate</span> uses ALLEXCEPT to ignore any filter apart from the ones on the <span class="charoverride3">Customer</span> table. Second, in order to check whether a customer is new, the measure filters the content of <span class="charoverride3">CustomersWithNewDate</span>. It then counts the row in the <span class="charoverride3">NewCustomers</span> variable, instead of using TREATAS as the corresponding measure in the Dynamic relative pattern. This technique may turn out to be slower than the one used in the Dynamic relative pattern; it is still required because it needs to count a customer even though they might not be visible due to the current filter context.</p>
			<p class="heading" id="calibre_link-681">Lost customers</p>
			<p class="normal--unindented">The measure computing the number of lost customers is the following:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-682">
					<img alt="" class="_idgenobjectattribute" src="images/000350.png" />
				</div>
			</div>
			<p class="normal1">Its structure is close to the New Customer measure, the main difference being in the calculation of the <span class="charoverride3">CustomersWithLostDate</span> variable.</p>
			<p class="heading" id="calibre_link-683">Temporarily-lost customers</p>
			<p class="normal--unindented">The measure computing the number of temporarily-lost customers is a variation of the measure computing the lost customers:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-684">
					<img alt="" class="_idgenobjectattribute" src="images/000365.png" />
				</div>
			</div>
			<p class="normal1">Its behavior is very close to the corresponding measure in the Dynamic relative pattern. The main differences are the use of ALLEXCEPT in the evaluation of <span class="charoverride3">CustomersWithLostDateComplete</span> and <span class="charoverride3">ActiveCustomers</span>. In <span class="charoverride3">CustomersWithLostDateComplete</span> all the filters other than <span class="charoverride3">Customer</span> are removed, whereas in <span class="charoverride3">ActiveCustomers</span> the filters are not removed from <span class="charoverride3">Date</span> and <span class="charoverride3">Customer</span>.</p>
			<p class="heading" id="calibre_link-685">Recovered customers</p>
			<p class="normal--unindented">The number of recovered customers is the number of customers that were temporarily lost before a purchase made in the current period. It is computed by the following measure:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-686">
					<img alt="" class="_idgenobjectattribute" src="images/000380.png" />
				</div>
			</div>
			<p class="normal1">Its behavior is very close to the corresponding measure in the Dynamic relative pattern. The main difference is the use of ALLEXCEPT in the evaluation of the <span class="charoverride3">CustomersWithLostDateComplete</span> and <span class="charoverride3">ActiveCustomer</span> variables to correctly set the required filter.</p>
			<p class="heading" id="calibre_link-687">Returning customers</p>
			<p class="normal--unindented">The last measure in the set of counting ones is the <span class="charoverride3"># Returning Customers</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-688">
					<img alt="" class="_idgenobjectattribute" src="images/000395.png" />
				</div>
			</div>
			<p class="normal1">Its behavior is very close to the corresponding measure in the Dynamic relative pattern. The main difference is the use of ALLEXCEPT in the evaluation of the <span class="charoverride3">CustomersWithNewDate</span> and <span class="charoverride3">ActiveCustomers</span> variables, to accurately set the required filter.</p>
			<p class="heading2" id="calibre_link-689">Generic dynamic pattern (dynamic by category)</p>
			<p class="normal--unindented">The generic dynamic pattern is an intermediate level between the absolute and the dynamic patterns. The pattern ignores all the filters from the report except for attributes determined by the business logic. In the examples used in this section, the measures are local to each product category. The result is dynamic for product category and absolute for all the other attributes in the data model. For instance, one customer can be new for a product category and a returning customer for another product category within the same month. The same customers might be considered new multiple times if they buy different categories of products over time. In other words, the analysis of new and returning customers is made by product category. You can customize the pattern by replacing product category with one or more other attributes, so that it fits your business logic.</p>
			<p class="normal1">We purposely avoided excessive optimizations when writing the code of this pattern: the primary goal of this set of measures is to make them easier to update. If you plan on modifying the pattern to fit your needs, this set of measures should be a good starting point.</p>
			<p class="normal1">The rules of this pattern are the following:</p>
			<ul class="calibre1">
				<li class="bull-list">The same customer might be considered a new customer multiple times, one for each combination of dynamic attributes (product category in the example).</li>
				<li class="bull-list">Customers are considered returning customers if they already purchased the same combination of dynamic attributes (product category in the example) they are purchasing in the selected period.</li>
				<li class="bull-list">Customers are temporarily lost if they did not purchase a combination of dynamic attributes (product category in the example) for two months, even though they may have purchased different combinations of dynamic attributes (product category in the example) in the meantime.</li>
				<li class="bull-list">Customers are considered recovered customers if they make a new purchase of products of the very combination of dynamic attributes (product category in the example) for which they were temporarily lost.</li>
			</ul>
			<p class="normal1">It is important to note that the pattern detects the customers, not the combination of dynamic attributes and customers &ndash; like customer and product category in the example. Therefore, the measures with the <span class="charoverride3">#</span> prefix always return the number of unique customers, whereas the measures with the <span class="charoverride3">Sales</span> prefix always evaluate the <span class="charoverride3">Sales Amount</span> measure regardless of the combination of dynamic attributes (product category in the example) for which a customer is considered new/lost/recovered. The difference is visible by filtering two or more combinations of the dynamic attributes. For example, by filtering two product categories, the <span class="charoverride3">Sales </span>measures for new and returning customers could add up to more than the value of <span class="charoverride3">Sales Amount</span>; indeed, the same amount can be computed considering the same customer both new and returning, because of their having different states for different categories.</p>
			<p class="normal1">Your requirements might be different from those assumed in this example. In that case, as we already stated in the introduction, you need to very carefully understand the filtering happening in all the measures before implementing any change. These measures are quite complex and easy to break with small changes.</p>
			<p class="heading" id="calibre_link-690">Internal measures</p>
			<p class="normal--unindented">The internal measures are the following:</p>
			<p class="code-block-screened-head">Measure (hidden) in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-691">
					<img alt="" class="_idgenobjectattribute" src="images/000410.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride7">Measure (hidden) in the Sales table </span></p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-692">
					<img alt="" class="_idgenobjectattribute" src="images/000424.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride7">Measure (hidden) in the Sales table </span></p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-693">
					<img alt="" class="_idgenobjectattribute" src="images/000438.png" />
				</div>
			</div>
			<p class="normal1">As shown in this code, the internal measures are designed to ignore filters other than the ones on <span class="charoverride3">Customer</span> and <span class="charoverride3">Product[Category]</span>.</p>
			<p class="heading" id="calibre_link-694">New customers</p>
			<p class="normal--unindented">The measure that computes the new customers is the following:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-695">
					<img alt="" class="_idgenobjectattribute" src="images/000452.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-696">
					<img alt="" class="_idgenobjectattribute" src="images/000466.png" />
				</div>
			</div>
			<p class="normal1">In this version of the measure, the <span class="charoverride3">CustomersWithNewDate</span> variable might compute a different date for each product category. Indeed, SUMMARIZE uses the <span class="charoverride3">Product[Category]</span> column as a group-by condition. Consequently, TREATAS specifies the lineage for the three columns in <span class="charoverride3">CustomersWithNewDate</span> so that the <span class="charoverride3">@NewCustomerDate</span> column can be used later to filter or join the <span class="charoverride3">Date[Date]</span> column.</p>
			<p class="normal1">For performance reasons, the <span class="charoverride3">CustomersWithNewDate</span> and <span class="charoverride3">CustomersCategoryNewDate</span> variables are invariant to the filter context of cells in a report, so their result is computed only once for a single visualization. In order to get the actual new customers, it is necessary to filter those combinations that are not visible in the filter context where <span class="charoverride3"># New Customer</span> is evaluated. This is accomplished by the NATURALINNERJOIN in <span class="charoverride3">ActiveNewCustomers</span>, which joins the combinations of customer, date, and category visible in the filter context (<span class="charoverride3">ActiveCustomersCategories</span>) with the combinations in <span class="charoverride3">CustomersCategoryNewDate</span>.</p>
			<p class="normal1">The <span class="charoverride3">NewCustomers</span> variable removes the duplicated customers that could be new for different categories in the same period. This way, <span class="charoverride3">NewCustomers</span> can be used as a filter in following calculations or it can be counted to obtain the number of new customers, as the <span class="charoverride3"># New Customers</span> measure does.</p>
			<p class="normal1">The <span class="charoverride3">Sales New Customers</span> measure is similar to <span class="charoverride3"># New Customers</span>, the only difference is the <span class="charoverride3">Result</span> variable that uses the <span class="charoverride3">NewCustomersCat</span> as a filter in CALCULATE instead of just counting the rows of the <span class="charoverride3">NewCustomer</span> variable. Therefore, we show here only the last part of the code, using ellipsis for the unchanged sections:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-697">
					<img alt="" class="_idgenobjectattribute" src="images/000480.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-698">Lost customers</p>
			<p class="normal--unindented">The measure computing the number of lost customers is the following:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-699">
					<img alt="" class="_idgenobjectattribute" src="images/000493.png" />
				</div>
			</div>
			<p class="normal1">In this version of the measure, the <span class="charoverride3">CustomersWithLostDate</span> variable might compute a different date for each product category. The reason is that SUMMARIZE uses the <span class="charoverride3">Product[Category]</span> column as a group-by condition and that the customer might have different dates of loss &ndash; one for each category.</p>
			<p class="normal1">The <span class="charoverride3">LostCustomersCategories</span> variable only filters the combinations of customers and categories that have a lost date included in the selected time period. Similarly to the <span class="charoverride3">New Customers</span> measure, the <span class="charoverride3">LostCustomers</span> variable removes the duplicated customers so it can be used both as a filter and to count the lost customers.</p>
			<p class="heading" id="calibre_link-700">Temporarily-lost customers</p>
			<p class="normal--unindented">The measure computing the number of temporarily-lost customers is a variation of the measure computing the lost customers:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-701">
					<img alt="" class="_idgenobjectattribute" src="images/000508.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-702">
					<img alt="" class="_idgenobjectattribute" src="images/000523.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">CustomersWithLostDateComplete</span> variable needs to enforce the filter on the <span class="charoverride3">Product[Category]</span> column by using the VALUES function &ndash; though the filter might not be directly applied to that column but rather, to other columns cross-filtering <span class="charoverride3">Product[Category]</span>.</p>
			<p class="normal1">Similarly, the <span class="charoverride3">ActiveCustomersCategories</span> variable creates a table of combinations of <span class="charoverride3">Sales[CustomerKey]</span> and <span class="charoverride3">Product[Category]</span> along with the first purchase date for each combination of customers and product category. This table is then joined to the <span class="charoverride3">PotentialTemporarilyLostCustomers</span> variable, which contains the content of <span class="charoverride3">CustomersWithLostDate</span> visible in the current selection. The result of the join filtered by date over the limit of the temporarily-lost date is returned in the <span class="charoverride3">TemporarilyLostCustomersCategories</span> variable.</p>
			<p class="normal1">Finally, to avoid counting the same customer multiple times, the measure extracts the customer key before finally counting the number of temporarily-lost customers.</p>
			<p class="heading" id="calibre_link-703">Recovered customers</p>
			<p class="normal--unindented">The number of recovered customers is the number of customers that were temporarily lost before a purchase was made in the current period. It is computed by using the following measure:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-704">
					<img alt="" class="_idgenobjectattribute" src="images/000537.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-705">
					<img alt="" class="_idgenobjectattribute" src="images/000551.png" />
				</div>
			</div>
			<p class="normal1">The measure first determines the customers that were temporarily lost before the current date, also summarizing by <span class="charoverride3">Product[Category]</span>. Because the <span class="charoverride3">Sales[CustomerKey]</span> and <span class="charoverride3">Product[Category] </span>columns are part of the tables stored in the <span class="charoverride3">CustomersWithLostDateComplete</span> and <span class="charoverride3">ActiveCustomers</span> variables, the join made in <span class="charoverride3">RecoveredCustomersCategories</span> returns a table that has both columns. This ensures that a customer that was to be considered lost for a given category is recovered only if they buy a product of the same category. The customer might appear multiple times in this table, so duplicated customers are removed in <span class="charoverride3">RecoveredCustomersCategories</span> in order to count or filter only the unique recovered customers. The <span class="charoverride3">Sales Recovered Customers</span> measure is similar to <span class="charoverride3"># Recovered Customers</span>; the only difference is the <span class="charoverride3">Result</span> variable that uses <span class="charoverride3">RecoveredCustomersCat</span> as a filter in CALCULATE instead of just counting the rows of the corresponding <span class="charoverride3">RecoveredCustomersCategories</span> variable in the <span class="charoverride3"># Recovered Customers</span> measure. Therefore, here we only show the last part of the code, using ellipsis for the identical sections:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-706">
					<img alt="" class="_idgenobjectattribute" src="images/000565.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-707">Returning customers</p>
			<p class="normal--unindented">The last measure in the set of counting measures is <span class="charoverride3"># Returning Customers</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-708">
					<img alt="" class="_idgenobjectattribute" src="images/000580.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-709">
					<img alt="" class="_idgenobjectattribute" src="images/000592.png" />
				</div>
			</div>
			<p class="normal1">The measure creates a <span class="charoverride3">CustomersWithNewDate</span> variable which obtains the first sale date for each combination of customer and product category. This result is joined to the combination of customers and product category that is present in the current filter context over <span class="charoverride3">Sales</span>. The result is the set of returning customers in the <span class="charoverride3">ReturningCustomers</span> variable that is counted in the <span class="charoverride3"># Returning Customer</span> measure. The <span class="charoverride3">Sales Returning Customers</span> measure uses the following <span class="charoverride3">ReturningCustomersCat</span> variable as a filter instead of the <span class="charoverride3">ReturningCustomers</span> variable. Here we only write its final lines of code, all the remaining code being identical to the previous formula:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-710">
					<img alt="" class="_idgenobjectattribute" src="images/000008.png" />
				</div>
			</div>
			<p class="heading2" id="calibre_link-711">Snapshot absolute</p>
			<p class="normal--unindented">Computing new and returning customers dynamically is a very expensive operation. Therefore, this pattern is oftentimes implemented by using precomputed tables (snapshots) to store the most relevant dates at the desired granularity.</p>
			<p class="normal1">By using precomputed tables, we get a much faster solution albeit with reduced flexibility. In the pre-calculated absolute pattern, the state of new and returning customers does not depend on the filters applied to the report. The results obtained by using this pattern correspond to those of the Dynamic absolute pattern.</p>
			<p class="normal1">The pattern uses a snapshot table containing the relevant states of each customer (New, Lost, Temporarily lost, and Recovered) shown in Figure 13-10.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-712">
					<img alt="" class="_idgenobjectattribute" src="images/000139.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-10</span> The snapshot table contains the full history for each customer.</p>
			<p class="normal1">The New and Lost events are unique for each customer, whereas the Temporarily lost and Recovered events can have multiple occurrences over time for each customer.</p>
			<p class="normal1">The resulting table is linked to <span class="charoverride3">Customer</span> and <span class="charoverride3">Date</span> through regular relationships. The resulting model is visible in Figure 13-11.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-713">
					<img alt="" class="_idgenobjectattribute" src="images/000080.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-11</span> The <span class="charoverride3">CustomerEvents</span> snapshot table is connected to <span class="charoverride3">Customer</span> and <span class="charoverride3">Date</span>.</p>
			<p class="normal1">Building the <span class="charoverride3">CustomerEvents</span> table is a critical step. Creating this table as a derived snapshot by using a calculated table in DAX is relatively efficient for the New and Lost states, whereas it can be very expensive for the Temporarily lost and Recovered states. Keep in mind that Temporarily lost is needed in order to compute the Recovered state. In models with hundreds of thousands of customers or with hundreds of millions of sales you should consider preparing this table outside of the data model, and importing it as a simple table.</p>
			<p class="normal1">Once this model is in place, the DAX measures are simple and efficient. Indeed, for this model there is no need to create external and internal measures &ndash; the external measures are already simple. The full logic that defines the status of a customer is in the table itself. This is the reason why the resulting DAX code is much simpler.</p>
			<p class="normal1">The only calculation that requires some attention is the <span class="charoverride3"># Returning Customers</span> measure, because it computes the number of customers dynamically while ignoring any filter other than <span class="charoverride3">Date</span> and <span class="charoverride3">Customer</span>. It then subtracts the number of new customers obtained by querying the snapshot table:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-714">
					<img alt="" class="_idgenobjectattribute" src="images/000022.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-715">
					<img alt="" class="_idgenobjectattribute" src="images/000036.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-716">
					<img alt="" class="_idgenobjectattribute" src="images/000050.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-717">
					<img alt="" class="_idgenobjectattribute" src="images/000064.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-718">
					<img alt="" class="_idgenobjectattribute" src="images/000079.png" />
				</div>
			</div>
			<p class="normal1">The measures computing the sales amount for new and returning customers take advantage of the physical relationship between the <span class="charoverride3">CustomerEvents</span> snapshot table and the <span class="charoverride3">Customer</span> table, thus reducing the DAX code required and providing higher efficiency:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-719">
					<img alt="" class="_idgenobjectattribute" src="images/000094.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-720">
					<img alt="" class="_idgenobjectattribute" src="images/000109.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-721">
					<img alt="" class="_idgenobjectattribute" src="images/000123.png" />
				</div>
			</div>
			<p class="heading" id="calibre_link-722">Creating the derived snapshot table in DAX</p>
			<p class="normal--unindented">We suggest creating the <span class="charoverride3">CustomerEvents</span> snapshot table outside of the data model. Indeed, creating it in DAX is an expensive operation that requires large amounts of memory and processing power to refresh the data model. The DAX implementation described in this section works well on models with up to a few thousand customers and up to a few million sales transactions. If your model is larger than that, you can implement a similar business logic using other tools or languages that are more optimized for data preparation.</p>
			<p class="normal1">The complex part of the calculation is the retrieving of the dates when a customer is temporarily lost and then possibly recovered. These events can happen multiple times for each customer. For this reason, for each transaction we compute two dates in two calculated columns in the <span class="charoverride3">Sales</span> table:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride3">TemporarilyLostDate</span>: this is the date obtained by the <span class="charoverride3">Date Temporary Lost Customer</span> measure when there are no other transactions between the current row in <span class="charoverride3">Sales</span> and the date. If the same customer put multiple transactions through on the same date, all of them will have the same value in the <span class="charoverride3">TemporarilyLostDate</span> column.</li>
				<li class="bull-list"><span class="charoverride3">RecoveredDate</span>: this is the date of the first purchase made by that same customer after <span class="charoverride3">TemporarilyLostDate</span>. This column is blank if there are no transactions after <span class="charoverride3">TemporarilyLostDate</span>.</li>
			</ul>
			<p class="normal1">The code of these calculated columns is the following: </p>
			<p class="code-block-screened-head">Calculated column in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-723">
					<img alt="" class="_idgenobjectattribute" src="images/000136.png" />
				</div>
			</div>
			<p class="code-block-screened-head"> Calculated column in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-724">
					<img alt="" class="_idgenobjectattribute" src="images/000149.png" />
				</div>
			</div>
			<p class="normal1">We then use these calculated columns to obtain two calculated tables as an intermediate step to compute the <span class="charoverride3">CustomerEvents</span> snapshot table. If you want to leverage an external tool to only compute the Temporarily Lost and Recovered events, you should consider importing these two tables from the data source, where you prepare their content by using dedicated tools for data preparation. The two tables are visible in Figure 13-12 and Figure 13-13.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-725">
					<img alt="" class="_idgenobjectattribute" src="images/000095.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-12</span> The <span class="charoverride3">TempLostDates</span> table only contains the Temporarily Lost events.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-726">
					<img alt="" class="_idgenobjectattribute" src="images/000110.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 13-13</span> The <span class="charoverride3">RecoveredDates</span> table only contains the Recovered events.</p>
			<p class="normal1">Using these intermediate tables, the <span class="charoverride3">CustomerEvents</span> calculated table is obtained with a final UNION of the four states:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-727">
					<img alt="" class="_idgenobjectattribute" src="images/000162.png" />
				</div>
			</div>
			<p class="normal1">Splitting the calculation into smaller steps is useful for educational purposes and to provide a guide in case you want to implement part of the calculation outside of the data model. However, if you implement the calculation entirely in DAX then you can skip the intermediate <span class="charoverride3">TempLostDates</span> and <span class="charoverride3">RecoveredDates</span> calculated tables. In this case you must pay attention to the CALCULATE functions in order to avoid circular dependencies, by implementing explicit filters obtained by iterating the result of ALLNOBLANKROW. This results in a more verbose definition of the <span class="charoverride3">CustomerEvents</span> table, proposed here under the name <span class="charoverride3">CustomerEventsSingleTable</span>:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-728">
					<img alt="" class="_idgenobjectattribute" src="images/000175.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-729">
					<img alt="" class="_idgenobjectattribute" src="images/000189.png" />
				</div>
			</div>
			<p class="normal1">Although the sample file includes a definition of <span class="charoverride3">CustomerEventsSingleTable</span>, the measures in the report do not use that table. If you want to use this approach, you can replace the definition of <span class="charoverride3">CustomerEvents</span> with the expression in <span class="charoverride3">CustomerEventsSingleTable</span> and remove the former expression from the model &ndash; you also want to remove the <span class="charoverride3">TempLostDates</span> and <span class="charoverride3">RecoveredDates</span> calculated tables that are no longer being used.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-730">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-731">
			</div>
		</div>
	</div>


<div id="calibre_link-14" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-732">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture12" id="calibre_link-733">
					<img alt="" class="_idgenobjectattribute" src="images/000302.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 14</p>
			<p class="ch-title--no-toc" id="calibre_link-734"><a id="calibre_link-735" class="calibre2"></a>Related distinct count</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-208"><span class="hyperlink1">https://sql.bi/dax-208</span></a></p>
			<p class="normal--unindented">The Related distinct count pattern is useful whenever you have one or more fact tables related to a dimension, and you need to perform the distinct count of column values in a dimension table only considering items related to transactions in the fact table. For demonstration purposes we use the distinct count of the product name in a model with two fact tables: <span class="charoverride3">Sales</span> and <span class="charoverride3">Receipts</span>.</p>
			<p class="normal1">Because the product name is not unique &ndash; we artificially introduced duplicated names by removing the color description from the product name &ndash; a simple distinct count of the product key in the <span class="charoverride3">Sales</span> or <span class="charoverride3">Receipts</span> table does not work. Finally, we show how to compute the distinct count of product names that appear in both tables and in at least one of the two.</p>
			<p class="heading1" id="calibre_link-736">Pattern description</p>
			<p class="normal--unindented">The <span class="charoverride3">Product[Product Name]</span> column is not unique in the <span class="charoverride3">Product</span> table and we need the distinct count of the product names that have related sales transactions. The model contains two tables with transactions related to products: <span class="charoverride3">Sales</span> and <span class="charoverride3">Receipts</span>. Figure 14-1 shows this data model.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-737">
					<img alt="" class="_idgenobjectattribute" src="images/000501.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 14-1</span> The data model contains two fact tables: <span class="charoverride3">Sales</span> and <span class="charoverride3">Receipts</span>.</p>
			<p class="normal1">Based on this model we want to compute the distinct count of product names appearing:</p>
			<ul class="calibre1">
				<li class="bull-list">In <span class="charoverride3">Sales</span>.</li>
				<li class="bull-list">In <span class="charoverride3">Receipts</span>.</li>
				<li class="bull-list">In both the <span class="charoverride3">Sales</span> and <span class="charoverride3">Receipts</span> tables.</li>
				<li class="bull-list">In at least one of the <span class="charoverride3">Sales</span> and <span class="charoverride3">Receipts</span> tables.</li>
			</ul>
			<p class="normal1">The report is visible in Figure 14-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-738">
					<img alt="" class="_idgenobjectattribute" src="images/000024.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 14-2</span> The report shows the four measures demonstrated in the pattern.</p>
			<p class="normal1">The code for the first two measures is the following:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-739">
					<img alt="" class="_idgenobjectattribute" src="images/000240.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Receipts table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-740">
					<img alt="" class="_idgenobjectattribute" src="images/000255.png" />
				</div>
			</div>
			<p class="normal1">Using SUMMARIZE, the <span class="charoverride3"># Prods from Sales</span> and <span class="charoverride3"># Prods from Receipts</span> measures retrieve the distinct product names referenced in the relevant table. SUMX just counts the number of those products and it is used instead of COUNTROWS or DISTINCTCOUNT for performance reasons &ndash; more details in the article <a href="https://www.sqlbi.com/articles/analyzing-distinctcount-performance-in-dax/"><span class="hyperlink">Analyzying the performance of DISTINCTCOUNT in DAX</span></a>.</p>
			<p class="normal1">Despite being longer than a solution using DISTINCTCOUNT and bidirectional cross-filtering, this version of the code is faster in the most frequent case &ndash; where the number of products is significantly smaller than the number of transactions.</p>
			<p class="readeraid--only"><span class="charoverride2">NOTE</span>&nbsp; The natural syntax to compute the <span class="charoverride3">Result</span> variable in the <span class="charoverride3"># Prods from Sales</span> and <span class="charoverride3"># Prods from Receipts</span> measures should use COUNTROWS. The SUMX version is only suggested for performance reasons in the simple measures. The following measures of this pattern use COUNTROWS because there would be no advantage in using SUMX in more complex expressions.</p>
			<p class="normal1">The formulation using SUMMARIZE and COUNTROWS can be easily extended to accommodate for the next formulas that produce the intersection (<span class="charoverride3"># Prods from Both</span>) or the union (<span class="charoverride3"># Prods from Any</span>) of the product names:</p>
			<p class="code-block-screened-head">Measure in the Receipts table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-741">
					<img alt="" class="_idgenobjectattribute" src="images/000269.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Receipts table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-742">
					<img alt="" class="_idgenobjectattribute" src="images/000283.png" />
				</div>
			</div>
			<p class="normal1">We provided the examples for INTERSECT and UNION. But the pattern can easily be adapted to perform more complex calculations. As a further example, the <span class="charoverride3"># Prods in Sales and not in Receipts</span> measure computes the number of product names that exist in <span class="charoverride3">Sales</span> but not in <span class="charoverride3">Receipts</span> by using the set function EXCEPT instead of the INTERSECT or UNION functions used in previous measures:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-743">
					<img alt="" class="_idgenobjectattribute" src="images/000298.png" />
				</div>
			</div>
			<p class="normal1">The result of the <span class="charoverride3"># Prods in Sales and not in Receipts</span> measure is visible in Figure 14-3.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-744">
					<img alt="" class="_idgenobjectattribute" src="images/000120.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 14-3</span> The <span class="charoverride3"># Prods in Sales and not in Receipts</span> measure counts the products present in <span class="charoverride3">Sales</span> but not in <span class="charoverride3">Receipts</span>.</p>
			<p class="normal1">The pattern can be extended to compute the distinct count of any column in a table that can be reached through a many-to-one chain of relationships from the fact tables. This is because SUMMARIZE is able to group by any of those columns.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-745">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-746">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-747">
			</div>
		</div>
	</div>


<div id="calibre_link-16" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-748">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture13" id="calibre_link-749">
					<img alt="" class="_idgenobjectattribute" src="images/000436.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 15</p>
			<p class="ch-title--no-toc" id="calibre_link-750"><a id="calibre_link-751" class="calibre2"></a>Events in progress</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-224"><span class="hyperlink1">https://sql.bi/dax-224</span></a></p>
			<p class="normal--unindented">The Events in progress pattern has a broad field of application. It is useful whenever dealing with events with a duration &ndash; events that have a start date and an end date. The event is considered to be in progress between the two dates. As an example, we use Contoso orders.</p>
			<p class="normal1">Each order has an order date and a delivery date. The date when the order was placed is considered the start date, and the date when the order was delivered is considered the end date.. An order is considered open when it has been placed but has not yet been delivered. We are interested in counting how many orders are open at a certain date, and what their value is.</p>
			<p class="normal1">As with many of the patterns described, Events in Progress can be handled both dynamically through measures, or statically by using a snapshot table.</p>
			<p class="heading1" id="calibre_link-752">Definition of events in progress</p>
			<p class="normal--unindented">You need to compute how many orders are open at a specific time, for Contoso. In Figure 15-1 you can see the result of the calculation at the day level; on each day the number of open orders is the number open orders from the previous day, plus the orders received and minus the orders delivered that day. EOP stands for End Of Period.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-753">
					<img alt="" class="_idgenobjectattribute" src="images/000389.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 15-1</span> The report shows orders received, delivered and open on a daily basis.</p>
			<p class="normal--unindented">However, this way of computing the number of open orders could be ambiguous when we consider a period of several days, such as a month or a year. The ambiguity is explained below. To avoid this ambiguity, it is important to clearly define the desired result. When looking at a single day, the number of orders open is evident, as you can see in Figure 15-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-754">
					<img alt="" class="_idgenobjectattribute" src="images/000574.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 15-2</span> On October 15, 2019 there are two orders that are open.</p>
			<p class="normal1">In Figure 15-2 only orders number 2 and 5 are open at the date considered (October 15, 2019). Order 1 is already delivered, whereas orders 3 and 4 are yet to be received by Contoso. Therefore, the calculation is clearly defined. Nevertheless, when you report on a larger period of time, like a month, the calculation is harder to define. Look at Figure 15-3 where the time duration is much larger, including the full month of October.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-755">
					<img alt="" class="_idgenobjectattribute" src="images/000549.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 15-3</span> When looking at October, are there one, two or three open orders?</p>
			<p class="normal1">In Figure 15-3, order 1 is completed before the beginning of October, and order 4 is yet to be received by Contoso after the end of October. Therefore, their status is obvious. However, order 2 is open at the beginning of the month, but it is closed at the end. Order 3 is opened during the month and still open at the end of the month. Order 5 is received and closed during the month. As you see, a calculation that is straightforward on an individual day requires a better definition at an aggregate level.</p>
			<p class="normal1">We do not want to provide an extensive description of every possible option. In this pattern we only consider the following three definitions for the orders in a period longer than one day &ndash; each measure is identified with a suffix from the list:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride2">ALL</span>: Returns the orders that were open at any time during the period. For Figure 15-3, we report three orders; we consider order 5 as open because it has been open for some time during the period considered.</li>
				<li class="bull-list"><span class="charoverride2">EOP</span>: Considers the status of each order at the end of the period. For Figure 15-3, this means reporting only one order (order 3), because all the other orders are either closed or not yet opened at the end of the period.</li>
				<li class="bull-list"><span class="charoverride2">AVG</span>: Computes the daily average of the orders open in the period. This requires computing the number of open orders day by day, and then averaging it over longer periods.</li>
			</ul>
			<p class="normal1">There might be different definitions of open orders, which usually are slight variations of the three scenarios described above.</p>
			<p class="heading1" id="calibre_link-756">Open orders</p>
			<p class="normal--unindented">If the <span class="charoverride3">Orders</span> table stores data at the correct granularity &ndash; storing one row for each order along with order date and delivery date &ndash; then the model looks like the one in Figure 15-4. </p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-757">
					<img alt="" class="_idgenobjectattribute" src="images/000186.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 15-4</span> The data model with an Orders table.</p>
			<p class="normal1">The DAX code computing the open orders for this model is rather simple:</p>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-758">
					<img alt="" class="_idgenobjectattribute" src="images/000514.png" />
				</div>
			</div>
			<p class="normal1">It is worth noting that REMOVEFILTERS is required, in order to remove any report filters that may be affecting the <span class="charoverride3">Date</span> table.</p>
			<p class="normal1">Based on this measure, you can compute the two variations (end of period and average) using the following formulas:</p>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-759">
					<img alt="" class="_idgenobjectattribute" src="images/000529.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-760">
					<img alt="" class="_idgenobjectattribute" src="images/000543.png" />
				</div>
			</div>
			<p class="normal1">You can see the result of these formulas in Figure 15-5.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-761">
					<img alt="" class="_idgenobjectattribute" src="images/000309.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 15-5</span> The three measures report different results for numbers of open orders.</p>
			<p class="normal1">The <span class="charoverride3">Orders</span> table might have more than one row for each order. If the <span class="charoverride3">Orders</span> table has one row for each line in the order instead of one row for each order, then you should use DISTINCTCOUNT over a column containing a unique identifier for each order &ndash; instead of using COUNTROWS over the <span class="charoverride3">Orders</span> table. This is not the case in our sample model, but in that scenario the <span class="charoverride3"># Open Orders ALL</span> formula would differ by just one line:</p>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-762">
					<img alt="" class="_idgenobjectattribute" src="images/000558.png" />
				</div>
			</div>
			<p class="normal1">If you want to compute the dollar value of the open orders, you use the <span class="charoverride3">Sales Amount</span> measure instead of the COUNTROWS or DISTINCTCOUNT functions. For example, this is the definition of the <span class="charoverride3">Open Amount ALL</span> measure:</p>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-763">
					<img alt="" class="_idgenobjectattribute" src="images/000572.png" />
				</div>
			</div>
			<p class="normal1">The other two measures just reference the underlying <span class="charoverride3">Open Amount ALL</span> measure instead of <span class="charoverride3"># Open Orders ALL</span>:</p>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-764">
					<img alt="" class="_idgenobjectattribute" src="images/000586.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-765">
					<img alt="" class="_idgenobjectattribute" src="images/000003.png" />
				</div>
			</div>
			<p class="normal1">The Figure 15-6 shows the results of the measures defined above.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-766">
					<img alt="" class="_idgenobjectattribute" src="images/000440.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 15-6</span> The three measures display the value of all open orders compared side by side.</p>
			<p class="normal1">The formulas described in this section work well on small datasets, but they require a big effort from the Formula Engine; this results in reduced performance starting from medium-sized databases and above - think hundreds of thousands of orders. If you need better performance, using a snapshot table is a very good option.</p>
			<p class="heading1" id="calibre_link-767">Open orders with snapshot</p>
			<p class="normal--unindented">Building a snapshot simplifies the calculation and speeds up the performance. A daily snapshot contains one row per day and order that is open on that day. Therefore, a single order that has been open for 10 days requires 10 rows in the snapshot.</p>
			<p class="normal1">In Figure 15-7 you can see an excerpt from the snapshot table.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-768">
					<img alt="" class="_idgenobjectattribute" src="images/000568.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 15-7</span> Each order has as many rows as days it has been open.</p>
			<p class="normal1">For large data models where the snapshot requires tens of millions of rows, it is suggested to use specific ETLs or queries in SQL to get the snapshot result. For smaller data models, the snapshot table can be created by using either Power Query or DAX. For example, the snapshot of our sample model can be created using the following definition of the <span class="charoverride3">Open Orders</span> calculated table:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-769">
					<img alt="" class="_idgenobjectattribute" src="images/000015.png" />
				</div>
			</div>
			<p class="normal1">In Figure 15-8 you can see that the <span class="charoverride3">Open Orders</span> snapshot has a set of regular relationships with the other tables in the model.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-770">
					<img alt="" class="_idgenobjectattribute" src="images/000053.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 15-8</span> The snapshot is related to other tables, so to perform slicing and dicing.</p>
			<p class="normal1">Using the snapshot, the formulas that compute the number of open orders are faster and simpler to write:</p>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-771">
					<img alt="" class="_idgenobjectattribute" src="images/000029.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure (hidden) in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-772">
					<img alt="" class="_idgenobjectattribute" src="images/000043.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-773">
					<img alt="" class="_idgenobjectattribute" src="images/000057.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-774">
					<img alt="" class="_idgenobjectattribute" src="images/000071.png" />
				</div>
			</div>
			<p class="normal1">Only the <span class="charoverride3"># Open Orders ALL</span> measure requires the DISTINCTCOUNT function. The other two measures, <span class="charoverride3"># Open Orders EOP</span> and <span class="charoverride3"># Open Orders AVG</span> count the number of open orders one day at a time, which can be done using a faster COUNTROWS over the snapshot table.</p>
			<p class="normal1">The <span class="charoverride3">Open Amount ALL</span> measure requires you to apply the list of open orders as a filter to the <span class="charoverride3">Orders</span> table. This is achieved using TREATAS:</p>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-775">
					<img alt="" class="_idgenobjectattribute" src="images/000086.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Open Amount EOP</span> and <span class="charoverride3">Open Amount AVG</span> measures just reference the underlying <span class="charoverride3">Open Amount ALL</span> measure instead of <span class="charoverride3"># Open Orders ALL</span>:</p>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-776">
					<img alt="" class="_idgenobjectattribute" src="images/000101.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-777">
					<img alt="" class="_idgenobjectattribute" src="images/000003.png" />
				</div>
			</div>
			<p class="normal1">The size of the snapshot depends on the number of orders and on the average duration of an order. If an order typically stays open for a few days, then it is fine to use a daily granularity. If an order is usually active for a much longer period of time (think years) then you should consider moving the snapshot granularity to the month level &ndash; one row for each order open in each month.</p>
			<p class="normal1">A possible optimization requires an inactive relationship between <span class="charoverride3">Orders</span> and <span class="charoverride3">Open Orders</span>. This is only useful when the <span class="charoverride3">Orders</span> table has one row per order &ndash; the <span class="charoverride3">Orders[Order Number]</span> column is thus unique and the relationship has a one-to-many cardinality. The inactive relationship should be like the one highlighted in Figure 15-9. Do not use this technique with a many-to-many cardinality because the pure DAX approach based on TREATAS would be similar in performance and simpler to manage.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-778">
					<img alt="" class="_idgenobjectattribute" src="images/000112.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 15-9</span> The inactive one-to-many relationship allows for performance optimization. </p>
			<p class="normal1">Then you should replace the previous <span class="charoverride3">Open Amount ALL</span> measure with the code of the <span class="charoverride3">Open Amount ALL optimized</span> measure defined as follows:</p>
			<p class="code-block-screened-head">Measure in the Orders table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-779">
					<img alt="" class="_idgenobjectattribute" src="images/000116.png" />
				</div>
			</div>
			<p class="normal1">Leveraging the relationship to transfer the filter reduces the workload of the Formula Engine and improves the performance of all the measures based on <span class="charoverride3">Open Amount ALL</span>. You should just consider the side effects of USERELATIONSHIP in different models, applying the required CROSSFILTER to remove possible ambiguities. Usually it should be enough to disable the relationship between <span class="charoverride3">Orders</span> and <span class="charoverride3">Date</span> like in this example, but carefully check the accuracy of the results by comparing the optimized measure with the one based on TREATAS.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-780">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-781">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-782">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-783">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-784">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-785">
			</div>
		</div>
	</div>


<div id="calibre_link-17" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-786">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture14" id="calibre_link-787">
					<img alt="" class="_idgenobjectattribute" src="images/000288.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 16</p>
			<p class="ch-title--no-toc" id="calibre_link-788"><a id="calibre_link-789" class="calibre2"></a>Ranking</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-229"><span class="hyperlink1">https://sql.bi/dax-229</span></a></p>
			<p class="normal--unindented">The ability to rank things is a very common requirement. Finding the best customers, computing the ranking position of products, or detecting the countries with the best sales volumes are among the questions most frequently asked by management.</p>
			<p class="normal1">Ranking can be either static or dynamic. Static ranking assigns to each product a ranking position that is not affected by filters, whereas in dynamic ranking the position is computed every time the user interacts with the report. For example, in dynamic ranking the year selected in the report defines a new calculation of the ranking value.</p>
			<p class="normal1">All the basic ranking calculations are based on the RANKX function, whereas more advanced techniques &ndash; like filtering the top 10 products &ndash; require the TOPN function and advanced table calculations.</p>
			<p class="heading1" id="calibre_link-790">Static ranking</p>
			<p class="normal--unindented">You assign a static ranking to a product by using a calculated column. The calculated column is computed during data refresh. Therefore, the value of the static ranking does not depend on the report filters. For example, in Figure 16-1 the first product is ranked 1 because the LCD HDTV M140 is the top seller among products of any category, whereas the second product (SV 16xDVD M360 Black) shows a product rank equal to 4 instead of 2. The reason is that there are another two products ranked 2 and 3 that are not included in the TV and Video category, which is selected in the Category slicer. Nevertheless, the ranking being static does not consider report filters. It shows the overall ranking of the products visible in the report.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-791">
					<img alt="" class="_idgenobjectattribute" src="images/000323.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 16-1</span> The report is showing the overall ranking, even though only a selection of products is visible.</p>
			<p class="normal1">Removing the filter on Category, the overall ranking shows all the products as one would expect. This is shown in the following figure.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-792">
					<img alt="" class="_idgenobjectattribute" src="images/000366.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 16-2</span> With no filter on Category, the ranking simply adds one to each row.</p>
			<p class="normal1">To compute the static ranking of a product based on the <span class="charoverride3">Sales Amount</span> measure we need a calculated column in the <span class="charoverride3">Product</span> table:</p>
			<p class="code-block-screened-head">Calculated column in the Product table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-793">
					<img alt="" class="_idgenobjectattribute" src="images/000247.png" />
				</div>
			</div>
			<p class="normal1">In this code, the ALL function is not needed. However, it clarifies the intention of ranking against all the products which is why we added it; it makes the code easier to read over time.</p>
			<p class="normal1">A similar formula can be used to obtain the ranking over a subset of products. For example, the following calculated column computes the ranking of a product inside its category:</p>
			<p class="code-block-screened-head">Calculated column in the Product table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-794">
					<img alt="" class="_idgenobjectattribute" src="images/000262.png" />
				</div>
			</div>
			<p class="normal1">As shown in the figure below, the fourth row (SV 16xDVD M360 Black) has a <span class="charoverride3">Product Rank</span> of 4 and a <span class="charoverride3">Rank in Category</span> of 2, because the latter is the ranking in the TV and Video category.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-795">
					<img alt="" class="_idgenobjectattribute" src="images/000411.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 16-3</span> <span class="charoverride3">Rank in Category</span> shows the ranking local to the category of the product.</p>
			<p class="heading1" id="calibre_link-796">Dynamic ranking</p>
			<p class="normal--unindented">The Dynamic ranking pattern produces a ranking that changes depending on the report filters. Consequently, it is based on measures instead of calculated columns.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-797">
					<img alt="" class="_idgenobjectattribute" src="images/000453.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 16-4</span> Dynamic ranking ranks products among the ones visible, using the report filters.</p>
			<p class="normal1">The code of the <span class="charoverride3">Product Rank</span> measure is the following:</p>
			<p class="code-block-screened-head">Measure in the Product table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-798">
					<img alt="" class="_idgenobjectattribute" src="images/000276.png" />
				</div>
			</div>
			<p class="normal1">Obtaining different rankings requires modifying the table iterated by RANKX. For example, the following figure shows a <span class="charoverride3">Rank in Category</span> measure that returns the ranking of a product between the products of the same category, still considering any other filter existing in the report, if any.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-799">
					<img alt="" class="_idgenobjectattribute" src="images/000494.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 16-5</span> Rank in Category, as a measure, shows the ranking inside the current category.</p>
			<p class="normal1">The definition of the Rank in Category measure is the following:</p>
			<p class="code-block-screened-head">Measure in the Product table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-800">
					<img alt="" class="_idgenobjectattribute" src="images/000291.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-801">Showing the top 3 products by category</p>
			<p class="normal--unindented">Ranking is useful to obtain reports that filter products based on their local ranking in a given group. For example, the report below shows how to obtain the top three products for each category. There are two possible solutions to this scenario, depending on whether the product name is part of the report or not.</p>
			<p class="normal1">If the report contains the product name, then we can use the <span class="charoverride3">Rank in Category</span> measure of the dynamic pattern and rely on Power BI visual filters.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-802">
					<img alt="" class="_idgenobjectattribute" src="images/000538.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 16-6</span> This report shows the top three products by category, by filtering the <span class="charoverride3">Rank in Category</span> measure in the visual.</p>
			<p class="normal1">Although this technique is not the most powerful, we show it because it is a very efficient way of filtering the top three products. Besides, it also solves the most common requirement which is to actually show by name the products included in the top three.</p>
			<p class="normal1">Nevertheless, if the product name is not part of the visual, then this technique cannot be used. The reason is that the granularity of the visual is not compatible with the measure and the previous technique no longer works. In the figure below, we removed the product names from the report above.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-803">
					<img alt="" class="_idgenobjectattribute" src="images/000581.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 16-7</span> <span class="charoverride3">Sales Amount</span> shows the total for all the products in each category ignoring the filter on the <span class="charoverride3">Rank in Category</span> measure.</p>
			<p class="normal1">The reason the visual filter is not effective is because it is only applied to the maximum granularity of the visual. Therefore, the visual filter does not necessarily apply to the products. In order to enforce the filter over product names, the measure displaying <span class="charoverride3">Sales Amount</span> must enforce the computation of the ranking at the correct granularity, determining the products to be included in the calculation and then using those products as a filter. The report must display the amount using the following definition of <span class="charoverride3">Sales Top 3 Products</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-804">
					<img alt="" class="_idgenobjectattribute" src="images/000305.png" />
				</div>
			</div>
			<p class="normal1">The following figure shows the result of <span class="charoverride3">Sales Top 3 Products</span> side by side with <span class="charoverride3">Sales Amount</span>. Though the product name is not part of the report, the formula for <span class="charoverride3">Sales Top 3 Products</span> retrieves sales strictly for the top three products of each category, ignoring all other products. This also applies to the grand total of the report.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-805">
					<img alt="" class="_idgenobjectattribute" src="images/000023.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 16-8</span> <span class="charoverride3">Sales Top 3 Products</span> reports the sales of the top three products for each category.</p>
			<p class="normal1">Performance-wise, the formula used for <span class="charoverride3">Sales Top 3 Products</span> is slightly slower than the one using the visual-level filter. Therefore, we suggest implementing the first solution, if feasible, and reverting to the full pattern only if strictly necessary or if the client tool does not support visual-level filters.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-806">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-807">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-808">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-809">
			</div>
		</div>
	</div>


<div id="calibre_link-20" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-810">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture15" id="calibre_link-811">
					<img alt="" class="_idgenobjectattribute" src="images/000450.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 17</p>
			<p class="ch-title--no-toc" id="calibre_link-812"><a id="calibre_link-813" class="calibre2"></a>Hierarchies</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-220"><span class="hyperlink1">https://sql.bi/dax-220</span></a></p>
			<p class="normal--unindented">Hierarchies are often created in data models to simplify the browsing of the model by providing users with suggested paths of navigation through attributes. The definition of the hierarchies follows the requirements of the model. For example, the <span class="charoverride3">Date</span> table usually contains a hierarchy with levels like year, quarter, month, and day. Similarly, the <span class="charoverride3">Product</span> table usually includes a common hierarchy like <span class="charoverride3">Category</span>, <span class="charoverride3">Subcategory</span> and <span class="charoverride3">Product</span>.</p>
			<p class="normal1">Hierarchies make it possible to insert multiple columns at once in a report, but hierarchies are also useful to drive calculations. For example, a measure can show sales as a percentage over the parent of the current level of the hierarchy. Any other calculation can use the same approach by just customizing the calculation associated to each level of the hierarchy.</p>
			<p class="heading1" id="calibre_link-814">Detecting the current level of a hierarchy</p>
			<p class="normal--unindented">Any calculation involving hierarchies requires the DAX code to detect the current level of the hierarchy. Therefore, it is important to understand how to detect the level of a hierarchy where a measure is being evaluated. Figure 17-1 shows the <span class="charoverride3">Product Level</span> measure whose only goal is to detect the hierarchy level being browsed. The <span class="charoverride3">Product Level</span> measure is usually hidden in the model because it is only used in other measures and implements a calculation related to the hierarchy level.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-815">
					<img alt="" class="_idgenobjectattribute" src="images/000404.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 17-1</span> The report shows the level being browsed.</p>
			<p class="normal1">The <span class="charoverride3">Product Level</span> measure is defined as follows:  </p>
			<p class="code-block-screened-head">Measure (hidden) in the Product table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-816">
					<img alt="" class="_idgenobjectattribute" src="images/000299.png" />
				</div>
			</div>
			<p class="normal1">By using ISINSCOPE, the three variables <span class="charoverride3">IsProductInScope</span>, <span class="charoverride3">IsSubcatInScope</span>, and <span class="charoverride3">IsCatInScope</span> check whether each level of the hierarchy is currently being grouped by. In that case, the corresponding column has a single value visible in the filter context.</p>
			<p class="normal1">The SWITCH statement detects the level by looking for the first level visible starting from the more granular one. The order of the conditions in SWITCH is relevant. Indeed, when the product is in scope, both category and subcategory are in scope too. Therefore, the measure must check the most restrictive filter first. The evaluation of the active level must always start from the lowest level of the hierarchy, and move up one step at a time.</p>
			<p class="normal1">The <span class="charoverride3">Product Level</span> measure is of no use by itself. The technique used in the measure is frequently used to implement a calculation depending on the current level of the hierarchy. We use this measure as a convenient way to detect the hierarchy level in the measures described further in this pattern.</p>
			<p class="readeraid--only"><span class="charoverride2">NOTE</span>&nbsp; When ISINSCOPE is not available, ISFILTERED can be used as an alternative technique &ndash; this is the case in Excel up to version 2019. However, by using ISFILTERED, the DAX expression operating over hierarchies must assume that the levels beyond the top-level of the hierarchy displayed in a visualization are not filtered outside of the visualization itself &ndash; that is, they should not be used in slicers, filters, or selected in other visuals. In order to prevent the user from doing that, if ISINSCOPE is not available it is a best practice to create a hierarchy using only hidden columns &ndash; this means duplicating the columns used in levels of a hierarchy so that they are also available as separate filters and slicers without affecting the DAX calculations over the hierarchy itself.</p>
			<p class="heading1" id="calibre_link-817">Percentage of parent node</p>
			<p class="normal--unindented">A common hierarchical calculation shows a measure as a percentage over the parent node, as shown in Figure 17-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-818">
					<img alt="" class="_idgenobjectattribute" src="images/000588.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 17-2</span> The percentage is computed against the parent node in the hierarchy.</p>
			<p class="normal1">The <span class="charoverride3">% Parent</span> measure detects the level of the hierarchy for the cell being evaluated and uses the value of the parent at the denominator of the ratio:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-819">
					<img alt="" class="_idgenobjectattribute" src="images/000313.png" />
				</div>
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-820">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-821">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-822">
			</div>
		</div>
	</div>


<div id="calibre_link-22" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-823">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture16" id="calibre_link-824">
					<img alt="" class="_idgenobjectattribute" src="images/000273.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 18</p>
			<p class="ch-title--no-toc" id="calibre_link-825"><a id="calibre_link-826" class="calibre2"></a>Parent-child hierarchies</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-221"><span class="hyperlink1">https://sql.bi/dax-221</span></a></p>
			<p class="normal--unindented">Parent-child hierarchies are often used to represent charts of accounts, stores, salespersons and such. Parent-child hierarchies have a peculiar way of storing the hierarchy in the sense that they have a variable depth. In this pattern we show how to use parent-child hierarchies to show budget, actual and forecast values in a report using both a chart of accounts and a geographic hierarchy.</p>
			<p class="heading1" id="calibre_link-827">Introduction</p>
			<p class="normal--unindented">In the Parent-child pattern the hierarchy is not defined by the presence of columns in the table of the original data source. The hierarchy is based on a structure where each node of the hierarchy is related to the key of its parent node. For example,  Figure 18-1 shows the first few rows of a parent-child hierarchy that defines a geographic structure for sales.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-828">
					<img alt="" class="_idgenobjectattribute" src="images/000418.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-1</span> The <span class="charoverride3">Entity</span> table stores the key of the parent for each entity. </p>
			<p class="normal1">Based on this data structure, we need to display a hierarchy showing Contoso United States under Contoso North America, as shown in Figure 18-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-829">
					<img alt="" class="_idgenobjectattribute" src="images/000517.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-2</span> The parent-child hierarchy derives from the parent keys.</p>
			<p class="normal1">The Parent-child pattern implements some sort of self-join of the table containing the entities, which is not supported in Tabular. Because of their nature, parent-child hierarchies may also have a variable depth: the number of levels traversing the hierarchy top to bottom can be different depending on the navigated path. For these reasons, a parent-child hierarchy should be implemented following the technique described in this pattern.</p>
			<p class="normal1">Parent-child hierarchies are often used with charts of accounts. In this case, the nodes also define the sign to use to aggregate a value to its parent. The chart of accounts in Figure 18-3 shows expenses that are subtracted from the total &ndash; despite the numbers displayed being all positive &ndash; whereas incomes are added.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-830">
					<img alt="" class="_idgenobjectattribute" src="images/000033.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-3</span> A parent-child hierarchy used with charts of accounts may define the sign to use to aggregate values.</p>
			<p class="normal1">The DAX expressions aggregating data over a parent-child hierarchy must consider the sign used to aggregate data at lower level of a hierarchy node.</p>
			<p class="heading1" id="calibre_link-831">Basic Parent-child pattern</p>
			<p class="normal--unindented">Neither hierarchies of variable depth nor self-joins are directly supported in a Tabular model. The first step in handling parent-child hierarchies is to flatten the hierarchical structure to a regular hierarchy made up of one column for each possible level of the hierarchy. We must move from the data structure of Figure 18-4 to that of Figure 18-5. In Figure 18-4 we only have the three columns required to define a parent-child hierarchy.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-832">
					<img alt="" class="_idgenobjectattribute" src="images/000199.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-4</span> The parent-child hierarchy shows a row for each node of the hierarchy and a single column with the name, regardless of the number of levels in the hierarchy.</p>
			<p class="normal1">The full expansion of the parent-child hierarchy in this example requires four levels. Figure 18-5 shows that there is one column for each level of the hierarchy, named <span class="charoverride3">Level1</span> to <span class="charoverride3">Level4</span>. The number of columns required depends on the data, so it is possible to add additional levels to accommodate for future changes in the data.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-833">
					<img alt="" class="_idgenobjectattribute" src="images/000324.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-5</span> Flattened hierarchy where each level of the original parent-child hierarchy is stored in a separate column.</p>
			<p class="normal1">The first step is to create a technical column called <span class="charoverride3">EntityPath</span> by using the PATH function:</p>
			<p class="code-block-screened-head">Calculated column in the Entity table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-834">
					<img alt="" class="_idgenobjectattribute" src="images/000327.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">EntityPath</span> column contains the full path to reach the node corresponding to the row of the table, as shown in Figure 18-6. This technical column is useful to define the <span class="charoverride3">Level</span> columns. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-835">
					<img alt="" class="_idgenobjectattribute" src="images/000454.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-6</span> The <span class="charoverride3">EntityPath</span> technical column contains the traversal path to reach the node from the root level.</p>
			<p class="normal1">The code for all the <span class="charoverride3">Level</span> columns is similar, and only differs in the value assigned to the <span class="charoverride3">LevelNumber</span> variable. This is the code for the <span class="charoverride3">Level1</span> column:</p>
			<p class="code-block-screened-head">Calculated column in the Entity table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-836">
					<img alt="" class="_idgenobjectattribute" src="images/000341.png" />
				</div>
			</div>
			<p class="normal1">The other columns have a different name and a different value assigned to <span class="charoverride3">LevelNumber</span>, corresponding to the relative position of their level in the hierarchy. Once all the <span class="charoverride3">Level</span> columns are defined, we hide them and create a regular hierarchy in the table that includes all of them &ndash; all the <span class="charoverride3">Level</span> columns. Only exposing these columns through a hierarchy is important in order to make sure they are used in properly by the user navigating a report.</p>
			<p class="normal1">If used straight in a report, the hierarchy still does not provide an optimal result. Indeed, all the levels are always shown, even though they might contain no value. Figure 18-7 shows a blank row under Contoso Asia Online Store, even though the <span class="charoverride3">Level4</span> column for that node is blank - thus meaning that the node can be expanded only three levels, not four.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-837">
					<img alt="" class="_idgenobjectattribute" src="images/000582.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-7</span> Rows with blank names should be hidden, but this does not happen by default.</p>
			<p class="normal1">To hide the unwanted rows, for each row we must check whether the current level is available by the visited node. This can be accomplished by checking the depth of each node. We need a calculated column in the hierarchy table containing the depth of the node defined by each row:</p>
			<p class="code-block-screened-head">Calculated column in the Entity table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-838">
					<img alt="" class="_idgenobjectattribute" src="images/000357.png" />
				</div>
			</div>
			<p class="normal1">We need two measures: <span class="charoverride3">EntityRowDepth</span> returns the maximum depth of the current node, whereas <span class="charoverride3">EntityBrowseDepth</span> returns the current depth of the matrix by leveraging the ISINSCOPE function:</p>
			<p class="code-block-screened-head">Measure in the Entity table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-839">
					<img alt="" class="_idgenobjectattribute" src="images/000372.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Entity table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-840">
					<img alt="" class="_idgenobjectattribute" src="images/000387.png" />
				</div>
			</div>
			<p class="normal1">Finally, we use these two measures to blank out the result if the <span class="charoverride3">EntityRowDepth</span> is greater than the browsing depth:</p>
			<p class="code-block-screened-head">Measure in the StrategyPlan table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-841">
					<img alt="" class="_idgenobjectattribute" src="images/000402.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the StrategyPlan table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-842">
					<img alt="" class="_idgenobjectattribute" src="images/000416.png" />
				</div>
			</div>
			<p class="normal1">The report obtained by using the <span class="charoverride3">Total Base</span> measure no longer contains rows with an empty description, as shown in Figure 18-8.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-843">
					<img alt="" class="_idgenobjectattribute" src="images/000067.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-8</span> The rows with a blank name have disappeared because <span class="charoverride3">Total Base</span> also returns blank in those cases.</p>
			<p class="normal1">The same pattern must be applied to any measure that could be reported by using the parent-child hierarchy.</p>
			<p class="heading1" id="calibre_link-844">Chart of accounts hierarchy</p>
			<p class="normal--unindented">The Chart of accounts pattern is a variation of the basic Parent-child hierarchy pattern, where the hierarchy is also used to drive the calculations. Each row in the hierarchy is tagged as either Income, Expense or Taxation. Incomes need to be summed, whereas expenses and taxation must be subtracted from the total. The Figure 18-9 shows the content of the table containing the hierarchy items.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-845">
					<img alt="" class="_idgenobjectattribute" src="images/000126.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-9</span> Each row in the hierarchy defines an <span class="charoverride3">AccountType</span> that drives the calculations.</p>
			<p class="normal1">The implementation is similar to the Parent-child pattern, grouping the calculation by <span class="charoverride3">AccountType</span> and applying the proper sign to the calculation depending on the value of <span class="charoverride3">AccountType</span>:</p>
			<p class="code-block-screened-head">Measure in the StrategyPlan table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-846">
					<img alt="" class="_idgenobjectattribute" src="images/000430.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">Total</span> measure can use both parent-child hierarchies: the hierarchy defined in the <span class="charoverride3">Entity</span> table &ndash; shown in the previous example &ndash; and the hierarchy defined in the <span class="charoverride3">Account</span> table, which is the subject of this section. </p>
			<p class="normal1">The formula in <span class="charoverride3">Total</span> returns the right result for each node of the hierarchy. However, in these types of reports it is commonly requested that the numbers be shown as positive despite being expenses. The requirement can be fulfilled by changing the sign of the result at the report level. The following <span class="charoverride3">Total No Signs</span> measure implements the calculation this way: It first determines the sign to use for the report, and then it changes the sign of the result in order to show expenses as positive numbers, even though they are internally managed as negative numbers:</p>
			<p class="code-block-screened-head">Measure in the StrategyPlan table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-847">
					<img alt="" class="_idgenobjectattribute" src="images/000444.png" />
				</div>
			</div>
			<p class="normal1">The report obtained using <span class="charoverride3">Total No Signs</span> is visible in Figure 18-10.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-848">
					<img alt="" class="_idgenobjectattribute" src="images/000152.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-10</span> The result of the parent-child hierarchy using the <span class="charoverride3">Total No Signs</span> measure.</p>
			<p class="normal1">The pattern shown above works fine if the chart of accounts contains the <span class="charoverride3">AccountType</span> column, which defines each item as being either an income or an expense. Sometimes the chart of accounts has a different way of defining the sign to use. For example, there could be a column defining the sign to use when aggregating an account to its parent. This is the case of the <span class="charoverride3">Operator</span> column shown in Figure 18-11.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-849">
					<img alt="" class="_idgenobjectattribute" src="images/000165.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-11</span> The operator column indicates the sign to use to aggregate one account to its parent.</p>
			<p class="normal1">In this case, the code to author is more complex. We need one column for each level of the hierarchy, stating how that account needs to be shown when aggregated at any given level of the hierarchy. A single account can be aggregated at one level with a plus, but at a different level with a minus.</p>
			<p class="normal1">These columns need to be built from the bottom of the hierarchy. In this example we need seven columns because there are seven levels. The column indicates the sign to use when aggregating that specific item of the hierarchy at the desired level. Figure 18-12 shows the result of the seven columns in this example.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-850">
					<img alt="" class="_idgenobjectattribute" src="images/000178.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-12</span> The columns from <span class="charoverride3">S L1</span> to <span class="charoverride3">S L7</span> show the sign required when aggregating the account at the correspondent hierarchical level.</p>
			<p class="normal1">For instance, examine the rows with <span class="charoverride3">AccountKey</span> 4 and 5: account 4 (Sale Revenue) must be summed when aggregated at levels 1, 2, 3 and 4, whereas it is not visible at other levels. Account 5 (Cost of Goods Sold) must be summed when aggregated at level 4, but it must be subtracted when aggregated at levels 1, 2, and 3.</p>
			<p class="normal1">The DAX formula computing the sign at each level starts from the most granular level &ndash; level 7 in our example. At this most granular level, the sign to use is just the operator converted into +1 or -1, for convenience in further calculations:</p>
			<p class="code-block-screened-head">Calculated column in the Account table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-851">
					<img alt="" class="_idgenobjectattribute" src="images/000458.png" />
				</div>
			</div>
			<p class="normal1">All the other columns (from level 1 to level 6) follow a similar pattern, though for each level the DAX expression must consider the sign at the more granular, adjacent level (stored in the <span class="charoverride3">PrevSign</span> variable) and invert the result when that level shows a “-“ sign, as shown in the column for level 6:</p>
			<p class="code-block-screened-head">Calculated column in the Account table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-852">
					<img alt="" class="_idgenobjectattribute" src="images/000472.png" />
				</div>
			</div>
			<p class="normal1">Once the level columns are ready, the <span class="charoverride3">Signed Total</span> measure computing the total with custom signs is the following:</p>
			<p class="code-block-screened-head">Measure in the StrategyPlan table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-853">
					<img alt="" class="_idgenobjectattribute" src="images/000486.png" />
				</div>
			</div>
			<p class="normal1">We can compare the result of this last <span class="charoverride3">Signed Total </span>measure with that of the previous <span class="charoverride3">Total</span> measure in Figure 18-13.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-854">
					<img alt="" class="_idgenobjectattribute" src="images/000192.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-13</span> The two formulas return a different sign for the same node in the hierarchy.</p>
			<p class="normal1">The amount for “Internet” is negative in <span class="charoverride3">Total</span>, because it is an expense. However, in <span class="charoverride3">Signed Total </span>the same row holds a positive number and it becomes negative only when it traverses the Expense node, which is aggregated to the parent with a minus sign.</p>
			<p class="heading1" id="calibre_link-855">Security pattern for a parent-child hierarchy</p>
			<p class="normal--unindented">A common security requirement for parent-child hierarchies is to restrict the visibility to a node (or a set of nodes) including all of its children. In that scenario, the PATHCONTAINS function is useful.</p>
			<p class="normal1">By applying the following expression to a security role on the <span class="charoverride3">Account</span> table, we limit the visibility to the node provided in the second argument of PATHCONTAINS. This way, all the children of the node are made visible to the user, because the node requested (2, corresponding to Income) is also part of the <span class="charoverride3">AccountPath</span> value of all the children nodes:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-856">
					<img alt="" class="_idgenobjectattribute" src="images/000499.png" />
				</div>
			</div>
			<p class="normal1">If we used the <span class="charoverride3">AccountKey</span> column to limit the visibility, we would end up limiting the visibility to only one row and the user would not see the children nodes. By leveraging the path column, we can easily select multiple rows by including all the nodes that can be reached when traversing a path that includes the filtered node.</p>
			<p class="normal1">When the security role is active, the user can only see the nodes (and the values) included in the tree starting from the Income node, as shown in Figure 18-14.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-857">
					<img alt="" class="_idgenobjectattribute" src="images/000124.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 18-14</span> The hierarchy is limited to the node that is visible for the active security role.</p>
			<p class="normal1">The nodes above the Income node (<span class="charoverride3">Level3</span>) no longer consider other children nodes in the <span class="charoverride3">Total</span> measure. In case this is misleading in the report, consider removing the initial levels from the report (in this case <span class="charoverride3">Level1</span> and <span class="charoverride3">Level2</span>) or using different descriptions of the nodes in Level1 and Level2 in order to better explain the result.</p>
			<p class="normal1">It is worth noting that the security role defined by using PATHCONTAINS may slow down the performance if used with a hierarchy with thousands of nodes. The expression in the role security must be evaluated for every node of the hierarchy when the end user opens a connection, and PATHCONTAINS can be expensive if it is applied to thousands of rows or more.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-858">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-859">
			</div>
		</div>
	</div>


<div id="calibre_link-24" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-860">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture17" id="calibre_link-861">
					<img alt="" class="_idgenobjectattribute" src="images/000218.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 19</p>
			<p class="ch-title--no-toc" id="calibre_link-862"><a id="calibre_link-863" class="calibre2"></a>Like-for-like comparison</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-225"><span class="hyperlink1">https://sql.bi/dax-225</span></a></p>
			<p class="normal--unindented">The like-for-like sales comparison is an adjusted metric that compares two time periods, restricting the comparison to products or stores with the same characteristics. In this example, we use the like-for-like technique to compare the sales of Contoso stores that had sales in all the time periods considered. The stores are continuously updated: new stores are opened, other stores are closed or renovated. The like-for-like comparison only evaluates those stores that were open in all the periods considered. This way, the report does not show a store that seems to be underperforming simply because it was closed during the period analyzed.</p>
			<p class="normal1">As is the case with many other patterns, like-for-like can be computed statically or dynamically. The choice is both in terms of performance and in terms of business requirements. The variations of the “Same store sales” measure described in the following paragraphs are examples of like-for-like sales comparisons.</p>
			<p class="heading1" id="calibre_link-864">Introduction</p>
			<p class="normal--unindented">If you analyze sales figures without considering whether stores were open or closed within the time period you are analyzing, looking at the following report might mislead you into thinking that there were issues in 2009 because of the dramatic drop in sales.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-865">
					<img alt="" class="_idgenobjectattribute" src="images/000432.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 19-1</span> Sales in 2009 dropped significantly.</p>
			<p class="normal1">In 2009 many stores were closed. Therefore, the numbers reflect a substantial drop in sales due to the lower number of open stores, as you can see in the following report that shows which stores were open in different years. A blank cell means that the store was closed in that particular year.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-866">
					<img alt="" class="_idgenobjectattribute" src="images/000111.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 19-2</span> Not all the stores are open every year.</p>
			<p class="normal1">In the “same store sales” measure, you must compute the sales amount just for the stores that were open during the entire time period (2007-2009), namely three stores.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-867">
					<img alt="" class="_idgenobjectattribute" src="images/000047.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 19-3</span> Only three stores were open during the entire three-year period.</p>
			<p class="normal1">The measure must compute the correct value even when sliced by different attributes, as shown in Figure 19-4.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-868">
					<img alt="" class="_idgenobjectattribute" src="images/000212.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 19-4</span> The measure totals the same numbers also when sliced by other attributes.</p>
			<p class="heading1" id="calibre_link-869">Same store sales with snapshot</p>
			<p class="normal1">The best method to solve the same store sales scenario is to use a snapshot table to manage store statuses. Later in this pattern we also demonstrate how to compute same store sales in a dynamic way without a snapshot table. Nevertheless, the snapshot table is the best option for both performance and manageability.</p>
			<p class="normal1">The snapshot table must contain all the stores and years, with an additional column indicating the status.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-870">
					<img alt="" class="_idgenobjectattribute" src="images/000337.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 19-5</span> The snapshot table <span class="charoverride3">StoreStatus</span> indicates the status of each store in different years.</p>
			<p class="normal1">The <span class="charoverride3">StoreStatus</span> snapshot table can be created with the following calculated table:</p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-871">
					<img alt="" class="_idgenobjectattribute" src="images/000129.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">StoreStatus</span> snapshot table has a granularity by store and year. Therefore, it has a regular strong relationship with the <span class="charoverride3">Store</span> table and a weak Many-Many-Relationship (MMR) with the <span class="charoverride3">Date</span> table. If weak relationships are not available in your tool - like in Power Pivot - then you must transfer the filter from <span class="charoverride3">Date</span> to <span class="charoverride3">Store</span> in DAX using TREATAS or INTERSECT.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-872">
					<img alt="" class="_idgenobjectattribute" src="images/000468.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 19-6</span> The data model requires a weak MMR relationship between <span class="charoverride3">Date</span> and <span class="charoverride3">StoreStatus</span>.</p>
			<p class="normal1"><span class="charoverride11">The </span><span class="charoverride12">Same Store Sales</span><span class="charoverride11"> measure checks the stores whose status is always “Open” during the entire selected period. If a store is “Closed” at any point, then SELECTEDVALUE returns either blank or “Closed”, filtering out that store:</span></p>
			<p class="code-block-screened-head">Measure in the Receipts table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-873">
					<img alt="" class="_idgenobjectattribute" src="images/000142.png" />
				</div>
			</div>
			<p class="normal1">The formula requires the snapshot table to contain the rows for all the years and stores. If you store in the snapshot table only the years when a store was open, then the code no longer works.</p>
			<p class="heading1" id="calibre_link-874">Same store sales without snapshot</p>
			<p class="normal--unindented">In case you do not have the option of building a snapshot table, same store sales can be computed in a more dynamic way using only DAX code.</p>
			<p class="normal1">If the snapshot table is not available, then you must compute the number of years of the report dynamically, and then filter all the stores that have sales in all the years. In other words, if the report is showing three years, then only the stores that have sales in all three years should survive the filter. If a store does not have sales in any one of the selected years, then that store will not be considered for the calculation:</p>
			<p class="code-block-screened-head">Measure in the Receipts table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-875">
					<img alt="" class="_idgenobjectattribute" src="images/000155.png" />
				</div>
			</div>
			<p class="normal1">From a computation perspective, this formula is much more expensive than the one using the snapshot. Besides, the entire logic to determine whether a store is open or closed lies inside the formula. In our experience, such business logic is better handled outside of DAX, possibly stored in the data source. Therefore, if you do not have that information available in the data source we suggest the implementation using the snapshot - even for smaller data models.</p>
			<p class="normal1">The <span class="charoverride3">Same Store Sales Dynamic</span> measure shows three stores that were open in Canada for the entire time period (2007-2009).</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-876">
					<img alt="" class="_idgenobjectattribute" src="images/000594.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 19-7</span> Only three stores were open in Canada during the entire three-year period.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-877">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-878">
			</div>
		</div>
	</div>


<div id="calibre_link-25" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-879">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture18" id="calibre_link-880">
					<img alt="" class="_idgenobjectattribute" src="images/000461.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 20</p>
			<p class="ch-title--no-toc" id="calibre_link-881"><a id="calibre_link-882" class="calibre2"></a>Transition matrix</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-227"><span class="hyperlink1">https://sql.bi/dax-227</span></a></p>
			<p class="normal--unindented">The Transition matrix pattern analyzes changes in an attribute assigned to an entity at regular intervals. For example, customers might receive a ranking evaluation every month, or products might have a rating score measured every week. Measuring the changes in rating between two points in time might require the evaluation of how many items moved from one rating to another within the considered interval. The transition matrix enables the end user to make this kind of analysis by just manipulating filters in a report and without having to write any custom query.</p>
			<p class="heading1" id="calibre_link-883">Introduction</p>
			<p class="normal--unindented">Each product is assigned a monthly rating based on the comparison between the percentage of sales in the current month and in the previous month. The configuration is depicted in Figure 20-1.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-884">
					<img alt="" class="_idgenobjectattribute" src="images/000474.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 20-1</span> The configuration table for ratings is based on growth percentage.</p>
			<p class="normal1">A simple implementation of the dynamic segmentation lets you analyze how many products fall under each rating every month, like in Figure 20-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-885">
					<img alt="" class="_idgenobjectattribute" src="images/000397.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 20-2</span> Counting the number of products in each rating is possible using the dynamic segmentation.</p>
			<p class="normal1">As you can imagine, one same product might be assigned different ratings over time. The same matrix in Figure 20-3, focusing on a single product, shows the situation for A. Datum SLR Camera.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-886">
					<img alt="" class="_idgenobjectattribute" src="images/000091.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 20-3</span> The same camera is assigned different ratings over time.</p>
			<p class="normal1">From a broader point of view, an interesting analysis is: taking all the products that had a given rating in a starting month, how did they evolve over time? Has their rating improved or worsened in the following months? You can see the result in Figure 20-4.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-887">
					<img alt="" class="_idgenobjectattribute" src="images/000251.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 20-4</span> The report shows the rating evolution of the 36 products ranked Stable in March 2007.</p>
			<p class="normal1">The report is showing that there are 36 products rated Stable in March 2007. The rating for that same set of products changes in different months, and a product only has a rating for months when there are sales. The number of products with a rating might thus change over time. In April for example, 8 out of the 36 products have a lower rating, 10 have the same rating, and 13 have a higher rating. 5 of the original 36 products have no rating in April 2007, because there were no sales for those 5 products. The products considered in April are only products with a rating in March 2007, the only change is their monthly rating and the 5 products without sales in April are not included because they have no rating in that month. The same reasoning applies to all the other months, always based on the 36 products that are Stable in March.</p>
			<p class="normal1">There are multiple ways of generating the transition matrix; here, we outline two possible solutions. The first solution is based on a snapshot table, generating a very fast static transition matrix. The second solution is based on pure DAX code, resulting in a slower but more flexible dynamic transition matrix.</p>
			<p class="normal1">Both patterns share some of the data modeling requirements. Therefore, we first explain the easier static transition matrix. Later on, we dive into more details with the dynamic transition matrix. In the dynamic transition matrix section, we will not repeat some of the details explained in the static transition matrix. Therefore, if you need to implement the dynamic transition matrix pattern, please review the static pattern first, in order to gather the required information on how to setup your model.</p>
			<p class="heading1" id="calibre_link-888">Static transition matrix</p>
			<p class="normal--unindented">The static transition matrix uses a snapshot table containing the rating assigned to each product on a monthly basis. In the example provided, we generated this snapshot through a DAX calculated table. In your scenario, you might have the same information already provided in the data source. The important thing is that the table must contain the month, the product, and the rating assigned. In Figure 20-5 you can see an excerpt of the <span class="charoverride3">Monthly Ratings</span> snapshot table.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-889">
					<img alt="" class="_idgenobjectattribute" src="images/000383.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 20-5</span> The snapshot contains the month, the product, and the product ratings for every month.</p>
			<p class="normal1">The snapshot table is not enough to solve the scenario. We need two additional tables to enable the user to select a starting month and a starting rating. The user interface provided to the user is visible in Figure 20-6.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-890">
					<img alt="" class="_idgenobjectattribute" src="images/000510.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 20-6</span> There needs to be four independent columns in the model to let the user create this report.</p>
			<p class="normal1">The slicer for Starting Month (1) cannot be based on the <span class="charoverride3">Date[Calendar Year Month] </span>column. Indeed, the <span class="charoverride3">Date</span> table is already used in the rows of the matrix (3). Therefore, the <span class="charoverride3">Date</span> table cannot be filtered by an external slicer in order to show &ndash; for example &ndash; September 2007 even though the starting month is March 2007. Similarly, the slicer with the Starting Rating (2) cannot use the same snapshot rating attribute applied to the columns of the matrix (4). The columns of the matrix and the slicer must be fed by different tables.</p>
			<p class="normal1">We need two calculated tables for the slicers that we call <span class="charoverride3">Starting Month</span> and <span class="charoverride3">Starting Rating:</span></p>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-891">
					<img alt="" class="_idgenobjectattribute" src="images/000168.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-892">
					<img alt="" class="_idgenobjectattribute" src="images/000182.png" />
				</div>
			</div>
			<p class="normal1">These two slicer tables are not linked with any of the other tables in the model. Only the DAX code will read their selection and use it to compute the result of the measures.</p>
			<p class="normal1">However, the snapshot tables must be linked with the remaining part of the model through appropriate relationships. In this example we use a weak many-to-many relationship with <span class="charoverride3">Date</span> based on the <span class="charoverride3">Calendar Year Month Number</span> column, and a simple one-to-many strong relationship with <span class="charoverride3">Product</span> based on the <span class="charoverride3">ProductKey</span> column. The diagram is visible in Figure 20-7.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-893">
					<img alt="" class="_idgenobjectattribute" src="images/000011.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 20-7</span> The snapshot table must have relationships with the other entities in the model.</p>
			<p class="normal1">Once the model is set, the DAX code must read the current selection on the two slicer tables and use the information to determine the list of products that &ndash; in the selected month &ndash; are in the selected status. Once the list of products is computed, it is used as a filter over the snapshot table in order to restrict the calculation strictly to the relevant products:</p>
			<p class="code-block-screened-head">Measure in Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-894">
					<img alt="" class="_idgenobjectattribute" src="images/000195.png" />
				</div>
			</div>
			<p class="normal1">Because the static transition matrix is based on a calculated table, its results are not dynamic. This means that if the user filters the customers in a specific country, the numbers in the transition matrix will not change. The only tables that affect the result are the ones linked through physical relationships with the snapshot. In this example these tables are <span class="charoverride3">Date</span> and <span class="charoverride3">Product</span>.</p>
			<p class="normal1">If you need a dynamic transition matrix that recomputes its result every time based on the current selection across the entire data model, then you need to implement the more powerful (albeit slower) dynamic transition matrix.</p>
			<p class="heading1" id="calibre_link-895">Dynamic transition matrix</p>
			<p class="normal--unindented">The dynamic transition matrix solves the same scenario as the static transition matrix, with the noticeable difference that it does not require the snapshot table. Instead, it computes the result every time the measure is evaluated, resulting in a dynamic calculation.</p>
			<p class="normal1">The data model is the same as the static transition matrix, but no snapshot table is required this time. The result is visible in Figure 20-8, where we added a slicer filtering one continent &ndash; the same slicer would have no effect on a static transition matrix.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-896">
					<img alt="" class="_idgenobjectattribute" src="images/000082.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 20-8</span> The dynamic transition matrix responds to any filter in the report.</p>
			<p class="normal1">Because the pattern requires computing the ranking of a product multiple times, this time we created a measure to return the rating of a product in a given month:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-897">
					<img alt="" class="_idgenobjectattribute" src="images/000208.png" />
				</div>
			</div>
			<p class="normal1">The final measure is quite intricate. It is divided into two separate steps:</p>
			<ol class="calibre3">
				<li class="num-list">Compute the list of the products that are in one of the selected states and months, chosen by the user with the slicers. To perform this operation &ndash; since the ranking of each product is unknown at the beginning &ndash; the formula computes the ranking of each product and then filters out the ones that are not selected.</li>
				<li class="num-list">Compute the status of the products computed earlier, this time in the current filter context. This second step is very similar to the previous one; the only important difference is in the filtering of dates and products, as better outlined in the code comments:</li>
			</ol>
			<p class="code-block-screened-head">Measure in Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-898">
					<img alt="" class="_idgenobjectattribute" src="images/000221.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-899">
					<img alt="" class="_idgenobjectattribute" src="images/000234.png" />
				</div>
			</div>
			<p class="normal1">As you see, this code is not trivial at all. Changing it to make it fit your specific needs requires a deep understanding of its inner workings.</p>
			<p class="normal1">The dynamic transition matrix, albeit very powerful, is extremely demanding on CPU and RAM. Its speed mainly depends on the number of products. In data models with hundreds of thousands of products, it is unlikely to be usable. On the other hand, on smaller models it works just fine, though the static transition matrix displays much better performance.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-900">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-901">
			</div>
		</div>
	</div>


<div id="calibre_link-26" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-902">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture19" id="calibre_link-903">
					<img alt="" class="_idgenobjectattribute" src="images/000375.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 21</p>
			<p class="ch-title--no-toc" id="calibre_link-904"><a id="calibre_link-905" class="calibre2"></a>Survey</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-216"><span class="hyperlink1">https://sql.bi/dax-216</span></a></p>
			<p class="normal--unindented"><span class="charoverride8">The Survey pattern uses a data model to analyze correlations between different events related to the same entity, such as customer answers to survey questions. For example, in healthcare organizations the Survey pattern can be used to analyze data about patient status, diagnoses, and medicine prescribed.</span></p>
			<p class="heading1" id="calibre_link-906">Pattern description</p>
			<p class="normal--unindented">You have a model that stores answers to questions. Therefore, consider a <span class="charoverride3">Questions</span> table containing questions and possible answers shown in Figure 21-1.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-907">
					<img alt="" class="_idgenobjectattribute" src="images/000446.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 21-1</span>  Every question has several possible answers.</p>
			<p class="normal1">The answers are stored in an <span class="charoverride3">Answers</span> table containing in each row the survey target (the <span class="charoverride3">Customer</span> in this case), one question and one answer. There are multiple rows in case the same customer provides multiple answers to the same question. The real model would store information with integer keys; In Figure 21-2 we are using strings to clarify the concept.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-908">
					<img alt="" class="_idgenobjectattribute" src="images/000352.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 21-2</span> Every row in the <span class="charoverride3">Answers</span> table contains the answer of a customer to one specific question.</p>
			<p class="normal1">By using a DAX formula, we can answer a request like, “How many customers enjoy cartoons, broken down by job and gender?” Consider Figure 21-3 as an example. In this table, totals are not strict totals. This is explained later.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-909">
					<img alt="" class="_idgenobjectattribute" src="images/000061.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 21-3</span>  Every cell shows the number of customers who like one kind of movie and provided different answers to the job and gender questions.</p>
			<p class="normal1">The report includes two slicers to select the questions to intersect in the report. The columns in the matrix have the answers to the question selected in the Question 1 slicer, whereas the rows of the matrix provide the details of questions and answers corresponding to the selection made in the Question 2 slicer. The highlighted cell shows that 9 customers who answered Cartoons to the Movie Preferences question also answered Female to the Gender question.</p>
			<p class="normal1">In order to implement this pattern, you need to load the <span class="charoverride3">Questions</span> table twice. This way you can use two slicers for the questions to analyze. Moreover, the relationship between the two copies of the questions must be inactive. Because we use the tables as filters, we named them <span class="charoverride3">Filter1</span> and <span class="charoverride3">Filter2</span>. You can see the resulting diagram in Figure 21-4.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-910">
					<img alt="" class="_idgenobjectattribute" src="images/000225.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 21-4</span>  The Survey data model includes inactive relationships between the <span class="charoverride3">Filter</span> and <span class="charoverride3">Answers</span> tables.</p>
			<p class="normal1">To compute the number of customers who answered Q1 (the question filtered by <span class="charoverride3">Filter1</span>) and Q2 (the question filtered by <span class="charoverride3">Filter2</span>) you can use the following formula:</p>
			<p class="code-block-screened-head">Measure in the Customers table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-911">
					<img alt="" class="_idgenobjectattribute" src="images/000407.png" />
				</div>
			</div>
			<p class="normal1">The formula activates the correct relationship when computing <span class="charoverride3">CustomersQ1</span> and <span class="charoverride3">CustomersQ2</span>. It then uses the two variables as filters for the <span class="charoverride3">Answers</span> table, which filters the customers through the CROSSFILTER modifier.</p>
			<p class="normal1">You can compute any calculation using the previous formula - provided that the CROSSFILTER modifier makes the <span class="charoverride3">Answers</span> table filter the table you are basing your code on. Therefore, you can replace <span class="charoverride3">COUNTROWS ( Customer )</span> with any expression involving the <span class="charoverride3">Customers</span> table. For example, the <span class="charoverride3">RevenueQ1andQ2</span> measure provides the total revenue made off of the customers included in the selection; The only difference with the <span class="charoverride3">CustomersQ1andQ2</span> measure is the <span class="charoverride3">Revenue Amount</span> measure reference that replaces the previous <span class="charoverride3">COUNTROWS ( Customer )</span> expression: </p>
			<p class="code-block-screened-head">Measure in the Customers table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-912">
					<img alt="" class="_idgenobjectattribute" src="images/000421.png" />
				</div>
			</div>
			<p class="normal1">The result of the <span class="charoverride3">RevenueQ1andQ2</span> measure is visible in Figure 21-5.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-913">
					<img alt="" class="_idgenobjectattribute" src="images/000353.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 21-5</span>  Every cell shows the revenue made off of customers who like one kind of movie and provided different answers to the job and gender questions.</p>
			<p class="normal1">If you only count the number of customers, then the previous code can be simplified and sped up by using the following variation:</p>
			<p class="code-block-screened-head">Measure in the Customers table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-914">
					<img alt="" class="_idgenobjectattribute" src="images/000435.png" />
				</div>
			</div>
			<p class="normal1">It is important to understand the condition computed in each cell. We use Figure 21-6 to explain this further, where we labeled a few cells from A to E.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-915">
					<img alt="" class="_idgenobjectattribute" src="images/000482.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 21-6</span> Each cell computes a different number, the explanation is in the text below.</p>
			<p class="normal1">Here is what is computed in each cell:</p>
			<table class="table" id="calibre_link-916">
				<colgroup class="calibre4">
					<col class="calibre5"></col>
					<col class="calibre5"></col>
				</colgroup>
				<tbody class="calibre6">
					<tr class="table1">
						<td class="table2">
							<p class="table-cell">A</p>
						</td>
						<td class="table2">
							<p class="table-cell">Female AND prefers Cartoons</p>
						</td>
					</tr>
					<tr class="table1">
						<td class="table2">
							<p class="table-cell">B</p>
						</td>
						<td class="table2">
							<p class="table-cell">( Female OR Male ) AND prefers Cartoons</p>
						</td>
					</tr>
					<tr class="table1">
						<td class="table2">
							<p class="table-cell">C</p>
						</td>
						<td class="table2">
							<p class="table-cell">( Female OR Male OR Consultant OR IT Pro OR Teacher ) AND prefers Cartoons</p>
						</td>
					</tr>
					<tr class="table1">
						<td class="table2">
							<p class="table-cell">D</p>
						</td>
						<td class="table2">
							<p class="table-cell">( Female OR Male ) AND prefers ( Cartoons OR Comedy OR Horror )</p>
						</td>
					</tr>
					<tr class="table1">
						<td class="table2">
							<p class="table-cell">E</p>
						</td>
						<td class="table2">
							<p class="table-cell">( Female OR Male OR Consultant OR IT Pro OR Teacher ) AND prefers ( Cartoons OR Comedy OR Horror )</p>
						</td>
					</tr>
				</tbody>
			</table>
			<p class="normal1">The formula uses an AND condition for the intersection between questions selected in Question 1 and Question 2, whereas it uses an OR condition for the answers provided to one same question. Remember that the OR condition means “any combination” (do not confuse it with an “exclusive or”) and the OR condition also implies a non-additive behavior of the measure.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-917">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-918">
			</div>
		</div>
	</div>


<div id="calibre_link-27" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-919">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture20" id="calibre_link-920">
					<img alt="" class="_idgenobjectattribute" src="images/000281.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 22</p>
			<p class="ch-title--no-toc" id="calibre_link-921"><a id="calibre_link-922" class="calibre2"></a>Basket analysis</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-217"><span class="hyperlink1">https://sql.bi/dax-217</span></a></p>
			<p class="normal--unindented"><span class="charoverride8">The Basket analysis pattern builds on a specific application of the Survey pattern. The goal of Basket analysis is to analyze relationships between events. A typical example is to analyze which products are frequently purchased together. This means they are in the same “basket”, hence the name of this pattern. </span></p>
			<p class="normal1"><span class="charoverride8">Two products are related when they are present in the same basket. In other words, the event granularity is the purchase of a product. The basket can be the most intuitive, like a sales order; but the basket can also be a customer; In that case, products are related if they are purchased by the same customer, albeit across different orders.</span></p>
			<p class="normal1">Because the pattern is about checking when there is a relationship between two products, the data model contains two copies of the same table of products. The two copies are named <span class="charoverride3">Product</span> and <span class="charoverride3">And Product</span>. The user chooses a set of products from the <span class="charoverride3">Product</span> table; the measures show how likely it is that products in the <span class="charoverride3">And Product</span> table are associated to the original selection.</p>
			<p class="normal1">We included in this pattern additional association rules metrics: <span class="charoverride3">support</span>, <span class="charoverride3">confidence</span>, and <span class="charoverride3">lift</span>. These measures make it easier to understand the results and they extract richer insights from the pattern.</p>
			<p class="heading1" id="calibre_link-923">Defining association rules metrics</p>
			<p class="normal--unindented">The pattern contains several measures, which we describe in detail in this section. In order to provide the definitions, we examine the orders containing at least a product of the Cameras and camcorders category and one product of the Computers category, as shown in Figure 22-1.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-924">
					<img alt="" class="_idgenobjectattribute" src="images/000488.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 22-1</span> Analysis of the orders with “Cameras and camcorders” products that also contain “Computers” products.</p>
			<p class="normal1">The report in Figure 22-1 uses two slicers: The Category slicer shows a selection of the <span class="charoverride3">Product[Category]</span> column, whereas the And Category slicer shows a selection of the <span class="charoverride3">‘And Product’[And Category]</span> column. The <span class="charoverride3"># Orders</span> measure shows you how many orders contain at least one product of the “Cameras and camcorders” category, whereas the <span class="charoverride3"># Orders And</span> measure shows how many orders contain at least one product of both the “Cameras and camcorders” <span class="charoverride2">and</span> “Computers” categories. We describe the other measures later. First, we need to make an important note: by inverting the selection between Category and And Category, the results are different by design. Most measures provide the same result (<span class="charoverride3"># Orders Both</span>, <span class="charoverride3">% Orders Support</span>, <span class="charoverride3">Orders Lift</span>), whereas <span class="charoverride3">confidence</span> (<span class="charoverride3">% Orders Confidence</span>) depends on the order of the selection. In Figure 22-2 you can see the report from Figure 22-1, with the difference that the selections were inverted between the Category and And Category slicers.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-925">
					<img alt="" class="_idgenobjectattribute" src="images/000367.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 22-2</span>  Analysis of the orders with “Computers” products that also contain “Cameras and camcorders” products.</p>
			<p class="normal1">Next, you find the definition of all the measures used in the pattern. There are two versions of all the measures: one considering the order as a basket, the other using the customer as a basket. For example, the description of <span class="charoverride3"># And</span> applies to both <span class="charoverride3"># Orders And</span> and <span class="charoverride3"># Customers And</span>.</p>
			<p class="heading" id="calibre_link-926">#</p>
			<p class="normal--unindented"><span class="charoverride3"># Orders</span> and <span class="charoverride3"># Customers</span> return the number of unique baskets in the current filter context. Figure 22-1 shows 2,361 orders containing one product from the “Cameras and camcorders” category, whereas Figure 22-2 shows 2,933 orders containing at least one product from the “Computers” category.</p>
			<p class="heading" id="calibre_link-927"># And</p>
			<p class="normal--unindented"><span class="charoverride3"># Orders And</span> and <span class="charoverride3"># Customers And</span> return the number of unique baskets containing products of the <span class="charoverride3">And Product</span> selection in the current filter context. These measures ignore the <span class="charoverride3">Product</span> selection. Figure 22-1 shows 2,933 orders containing at least one product from the “Computers” category.</p>
			<p class="heading" id="calibre_link-928"># Total</p>
			<p class="normal--unindented"><span class="charoverride3"># Orders Total</span> and <span class="charoverride3"># Customers Total</span> return the total number of baskets and ignore any filter over <span class="charoverride3">Product</span> and<span class="charoverride3"> And Product</span>. Both Figure 22-1 and Figure 22-2 report 21,601 orders. Be mindful that the filter on <span class="charoverride3">And Product</span> is ignored by default because the relationship is not active; the only filter being explicitly ignored in the measure is the filter on <span class="charoverride3">Product</span>. If there were a filter over <span class="charoverride3">Date</span>, the measure would report only the baskets in the selected time period, and still ignore the filter over <span class="charoverride3">Product</span>.</p>
			<p class="heading" id="calibre_link-929"># Both</p>
			<p class="normal--unindented"><span class="charoverride3"># Orders Both</span> and <span class="charoverride3"># Customer Both</span> return the number of unique baskets containing products from both the categories selected with the slicers. Figure 22-1 shows that 400 orders contain products from both categories: “Cameras and camcorders” <span class="charoverride2">and</span> “Computers”.</p>
			<p class="heading" id="calibre_link-930">% Support</p>
			<p class="normal--unindented"><span class="charoverride3">% Orders Support</span> and <span class="charoverride3">% Customers Support</span> return the support of the association rule. <span class="charoverride3">Support</span> is the ratio between <span class="charoverride3"># Both</span> and <span class="charoverride3"># Total</span>. Figure 22-1 shows that 1.85% of the orders contain products from both categories: “Cameras and camcorders” <span class="charoverride2">and</span> “Computers”.</p>
			<p class="heading" id="calibre_link-931">% Confidence</p>
			<p class="normal--unindented"><span class="charoverride3">% Orders Confidence</span> and <span class="charoverride3">% Customers Confidence</span> return the confidence of the association rule. <span class="charoverride3">Confidence</span> is the ratio between <span class="charoverride3"># Both</span> and <span class="charoverride3">#</span>. Figure 22-1 shows that out of all the orders containing “Cameras and camcorders”, 16.94% also contain “Computers” products.</p>
			<p class="heading" id="calibre_link-932">Lift</p>
			<p class="normal--unindented"><span class="charoverride3">Orders Lift</span> and <span class="charoverride3">Customers Lift</span> return the ratio of confidence to the probability of the selection in <span class="charoverride3">And Product</span>. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-933">
					<img alt="" class="_idgenobjectattribute" src="images/000320.png" />
				</div>
			</div>
			<p class="normal1">A lift greater than 1 indicates an association rule which is good enough to predict events. The greater the lift, the stronger the association. Figure 22-1 reports that the association rule between “Cameras and camcorders” and “Computers” is 1.25, obtained by dividing the % Confidence (16.94%) by the probability of <span class="charoverride3"># Orders And</span> over <span class="charoverride3"># Orders Total</span> (2933/21601 = 13.58%).</p>
			<p class="heading1" id="calibre_link-934">Sample reports</p>
			<p class="normal--unindented">This section describes several reports generated on our sample model. These reports are useful to better understand the capabilities of the pattern.</p>
			<p class="normal1">The report in Figure 22-3 shows the products that are more likely to be present in orders containing “Contoso Optical USB Mouse M45 White”.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-935">
					<img alt="" class="_idgenobjectattribute" src="images/000106.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 22-3</span>  Basket analysis between products grouped by category.</p>
			<p class="normal1">“SV Keyboard E90 White” is present in 99.45% (confidence) of the orders that contain the selected mouse. The support of 3.33% indicates that the orders with this combination of products represent 3.33% of the total number of orders (21,601 as shown in Figure 22-1). The high lift value (29.67) is also a good indicator of the quality of the association rule between these two products.</p>
			<p class="normal1">The report in Figure 22-4 shows the pairs of products that are most likely to be in the same order, sorted by confidence.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-936">
					<img alt="" class="_idgenobjectattribute" src="images/000266.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 22-4</span>  Basket analysis between products.</p>
			<p class="normal1">The dataset used in this example returns somewhat similar confidence values when the order of the two products is reversed. However, this is not common. Focus on the highlighted lines: when “Contoso USB Cable M250 White” is in the first column the confidence of an association with “SV 40GB USB2.0 Portable Hard Disk E400 Silver” is slightly smaller than the other way around. In real datasets, these differences are usually bigger. Even though support and lift are identical, the order matters for confidence.</p>
			<p class="normal1">The same pattern can use the customer as a basket instead of the order. By using the customer, there are many more products in each basket. With more data, it is possible to perform an analysis by category of product instead of by individual product. For example, the report in Figure 22-5 shows what the associations are between categories in the customers’ purchase history.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-937">
					<img alt="" class="_idgenobjectattribute" src="images/000398.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 22-5</span>  Basket analysis between categories.</p>
			<p class="normal1">Customers buying “Cell phones” are likely to buy “Computers” too (confidence is 48.19%), whereas only 12.74% of customers buying “Computers” also buy “Cell phones”.</p>
			<p class="heading1" id="calibre_link-938">Basic pattern example</p>
			<p class="normal--unindented">The model requires a copy of the <span class="charoverride3">Product</span> table, needed to select the <span class="charoverride3">And Product</span> in a report. The <span class="charoverride3">And Product</span> table can be created as a calculated table using the following definition:</p>
			<p class="code-block-screened-head">Calculated table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-939">
					<img alt="" class="_idgenobjectattribute" src="images/000449.png" />
				</div>
			</div>
			<p class="normal1">There is an inactive relationship between the <span class="charoverride3">And Product</span> table and <span class="charoverride3">Sales,</span> connecting the <span class="charoverride3">Sales[ProductKey]</span> column used in the relationship between <span class="charoverride3">Product</span> and <span class="charoverride3">Sales</span>. The relationship must be inactive because it is only used in the measures of this pattern and should not affect other measures in the model. Figure 22-6 shows the relationships between <span class="charoverride3">Product</span>, <span class="charoverride3">And Product</span>, and <span class="charoverride3">Sales</span>.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-940">
					<img alt="" class="_idgenobjectattribute" src="images/000525.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 22-6</span>  Relationships between <span class="charoverride3">Product</span>, <span class="charoverride3">And Product</span>, and <span class="charoverride3">Sales</span>.</p>
			<p class="normal1">We use two baskets: orders and customers. An order is identified by <span class="charoverride3">Sales[Order Number]</span>, whereas a customer is identified by <span class="charoverride3">Sales[CustomerKey]</span>. From now on, we show only the measures for orders, because the measures for the customers are a basic variation &ndash; obtained by replacing <span class="charoverride3">Sales[Order Number]</span> with <span class="charoverride3">Sales[CustomerKey]</span>. The curious reader can find the customer measures in the sample files.</p>
			<p class="normal1">The first measure counts the number of unique orders in the current filter context:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-941">
					<img alt="" class="_idgenobjectattribute" src="images/000463.png" />
				</div>
			</div>
			<p class="normal1">Before we describe the remaining measures in the pattern, a small digression is required. The <span class="charoverride3"># Orders</span> measure is actually a DISTINCTCOUNT over <span class="charoverride3">Sales[Order Number]</span>. We used an alternative implementation for both flexibility and performance reasons. Let us elaborate on the rationale of this choice.</p>
			<p class="normal1">The <span class="charoverride3"># Orders</span> measure could have been written using the following formula with DISTINCTCOUNT:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-942">
					<img alt="" class="_idgenobjectattribute" src="images/000477.png" />
				</div>
			</div>
			<p class="normal1">In DAX this is a shorter way to perform a COUNTROWS over DISTINCT:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-943">
					<img alt="" class="_idgenobjectattribute" src="images/000490.png" />
				</div>
			</div>
			<p class="normal1">You can replace DISTINCT with SUMMARIZE this way:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-944">
					<img alt="" class="_idgenobjectattribute" src="images/000503.png" />
				</div>
			</div>
			<p class="normal1">The last three versions of the formula return the same result in terms of performance and query plan. Using SUMX instead of COUNTROWS leads to the same result:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-945">
					<img alt="" class="_idgenobjectattribute" src="images/000519.png" />
				</div>
			</div>
			<p class="normal1">Usually, replacing COUNTROWS with SUMX produces a query plan with lower performance. However, the specifics of Basket analysis make this alternative much faster in this pattern. More details about this optimization are available in this article: <a href="https://www.sqlbi.com/articles/analyzing-distinctcount-performance-in-dax/"><span class="hyperlink">Analizing the performance of DISTINCTCOUNT in DAX</span></a>. </p>
			<p class="normal1">The advantage of using SUMMARIZE is that we can replace the second argument with a column that represents the basket even if it is in another table, as long as the table is related to <span class="charoverride3">Sales</span>. For example, the measure computing the number of unique customer cities can be written this way:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-946">
					<img alt="" class="_idgenobjectattribute" src="images/000533.png" />
				</div>
			</div>
			<p class="normal1">The first argument of SUMMARIZE needs to be the table containing the transactions, like <span class="charoverride3">Sales</span>. If the second argument is a column in <span class="charoverride3">Customer</span>, then you have no choice: you must use that column. For example, for the city of the customer you specify <span class="charoverride3">Customer[City]</span>. In case you use the column that defines the relationship, like <span class="charoverride3">CustomerKey</span> for <span class="charoverride3">Customer</span>, then you can choose to use either <span class="charoverride3">Sales[CustomerKey]</span> or <span class="charoverride3">Customer[CustomerKey]</span>. Whenever possible, it is better to use the column available in <span class="charoverride3">Sales</span> to avoid traversing the relationship. This is why instead of using <span class="charoverride3">Customer[CustomerKey]</span> to identify the customer as a basket, we used <span class="charoverride3">Sales[CustomerKey]</span>:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-947">
					<img alt="" class="_idgenobjectattribute" src="images/000547.png" />
				</div>
			</div>
			<p class="normal1">Now that we have explained why we use SUMMARIZE instead of DISTINCT to identify the basket attribute, we can move forward with the other measures of the pattern.</p>
			<p class="normal1"><span class="charoverride3"># Orders And</span> computes the number of orders by using the selection made in <span class="charoverride3">And Product</span>. It activates the inactive relationship between <span class="charoverride3">Sales</span> and <span class="charoverride3">And Product</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-948">
					<img alt="" class="_idgenobjectattribute" src="images/000562.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3"># Orders Total</span> returns the number of orders, while ignoring any selection in <span class="charoverride3">Product</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-949">
					<img alt="" class="_idgenobjectattribute" src="images/000576.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3"># Orders Both (Internal)</span> is a hidden measure used to compute the number of orders including <span class="charoverride4">at least</span> one item of <span class="charoverride3">Product</span> and one item of <span class="charoverride3">And Product</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-950">
					<img alt="" class="_idgenobjectattribute" src="images/000005.png" />
				</div>
			</div>
			<p class="normal1">This hidden measure is useful to compute <span class="charoverride3"># Orders Both</span> and other calculations described later in the optimized version of the pattern. <span class="charoverride3"># Orders Both</span> adds a check to return blank in case the selection in <span class="charoverride3">Product</span> and <span class="charoverride3">And Product</span> contains at least one identical product. This is required to prevent the report from showing associations between a product and itself:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-951">
					<img alt="" class="_idgenobjectattribute" src="images/000167.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">% Orders Support</span> is the ratio of <span class="charoverride3"># Orders Both</span> to <span class="charoverride3"># Orders Total</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-952">
					<img alt="" class="_idgenobjectattribute" src="images/000031.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3">% Orders Confidence</span> is the ratio of <span class="charoverride3"># Orders Both</span> to <span class="charoverride3"># Orders</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-953">
					<img alt="" class="_idgenobjectattribute" src="images/000045.png" />
				</div>
			</div>
			<p class="normal--unindented"><span class="charoverride3">Orders Lift</span> is the result of the division of <span class="charoverride3">% Orders Confidence</span> by the ratio of <span class="charoverride3"># Orders And</span> to <span class="charoverride3"># Orders Total</span>, as per the formula we had introduced earlier: </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-954">
					<img alt="" class="_idgenobjectattribute" src="images/000320.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-955">
					<img alt="" class="_idgenobjectattribute" src="images/000059.png" />
				</div>
			</div>
			<p class="normal1">The code described in this section works. Yet, the measures might display performance issues in case there are more than a few thousand products. The optimized pattern provides a faster solution, but at the same time it requires additional calculated tables and relationships to improve the performance.</p>
			<p class="heading1" id="calibre_link-956">Optimized pattern example</p>
			<p class="normal--unindented">The optimized pattern reduces the effort required at query time to find the best combinations of products to consider. The performance improvement is obtained by creating calculated tables that pre-compute the existing combinations of products in the available baskets. Because we consider orders and customers as baskets, we created two calculated tables that are related to <span class="charoverride3">Product</span>, as shown in Figure 22-7.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-957">
					<img alt="" class="_idgenobjectattribute" src="images/000025.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 22-7</span>  Relationships between <span class="charoverride3">Product</span>, <span class="charoverride3">RawProductsCustomers</span>, <span class="charoverride3">RawProductsOrders</span>, <span class="charoverride3">And Product</span>, and <span class="charoverride3">Sales</span>.</p>
			<p class="normal1">The <span class="charoverride3">RawProductsOrders</span> and <span class="charoverride3">RawProductsCustomers</span> tables contain in each row, a combination of two product keys alongside the number of baskets containing both products. The rows that would combine identical products are excluded:</p>
			<p class="code-block-screened-head">Calculated table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-958">
					<img alt="" class="_idgenobjectattribute" src="images/000074.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Calculated table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-959">
					<img alt="" class="_idgenobjectattribute" src="images/000089.png" />
				</div>
			</div>
			<p class="normal1">The filter from <span class="charoverride3">Product</span> automatically propagates to the two <span class="charoverride3">RawProducts</span> tables. Only the filter from <span class="charoverride3">And Product</span> must be moved through a DAX expression in the <span class="charoverride3"># Orders Both</span> measure. Indeed, <span class="charoverride3"># Orders Both</span> is the only measure that differs from the ones in the basic pattern:</p>
			<p class="code-block-screened-head">Measure in the Sales table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-960">
					<img alt="" class="_idgenobjectattribute" src="images/000104.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride3"># Orders Both</span> cannot use the <span class="charoverride3"># Orders Both (Internal)</span> implementation because of the way it applies the filters. <span class="charoverride3"># Orders Both</span> transfers the filter from <span class="charoverride3">And Product</span> to <span class="charoverride3">RawProductsOrders</span> and then to <span class="charoverride3">Sales</span> in order to retrieve the orders that include any of the items in <span class="charoverride3">Any Product</span>. This technique is somewhat complex, but it is useful in order to reduce the workload in the formula engine. All this results in better performance at query time.</p>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-961">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-962">
			</div>
		</div>
	</div>


<div id="calibre_link-28" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-963">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture21" id="calibre_link-964">
					<img alt="" class="_idgenobjectattribute" src="images/000393.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 23</p>
			<p class="ch-title--no-toc" id="calibre_link-965"><a id="calibre_link-966" class="calibre2"></a>Currency conversion</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-219"><span class="hyperlink1">https://sql.bi/dax-219</span></a></p>
			<p class="normal--unindented">Currency conversion is a complex scenario where both the data model and the quality of the DAX code play an important role. There are two kinds of currencies: the currency used to collect orders and the currency used to produce the report. Indeed, you might collect orders in multiple currencies, but need to report on those orders using only one currency, so to be able to compare all the values with the same unit of measure. Alternatively, you might collect (or store) orders in a single currency, but need to report the values using different currencies. Finally, you might have both orders that are collected in different currencies and reports that need to show many different currencies.</p>
			<p class="normal1">In this pattern, we cover three different scenarios where we simplified the description by only using EUR and USD:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride2">Multiple sources, single target</span>: orders are in both EUR and USD, but the report must convert all currencies into USD.</li>
				<li class="bull-list"><span class="charoverride2">Single source, multiple targets</span>: orders are only in USD, but the user can choose to see the report in either EUR or USD.</li>
				<li class="bull-list"><span class="charoverride2">Multiple sources, multiple targets</span>: orders are in both EUR and USD, but the user can choose to see the report in either EUR or USD.</li>
			</ul>
			<p class="normal1">The formulas depend on the currency conversion table available. The requirement is often to perform the currency conversion for each day of the year. Sometimes it is only possible to perform the currency conversion at a different granularity, for example at the month level. The differences in managing these different cases are minimal, and we highlight them when showing the DAX code.</p>
			<p class="normal1">For demo purposes, we created models with both the daily and the monthly currency conversions. Therefore, you find both formulas and models in the same demo file, though you should only use one of the two exchange rate granularities for a specific implementation.</p>
			<p class="normal1">We created the daily currency conversion tables by tweaking the data available in Contoso. Therefore, these examples contain imaginary currency conversion rates with the sole purpose of showing a technique &ndash; and no guarantee of accuracy at all.</p>
			<p class="heading1" id="calibre_link-967">Multiple source currencies, single reporting currency</p>
			<p class="normal--unindented">In this scenario, the source data contains orders in different currencies, and the report converts values into a single currency. For example, orders are in EUR, USD, and other currencies; the report must convert the order currency to USD.</p>
			<p class="normal1">The first thing to analyze is the model shown in Figure 23-1.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-968">
					<img alt="" class="_idgenobjectattribute" src="images/000460.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 23-1</span> The model shows how to link Sales with the Daily Exchange Rates, through Date and Currency.</p>
			<p class="normal1">The <span class="charoverride3">Sales</span> table stores the transaction value with the local currency. Every column that contains a monetary amount uses the local currency, like <span class="charoverride3">Net Price</span>, <span class="charoverride3">Unit Price</span>, and <span class="charoverride3">Unit Discount</span>. The <span class="charoverride3">Sales</span> table has a relationship with the <span class="charoverride3">Currency</span> table that depends on the currency of the transaction.</p>
			<p class="normal1">A simple measure computing the sales amount would only work if sliced by the source currency; indeed, it is not possible to aggregate values in different currencies without performing a currency conversion first. For this reason, we called the measure doing this calculation <span class="charoverride3">Sales (Internal)</span>, and we also hide this measure from the user:</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-969">
					<img alt="" class="_idgenobjectattribute" src="images/000202.png" />
				</div>
			</div>
			<p class="normal1">As shown in Figure 23-2, <span class="charoverride3">Sales (Internal)</span> produces a meaningless total, because it is summing values in different source currencies. Instead, the two measures <span class="charoverride3">Sales USD (Monthly)</span> and <span class="charoverride3">Sales USD (Daily)</span> produce a result that make sense, because they convert the <span class="charoverride3">Sales (Internal)</span> value to USD. The differences in the report between the <span class="charoverride3">Sales USD (Monthly)</span> and <span class="charoverride3">Sales USD (Daily)</span> measures are due to the fluctuation of the currency exchange rates within each month.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-970">
					<img alt="" class="_idgenobjectattribute" src="images/000382.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 23-2</span>  The sum of <span class="charoverride3">Sales (Internal)</span> across different currencies produces a meaningless result.</p>
			<p class="normal1">To perform an efficient currency conversion, we aggregate <span class="charoverride3">Sales (Internal)</span> at the granularity of the exchange rate for each currency, and then we apply the conversion rate. For example, the <span class="charoverride3">Sales USD (Daily)</span> measure implements the calculation at a day granularity by iterating with a SUMX the result of a table that has one row for each date and currency:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-971">
					<img alt="" class="_idgenobjectattribute" src="images/000215.png" />
				</div>
			</div>
			<p class="normal1">To achieve optimal performance, it is essential to reduce the number of iterations to retrieve the currency exchange rate. Performing the currency exchange rate for every transaction would be time-consuming because all the transactions made on the same day with the same currency have the same currency exchange rate. SUMMARIZE over <span class="charoverride3">Sales</span> significantly reduces the granularity of the entire formula. In case the currency exchange rates are available at the month level, the formula must reduce the granularity to the month level, like <span class="charoverride3">Sales USD (Monthly)</span>:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-972">
					<img alt="" class="_idgenobjectattribute" src="images/000228.png" />
				</div>
			</div>
			<p class="normal1">The measures used in this example do not check whether a currency exchange rate is available or not because the operation being performed is a division &ndash; which  results in a division by zero error in case a rate is missing. An alternative approach is to use the conditional statement in the following examples, which controls the error message displayed if a currency exchange rate is missing. You should use either one of the two techniques that raise an error in case a rate is missing, otherwise the report would show inaccurate numbers without any warning to the user. </p>
			<p class="heading1" id="calibre_link-973">Single source currency, multiple reporting currencies</p>
			<p class="normal--unindented">In this scenario, the source data contains orders in a single currency (USD in our example), and the user changes the currency to use in the report through a slicer. The report converts the original amount according to the date of the transaction and to the currency selected by the user.</p>
			<p class="normal1">The model shown in Figure 23-3 does not show any direct relationship between the <span class="charoverride3">Sales</span> and <span class="charoverride3">Currency</span> tables. Indeed, all the sales transactions are in USD, and the <span class="charoverride3">Currency</span> table allows the user to select the desired report currency.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-974">
					<img alt="" class="_idgenobjectattribute" src="images/000076.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 23-3</span> There is no direct relationship between <span class="charoverride3">Sales</span> and <span class="charoverride3">Currency</span>.</p>
			<p class="normal1">The user can either choose the desired currency with a slicer, or use the <span class="charoverride3">Currency[Currency]</span> column in a matrix as shown in Figure 23-4, which performs the conversion using the monthly currency exchange rates.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-975">
					<img alt="" class="_idgenobjectattribute" src="images/000238.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 23-4</span> The report shows the same sales amount by product brand in different currencies.</p>
			<p class="normal1">The structure of the formula to obtain the desired result is similar to the previous example, even though its implementation is slightly different because of the data model being different. The <span class="charoverride3">Sales (Daily)</span> measure applies a different currency conversion rate for every day:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-976">
					<img alt="" class="_idgenobjectattribute" src="images/000241.png" />
				</div>
			</div>
			<p class="normal1">The initial test with HASONEVALUE ensures that only one currency is visible in the current filter context. The <span class="charoverride3">AggregatedSalesInUSD</span> variable stores a table with the sales amount in USD and the corresponding currency exchange rate at the day granularity. The <span class="charoverride3">@Rate</span> column retrieves the proper exchange rate thanks to the existing filter over <span class="charoverride3">Currency[Currency]</span> and the context transition from <span class="charoverride3">Date[Date]</span> aggregated by SUMMARIZE. The <span class="charoverride3">Result</span> variable gets the final result by summing the result of the product of <span class="charoverride3">@Rate</span> by <span class="charoverride3">@USDSalesAmount</span>, or raises an error in case <span class="charoverride3">@Rate</span> is not available. This breaks the report with an error message that describes the data quality issue (Missing conversion rate).</p>
			<p class="normal1">If the currency exchange rate is only available at the month level, <span class="charoverride3">Sales (Monthly)</span> only differs from <span class="charoverride3">Sales (Daily)</span> by the argument of SUMMARIZE:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-977">
					<img alt="" class="_idgenobjectattribute" src="images/000256.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-978">Multiple source currencies, multiple reporting currencies</p>
			<p class="normal--unindented">This scenario is a combination of the previous two. The source data contains orders in different currencies, and the user changes the currency to use in the report through a slicer. The report converts the original amount according to the date of the transaction, the original currency, and the reporting currency selected by the user.</p>
			<p class="normal1">There are two currency tables in the data model: <span class="charoverride3">Source Currency</span> and <span class="charoverride3">Target Currency</span>. The <span class="charoverride3">Source Currency</span> table has a relationship with <span class="charoverride3">Sales</span> and represents the currency of the transaction. The <span class="charoverride3">Target Currency</span> table allows the user to select the desired currency for the report. The model is visible in Figure 23-5.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-979">
					<img alt="" class="_idgenobjectattribute" src="images/000368.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 23-5</span> In this model there are two currencies: the source linked to Sales, and the target for the user to select.</p>
			<p class="normal1">This model enables the conversion of any source currency into any target currency. Figure 23-6 shows orders collected in different currencies from several countries using the monthly currency exchange rates. The report converts the original amount into the currency displayed in the column of the matrix.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-980">
					<img alt="" class="_idgenobjectattribute" src="images/000495.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 23-6</span> The model converts any source currency into any target currency.</p>
			<p class="normal1">The formula of the measure &ndash; like the model &ndash; is a mix of the two previous ones. The HASONEVALUE function checks that only one target currency is selected. The <span class="charoverride3">AggregatedSalesInCurrency</span> variable contains a table with the sales amount aggregated at the available granularity of the currency exchange rate, also including the source currency. The <span class="charoverride3">@Rate</span> column fetches the proper exchange rate thanks to the existing filter over <span class="charoverride3">‘Target Currency’[Currency]</span>, and thanks to the context transition from <span class="charoverride3">Date[Date]</span> and <span class="charoverride3">‘Source Currency’[Currency]</span> aggregated by SUMMARIZE. The <span class="charoverride3">Result</span> variable obtains the final result by summing the result of the product of <span class="charoverride3">@Rate</span> by <span class="charoverride3">@SalesAmount</span>, or raising an error in case <span class="charoverride3">@Rate</span> is not available:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-981">
					<img alt="" class="_idgenobjectattribute" src="images/000270.png" />
				</div>
			</div>
			<p class="normal1">As with the previous examples, it is important to use the granularity of the currency exchange table. If the currency exchange rate is only available at the month level, the <span class="charoverride3">Sales (Monthly)</span> measure only differs from <span class="charoverride3">Sales (Daily)</span> by the argument of SUMMARIZE:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-982">
					<img alt="" class="_idgenobjectattribute" src="images/000284.png" />
				</div>
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-983">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-984">
			</div>
		</div>
	</div>


<div id="calibre_link-29" lang="en-US" lang="en-US" class="calibre">
		<div class="full-margin-text-frame" id="calibre_link-985">
			<div class="_idgenobjectlayout">
				<div class="chapter-picture22" id="calibre_link-986">
					<img alt="" class="_idgenobjectattribute" src="images/000296.png" />
				</div>
			</div>
			<p class="ch-number">CHAPTER 24</p>
			<p class="ch-title--no-toc" id="calibre_link-987"><a id="calibre_link-988" class="calibre2"></a>Budget</p>
			<p class="download">Download sample files: <a href="https://sql.bi/dax-214"><span class="hyperlink1">https://sql.bi/dax-214</span></a></p>
			<p class="normal--unindented">This pattern includes several coding techniques you may find useful for budgeting scenarios. The techniques do not apply only to budgeting. We use the budget as an example to show how to reallocate a measure at a different granularity, and how to combine measures coming from tables with different granularities into the same chart.</p>
			<p class="normal1">Besides, each company has its own approach for creating and managing a budget. This pattern is just an example of what can be done. You must adapt the measures and the techniques shown in this pattern to your specific business.</p>
			<p class="heading1" id="calibre_link-989">Introduction</p>
			<p class="normal--unindented">The initial table used for the budget contains forecasts of sales at a certain granularity. In our example, this table contains forecasts of sales by store country, product category, and year. There are three forecasts named Low, Medium, and High. Figure 24-1 shows the full dataset.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-990">
					<img alt="" class="_idgenobjectattribute" src="images/000516.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 24-1</span> The forecast dataset contains data for store country, product category, year, and scenario.</p>
			<p class="normal1">Based on this dataset, we work with the following requirements:</p>
			<ul class="calibre1">
				<li class="bull-list">Allocating the forecast at a different granularity. For example, computing the monthly forecast based on the sales in the previous year.</li>
				<li class="bull-list">Combining actuals and forecasts in the same report, using the actual values for the past months and the forecasts for the future months of the current year.</li>
				<li class="bull-list">Correcting the forecast of future months based on how far they are from the actuals in past months of the current year.</li>
			</ul>
			<p class="normal1">Additionally, we want to keep in mind new products that might be introduced throughout the years, as well as discontinued products for which the forecast should not be computed. For this purpose, we use a table called <span class="charoverride3">Override</span> that states when a product was introduced, along with the sales forecast for the first year. The same <span class="charoverride3">Override</span> table also includes the dismission date of the discontinued products that are not used in order to allocate the forecast. The allocation of the new products by store country must be based on past sales of other products.</p>
			<p class="heading1" id="calibre_link-991">The data model</p>
			<p class="normal--unindented">Before diving into the details of the calculations, it is important to make some considerations about the data model.</p>
			<p class="normal1">The scenario we are analyzing is a top-down forecasting scenario. Therefore, the source data contains a forecast of sales for different scenarios at a low granularity. Low granularity means that the information provided is at a very high level: year, store country, and product category. There are no details about individual products, months or stores. Consequently, the <span class="charoverride3">Forecast</span> table is linked with the relevant tables using weak Many-Many-Relationships (MMR) and it has a Single-Many-Relationship (SMR) only with the <span class="charoverride3">Scenario</span> table, as depicted in the diagram in Figure 24-2.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-992">
					<img alt="" class="_idgenobjectattribute" src="images/000287.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 24-2</span> The relationships between Forecast and other dimensions (other than Scenario) are weak MMR relationships.</p>
			<p class="normal1">The following relationships start off of the <span class="charoverride3">Forecast</span> table:</p>
			<ul class="calibre1">
				<li class="bull-list">MMR with <span class="charoverride3">Store</span> based on the <span class="charoverride3">CountryRegion</span> column.</li>
				<li class="bull-list">MMR with <span class="charoverride3">Product</span> based on the <span class="charoverride3">Category</span> column.</li>
				<li class="bull-list">MMR with <span class="charoverride3">Date</span> based on the <span class="charoverride3">Year</span> column.</li>
				<li class="bull-list">SMR with <span class="charoverride3">Scenario</span> based on the <span class="charoverride3">Scenario</span> column.</li>
			</ul>
			<p class="normal1">All the MMRs are weak relationships; they only filter at the granularity of the relationship. At a more detailed (higher) granularity, they just repeat the total at the supported grain.</p>
			<p class="readeraid--only"><span class="charoverride2">NOTE</span>&nbsp; The use of MMR and SMR is required to avoid confusion with other definitions of many-to-many relationships. A complete description of the MMR and SMR relationships in Power BI is available in the article, <a href="https://www.sqlbi.com/articles/relationships-in-power-bi-and-tabular-models/"><span class="hyperlink">Relationships in Power BI and Tabular models</span></a>.</p>
			<p class="normal1">The <span class="charoverride3">Scenario</span> table implements the best practice of always using dimension tables to slice and dice, instead of using columns in the fact table (<span class="charoverride3">Forecast</span> in this case) for slicers and filters.</p>
			<p class="normal1">The forecast information of this pattern comes from an Excel file. The same Excel file includes another table called <span class="charoverride3">Override</span>, which contains information about new and dismissed products. The relevant columns in the <span class="charoverride3">Override</span> table are:</p>
			<ul class="calibre1">
				<li class="bull-list"><span class="charoverride4">Year New</span>: the year a new product was introduced.</li>
				<li class="bull-list"><span class="charoverride4">Year Del</span>: the year a product was (or will be) dismissed.</li>
				<li class="bull-list"><span class="charoverride4">Amount</span>: the forecast sales over all countries for the first year.</li>
			</ul>
			<p class="normal1">Because the <span class="charoverride3">Override</span> table has the same granularity as the <span class="charoverride3">Product</span> table, we used Power Query to merge these three columns directly in the <span class="charoverride3">Product</span> table. Figure 24-3 shows the content of these three columns imported in <span class="charoverride3">Product</span> from the <span class="charoverride3">Override</span> table.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-993">
					<img alt="" class="_idgenobjectattribute" src="images/000133.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 24-3</span> For each new or dismissed product, the relevant information is stored in the <span class="charoverride3">Product</span> table itself.</p>
			<p class="normal1">This is not necessarily an optimal model. We designed it to show you the DAX code, but different requirements might justify using a different model. You should update the calculations to reflect your specific requirements and data model.</p>
			<p class="heading1" id="calibre_link-994">Business choices</p>
			<p class="normal--unindented">As with the model, we needed to set some business choices in order to author the DAX code. The following sections describe the business rules implemented in this pattern.</p>
			<p class="heading" id="calibre_link-995">Allocation based on the previous year</p>
			<p class="normal--unindented">When the forecast needs to be reallocated, we consider the sales in the previous year as an allocation factor. In other words, in order to show the forecast of a subcategory, we reallocate the budget defined at the category level by the percentage of sales of the given subcategory against the corresponding category in the previous year.</p>
			<p class="normal1">This is better depicted in Figure 24-4.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-996">
					<img alt="" class="_idgenobjectattribute" src="images/000280.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 24-4</span> The forecast is allocated to subcategories based on the sales of the previous year.</p>
			<p class="normal1">Consequently, a previously existing product that had no sales in one year, will have a forecast of zero in the following year.</p>
			<p class="heading" id="calibre_link-997">Dismissed products do not contribute to the allocation</p>
			<p class="normal--unindented">If a product is dismissed, its forecast for the new year is zero since the product is no longer available for sale. Consequently, the forecast for the new year does not include dismissed products. If we ignored this condition, the allocation would produce undesired results.</p>
			<p class="normal1">For example, think about what would happen if all the products in the category Cell Phones Accessories were dismissed. In the United States, they contribute for 26% of sales, as shown in Figure 24-4. Because the products of this category are dismissed, the forecast for the next year does not include their sales. The allocation formula must take this into account, by increasing the percentages of other subcategories to compensate for the absence of a certain category. If not, the total allocated forecast would only add up to 74% of the total forecast, hiding the 26% that are no longer being allocated to dismissed products.</p>
			<p class="normal1">In summary, if a product is dismissed one year, its sales in the previous year are not considered for the forecast allocation.</p>
			<p class="heading" id="calibre_link-998">New products have their own forecast amount</p>
			<p class="normal--unindented">This is not really a business decision, but rather a choice to simplify the model. If a product is being introduced as new, then its sales in the previous year are at zero. As we stated earlier, this would translate into an empty forecast for the following year. Still, the product being new is expected to have no sales in the previous year.</p>
			<p class="normal1">For this reason, every new product has a forecast amount associated to it for the year when it is being introduced. This is a single value, which is allocated in different store countries depending on the distribution percentage of all the other products over the store countries.</p>
			<p class="normal1">As with other options, this is not necessarily the best choice; but we must make a choice in order to write working code. In other scenarios, there could be a table containing more detailed forecasts, or the issue could be ignored for a specific business. Therefore, consider this as an optional implementation option and not as a mandatory requirement.</p>
			<p class="heading" id="calibre_link-999">Products can be dismissed or introduced on a yearly basis</p>
			<p class="normal--unindented">In order to keep the model simple enough, we introduced this artificial limitation: a product is introduced at the beginning of a year (therefore it starts selling in January) and dismissed at the end of a year (no more sales in the new year).</p>
			<p class="normal1">Handling the introduction of products at different points in time introduces a new level of complexity around time. Indeed, when computing the forecast for the new products, the amount should be allocated only starting at a given point in time. Dismissed products present a similar issue. We decided not to handle this complexity in order to focus more on the allocation algorithm. Specific and more detailed business requirements might require some adjustment to the proposed formulas.</p>
			<p class="heading1" id="calibre_link-1000">Forecast allocation</p>
			<p class="normal--unindented">The allocation of forecast uses sales in the previous year to determine the percentage of the total forecast that must be allocated to the current selection. The formula is composed of two main sections: the allocation of the forecast and the computation of the value for new products.</p>
			<p class="normal1">Figure 24-5 helps us better understand the calculation by showing the <span class="charoverride3">Forecast Amount</span> and the <span class="charoverride3">% Sales PY (BG)</span> measures side by side. <span class="charoverride3">% Sales PY (BG)</span> is the allocation percentage at the budget granularity that is internally computed in <span class="charoverride3">Forecast Amount</span>. The sample file includes a separate definition of <span class="charoverride3">% Sales PY (BG)</span> just to display this intermediate calculation that is not relevant to the pattern.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-1001">
					<img alt="" class="_idgenobjectattribute" src="images/000412.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 24-5</span> The figure shows the relevant parts of the forecast allocation by product.</p>
			<p class="normal1">There are two categories selected in the report: Cell phones and Clothes. Clothes is a new category, that was not present in the previous year. The full forecast for each store country (China and Germany are visible in Figure 24-5) includes the allocated forecast for the selected country, plus the amount assigned to new products through the <span class="charoverride3">Forecast New</span> column imported from the <span class="charoverride3">Amount</span> column in the <span class="charoverride3">Override</span> table of the Excel file.</p>
			<p class="normal1">The model is designed in a way that there is a single forecast amount for each product for the entire year. This number must be allocated by store country based on the sales of the previous year for that country, as shown by <span class="charoverride3">% Sales PY by Store</span> in Figure 24-6. This time, the allocation is made only by store country &ndash; no other columns are involved.</p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-1002">
					<img alt="" class="_idgenobjectattribute" src="images/000539.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 24-6</span> The figure shows the relevant parts of the forecast allocation by country.</p>
			<p class="normal1">This is the definition of the <span class="charoverride3">Forecast Amount</span> measure:</p>
			<p class="code-block-screened-head">Measure in the Forecast table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-1003">
					<img alt="" class="_idgenobjectattribute" src="images/000275.png" />
				</div>
			</div>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-1004">
					<img alt="" class="_idgenobjectattribute" src="images/000290.png" />
				</div>
			</div>
			<p class="normal1">The formula works with a single year selected and it also produces correct results with a reduced set of dates within one year. It is also possible to implement time intelligence calculations over the <span class="charoverride3">Forecast Amount</span> measures, like the year-to-date in the <span class="charoverride3">YTD Forecast</span> measure:</p>
			<p class="code-block-screened-head">Measure in the Forecast table </p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-1005">
					<img alt="" class="_idgenobjectattribute" src="images/000304.png" />
				</div>
			</div>
			<p class="heading1" id="calibre_link-1006">Showing actuals and forecasts on the same chart</p>
			<p class="normal--unindented">A common requirement is to show both actual and forecast measures in the same chart. This type of requests might end up in producing reports that are not very useful, like the one visible in Figure 24-7. The <span class="charoverride3">YTD Sales (not filtered)</span> measure displays the year-to-date of <span class="charoverride3">Sales Amount</span>: because the <span class="charoverride3">Sales</span> table contains data until August 14, 2010, the year-to-date is a flat line from August to December. </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-1007">
					<img alt="" class="_idgenobjectattribute" src="images/000593.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 24-7</span> Actual and forecast sales are represented in the same line chart, relying on the projection measures.</p>
			<p class="normal--unindented">A better visualization in these cases shows the actual sales amount up to the last day of sales available, and then it uses the forecast for the following days to complete the chart for the future months. Figure 24-8 shows this type of report through a line chart.</p>
			<p class="fig-graphic"> </p>
			<div class="_idgenobjectlayout">
				<div class="screenshot" id="calibre_link-1008">
					<img alt="" class="_idgenobjectattribute" src="images/000037.png" />
				</div>
			</div>
			<p class="num-caption"><span class="fig-num">Figure 24-8</span> Actual and forecast sales are represented in the same line chart using the projection measures.</p>
			<p class="normal1">The last complete month showing data for the <span class="charoverride3">YTD Sales Amount</span> measure is July 2010. The following months are not displayed thanks to the date check in the following implementation:</p>
			<p class="code-block-screened-head">Measure in the Sales table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-1009">
					<img alt="" class="_idgenobjectattribute" src="images/000317.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">YTD Forecast</span> measure is only used to display the complete forecast in the line chart; It just computes the year-to-date of <span class="charoverride3">Forecast Amount</span> defined in the previous section:</p>
			<p class="code-block-screened-head">Measure in the Forecast table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-1010">
					<img alt="" class="_idgenobjectattribute" src="images/000304.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">YTD Projection</span> measure computes the year-to-date of the <span class="charoverride3">Projection Amount</span> measure. The latter uses <span class="charoverride3">Sales Amount</span> for the dates available in the <span class="charoverride3">Sales</span> table (until August 14, 2010 in this example) and <span class="charoverride3">Forecast Amount</span> for the dates following the last date available in <span class="charoverride3">Sales</span> (dates greater than August 14, 2010 in this example):</p>
			<p class="code-block-screened-head">Measure in the Forecast table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-1011">
					<img alt="" class="_idgenobjectattribute" src="images/000332.png" />
				</div>
			</div>
			<p class="normal1"><span class="charoverride7">Measure in the Forecast table</span></p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-1012">
					<img alt="" class="_idgenobjectattribute" src="images/000345.png" />
				</div>
			</div>
			<p class="normal1">The <span class="charoverride3">YTD Adjusted Projection</span> measure is like <span class="charoverride3">YTD Projection; </span>however, it applies an adjustment factor to the <span class="charoverride3">Forecast Amount</span> based on the comparison between available transactions and the corresponding forecast:</p>
			<p class="code-block-screened-head">Measure in the Forecast table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-1013">
					<img alt="" class="_idgenobjectattribute" src="images/000363.png" />
				</div>
			</div>
			<p class="code-block-screened-head">Measure in the Forecast table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-1014">
					<img alt="" class="_idgenobjectattribute" src="images/000377.png" />
				</div>
			</div>
			<p class="normal1">The adjustment factor computed by the <span class="charoverride3">% Adjustment</span> measure could have many different implementations, depending on specific business requirements. In this example we use the ratio between <span class="charoverride3">Sales Amount</span> and <span class="charoverride3">Forecast Amount</span> for the dates available in the <span class="charoverride3">Sales</span> table:</p>
			<p class="code-block-screened-head">Measure in the Forecast table</p>
			<div class="_idgenobjectlayout">
				<div class="code-screenshot" id="calibre_link-1015">
					<img alt="" class="_idgenobjectattribute" src="images/000392.png" />
				</div>
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-1016">
			</div>
		</div>
		<div class="_idgenobjectlayout">
			<div class="_idgenobjectstyleoverride8" id="calibre_link-1017">
			</div>
		</div>
	</div>


<div id="calibre_link-30" lang="en-US" lang="en-US" class="calibre">
		<div class="_idgenobjectlayout">
			<div class="about-picture" id="calibre_link-1018">
				<img alt="" class="_idgenobjectattribute" src="images/000267.png" />
			</div>
		</div>
		<div class="full-margin-text-frame" type="contributors" id="calibre_link-1019">
			<p class="under-picture"><span class="charoverride2">Alberto Ferrari</span> and <span class="charoverride2">Marco Russo</span> co-founded SQLBI, where they publish frequent articles about DAX and other Microsoft tools. </p>
			<p class="under-picture">They are regular speakers at major international conferences such as Microsoft Ignite, PASS Summit, and SQLBits. Both currently teach, consult, and mentor on Microsoft Business Intelligence technologies.</p>
			<p class="under-picture"><a href="https://www.sqlbi.com"><span class="hyperlink1">www.sqlbi.com</span></a></p>
		</div>
	</div>


</body></html>